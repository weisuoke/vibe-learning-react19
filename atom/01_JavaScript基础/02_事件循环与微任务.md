# äº‹ä»¶å¾ªç¯ä¸å¾®ä»»åŠ¡

## ä¸€ã€ã€30å­—æ ¸å¿ƒã€‘

**äº‹ä»¶å¾ªç¯æ˜¯ JavaScript çš„å¹¶å‘æ¨¡å‹ï¼Œé€šè¿‡å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†å¼‚æ­¥æ“ä½œï¼Œæ˜¯ React Scheduler è°ƒåº¦å’Œ Effect æ‰§è¡Œçš„åŸºç¡€ã€‚**

---

## äºŒã€ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### äº‹ä»¶å¾ªç¯çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**äº‹ä»¶å¾ªç¯ = å•çº¿ç¨‹ + ä»»åŠ¡é˜Ÿåˆ— + å¾ªç¯æ£€æŸ¥**

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

JavaScript æ˜¯å•çº¿ç¨‹è¯­è¨€ï¼Œä¸€æ¬¡åªèƒ½åšä¸€ä»¶äº‹ã€‚äº‹ä»¶å¾ªç¯æ˜¯ JavaScript å¤„ç†å¼‚æ­¥æ“ä½œçš„æœºåˆ¶ï¼Œå®ƒä¸æ–­æ£€æŸ¥æ˜¯å¦æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶æŒ‰ä¼˜å…ˆçº§æ‰§è¡Œå®ƒä»¬ã€‚

#### 2. ä¸ºä»€ä¹ˆéœ€è¦äº‹ä»¶å¾ªç¯ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šå•çº¿ç¨‹å¦‚ä½•å¤„ç†å¼‚æ­¥æ“ä½œè€Œä¸é˜»å¡ä¸»çº¿ç¨‹ï¼Ÿ**

å¦‚æœæ²¡æœ‰äº‹ä»¶å¾ªç¯ï¼ŒJavaScript ä¼šé‡åˆ°ä¸¥é‡çš„é—®é¢˜ï¼š
- ç½‘ç»œè¯·æ±‚éœ€è¦ç­‰å¾…å‡ ç§’ï¼Œç•Œé¢å®Œå…¨å¡æ­»
- å®šæ—¶å™¨æ— æ³•å·¥ä½œ
- ç”¨æˆ·ç‚¹å‡»æŒ‰é’®åï¼Œå¿…é¡»ç­‰å½“å‰ä»£ç æ‰§è¡Œå®Œæ‰èƒ½å“åº”

äº‹ä»¶å¾ªç¯è®© JavaScript å¯ä»¥"åŒæ—¶"å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œè™½ç„¶ä»æ˜¯å•çº¿ç¨‹ï¼Œä½†é€šè¿‡ä»»åŠ¡è°ƒåº¦å®ç°äº†"å¹¶å‘"ã€‚

#### 3. äº‹ä»¶å¾ªç¯çš„ä¸‰å±‚ä»·å€¼

##### ä»·å€¼1ï¼šé¿å…é˜»å¡ä¸»çº¿ç¨‹ ğŸš€

```javascript
// âŒ æ²¡æœ‰äº‹ä»¶å¾ªç¯çš„ä¸–ç•Œï¼ˆåŒæ­¥é˜»å¡ï¼‰
function syncFetch(url) {
  // å‡è®¾è¿™éœ€è¦ 3 ç§’
  const data = blockingNetworkRequest(url);
  return data;
  // æœŸé—´ç•Œé¢å®Œå…¨å¡æ­»ï¼Œæ— æ³•æ»šåŠ¨ã€ç‚¹å‡»
}

// âœ… æœ‰äº‹ä»¶å¾ªç¯çš„ä¸–ç•Œï¼ˆå¼‚æ­¥éé˜»å¡ï¼‰
function asyncFetch(url) {
  fetch(url).then(data => {
    console.log(data);
  });
  // ç«‹å³è¿”å›ï¼Œç½‘ç»œè¯·æ±‚åœ¨åå°è¿›è¡Œ
  // ç”¨æˆ·å¯ä»¥ç»§ç»­æ“ä½œç•Œé¢
}

console.log('start');
asyncFetch('/api/data');
console.log('end');
// è¾“å‡ºï¼šstart -> end -> (1ç§’å) data
```

##### ä»·å€¼2ï¼šæœ‰åºæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ ğŸ“‹

```javascript
// å¤šä¸ªå¼‚æ­¥ä»»åŠ¡æŒ‰ä¼˜å…ˆçº§æœ‰åºæ‰§è¡Œ
console.log('1. åŒæ­¥ä»»åŠ¡');

setTimeout(() => {
  console.log('4. å®ä»»åŠ¡ï¼šsetTimeout');
}, 0);

Promise.resolve().then(() => {
  console.log('3. å¾®ä»»åŠ¡ï¼šPromise');
});

console.log('2. åŒæ­¥ä»»åŠ¡');

// è¾“å‡ºé¡ºåºï¼š
// 1. åŒæ­¥ä»»åŠ¡
// 2. åŒæ­¥ä»»åŠ¡
// 3. å¾®ä»»åŠ¡ï¼šPromise
// 4. å®ä»»åŠ¡ï¼šsetTimeout
```

##### ä»·å€¼3ï¼šå®ç°ä¼˜å…ˆçº§è°ƒåº¦ ğŸ¯

å¾®ä»»åŠ¡çš„ä¼˜å…ˆçº§é«˜äºå®ä»»åŠ¡ï¼Œè¿™è®©æˆ‘ä»¬å¯ä»¥æ§åˆ¶æ‰§è¡Œé¡ºåºï¼š

```javascript
function urgentTask() {
  // ä½¿ç”¨å¾®ä»»åŠ¡ï¼Œä¼˜å…ˆçº§é«˜
  queueMicrotask(() => {
    console.log('ç´§æ€¥ä»»åŠ¡');
  });
}

function normalTask() {
  // ä½¿ç”¨å®ä»»åŠ¡ï¼Œä¼˜å…ˆçº§ä½
  setTimeout(() => {
    console.log('æ™®é€šä»»åŠ¡');
  }, 0);
}

normalTask();
urgentTask();

// è¾“å‡ºï¼š
// ç´§æ€¥ä»»åŠ¡ï¼ˆå¾®ä»»åŠ¡å…ˆæ‰§è¡Œï¼‰
// æ™®é€šä»»åŠ¡ï¼ˆå®ä»»åŠ¡åæ‰§è¡Œï¼‰
```

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼ React å®ç°

**æ¨ç†é“¾ï¼š**

```
1. React éœ€è¦é«˜æ€§èƒ½çš„ UI æ›´æ–°
   â†“
2. åŒæ­¥æ›´æ–°ä¼šé˜»å¡ç”¨æˆ·äº¤äº’
   â†“
3. éœ€è¦å¼‚æ­¥è°ƒåº¦æœºåˆ¶
   â†“
4. JavaScript åªæœ‰äº‹ä»¶å¾ªç¯æœºåˆ¶
   â†“
5. å®ä»»åŠ¡ï¼ˆsetTimeoutï¼‰å¯ä»¥åˆ‡åˆ†ä»»åŠ¡
   â†“
6. å¾®ä»»åŠ¡ï¼ˆPromiseï¼‰å¯ä»¥æ‰¹é‡æ›´æ–°
   â†“
7. React 18 ä½¿ç”¨ MessageChannelï¼ˆå®ä»»åŠ¡ï¼‰å®ç°æ—¶é—´åˆ‡ç‰‡
   â†“
8. React 18 ä½¿ç”¨ queueMicrotask å®ç°è‡ªåŠ¨æ‰¹å¤„ç†
   â†“
9. Scheduler è°ƒåº¦å™¨åŸºäºäº‹ä»¶å¾ªç¯å®ç°ä¼˜å…ˆçº§è°ƒåº¦
```

**ä¸ºä»€ä¹ˆ React é€‰æ‹©äº‹ä»¶å¾ªç¯ï¼Ÿ**

- **æµè§ˆå™¨åŸç”Ÿæœºåˆ¶**ï¼šä¸éœ€è¦é¢å¤–çš„è¿è¡Œæ—¶
- **ä¼˜å…ˆçº§æ§åˆ¶**ï¼šå¾®ä»»åŠ¡å’Œå®ä»»åŠ¡æä¾›äº†ä¸¤çº§ä¼˜å…ˆçº§
- **æ—¶é—´åˆ‡ç‰‡**ï¼šåˆ©ç”¨å®ä»»åŠ¡å¯ä»¥åœ¨ä»»åŠ¡é—´è®©å‡ºæ§åˆ¶æƒ
- **æ‰¹é‡æ›´æ–°**ï¼šå¾®ä»»åŠ¡å¯ä»¥åœ¨å½“å‰ä»»åŠ¡ç»“æŸåç«‹å³æ‰§è¡Œ

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**äº‹ä»¶å¾ªç¯é€šè¿‡è°ƒç”¨æ ˆã€å¾®ä»»åŠ¡é˜Ÿåˆ—å’Œå®ä»»åŠ¡é˜Ÿåˆ—çš„ååŒå·¥ä½œï¼Œè®©å•çº¿ç¨‹çš„ JavaScript èƒ½å¤Ÿé«˜æ•ˆå¤„ç†å¼‚æ­¥æ“ä½œï¼Œæ˜¯æ‰€æœ‰å¼‚æ­¥ç¼–ç¨‹çš„åŸºç¡€ã€‚**

---

## ä¸‰ã€ã€3ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šè°ƒç”¨æ ˆï¼ˆCall Stackï¼‰ ğŸ“š

**è°ƒç”¨æ ˆæ˜¯åŒæ­¥ä»£ç æ‰§è¡Œçš„åœ°æ–¹ï¼Œé‡‡ç”¨åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰çš„æ•°æ®ç»“æ„ã€‚**

```javascript
function third() {
  console.log('ç¬¬ä¸‰å±‚');
}

function second() {
  console.log('ç¬¬äºŒå±‚');
  third();
  console.log('ç¬¬äºŒå±‚è¿”å›');
}

function first() {
  console.log('ç¬¬ä¸€å±‚');
  second();
  console.log('ç¬¬ä¸€å±‚è¿”å›');
}

first();

// è¾“å‡ºï¼š
// ç¬¬ä¸€å±‚
// ç¬¬äºŒå±‚
// ç¬¬ä¸‰å±‚
// ç¬¬äºŒå±‚è¿”å›
// ç¬¬ä¸€å±‚è¿”å›
```

**è°ƒç”¨æ ˆçš„å˜åŒ–è¿‡ç¨‹ï¼š**

```
1. [first] å…¥æ ˆ
2. [first, second] å…¥æ ˆ
3. [first, second, third] å…¥æ ˆ
4. [first, second, third, console.log] å…¥æ ˆå¹¶ç«‹å³å‡ºæ ˆ
5. [first, second] third æ‰§è¡Œå®Œæ¯•å‡ºæ ˆ
6. [first, second, console.log] å…¥æ ˆå¹¶ç«‹å³å‡ºæ ˆ
7. [first] second æ‰§è¡Œå®Œæ¯•å‡ºæ ˆ
8. [first, console.log] å…¥æ ˆå¹¶ç«‹å³å‡ºæ ˆ
9. [] first æ‰§è¡Œå®Œæ¯•å‡ºæ ˆ
```

**æ ˆæº¢å‡ºç¤ºä¾‹ï¼š**

```javascript
function recursion() {
  recursion(); // æ— é™é€’å½’
}

// recursion();
// Uncaught RangeError: Maximum call stack size exceeded
// è°ƒç”¨æ ˆè¢«å¡«æ»¡ï¼Œæ— æ³•å†å‹å…¥æ–°çš„å‡½æ•°
```

**åœ¨ React æºç /å¼€å‘ä¸­çš„åº”ç”¨ï¼š**

React Fiber ä¹‹å‰ä½¿ç”¨é€’å½’éå†ç»„ä»¶æ ‘ï¼Œæ·±å±‚åµŒå¥—ä¼šå¯¼è‡´è°ƒç”¨æ ˆå¾ˆæ·±ã€‚Fiber é€šè¿‡é“¾è¡¨ç»“æ„é‡å†™äº†éå†ç®—æ³•ï¼Œå¯ä»¥ä¸­æ–­å’Œæ¢å¤ï¼Œé¿å…äº†æ ˆæº¢å‡ºã€‚

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šå®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆMacro Task Queueï¼‰ ğŸ¢

**å®ä»»åŠ¡æ˜¯äº‹ä»¶å¾ªç¯çš„åŸºæœ¬è°ƒåº¦å•ä½ï¼ŒåŒ…æ‹¬ï¼šsetTimeoutã€setIntervalã€I/Oã€UI æ¸²æŸ“ã€MessageChannel ç­‰ã€‚**

```javascript
console.log('1. åŒæ­¥ä»£ç ');

setTimeout(() => {
  console.log('3. å®ä»»åŠ¡1');
}, 0);

setTimeout(() => {
  console.log('4. å®ä»»åŠ¡2');
}, 0);

console.log('2. åŒæ­¥ä»£ç ');

// è¾“å‡ºï¼š
// 1. åŒæ­¥ä»£ç 
// 2. åŒæ­¥ä»£ç 
// 3. å®ä»»åŠ¡1
// 4. å®ä»»åŠ¡2
```

**å®ä»»åŠ¡çš„ç‰¹ç‚¹ï¼š**

1. **å»¶è¿Ÿæ‰§è¡Œ**ï¼šå³ä½¿å»¶è¿Ÿæ—¶é—´ä¸º 0ï¼Œä¹Ÿä¼šåœ¨å½“å‰åŒæ­¥ä»£ç æ‰§è¡Œå®Œåæ‰æ‰§è¡Œ
2. **é˜Ÿåˆ—è°ƒåº¦**ï¼šå¤šä¸ªå®ä»»åŠ¡æŒ‰åŠ å…¥é˜Ÿåˆ—çš„é¡ºåºæ‰§è¡Œ
3. **å¯ä¸­æ–­**ï¼šæ¯ä¸ªå®ä»»åŠ¡ä¹‹é—´ï¼Œæµè§ˆå™¨å¯ä»¥è¿›è¡Œæ¸²æŸ“

**å®ä»»åŠ¡çš„æ‰§è¡Œæµç¨‹ï¼š**

```
1. æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ï¼ˆä»é˜Ÿåˆ—ä¸­å–å‡ºï¼‰
   â†“
2. æ‰§è¡Œæ‰€æœ‰å¾®ä»»åŠ¡
   â†“
3. æ¸²æŸ“æ›´æ–°ï¼ˆå¦‚æœéœ€è¦ï¼‰
   â†“
4. æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡
   â†“
5. é‡å¤...
```

**åœ¨ React æºç /å¼€å‘ä¸­çš„åº”ç”¨ï¼š**

React Scheduler ä½¿ç”¨ `MessageChannel` åˆ›å»ºå®ä»»åŠ¡æ¥å®ç°æ—¶é—´åˆ‡ç‰‡ï¼š

```javascript
// React æºç ç®€åŒ–ç‰ˆ
const channel = new MessageChannel();
const port = channel.port2;

// ç›‘å¬æ¶ˆæ¯ï¼ˆå®ä»»åŠ¡ï¼‰
channel.port1.onmessage = performWorkUntilDeadline;

function schedulePerformWorkUntilDeadline() {
  // å‘é€æ¶ˆæ¯ï¼Œè§¦å‘å®ä»»åŠ¡
  port.postMessage(null);
}

function performWorkUntilDeadline() {
  const currentTime = getCurrentTime();
  const deadline = currentTime + 5; // 5ms æ—¶é—´ç‰‡

  // æ‰§è¡Œå·¥ä½œï¼Œç›´åˆ°è¶…æ—¶
  while (hasMoreWork() && getCurrentTime() < deadline) {
    performUnitOfWork();
  }

  // å¦‚æœè¿˜æœ‰å·¥ä½œï¼Œè°ƒåº¦ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡
  if (hasMoreWork()) {
    schedulePerformWorkUntilDeadline();
  }
}
```

**ä¸ºä»€ä¹ˆç”¨ MessageChannel è€Œä¸æ˜¯ setTimeoutï¼Ÿ**

- `setTimeout` æœ‰ 4ms çš„æœ€å°å»¶è¿Ÿï¼ˆåµŒå¥—5æ¬¡åï¼‰
- `MessageChannel` æ²¡æœ‰å»¶è¿Ÿé™åˆ¶ï¼Œæ›´ç²¾ç¡®
- `requestIdleCallback` å…¼å®¹æ€§å·®ä¸”ä¼˜å…ˆçº§å¤ªä½

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆMicro Task Queueï¼‰ âš¡

**å¾®ä»»åŠ¡æ˜¯ä¼˜å…ˆçº§é«˜äºå®ä»»åŠ¡çš„ä»»åŠ¡ï¼ŒåŒ…æ‹¬ï¼šPromise.thenã€queueMicrotaskã€MutationObserverã€process.nextTickï¼ˆNode.jsï¼‰ç­‰ã€‚**

```javascript
console.log('1. åŒæ­¥ä»£ç ');

setTimeout(() => {
  console.log('4. å®ä»»åŠ¡');
}, 0);

Promise.resolve().then(() => {
  console.log('3. å¾®ä»»åŠ¡1');
}).then(() => {
  console.log('5. å¾®ä»»åŠ¡2');
});

queueMicrotask(() => {
  console.log('3.5. å¾®ä»»åŠ¡3');
});

console.log('2. åŒæ­¥ä»£ç ');

// è¾“å‡ºï¼š
// 1. åŒæ­¥ä»£ç 
// 2. åŒæ­¥ä»£ç 
// 3. å¾®ä»»åŠ¡1
// 3.5. å¾®ä»»åŠ¡3
// 5. å¾®ä»»åŠ¡2
// 4. å®ä»»åŠ¡
```

**å¾®ä»»åŠ¡çš„å…³é”®ç‰¹æ€§ï¼š**

1. **é«˜ä¼˜å…ˆçº§**ï¼šåœ¨å½“å‰å®ä»»åŠ¡ç»“æŸåç«‹å³æ‰§è¡Œï¼Œæ—©äºä¸‹ä¸€ä¸ªå®ä»»åŠ¡
2. **æ¸…ç©ºé˜Ÿåˆ—**ï¼šæ‰€æœ‰å¾®ä»»åŠ¡ä¼šè¢«æ¸…ç©ºæ‰ä¼šæ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡
3. **å¯æ’é˜Ÿ**ï¼šåœ¨å¾®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–°å¾®ä»»åŠ¡ä¼šç«‹å³åŠ å…¥é˜Ÿåˆ—

**å¾®ä»»åŠ¡çš„"æ¸…ç©º"ç‰¹æ€§ï¼š**

```javascript
console.log('start');

setTimeout(() => {
  console.log('å®ä»»åŠ¡');
}, 0);

Promise.resolve().then(() => {
  console.log('å¾®ä»»åŠ¡1');

  // å¾®ä»»åŠ¡ä¸­åˆ›å»ºæ–°å¾®ä»»åŠ¡
  Promise.resolve().then(() => {
    console.log('å¾®ä»»åŠ¡1.1');
  });
});

Promise.resolve().then(() => {
  console.log('å¾®ä»»åŠ¡2');
});

console.log('end');

// è¾“å‡ºï¼š
// start
// end
// å¾®ä»»åŠ¡1
// å¾®ä»»åŠ¡2
// å¾®ä»»åŠ¡1.1  <- æ’é˜ŸæˆåŠŸï¼Œåœ¨å®ä»»åŠ¡å‰æ‰§è¡Œ
// å®ä»»åŠ¡
```

**åœ¨ React æºç /å¼€å‘ä¸­çš„åº”ç”¨ï¼š**

React 18 ä½¿ç”¨ `queueMicrotask` å®ç°è‡ªåŠ¨æ‰¹å¤„ç†ï¼š

```javascript
// React 18 æ‰¹å¤„ç†ç®€åŒ–ç‰ˆ
let isBatchingUpdates = false;
const pendingUpdates = [];

function setState(update) {
  pendingUpdates.push(update);

  if (!isBatchingUpdates) {
    isBatchingUpdates = true;

    // ä½¿ç”¨å¾®ä»»åŠ¡æ‰¹é‡æ›´æ–°
    queueMicrotask(() => {
      flushUpdates();
      isBatchingUpdates = false;
    });
  }
}

function flushUpdates() {
  // ä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰æ›´æ–°
  const updates = pendingUpdates.splice(0);
  updates.forEach(update => update());
}

// ä½¿ç”¨ç¤ºä¾‹
function Component() {
  const [count, setCount] = useState(0);

  function handleClick() {
    setCount(1); // è¿›å…¥æ‰¹å¤„ç†
    setCount(2); // è¿›å…¥æ‰¹å¤„ç†
    setCount(3); // è¿›å…¥æ‰¹å¤„ç†
    // å¾®ä»»åŠ¡è§¦å‘ï¼Œåªæ¸²æŸ“ä¸€æ¬¡
  }
}
```

**React 18 ä¹‹å‰ vs React 18ï¼š**

```javascript
// React 17ï¼šåªåœ¨äº‹ä»¶å¤„ç†å™¨ä¸­æ‰¹å¤„ç†
function handleClick() {
  setCount(1);
  setCount(2); // æ‰¹å¤„ç† âœ…
}

setTimeout(() => {
  setCount(1);
  setCount(2); // ä¸æ‰¹å¤„ç† âŒ æ¸²æŸ“ä¸¤æ¬¡
}, 0);

// React 18ï¼šæ‰€æœ‰åœ°æ–¹éƒ½æ‰¹å¤„ç†
setTimeout(() => {
  setCount(1);
  setCount(2); // æ‰¹å¤„ç† âœ… åªæ¸²æŸ“ä¸€æ¬¡
}, 0);
```

---

## å››ã€ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½ç†è§£ React æºç æ ¸å¿ƒï¼š

### 4.1 äº‹ä»¶å¾ªç¯æ‰§è¡Œé¡ºåº

```javascript
// è®°ä½è¿™ä¸ªå£è¯€ï¼šåŒæ­¥ â†’ å¾®ä»»åŠ¡ â†’ å®ä»»åŠ¡

console.log('1. åŒæ­¥ä»£ç å¼€å§‹');

// å®ä»»åŠ¡
setTimeout(() => {
  console.log('5. å®ä»»åŠ¡');
}, 0);

// å¾®ä»»åŠ¡
Promise.resolve().then(() => {
  console.log('4. å¾®ä»»åŠ¡');
});

console.log('2. åŒæ­¥ä»£ç ç»§ç»­');

queueMicrotask(() => {
  console.log('3. queueMicrotask');
});

// è¾“å‡ºé¡ºåºï¼š1 â†’ 2 â†’ 3 â†’ 4 â†’ 5
```

**å…³é”®ç‚¹ï¼š**
- åŒæ­¥ä»£ç åœ¨è°ƒç”¨æ ˆä¸­ç«‹å³æ‰§è¡Œ
- åŒæ­¥ä»£ç æ‰§è¡Œå®Œåï¼Œæ¸…ç©ºæ‰€æœ‰å¾®ä»»åŠ¡
- å¾®ä»»åŠ¡æ¸…ç©ºåï¼Œæ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡
- é‡å¤ä¸Šè¿°è¿‡ç¨‹

### 4.2 Promise æ˜¯å¾®ä»»åŠ¡

```javascript
console.log('start');

new Promise((resolve) => {
  console.log('Promise æ„é€ å‡½æ•°ï¼ˆåŒæ­¥ï¼‰');
  resolve();
}).then(() => {
  console.log('Promise.thenï¼ˆå¾®ä»»åŠ¡ï¼‰');
});

console.log('end');

// è¾“å‡ºï¼š
// start
// Promise æ„é€ å‡½æ•°ï¼ˆåŒæ­¥ï¼‰
// end
// Promise.thenï¼ˆå¾®ä»»åŠ¡ï¼‰
```

**è®°ä½ï¼š**
- `new Promise(executor)` ä¸­çš„ `executor` å‡½æ•°æ˜¯åŒæ­¥æ‰§è¡Œçš„
- `.then()` å›è°ƒæ˜¯å¾®ä»»åŠ¡

### 4.3 setTimeout æ˜¯å®ä»»åŠ¡

```javascript
console.log('start');

setTimeout(() => {
  console.log('setTimeout 0ms');
}, 0);

setTimeout(() => {
  console.log('setTimeout 10ms');
}, 10);

Promise.resolve().then(() => {
  console.log('Promise.then');
});

console.log('end');

// è¾“å‡ºï¼š
// start
// end
// Promise.thenï¼ˆå¾®ä»»åŠ¡å…ˆæ‰§è¡Œï¼‰
// setTimeout 0msï¼ˆç¬¬ä¸€ä¸ªå®ä»»åŠ¡ï¼‰
// setTimeout 10msï¼ˆç¬¬äºŒä¸ªå®ä»»åŠ¡ï¼Œ10msåï¼‰
```

### 4.4 React å¦‚ä½•åˆ©ç”¨å¾®ä»»åŠ¡æ‰¹é‡æ›´æ–°

```javascript
// React 18 è‡ªåŠ¨æ‰¹å¤„ç†åŸç†
let updates = [];
let isScheduled = false;

function setState(newState) {
  updates.push(newState);

  if (!isScheduled) {
    isScheduled = true;

    // ä½¿ç”¨å¾®ä»»åŠ¡åˆå¹¶æ›´æ–°
    queueMicrotask(() => {
      console.log(`æ‰¹é‡æ›´æ–°ï¼š${updates.length} ä¸ªsetState`);
      // åªè§¦å‘ä¸€æ¬¡æ¸²æŸ“
      render(updates[updates.length - 1]);
      updates = [];
      isScheduled = false;
    });
  }
}

// æ¨¡æ‹Ÿç»„ä»¶ä¸­çš„å¤šæ¬¡ setState
setState(1);
setState(2);
setState(3);
console.log('åŒæ­¥ä»£ç ç»“æŸ');

// è¾“å‡ºï¼š
// åŒæ­¥ä»£ç ç»“æŸ
// æ‰¹é‡æ›´æ–°ï¼š3 ä¸ªsetState
// ï¼ˆåªæ¸²æŸ“ä¸€æ¬¡ï¼Œä½¿ç”¨æœ€åçš„å€¼ 3ï¼‰
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£ React 18 çš„è‡ªåŠ¨æ‰¹å¤„ç†æœºåˆ¶
- ç†è§£ useEffect çš„æ‰§è¡Œæ—¶æœº
- ç†è§£ Scheduler çš„æ—¶é—´åˆ‡ç‰‡åŸç†
- é¿å…å¼‚æ­¥ä»£ç ä¸­çš„å¸¸è§é™·é˜±

---

## äº”ã€ã€1ä¸ªç±»æ¯”ã€‘

### ç±»æ¯”1ï¼šäº‹ä»¶å¾ªç¯ = åŒ»é™¢åˆ†è¯Šå° ğŸ¥

**è§£é‡Šç›¸ä¼¼æ€§ï¼š**

æƒ³è±¡ä½ å»åŒ»é™¢çœ‹ç—…ï¼Œåˆ†è¯Šå°å¦‚ä½•å®‰æ’æ‚£è€…å°±è¯Šï¼š

1. **æ€¥è¯Šå®¤ï¼ˆè°ƒç”¨æ ˆï¼‰**
   - æ­£åœ¨å¤„ç†çš„ç—…äºº
   - ä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ª
   - å…ˆè¿›åå‡ºï¼ˆåæ¥çš„å…ˆå¤„ç†å®Œï¼‰

2. **ä¼˜å…ˆé€šé“ï¼ˆå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼‰**
   - VIP æ‚£è€…ã€æ€¥ç—‡æ‚£è€…
   - ä¼˜å…ˆçº§é«˜ï¼Œæ’é˜Ÿ
   - æ€¥è¯Šå®¤ç©ºé—²åç«‹å³å¤„ç†

3. **æ™®é€šæŒ‚å·ï¼ˆå®ä»»åŠ¡é˜Ÿåˆ—ï¼‰**
   - æ™®é€šæ‚£è€…æ’é˜Ÿ
   - ä¼˜å…ˆé€šé“æ¸…ç©ºåæ‰å¤„ç†
   - ä¸€ä¸ªä¸€ä¸ªæ¥

**ä¸¾ä¾‹ï¼š**

```javascript
console.log('1. æ€¥è¯Šå®¤ï¼šå¤„ç†éª¨æŠ˜æ‚£è€…ï¼ˆåŒæ­¥ä»£ç ï¼‰');

setTimeout(() => {
  console.log('5. æ™®é€šæŒ‚å·ï¼šå¤„ç†æ„Ÿå†’æ‚£è€…ï¼ˆå®ä»»åŠ¡ï¼‰');
}, 0);

Promise.resolve().then(() => {
  console.log('3. ä¼˜å…ˆé€šé“ï¼šå¤„ç†å¿ƒè„ç—…æ‚£è€…ï¼ˆå¾®ä»»åŠ¡ï¼‰');

  Promise.resolve().then(() => {
    console.log('4. ä¼˜å…ˆé€šé“ï¼šå¤„ç†å“®å–˜æ‚£è€…ï¼ˆå¾®ä»»åŠ¡æ’é˜Ÿï¼‰');
  });
});

console.log('2. æ€¥è¯Šå®¤ï¼šå¤„ç†æ‰­ä¼¤æ‚£è€…ï¼ˆåŒæ­¥ä»£ç ï¼‰');

// æ‰§è¡Œæµç¨‹ï¼š
// 1. æ€¥è¯Šå®¤å…ˆå¤„ç†å®Œæ‰€æœ‰å½“å‰æ‚£è€…ï¼ˆåŒæ­¥ä»£ç ï¼‰
// 2. æ€¥è¯Šå®¤ç©ºé—²ï¼ŒæŸ¥çœ‹ä¼˜å…ˆé€šé“ï¼ˆå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼‰
// 3. ä¼˜å…ˆé€šé“çš„æ‚£è€…ä¾æ¬¡å¤„ç†ï¼ˆæ¸…ç©ºå¾®ä»»åŠ¡ï¼‰
// 4. ä¼˜å…ˆé€šé“æ¸…ç©ºåï¼Œå¤„ç†æ™®é€šæŒ‚å·ï¼ˆå®ä»»åŠ¡ï¼‰
```

---

### ç±»æ¯”2ï¼šReact è°ƒåº¦ = å¤–å–é…é€ ğŸšš

**è§£é‡Šç›¸ä¼¼æ€§ï¼š**

React çš„æ›´æ–°è°ƒåº¦å°±åƒå¤–å–é…é€ç³»ç»Ÿï¼š

1. **åŒæ­¥æ¸²æŸ“ = ç«‹å³é€è¾¾**
   - ç´§æ€¥è®¢å•ï¼Œéª‘æ‰‹é©¬ä¸Šé€
   - ç”¨æˆ·ç«‹å³çœ‹åˆ°ç»“æœ
   - é˜»å¡å…¶ä»–è®¢å•

2. **å¾®ä»»åŠ¡æ‰¹é‡æ›´æ–° = é¡ºè·¯ä¸€èµ·é€**
   - åŒä¸€ä¸ªå°åŒºçš„è®¢å•åˆå¹¶é…é€
   - å‡å°‘é…é€æ¬¡æ•°
   - æé«˜æ•ˆç‡

3. **å®ä»»åŠ¡å»¶è¿Ÿæ›´æ–° = ä¸‹ä¸€æ‰¹æ¬¡é…é€**
   - ä¸ç€æ€¥çš„è®¢å•ç­‰ä¸‹ä¸€è½®
   - ç»™é«˜ä¼˜å…ˆçº§è®¢å•è®©è·¯
   - é¿å…éª‘æ‰‹è¿‡åŠ³

**ä¸¾ä¾‹ï¼š**

```javascript
// å¤–å–é…é€ç³»ç»Ÿ
function OrderSystem() {
  const [orders, setOrders] = useState([]);

  function handleBatchOrders() {
    // åŒä¸€æ—¶é—´æ”¶åˆ°å¤šä¸ªè®¢å•
    setOrders(prev => [...prev, 'è®¢å•1']);
    setOrders(prev => [...prev, 'è®¢å•2']);
    setOrders(prev => [...prev, 'è®¢å•3']);

    // React 18ï¼šå¾®ä»»åŠ¡æ‰¹å¤„ç†
    // ä¸‰ä¸ªè®¢å•åˆå¹¶æˆä¸€æ¬¡é…é€ï¼ˆä¸€æ¬¡æ¸²æŸ“ï¼‰

    console.log('è®¢å•å·²æäº¤ï¼Œç­‰å¾…é…é€...');
    // åŒæ­¥ä»£ç ç»“æŸåï¼Œå¾®ä»»åŠ¡è§¦å‘ï¼Œç»Ÿä¸€é…é€
  }

  useEffect(() => {
    console.log(`é…é€äº† ${orders.length} ä¸ªè®¢å•`);
  }, [orders]);
}
```

---

### ç±»æ¯”3ï¼šæ—¶é—´åˆ‡ç‰‡ = åšé¥­æ—¶ç©¿æ’æ´—ç¢— ğŸ³

**è§£é‡Šç›¸ä¼¼æ€§ï¼š**

React çš„æ—¶é—´åˆ‡ç‰‡å°±åƒä½ åœ¨åšé¥­æ—¶ç©¿æ’åšå…¶ä»–äº‹ï¼š

```javascript
// æ²¡æœ‰æ—¶é—´åˆ‡ç‰‡ï¼ˆä¸€ç›´åˆ‡èœï¼Œæ‰‹ä¼šç´¯ï¼‰
function cookWithoutBreak() {
  for (let i = 0; i < 1000; i++) {
    chopVegetable(); // åˆ‡1000ä¸ªèœï¼Œæ‰‹éº»äº†ï¼Œä¸èƒ½å“åº”å…¶ä»–äº‹
  }
}

// æœ‰æ—¶é—´åˆ‡ç‰‡ï¼ˆåˆ‡ä¸€ä¼šå„¿ï¼Œæ´—ä¸ªç¢—ï¼Œå†åˆ‡ï¼‰
function cookWithBreak() {
  let count = 0;

  function workLoop() {
    const deadline = performance.now() + 5; // 5ms æ—¶é—´ç‰‡

    // åœ¨æ—¶é—´ç‰‡å†…å·¥ä½œ
    while (count < 1000 && performance.now() < deadline) {
      chopVegetable();
      count++;
    }

    // æ—¶é—´ç‰‡ç”¨å®Œï¼Œè®©å‡ºæ§åˆ¶æƒ
    if (count < 1000) {
      // ç”¨å®ä»»åŠ¡è°ƒåº¦ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡
      setTimeout(workLoop, 0);
    }
  }

  workLoop();
}
```

**React Fiber çš„å·¥ä½œå¾ªç¯ï¼š**

```
1. æ‰§è¡Œ 5ms çš„æ¸²æŸ“å·¥ä½œ
   â†“
2. æ£€æŸ¥æœ‰æ²¡æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼ˆç”¨æˆ·è¾“å…¥ï¼‰
   â†“
3. å¦‚æœæœ‰ï¼Œå…ˆå¤„ç†é«˜ä¼˜å…ˆçº§ä»»åŠ¡
   â†“
4. å¦‚æœæ²¡æœ‰ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª 5ms æ—¶é—´ç‰‡
   â†“
5. é‡å¤...
```

---

### ç±»æ¯”æ€»ç»“è¡¨

| äº‹ä»¶å¾ªç¯æ¦‚å¿µ | ç”Ÿæ´»åœºæ™¯ç±»æ¯” | ç›¸ä¼¼ç‚¹ |
|------------|------------|--------|
| è°ƒç”¨æ ˆ | æ€¥è¯Šå®¤ | æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ï¼Œä¸€æ¬¡ä¸€ä¸ª |
| å¾®ä»»åŠ¡é˜Ÿåˆ— | VIPä¼˜å…ˆé€šé“ | é«˜ä¼˜å…ˆçº§ï¼Œæ€¥è¯Šåç«‹å³å¤„ç† |
| å®ä»»åŠ¡é˜Ÿåˆ— | æ™®é€šæŒ‚å· | ä½ä¼˜å…ˆçº§ï¼Œæ’é˜Ÿç­‰å¾… |
| æ‰¹é‡æ›´æ–° | åˆå¹¶é…é€ | å‡å°‘æ‰§è¡Œæ¬¡æ•°ï¼Œæé«˜æ•ˆç‡ |
| æ—¶é—´åˆ‡ç‰‡ | ç©¿æ’ä¼‘æ¯ | é¿å…é•¿æ—¶é—´é˜»å¡ï¼Œä¿æŒå“åº” |

---

## å…­ã€ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼šå¾®ä»»åŠ¡æ¯”å®ä»»åŠ¡å…ˆæ‰§è¡Œ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

æ­£ç¡®çš„è¯´æ³•æ˜¯ï¼š**æ¯ä¸ªå®ä»»åŠ¡åï¼Œä¼šæ¸…ç©ºæ‰€æœ‰å¾®ä»»åŠ¡**ã€‚æ‰§è¡Œé¡ºåºæ˜¯ï¼š

```
å®ä»»åŠ¡1 â†’ æ¸…ç©ºå¾®ä»»åŠ¡ â†’ å®ä»»åŠ¡2 â†’ æ¸…ç©ºå¾®ä»»åŠ¡ â†’ ...
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

å› ä¸ºå¤§å¤šæ•°ç¤ºä¾‹ä¸­ï¼Œç¬¬ä¸€ä¸ªå®ä»»åŠ¡æ˜¯"è„šæœ¬æ‰§è¡Œ"æœ¬èº«ï¼Œçœ‹èµ·æ¥åƒæ˜¯"å¾®ä»»åŠ¡æ€»æ˜¯æœ€å…ˆæ‰§è¡Œ"ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```javascript
console.log('=== ç¤ºä¾‹1ï¼šåˆå§‹è„šæœ¬æ˜¯ç¬¬ä¸€ä¸ªå®ä»»åŠ¡ ===');

setTimeout(() => {
  console.log('å®ä»»åŠ¡2');

  Promise.resolve().then(() => {
    console.log('å®ä»»åŠ¡2ä¸­çš„å¾®ä»»åŠ¡');
  });
}, 0);

Promise.resolve().then(() => {
  console.log('å®ä»»åŠ¡1ä¸­çš„å¾®ä»»åŠ¡');
});

console.log('å®ä»»åŠ¡1ï¼ˆè„šæœ¬æ‰§è¡Œï¼‰');

// è¾“å‡ºï¼š
// å®ä»»åŠ¡1ï¼ˆè„šæœ¬æ‰§è¡Œï¼‰        <- å®ä»»åŠ¡1
// å®ä»»åŠ¡1ä¸­çš„å¾®ä»»åŠ¡           <- å®ä»»åŠ¡1åçš„å¾®ä»»åŠ¡
// å®ä»»åŠ¡2                    <- å®ä»»åŠ¡2
// å®ä»»åŠ¡2ä¸­çš„å¾®ä»»åŠ¡           <- å®ä»»åŠ¡2åçš„å¾®ä»»åŠ¡

console.log('\n=== ç¤ºä¾‹2ï¼šå¾®ä»»åŠ¡ä¸­åˆ›å»ºå®ä»»åŠ¡ ===');

Promise.resolve().then(() => {
  console.log('å¾®ä»»åŠ¡1');

  setTimeout(() => {
    console.log('å¾®ä»»åŠ¡1ä¸­åˆ›å»ºçš„å®ä»»åŠ¡');
  }, 0);
});

setTimeout(() => {
  console.log('å®ä»»åŠ¡');
}, 0);

// è¾“å‡ºï¼š
// å¾®ä»»åŠ¡1                    <- å½“å‰å®ä»»åŠ¡åçš„å¾®ä»»åŠ¡
// å®ä»»åŠ¡                     <- ä¸‹ä¸€ä¸ªå®ä»»åŠ¡
// å¾®ä»»åŠ¡1ä¸­åˆ›å»ºçš„å®ä»»åŠ¡       <- å†ä¸‹ä¸€ä¸ªå®ä»»åŠ¡
```

---

### è¯¯åŒº2ï¼šPromise.then ç«‹å³æ‰§è¡Œ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

`Promise.then` çš„å›è°ƒæ˜¯å¾®ä»»åŠ¡ï¼Œä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨å½“å‰åŒæ­¥ä»£ç æ‰§è¡Œå®Œä¹‹åæ‰æ‰§è¡Œã€‚

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

å› ä¸ºå¾®ä»»åŠ¡æ‰§è¡Œå¾—å¾ˆå¿«ï¼Œæ„Ÿè§‰åƒæ˜¯"ç«‹å³æ‰§è¡Œ"ã€‚è€Œä¸” `new Promise(executor)` ä¸­çš„ `executor` ç¡®å®æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œå®¹æ˜“æ··æ·†ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```javascript
console.log('1');

new Promise((resolve) => {
  console.log('2'); // åŒæ­¥æ‰§è¡Œ
  resolve();
}).then(() => {
  console.log('4'); // å¾®ä»»åŠ¡ï¼Œå¼‚æ­¥æ‰§è¡Œ
});

console.log('3');

// è¾“å‡ºï¼š1 â†’ 2 â†’ 3 â†’ 4

// âŒ é”™è¯¯ç†è§£ï¼šthen ç«‹å³æ‰§è¡Œï¼Œè¾“å‡ºåº”è¯¥æ˜¯ 1 â†’ 2 â†’ 4 â†’ 3
// âœ… æ­£ç¡®ç†è§£ï¼šthen æ˜¯å¾®ä»»åŠ¡ï¼Œåœ¨åŒæ­¥ä»£ç åæ‰§è¡Œ
```

**åœ¨ React ä¸­çš„å®é™…å½±å“ï¼š**

```javascript
function Component() {
  const [count, setCount] = useState(0);

  function handleClick() {
    setCount(1);
    console.log(count); // è¿˜æ˜¯ 0ï¼Œå› ä¸º setState æ˜¯å¼‚æ­¥çš„

    // React 18 çš„æ‰¹å¤„ç†æ˜¯å¾®ä»»åŠ¡
    queueMicrotask(() => {
      console.log(count); // è¿˜æ˜¯ 0ï¼å› ä¸ºè¿™æ˜¯æ—§çš„é—­åŒ…
    });

    // æ­£ç¡®åšæ³•ï¼šä½¿ç”¨ useEffect æˆ–å‡½æ•°å¼æ›´æ–°
    setCount(prev => {
      console.log(prev); // 1ï¼Œæœ€æ–°çš„å€¼
      return prev + 1;
    });
  }
}
```

---

### è¯¯åŒº3ï¼šasync/await æ˜¯å¤šçº¿ç¨‹ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

`async/await` åªæ˜¯ Promise çš„è¯­æ³•ç³–ï¼ŒJavaScript ä»ç„¶æ˜¯å•çº¿ç¨‹ã€‚`await` åé¢çš„ä»£ç ç›¸å½“äº `.then()` å›è°ƒï¼Œæ˜¯å¾®ä»»åŠ¡ã€‚

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

å› ä¸º `await` ä¼š"æš‚åœ"å‡½æ•°æ‰§è¡Œï¼Œçœ‹èµ·æ¥åƒæ˜¯å¤šçº¿ç¨‹å¹¶å‘ã€‚ä½†å®é™…ä¸Šåªæ˜¯è®©å‡ºäº†æ‰§è¡Œæƒã€‚

**æ­£ç¡®ç†è§£ï¼š**

```javascript
async function async1() {
  console.log('async1 start');      // åŒæ­¥
  await async2();                   // async2() åŒæ­¥ï¼Œawait åé¢çš„æ˜¯å¾®ä»»åŠ¡
  console.log('async1 end');        // å¾®ä»»åŠ¡
}

async function async2() {
  console.log('async2');            // åŒæ­¥
}

console.log('script start');       // åŒæ­¥

setTimeout(() => {
  console.log('setTimeout');        // å®ä»»åŠ¡
}, 0);

async1();

new Promise((resolve) => {
  console.log('promise1');          // åŒæ­¥
  resolve();
}).then(() => {
  console.log('promise2');          // å¾®ä»»åŠ¡
});

console.log('script end');         // åŒæ­¥

// è¾“å‡ºé¡ºåºï¼š
// script start
// async1 start
// async2
// promise1
// script end
// async1 end      <- await åé¢çš„ä»£ç ï¼Œç›¸å½“äº .then()
// promise2        <- å¦ä¸€ä¸ª .then()
// setTimeout
```

**ç­‰ä»·çš„ Promise å†™æ³•ï¼š**

```javascript
function async1() {
  console.log('async1 start');

  return async2().then(() => {
    console.log('async1 end');
  });
}

// await async2() ç›¸å½“äº async2().then(...)
```

**åœ¨ React ä¸­çš„åº”ç”¨ï¼š**

```javascript
function DataFetcher() {
  const [data, setData] = useState(null);

  async function fetchData() {
    console.log('1. å¼€å§‹è¯·æ±‚');

    const response = await fetch('/api/data'); // å¾®ä»»åŠ¡
    console.log('3. æ”¶åˆ°å“åº”');

    const json = await response.json();        // å¾®ä»»åŠ¡
    console.log('5. è§£æå®Œæˆ');

    setData(json);
  }

  useEffect(() => {
    fetchData();
    console.log('2. Effect åŒæ­¥ä»£ç ');
  }, []);

  console.log('4. ç»„ä»¶æ¸²æŸ“');
  return <div>{data?.name}</div>;
}

// æ‰§è¡Œé¡ºåºï¼š
// 1. å¼€å§‹è¯·æ±‚
// 2. Effect åŒæ­¥ä»£ç 
// 4. ç»„ä»¶æ¸²æŸ“
// 3. æ”¶åˆ°å“åº”ï¼ˆç½‘ç»œè¯·æ±‚è¿”å›ï¼‰
// 5. è§£æå®Œæˆ
// 4. ç»„ä»¶æ¸²æŸ“ï¼ˆsetState è§¦å‘é‡æ–°æ¸²æŸ“ï¼‰
```

---

## ä¸ƒã€ã€å®æˆ˜ä»£ç ã€‘

### åŸºç¡€å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰

```javascript
// ===== 1. åœºæ™¯1ï¼šäº‹ä»¶å¾ªç¯åŸºç¡€é¡ºåº =====
console.log("=== åœºæ™¯1ï¼šäº‹ä»¶å¾ªç¯åŸºç¡€é¡ºåº ===\n");

console.log('1. åŒæ­¥ä»£ç  start');

setTimeout(() => {
  console.log('6. å®ä»»åŠ¡ï¼šsetTimeout');
}, 0);

Promise.resolve().then(() => {
  console.log('4. å¾®ä»»åŠ¡ï¼šPromise.then');
});

queueMicrotask(() => {
  console.log('5. å¾®ä»»åŠ¡ï¼šqueueMicrotask');
});

console.log('2. åŒæ­¥ä»£ç  continue');

new Promise((resolve) => {
  console.log('3. Promise æ„é€ å‡½æ•°ï¼ˆåŒæ­¥ï¼‰');
  resolve();
});

// è¾“å‡ºé¡ºåºï¼š1 â†’ 2 â†’ 3 â†’ 4 â†’ 5 â†’ 6

// ===== 2. åœºæ™¯2ï¼šå¾®ä»»åŠ¡æ’é˜Ÿ =====
setTimeout(() => {
  console.log("\n=== åœºæ™¯2ï¼šå¾®ä»»åŠ¡æ’é˜Ÿ ===\n");

  setTimeout(() => {
    console.log('å®ä»»åŠ¡2');
  }, 0);

  Promise.resolve().then(() => {
    console.log('å¾®ä»»åŠ¡1');

    Promise.resolve().then(() => {
      console.log('å¾®ä»»åŠ¡1.1ï¼ˆæ’é˜ŸæˆåŠŸï¼‰');
    });
  });

  Promise.resolve().then(() => {
    console.log('å¾®ä»»åŠ¡2');
  });

  console.log('å®ä»»åŠ¡1');

  // è¾“å‡ºï¼š
  // å®ä»»åŠ¡1
  // å¾®ä»»åŠ¡1
  // å¾®ä»»åŠ¡2
  // å¾®ä»»åŠ¡1.1ï¼ˆæ’é˜ŸæˆåŠŸï¼‰  <- åœ¨å®ä»»åŠ¡2ä¹‹å‰
  // å®ä»»åŠ¡2
}, 1000);

// ===== 3. åœºæ™¯3ï¼šasync/await æ‰§è¡Œé¡ºåº =====
setTimeout(() => {
  console.log("\n=== åœºæ™¯3ï¼šasync/await æ‰§è¡Œé¡ºåº ===\n");

  async function async1() {
    console.log('async1 start');
    await async2();
    console.log('async1 end'); // ç›¸å½“äºå¾®ä»»åŠ¡
  }

  async function async2() {
    console.log('async2');
  }

  console.log('script start');

  setTimeout(() => {
    console.log('setTimeout');
  }, 0);

  async1();

  new Promise((resolve) => {
    console.log('promise1');
    resolve();
  }).then(() => {
    console.log('promise2');
  });

  console.log('script end');

  // è¾“å‡ºï¼š
  // script start
  // async1 start
  // async2
  // promise1
  // script end
  // async1 end
  // promise2
  // setTimeout
}, 2000);

// ===== 4. åœºæ™¯4ï¼šæ¨¡æ‹Ÿ React æ‰¹å¤„ç† =====
setTimeout(() => {
  console.log("\n=== åœºæ™¯4ï¼šæ¨¡æ‹Ÿ React æ‰¹å¤„ç† ===\n");

  let count = 0;
  let renderCount = 0;
  let updates = [];
  let isScheduled = false;

  function setState(newCount) {
    updates.push(newCount);
    console.log(`setState(${newCount}) è¢«è°ƒç”¨`);

    if (!isScheduled) {
      isScheduled = true;

      // ä½¿ç”¨å¾®ä»»åŠ¡æ‰¹é‡æ›´æ–°
      queueMicrotask(() => {
        console.log(`\næ‰¹å¤„ç†ï¼šåˆå¹¶ ${updates.length} ä¸ªæ›´æ–°`);
        count = updates[updates.length - 1]; // å–æœ€åä¸€ä¸ª
        render();
        updates = [];
        isScheduled = false;
      });
    }
  }

  function render() {
    renderCount++;
    console.log(`âœ… ç¬¬${renderCount}æ¬¡æ¸²æŸ“ï¼Œcount = ${count}\n`);
  }

  // æ¨¡æ‹Ÿç»„ä»¶ä¸­çš„æ“ä½œ
  console.log('ç”¨æˆ·ç‚¹å‡»æŒ‰é’®ï¼Œè§¦å‘å¤šæ¬¡ setStateï¼š');
  setState(1);
  setState(2);
  setState(3);
  console.log('åŒæ­¥ä»£ç ç»“æŸ\n');

  // è¾“å‡ºï¼š
  // ç”¨æˆ·ç‚¹å‡»æŒ‰é’®ï¼Œè§¦å‘å¤šæ¬¡ setStateï¼š
  // setState(1) è¢«è°ƒç”¨
  // setState(2) è¢«è°ƒç”¨
  // setState(3) è¢«è°ƒç”¨
  // åŒæ­¥ä»£ç ç»“æŸ
  //
  // æ‰¹å¤„ç†ï¼šåˆå¹¶ 3 ä¸ªæ›´æ–°
  // âœ… ç¬¬1æ¬¡æ¸²æŸ“ï¼Œcount = 3
}, 3000);

// ===== 5. åœºæ™¯5ï¼šæ—¶é—´åˆ‡ç‰‡æ¨¡æ‹Ÿ =====
setTimeout(() => {
  console.log("\n=== åœºæ™¯5ï¼šæ—¶é—´åˆ‡ç‰‡æ¨¡æ‹Ÿ ===\n");

  function performWork(totalWork) {
    let workDone = 0;

    function workLoop() {
      const startTime = performance.now();
      const timeSlice = 5; // 5ms æ—¶é—´ç‰‡
      const deadline = startTime + timeSlice;

      console.log(`â° æ—¶é—´ç‰‡å¼€å§‹ï¼š${startTime.toFixed(2)}ms`);

      // åœ¨æ—¶é—´ç‰‡å†…å·¥ä½œ
      while (workDone < totalWork && performance.now() < deadline) {
        // æ¨¡æ‹Ÿå·¥ä½œï¼ˆè®¡ç®—å¯†é›†ä»»åŠ¡ï¼‰
        let sum = 0;
        for (let i = 0; i < 100000; i++) {
          sum += i;
        }
        workDone++;
      }

      const endTime = performance.now();
      console.log(
        `âœ… å®Œæˆå·¥ä½œï¼š${workDone}/${totalWork}ï¼Œè€—æ—¶ï¼š${(endTime - startTime).toFixed(2)}ms\n`
      );

      // å¦‚æœè¿˜æœ‰å·¥ä½œï¼Œè°ƒåº¦ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡
      if (workDone < totalWork) {
        setTimeout(workLoop, 0); // ç”¨å®ä»»åŠ¡è®©å‡ºæ§åˆ¶æƒ
      } else {
        console.log('ğŸ‰ æ‰€æœ‰å·¥ä½œå®Œæˆï¼');
      }
    }

    workLoop();
  }

  performWork(3); // æ‰§è¡Œ3ä¸ªå·¥ä½œå•å…ƒ
}, 4000);
```

### è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼š

```
=== åœºæ™¯1ï¼šäº‹ä»¶å¾ªç¯åŸºç¡€é¡ºåº ===

1. åŒæ­¥ä»£ç  start
2. åŒæ­¥ä»£ç  continue
3. Promise æ„é€ å‡½æ•°ï¼ˆåŒæ­¥ï¼‰
4. å¾®ä»»åŠ¡ï¼šPromise.then
5. å¾®ä»»åŠ¡ï¼šqueueMicrotask
6. å®ä»»åŠ¡ï¼šsetTimeout

=== åœºæ™¯2ï¼šå¾®ä»»åŠ¡æ’é˜Ÿ ===

å®ä»»åŠ¡1
å¾®ä»»åŠ¡1
å¾®ä»»åŠ¡2
å¾®ä»»åŠ¡1.1ï¼ˆæ’é˜ŸæˆåŠŸï¼‰
å®ä»»åŠ¡2

=== åœºæ™¯3ï¼šasync/await æ‰§è¡Œé¡ºåº ===

script start
async1 start
async2
promise1
script end
async1 end
promise2
setTimeout

=== åœºæ™¯4ï¼šæ¨¡æ‹Ÿ React æ‰¹å¤„ç† ===

ç”¨æˆ·ç‚¹å‡»æŒ‰é’®ï¼Œè§¦å‘å¤šæ¬¡ setStateï¼š
setState(1) è¢«è°ƒç”¨
setState(2) è¢«è°ƒç”¨
setState(3) è¢«è°ƒç”¨
åŒæ­¥ä»£ç ç»“æŸ

æ‰¹å¤„ç†ï¼šåˆå¹¶ 3 ä¸ªæ›´æ–°
âœ… ç¬¬1æ¬¡æ¸²æŸ“ï¼Œcount = 3

=== åœºæ™¯5ï¼šæ—¶é—´åˆ‡ç‰‡æ¨¡æ‹Ÿ ===

â° æ—¶é—´ç‰‡å¼€å§‹ï¼š104.50ms
âœ… å®Œæˆå·¥ä½œï¼š1/3ï¼Œè€—æ—¶ï¼š2.30ms

â° æ—¶é—´ç‰‡å¼€å§‹ï¼š109.80ms
âœ… å®Œæˆå·¥ä½œï¼š2/3ï¼Œè€—æ—¶ï¼š2.10ms

â° æ—¶é—´ç‰‡å¼€å§‹ï¼š115.20ms
âœ… å®Œæˆå·¥ä½œï¼š3/3ï¼Œè€—æ—¶ï¼š2.20ms

ğŸ‰ æ‰€æœ‰å·¥ä½œå®Œæˆï¼
```

---

### è¿›é˜¶ï¼šReact æºç å®ç°

```javascript
// packages/react-reconciler/src/ReactFiberWorkLoop.jsï¼ˆç®€åŒ–ç‰ˆï¼‰

// ===== 1. Scheduler ä½¿ç”¨ MessageChannel =====

const channel = new MessageChannel();
const port = channel.port2;

channel.port1.onmessage = performWorkUntilDeadline;

let scheduledCallback = null;
let startTime = -1;

function scheduleCallback(callback) {
  scheduledCallback = callback;
  port.postMessage(null); // è§¦å‘å®ä»»åŠ¡
}

function performWorkUntilDeadline() {
  if (scheduledCallback !== null) {
    startTime = performance.now();
    const hasTimeRemaining = true;
    const hasMoreWork = scheduledCallback(hasTimeRemaining, startTime);

    if (hasMoreWork) {
      // è¿˜æœ‰å·¥ä½œï¼Œè°ƒåº¦ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡
      port.postMessage(null);
    } else {
      scheduledCallback = null;
    }
  }
}

// ===== 2. å·¥ä½œå¾ªç¯ =====

let workInProgress = null;
const frameYieldMs = 5; // 5ms å¸§æ—¶é—´

function workLoopConcurrent() {
  // åœ¨æ—¶é—´ç‰‡å†…å¾ªç¯å·¥ä½œ
  while (workInProgress !== null && !shouldYield()) {
    performUnitOfWork(workInProgress);
  }
}

function shouldYield() {
  // æ£€æŸ¥æ˜¯å¦åº”è¯¥è®©å‡ºæ§åˆ¶æƒ
  const currentTime = performance.now();
  return currentTime >= startTime + frameYieldMs;
}

function performUnitOfWork(unitOfWork) {
  // æ‰§è¡Œä¸€ä¸ªå·¥ä½œå•å…ƒ
  const next = beginWork(unitOfWork);

  if (next === null) {
    // æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œå®Œæˆè¿™ä¸ªå•å…ƒ
    completeUnitOfWork(unitOfWork);
  } else {
    // æœ‰å­èŠ‚ç‚¹ï¼Œç»§ç»­å‘ä¸‹
    workInProgress = next;
  }
}

// ===== 3. React 18 æ‰¹å¤„ç†ï¼ˆä½¿ç”¨å¾®ä»»åŠ¡ï¼‰ =====

let isBatchingUpdates = false;
const pendingUpdates = [];

function dispatchAction(fiber, queue, action) {
  const update = {
    action,
    next: null,
  };

  // åŠ å…¥æ›´æ–°é˜Ÿåˆ—
  enqueueUpdate(queue, update);

  if (!isBatchingUpdates) {
    isBatchingUpdates = true;

    // React 18ï¼šä½¿ç”¨å¾®ä»»åŠ¡æ‰¹å¤„ç†
    queueMicrotask(() => {
      flushSyncCallbacks();
      isBatchingUpdates = false;
    });
  }
}

function flushSyncCallbacks() {
  // æ‰¹é‡å¤„ç†æ‰€æœ‰æ›´æ–°
  for (const update of pendingUpdates) {
    processUpdate(update);
  }
  pendingUpdates.length = 0;
}

// ===== 4. useEffect çš„æ‰§è¡Œæ—¶æœº =====

let pendingPassiveEffects = [];

function commitRoot(root) {
  // 1. åŒæ­¥æ‰§è¡Œ DOM æ“ä½œ
  commitMutationEffects(root);

  // 2. è°ƒåº¦ useEffectï¼ˆè¢«åŠ¨å‰¯ä½œç”¨ï¼‰
  schedulePassiveEffects();
}

function schedulePassiveEffects() {
  // useEffect ä½¿ç”¨å®ä»»åŠ¡å»¶è¿Ÿæ‰§è¡Œ
  scheduleCallback(() => {
    flushPassiveEffects();
  });
}

function flushPassiveEffects() {
  // å…ˆæ‰§è¡Œæ¸…ç†å‡½æ•°
  for (const effect of pendingPassiveEffects) {
    if (effect.destroy) {
      effect.destroy();
    }
  }

  // å†æ‰§è¡Œå‰¯ä½œç”¨
  for (const effect of pendingPassiveEffects) {
    effect.create();
  }

  pendingPassiveEffects = [];
}
```

**React äº‹ä»¶å¾ªç¯çš„ä¸‰ä¸ªå…³é”®åº”ç”¨ï¼š**

1. **æ—¶é—´åˆ‡ç‰‡ï¼ˆConcurrent Modeï¼‰**ï¼šä½¿ç”¨ MessageChannel åˆ›å»ºå®ä»»åŠ¡ï¼Œæ¯ 5ms ä¸€ä¸ªæ—¶é—´ç‰‡ï¼Œå¯ä¸­æ–­

2. **æ‰¹é‡æ›´æ–°ï¼ˆAuto Batchingï¼‰**ï¼šä½¿ç”¨ queueMicrotask åˆå¹¶å¤šä¸ª setStateï¼Œå‡å°‘æ¸²æŸ“æ¬¡æ•°

3. **å‰¯ä½œç”¨è°ƒåº¦ï¼ˆuseEffectï¼‰**ï¼šä½¿ç”¨å®ä»»åŠ¡å»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…é˜»å¡æµè§ˆå™¨ç»˜åˆ¶

---

## å…«ã€ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜1ï¼š"è¯·æè¿° JavaScript äº‹ä»¶å¾ªç¯çš„æ‰§è¡Œæœºåˆ¶"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"äº‹ä»¶å¾ªç¯å°±æ˜¯å…ˆæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œå†æ‰§è¡Œå¾®ä»»åŠ¡ï¼Œæœ€åæ‰§è¡Œå®ä»»åŠ¡ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **äº‹ä»¶å¾ªç¯æ˜¯ JavaScript å®ç°å¼‚æ­¥çš„æ ¸å¿ƒæœºåˆ¶ï¼ŒåŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š**
>
> 1. **è°ƒç”¨æ ˆï¼ˆCall Stackï¼‰**ï¼šå­˜æ”¾æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°ï¼Œåè¿›å…ˆå‡ºï¼ˆLIFOï¼‰
>
> 2. **ä»»åŠ¡é˜Ÿåˆ—**ï¼šåˆ†ä¸ºä¸¤ç§
>    - **å¾®ä»»åŠ¡é˜Ÿåˆ—**ï¼šPromise.thenã€queueMicrotaskã€MutationObserverï¼Œä¼˜å…ˆçº§é«˜
>    - **å®ä»»åŠ¡é˜Ÿåˆ—**ï¼šsetTimeoutã€setIntervalã€I/Oã€UIæ¸²æŸ“ï¼Œä¼˜å…ˆçº§ä½
>
> 3. **æ‰§è¡Œæµç¨‹**ï¼š
>    ```
>    æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ï¼ˆscript è„šæœ¬ï¼‰
>    â†“
>    æ‰§è¡Œæ‰€æœ‰å¾®ä»»åŠ¡ï¼ˆæ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼‰
>    â†“
>    æ¸²æŸ“æ›´æ–°ï¼ˆå¦‚æœéœ€è¦ï¼‰
>    â†“
>    æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡
>    â†“
>    é‡å¤...
>    ```
>
> **å…³é”®ç‰¹æ€§**ï¼š
> - å¾®ä»»åŠ¡å¯ä»¥æ’é˜Ÿï¼šå¾®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–°å¾®ä»»åŠ¡ä¼šç«‹å³åŠ å…¥é˜Ÿåˆ—
> - å®ä»»åŠ¡ä¸å¯æ’é˜Ÿï¼šæ¯æ¬¡åªæ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡
> - æ¸²æŸ“æ—¶æœºï¼šæµè§ˆå™¨ä¼šåœ¨å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ä¹‹é—´è¿›è¡Œæ¸²æŸ“
>
> **åœ¨ React ä¸­çš„åº”ç”¨**ï¼š
> - React 18 ä½¿ç”¨ queueMicrotask å®ç°è‡ªåŠ¨æ‰¹å¤„ç†
> - Scheduler ä½¿ç”¨ MessageChannel å®ç°æ—¶é—´åˆ‡ç‰‡
> - useEffect åœ¨å®ä»»åŠ¡ä¸­å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡æ¸²æŸ“

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**

1. âœ… **ç»“æ„æ¸…æ™°**ï¼šåˆ†å±‚è§£é‡Šäº†è°ƒç”¨æ ˆã€ä»»åŠ¡é˜Ÿåˆ—ã€æ‰§è¡Œæµç¨‹
2. âœ… **æœ‰å¯è§†åŒ–**ï¼šç”¨æµç¨‹å›¾å±•ç¤ºæ‰§è¡Œé¡ºåº
3. âœ… **æ·±å…¥åŸç†**ï¼šæåˆ°äº†æ¸²æŸ“æ—¶æœºã€æ’é˜Ÿæœºåˆ¶
4. âœ… **è”ç³»å®è·µ**ï¼šç»“åˆ React çš„å…·ä½“åº”ç”¨

---

### é—®é¢˜2ï¼š"ä¸ºä»€ä¹ˆ React 18 ä½¿ç”¨å¾®ä»»åŠ¡æ¥æ‰¹é‡æ›´æ–°ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"å› ä¸ºå¾®ä»»åŠ¡æ¯”å®ä»»åŠ¡å¿«ï¼Œå¯ä»¥æé«˜æ€§èƒ½ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **React 18 é€‰æ‹©å¾®ä»»åŠ¡æ‰¹å¤„ç†æ˜¯ç»è¿‡æ·±æ€ç†Ÿè™‘çš„è®¾è®¡ï¼š**
>
> 1. **é—®é¢˜èƒŒæ™¯**ï¼šReact 17 åªåœ¨äº‹ä»¶å¤„ç†å™¨ä¸­æ‰¹å¤„ç†ï¼Œåœ¨ setTimeoutã€Promise ç­‰å¼‚æ­¥ä»£ç ä¸­ä¸æ‰¹å¤„ç†ï¼Œå¯¼è‡´ï¼š
>    ```javascript
>    // React 17
>    setTimeout(() => {
>      setCount(1); // æ¸²æŸ“ä¸€æ¬¡
>      setName('A'); // åˆæ¸²æŸ“ä¸€æ¬¡
>    }, 0);
>    ```
>
> 2. **å¾®ä»»åŠ¡çš„ä¼˜åŠ¿**ï¼š
>    - **æ‰§è¡Œæ—¶æœºæ°å½“**ï¼šåœ¨å½“å‰å®ä»»åŠ¡ç»“æŸåã€ä¸‹ä¸€æ¬¡æ¸²æŸ“å‰æ‰§è¡Œ
>    - **è‡ªåŠ¨åˆå¹¶**ï¼šåŒä¸€ä¸ªå®ä»»åŠ¡ä¸­çš„å¤šä¸ª setState ä¼šåœ¨å¾®ä»»åŠ¡ä¸­åˆå¹¶
>    - **ä¸ä¼šå¤ªæ™š**ï¼šæ¯”å®ä»»åŠ¡æ›´æ—©æ‰§è¡Œï¼Œç”¨æˆ·æ„ŸçŸ¥ä¸åˆ°å»¶è¿Ÿ
>
> 3. **å®ç°åŸç†**ï¼š
>    ```javascript
>    let isBatching = false;
>    const updates = [];
>
>    function setState(newState) {
>      updates.push(newState);
>
>      if (!isBatching) {
>        isBatching = true;
>        queueMicrotask(() => {
>          // åˆå¹¶æ‰€æœ‰æ›´æ–°ï¼Œåªæ¸²æŸ“ä¸€æ¬¡
>          render(updates);
>          updates.length = 0;
>          isBatching = false;
>        });
>      }
>    }
>    ```
>
> 4. **ä¸ºä»€ä¹ˆä¸ç”¨å®ä»»åŠ¡**ï¼š
>    - å®ä»»åŠ¡å»¶è¿Ÿå¤ªé«˜ï¼ˆè‡³å°‘4msï¼‰
>    - å¯èƒ½é”™è¿‡ä¸€å¸§ï¼Œå¯¼è‡´å¡é¡¿
>    - å¾®ä»»åŠ¡ä¼˜å…ˆçº§æ›´é«˜ï¼Œå“åº”æ›´å¿«
>
> **ç»“æœ**ï¼šReact 18 å®ç°äº†çœŸæ­£çš„"è‡ªåŠ¨æ‰¹å¤„ç†"ï¼Œæ— è®ºåœ¨å“ªé‡Œè°ƒç”¨ setStateï¼Œéƒ½ä¼šè‡ªåŠ¨åˆå¹¶æ›´æ–°ã€‚

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**

1. âœ… **å¯¹æ¯”åˆ†æ**ï¼šè¯´æ˜äº† React 17 çš„é—®é¢˜
2. âœ… **å¤šç»´åº¦è§£é‡Š**ï¼šä»æ‰§è¡Œæ—¶æœºã€æ€§èƒ½ã€ç”¨æˆ·ä½“éªŒå¤šè§’åº¦åˆ†æ
3. âœ… **ä»£ç ç¤ºä¾‹**ï¼šç”¨ç®€åŒ–ä»£ç å±•ç¤ºå®ç°åŸç†
4. âœ… **æ·±åº¦æ€è€ƒ**ï¼šè§£é‡Šäº†"ä¸ºä»€ä¹ˆä¸ç”¨å…¶ä»–æ–¹æ¡ˆ"

---

## ä¹ã€ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šäº‹ä»¶å¾ªç¯æ˜¯ä»€ä¹ˆ ğŸ¯

**ä¸€å¥è¯ï¼š** äº‹ä»¶å¾ªç¯æ˜¯ JavaScript å¤„ç†å¼‚æ­¥æ“ä½œçš„æœºåˆ¶ï¼Œé€šè¿‡ä¸æ–­å¾ªç¯æ£€æŸ¥ä»»åŠ¡é˜Ÿåˆ—æ¥è°ƒåº¦ä»»åŠ¡æ‰§è¡Œã€‚

**ä¸¾ä¾‹ï¼š**

```javascript
while (true) {
  task = taskQueue.pop();
  execute(task);

  while (microtaskQueue.notEmpty()) {
    microtask = microtaskQueue.pop();
    execute(microtask);
  }
}
```

**åº”ç”¨ï¼š** React çš„ Scheduler åŸºäºäº‹ä»¶å¾ªç¯å®ç°ä»»åŠ¡è°ƒåº¦å’Œä¼˜å…ˆçº§ç®¡ç†ã€‚

---

### å¡ç‰‡2ï¼šè°ƒç”¨æ ˆ ğŸ“š

**ä¸€å¥è¯ï¼š** è°ƒç”¨æ ˆå­˜æ”¾æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°ï¼Œé‡‡ç”¨åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰çš„æ•°æ®ç»“æ„ã€‚

**ä¸¾ä¾‹ï¼š**

```javascript
function a() {
  b();
}
function b() {
  c();
}
function c() {
  console.log('æ ˆæ·±åº¦ä¸º3');
}
a(); // æ ˆï¼š[a, b, c]
```

**åº”ç”¨ï¼š** React Fiber ä¹‹å‰çš„é€’å½’ç®—æ³•ä¼šå¯¼è‡´æ·±å±‚åµŒå¥—æ—¶æ ˆæº¢å‡ºï¼ŒFiber ç”¨é“¾è¡¨è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚

---

### å¡ç‰‡3ï¼šå®ä»»åŠ¡ ğŸ¢

**ä¸€å¥è¯ï¼š** å®ä»»åŠ¡æ˜¯äº‹ä»¶å¾ªç¯çš„åŸºæœ¬å•ä½ï¼Œæ¯æ¬¡å¾ªç¯æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ã€‚

**å¸¸è§å®ä»»åŠ¡ï¼š** setTimeoutã€setIntervalã€MessageChannelã€I/Oã€UIæ¸²æŸ“

**ä¸¾ä¾‹ï¼š**

```javascript
setTimeout(() => {
  console.log('å®ä»»åŠ¡1');
}, 0);

setTimeout(() => {
  console.log('å®ä»»åŠ¡2');
}, 0);
// ä¸¤ä¸ªå®ä»»åŠ¡ä¾æ¬¡æ‰§è¡Œ
```

**åº”ç”¨ï¼š** React Scheduler ç”¨ MessageChannel åˆ›å»ºå®ä»»åŠ¡å®ç°æ—¶é—´åˆ‡ç‰‡ã€‚

---

### å¡ç‰‡4ï¼šå¾®ä»»åŠ¡ âš¡

**ä¸€å¥è¯ï¼š** å¾®ä»»åŠ¡ä¼˜å…ˆçº§é«˜äºå®ä»»åŠ¡ï¼Œåœ¨æ¯ä¸ªå®ä»»åŠ¡åç«‹å³æ‰§è¡Œï¼Œä¼šæ¸…ç©ºæ•´ä¸ªé˜Ÿåˆ—ã€‚

**å¸¸è§å¾®ä»»åŠ¡ï¼š** Promise.thenã€queueMicrotaskã€MutationObserver

**ä¸¾ä¾‹ï¼š**

```javascript
Promise.resolve().then(() => {
  console.log('å¾®ä»»åŠ¡');
});

setTimeout(() => {
  console.log('å®ä»»åŠ¡');
}, 0);
// å¾®ä»»åŠ¡å…ˆæ‰§è¡Œ
```

**åº”ç”¨ï¼š** React 18 ç”¨ queueMicrotask å®ç°è‡ªåŠ¨æ‰¹å¤„ç†ã€‚

---

### å¡ç‰‡5ï¼šæ‰§è¡Œé¡ºåº ğŸ”„

**ä¸€å¥è¯ï¼š** åŒæ­¥ä»£ç  â†’ å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆæ¸…ç©ºï¼‰ â†’ å®ä»»åŠ¡ï¼ˆä¸€ä¸ªï¼‰ â†’ é‡å¤

**ä¸¾ä¾‹ï¼š**

```javascript
console.log('åŒæ­¥'); // 1
Promise.resolve().then(() => console.log('å¾®ä»»åŠ¡')); // 3
setTimeout(() => console.log('å®ä»»åŠ¡'), 0); // 4
console.log('åŒæ­¥'); // 2
```

**åº”ç”¨ï¼š** ç†è§£ useEffect ä¸ºä»€ä¹ˆåœ¨æ¸²æŸ“åæ‰§è¡Œï¼Œè€Œ useLayoutEffect åœ¨æ¸²æŸ“å‰æ‰§è¡Œã€‚

---

### å¡ç‰‡6ï¼šå¾®ä»»åŠ¡æ’é˜Ÿ ğŸš€

**ä¸€å¥è¯ï¼š** å¾®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–°å¾®ä»»åŠ¡ä¼šç«‹å³åŠ å…¥é˜Ÿåˆ—ï¼Œåœ¨å½“å‰è½®æ¬¡æ¸…ç©ºã€‚

**ä¸¾ä¾‹ï¼š**

```javascript
Promise.resolve().then(() => {
  console.log('å¾®ä»»åŠ¡1');
  Promise.resolve().then(() => {
    console.log('å¾®ä»»åŠ¡1.1'); // æ’é˜ŸæˆåŠŸ
  });
});

setTimeout(() => console.log('å®ä»»åŠ¡'), 0);
// å¾®ä»»åŠ¡1 â†’ å¾®ä»»åŠ¡1.1 â†’ å®ä»»åŠ¡
```

**åº”ç”¨ï¼š** React æ‰¹å¤„ç†è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–°æ›´æ–°ä¼šåœ¨åŒä¸€æ‰¹æ¬¡å¤„ç†ã€‚

---

### å¡ç‰‡7ï¼šæ—¶é—´åˆ‡ç‰‡ â±ï¸

**ä¸€å¥è¯ï¼š** åˆ©ç”¨å®ä»»åŠ¡çš„é—´éš™è®©å‡ºæ§åˆ¶æƒï¼Œé¿å…é•¿æ—¶é—´é˜»å¡ä¸»çº¿ç¨‹ã€‚

**ä¸¾ä¾‹ï¼š**

```javascript
function work() {
  const deadline = performance.now() + 5;
  while (hasWork() && performance.now() < deadline) {
    doWork();
  }
  if (hasWork()) {
    setTimeout(work, 0); // è®©å‡ºæ§åˆ¶æƒ
  }
}
```

**åº”ç”¨ï¼š** React Concurrent Mode ç”¨æ—¶é—´åˆ‡ç‰‡å®ç°å¯ä¸­æ–­æ¸²æŸ“ã€‚

---

### å¡ç‰‡8ï¼šPromise æ‰§è¡Œæ—¶æœº ğŸ”–

**ä¸€å¥è¯ï¼š** Promise æ„é€ å‡½æ•°æ˜¯åŒæ­¥çš„ï¼Œ.then å›è°ƒæ˜¯å¾®ä»»åŠ¡ã€‚

**ä¸¾ä¾‹ï¼š**

```javascript
new Promise(resolve => {
  console.log('åŒæ­¥'); // ç«‹å³æ‰§è¡Œ
  resolve();
}).then(() => {
  console.log('å¾®ä»»åŠ¡'); // å¼‚æ­¥æ‰§è¡Œ
});
```

**åº”ç”¨ï¼š** åœ¨ React ä¸­ fetch æ•°æ®æ—¶ï¼Œè¦ç†è§£ä½•æ—¶è§¦å‘é‡æ–°æ¸²æŸ“ã€‚

---

### å¡ç‰‡9ï¼šasync/await æœ¬è´¨ ğŸ­

**ä¸€å¥è¯ï¼š** async/await æ˜¯ Promise çš„è¯­æ³•ç³–ï¼Œawait åé¢çš„ä»£ç ç›¸å½“äº .then å›è°ƒã€‚

**ä¸¾ä¾‹ï¼š**

```javascript
async function foo() {
  await bar();
  console.log('åé¢çš„ä»£ç '); // ç­‰ä»·äº .then
}

// ç­‰ä»·äº
function foo() {
  return bar().then(() => {
    console.log('åé¢çš„ä»£ç ');
  });
}
```

**åº”ç”¨ï¼š** useEffect ä¸­çš„ async å‡½æ•°è¦æ³¨æ„æ¸…ç†ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚

---

### å¡ç‰‡10ï¼šReact æ‰¹å¤„ç† ğŸ“

**ä¸€å¥è¯ï¼š** React 18 ä½¿ç”¨å¾®ä»»åŠ¡è‡ªåŠ¨æ‰¹é‡å¤„ç†æ‰€æœ‰ setStateï¼Œå‡å°‘æ¸²æŸ“æ¬¡æ•°ã€‚

**å…³é”®æŠ€å·§ï¼š**
- âœ… å¾®ä»»åŠ¡åœ¨å½“å‰ä»»åŠ¡ç»“æŸåç«‹å³æ‰§è¡Œ
- âœ… åŒä¸€ä»»åŠ¡ä¸­çš„å¤šä¸ª setState ä¼šåˆå¹¶
- âœ… ä»»ä½•åœ°æ–¹ï¼ˆsetTimeoutã€Promiseï¼‰éƒ½ä¼šæ‰¹å¤„ç†
- âœ… å¦‚éœ€ç«‹å³åŒæ­¥æ›´æ–°ï¼Œä½¿ç”¨ flushSync

**ä¸¾ä¾‹ï¼š**

```javascript
setTimeout(() => {
  setCount(1);
  setCount(2); // åªæ¸²æŸ“ä¸€æ¬¡ï¼ˆReact 18ï¼‰
}, 0);
```

**åº”ç”¨ï¼š** æ€§èƒ½ä¼˜åŒ–ä¸å†éœ€è¦æ‰‹åŠ¨åˆå¹¶ setStateã€‚

---

## åã€ã€ä¸€å¥è¯æ€»ç»“ã€‘

**äº‹ä»¶å¾ªç¯é€šè¿‡è°ƒç”¨æ ˆã€å¾®ä»»åŠ¡é˜Ÿåˆ—å’Œå®ä»»åŠ¡é˜Ÿåˆ—åè°ƒå¼‚æ­¥æ“ä½œï¼Œåœ¨ React ä¸­æ”¯æ’‘ Scheduler çš„æ—¶é—´åˆ‡ç‰‡ã€Effect çš„æ‰§è¡Œæ—¶æœºå’Œæ‰¹é‡æ›´æ–°æœºåˆ¶ï¼Œæ˜¯ç†è§£ React å¼‚æ­¥æ¸²æŸ“å’Œå¹¶å‘ç‰¹æ€§çš„åŸºç¡€ã€‚**

---

## âœ… å­¦ä¹ æ£€æŸ¥æ¸…å•

### åŸºç¡€ç†è§£
- [ ] èƒ½è§£é‡Šäº‹ä»¶å¾ªç¯çš„æ¦‚å¿µ
- [ ] ç†è§£è°ƒç”¨æ ˆçš„ LIFO ç‰¹æ€§
- [ ] åŒºåˆ†å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡
- [ ] çŸ¥é“æ‰§è¡Œé¡ºåºï¼šåŒæ­¥ â†’ å¾®ä»»åŠ¡ â†’ å®ä»»åŠ¡

### ä»»åŠ¡ç±»å‹
- [ ] èƒ½åˆ—ä¸¾å¸¸è§çš„å®ä»»åŠ¡
- [ ] èƒ½åˆ—ä¸¾å¸¸è§çš„å¾®ä»»åŠ¡
- [ ] ç†è§£ Promise çš„æ‰§è¡Œæ—¶æœº
- [ ] ç†è§£ async/await çš„æœ¬è´¨

### React åº”ç”¨
- [ ] ç†è§£ React 18 çš„æ‰¹å¤„ç†æœºåˆ¶
- [ ] çŸ¥é“ useEffect ä½•æ—¶æ‰§è¡Œ
- [ ] ç†è§£æ—¶é—´åˆ‡ç‰‡çš„åŸç†
- [ ] äº†è§£ MessageChannel çš„ä½œç”¨

### è¿›é˜¶çŸ¥è¯†
- [ ] ç†è§£å¾®ä»»åŠ¡æ’é˜Ÿæœºåˆ¶
- [ ] çŸ¥é“æ¸²æŸ“æ—¶æœº
- [ ] äº†è§£ Scheduler çš„å®ç°
- [ ] èƒ½è¯»æ‡‚ React äº‹ä»¶å¾ªç¯æºç 

---

## ğŸ“š ä¸‹ä¸€æ­¥å­¦ä¹ 

æŒæ¡äº‹ä»¶å¾ªç¯åï¼Œå»ºè®®å­¦ä¹ ï¼š

1. **Object.is æ¯”è¾ƒç­–ç•¥** - ç†è§£ React ä¾èµ–æ¯”è¾ƒçš„åŸºç¡€
2. **Scheduler è°ƒåº¦å™¨** - æ·±å…¥ React çš„ä»»åŠ¡è°ƒåº¦æœºåˆ¶
3. **Fiber æ¶æ„** - ç†è§£å¯ä¸­æ–­æ¸²æŸ“çš„å®ç°
4. **Concurrent Mode** - React 18 çš„å¹¶å‘ç‰¹æ€§

---

## ğŸ”— å‚è€ƒèµ„æº

- [MDN - Event Loop](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/EventLoop)
- [Jake Archibald - Tasks, microtasks, queues and schedules](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)
- [React æºç  - Scheduler](https://github.com/facebook/react/tree/main/packages/scheduler)
- [React 18 - Automatic Batching](https://react.dev/blog/2022/03/29/react-v18#new-feature-automatic-batching)

---

**ğŸ¯ è®°ä½ï¼šäº‹ä»¶å¾ªç¯ä¸æ˜¯å¤šçº¿ç¨‹ï¼Œè€Œæ˜¯å•çº¿ç¨‹çš„ä»»åŠ¡è°ƒåº¦æœºåˆ¶ï¼**
