# åŒå‘é“¾è¡¨æ“ä½œ

## 1. ã€30å­—æ ¸å¿ƒã€‘

**åŒå‘é“¾è¡¨æ˜¯æ¯ä¸ªèŠ‚ç‚¹é€šè¿‡ prev/next åŒæŒ‡é’ˆè¿æ¥å‰åèŠ‚ç‚¹çš„æ•°æ®ç»“æ„ï¼Œæ”¯æŒåŒå‘éå†ï¼Œæ˜¯ React Fiber å’Œ Hooks é“¾è¡¨çš„æ ¸å¿ƒå®ç°ã€‚**

---

## 2. ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### åŒå‘é“¾è¡¨çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**åŒå‘é“¾è¡¨ = æ¯ä¸ªèŠ‚ç‚¹è®°å½•å‰åä¸¤ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆ**

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

#### 2. ä¸ºä»€ä¹ˆéœ€è¦åŒå‘é“¾è¡¨ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•é«˜æ•ˆåœ°åœ¨ä»»æ„ä½ç½®æ’å…¥/åˆ é™¤èŠ‚ç‚¹ï¼ŒåŒæ—¶æ”¯æŒåŒå‘éå†ï¼Ÿ**

**æ•°ç»„çš„å±€é™ï¼š**
- æ’å…¥/åˆ é™¤ï¼šéœ€è¦ç§»åŠ¨å…ƒç´ ï¼Œæ—¶é—´å¤æ‚åº¦ O(n)
- åªèƒ½ä»å¤´/å°¾éå†ï¼Œä¸èƒ½å¿«é€Ÿè®¿é—®å‰ä¸€ä¸ªå…ƒç´ 

**å•å‘é“¾è¡¨çš„å±€é™ï¼š**
- åªèƒ½å•å‘éå†ï¼ˆåªæœ‰ next æŒ‡é’ˆï¼‰
- åˆ é™¤èŠ‚ç‚¹éœ€è¦çŸ¥é“å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆéœ€è¦éå†æ‰¾åˆ°ï¼‰

**åŒå‘é“¾è¡¨çš„ä¼˜åŠ¿ï¼š**
- æ’å…¥/åˆ é™¤ï¼šåªéœ€ä¿®æ”¹æŒ‡é’ˆï¼Œæ—¶é—´å¤æ‚åº¦ O(1)
- åŒå‘éå†ï¼šæ—¢å¯ä»¥å‘å‰ï¼ˆprevï¼‰ä¹Ÿå¯ä»¥å‘åï¼ˆnextï¼‰
- åˆ é™¤èŠ‚ç‚¹ï¼šæ— éœ€éå†ï¼Œç›´æ¥é€šè¿‡ prev æŒ‡é’ˆè®¿é—®å‰ä¸€ä¸ªèŠ‚ç‚¹

#### 3. åŒå‘é“¾è¡¨çš„ä¸‰å±‚ä»·å€¼

##### ä»·å€¼1ï¼šO(1) æ—¶é—´å¤æ‚åº¦çš„æ’å…¥/åˆ é™¤

åœ¨å·²çŸ¥èŠ‚ç‚¹ä½ç½®çš„æƒ…å†µä¸‹ï¼Œæ’å…¥/åˆ é™¤åªéœ€ä¿®æ”¹ 2-4 ä¸ªæŒ‡é’ˆã€‚

**ç¤ºä¾‹ï¼š**
```javascript
// åœ¨ node åæ’å…¥ newNode
function insertAfter(node, newNode) {
  newNode.next = node.next;  // 1. newNode.next æŒ‡å‘åç»§
  newNode.prev = node;       // 2. newNode.prev æŒ‡å‘å‰é©±

  if (node.next) {
    node.next.prev = newNode; // 3. åç»§çš„ prev æŒ‡å‘ newNode
  }

  node.next = newNode;       // 4. å‰é©±çš„ next æŒ‡å‘ newNode
}
// æ—¶é—´å¤æ‚åº¦ï¼šO(1)
```

##### ä»·å€¼2ï¼šåŒå‘éå†çš„çµæ´»æ€§

å¯ä»¥ä»ä»»æ„èŠ‚ç‚¹å‘å‰æˆ–å‘åéå†ï¼Œé€‚åˆ"å›æº¯"åœºæ™¯ã€‚

**ç¤ºä¾‹ï¼š**
```javascript
// å‘å‰éå†åˆ°å¤´èŠ‚ç‚¹
function traverseBackward(node) {
  while (node.prev !== null) {
    node = node.prev;
  }
  return node;  // è¿”å›å¤´èŠ‚ç‚¹
}

// å‘åéå†åˆ°å°¾èŠ‚ç‚¹
function traverseForward(node) {
  while (node.next !== null) {
    node = node.next;
  }
  return node;  // è¿”å›å°¾èŠ‚ç‚¹
}
```

##### ä»·å€¼3ï¼šæ”¯æŒå¤æ‚çš„é“¾è¡¨æ“ä½œ

åŒæŒ‡é’ˆè®©å¾ˆå¤šå¤æ‚æ“ä½œå˜å¾—ç®€å•ï¼š
- å¿«é€Ÿåˆ é™¤èŠ‚ç‚¹ï¼ˆæ— éœ€éå†æ‰¾å‰é©±ï¼‰
- é“¾è¡¨åè½¬ï¼ˆäº¤æ¢ prev å’Œ nextï¼‰
- åŒºé—´ç§»é™¤/æ‹¼æ¥ï¼ˆä¿®æ”¹è¾¹ç•ŒæŒ‡é’ˆï¼‰

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼ React å®ç°

**æ¨ç†é“¾ï¼š**
```
1. React éœ€è¦ç®¡ç† Fiber æ ‘ï¼Œæ¯ä¸ª Fiber æ˜¯ä¸€ä¸ªèŠ‚ç‚¹
   â†“
2. Fiber éœ€è¦çŸ¥é“çˆ¶èŠ‚ç‚¹ï¼ˆreturnï¼‰ã€å­èŠ‚ç‚¹ï¼ˆchildï¼‰ã€å…„å¼ŸèŠ‚ç‚¹ï¼ˆsiblingï¼‰
   â†“
3. è¿™æœ¬è´¨æ˜¯ä¸€ä¸ª"ä¸‰æŒ‡é’ˆ"ç»“æ„ï¼Œå…¶ä¸­ sibling å½¢æˆå•å‘é“¾è¡¨
   â†“
4. ä½†æœ‰äº›åœºæ™¯éœ€è¦åŒå‘éå†ï¼ˆå¦‚ Effect é“¾è¡¨ï¼‰
   â†“
5. Effect é“¾è¡¨ä½¿ç”¨ firstEffect/lastEffect/nextEffect å®ç°åŒå‘é“¾è¡¨
   â†“
6. Hooks é“¾è¡¨ä¹Ÿæ˜¯å•å‘çš„ï¼Œä½†é€šè¿‡ baseQueue/pending å½¢æˆç¯å½¢é“¾è¡¨
   â†“
7. åŒå‘é“¾è¡¨çš„æ ¸å¿ƒæ€æƒ³ï¼ˆåŒæŒ‡é’ˆï¼‰è´¯ç©¿ React çš„æ•°æ®ç»“æ„è®¾è®¡
```

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**åŒå‘é“¾è¡¨é€šè¿‡ prev/next åŒæŒ‡é’ˆè¿æ¥èŠ‚ç‚¹ï¼Œå®ç° O(1) æ’å…¥/åˆ é™¤å’ŒåŒå‘éå†ï¼Œæ˜¯ React Fiberã€Hooksã€Effect é“¾è¡¨çš„åŸºç¡€æ•°æ®ç»“æ„ã€‚**

---

## 3. ã€3ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šèŠ‚ç‚¹ç»“æ„ï¼ˆprev + next åŒæŒ‡é’ˆï¼‰ ğŸ”—

**æ¯ä¸ªèŠ‚ç‚¹åŒ…å«æ•°æ®å’Œä¸¤ä¸ªæŒ‡é’ˆï¼šprev æŒ‡å‘å‰é©±ï¼Œnext æŒ‡å‘åç»§ã€‚**

```javascript
// åŒå‘é“¾è¡¨èŠ‚ç‚¹å®šä¹‰
class ListNode {
  constructor(val) {
    this.val = val;
    this.prev = null;  // æŒ‡å‘å‰ä¸€ä¸ªèŠ‚ç‚¹
    this.next = null;  // æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
  }
}

// åˆ›å»ºåŒå‘é“¾è¡¨ï¼šA <-> B <-> C
const nodeA = new ListNode('A');
const nodeB = new ListNode('B');
const nodeC = new ListNode('C');

// å»ºç«‹åŒå‘è¿æ¥
nodeA.next = nodeB;
nodeB.prev = nodeA;

nodeB.next = nodeC;
nodeC.prev = nodeB;

// éå†ç¤ºä¾‹
console.log(nodeA.next.val);       // 'B' (å‘å)
console.log(nodeC.prev.val);       // 'B' (å‘å‰)
console.log(nodeB.prev.val);       // 'A' (å‘å‰)
console.log(nodeB.next.val);       // 'C' (å‘å)
```

**è¯¦ç»†è§£é‡Šï¼š**

åŒå‘é“¾è¡¨çš„æ ¸å¿ƒå°±æ˜¯**æ¯ä¸ªèŠ‚ç‚¹éƒ½çŸ¥é“å‰åä¸¤ä¸ªèŠ‚ç‚¹æ˜¯è°**ï¼š
- `prev`ï¼šæŒ‡å‘å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå‰é©±ï¼‰
- `next`ï¼šæŒ‡å‘åä¸€ä¸ªèŠ‚ç‚¹ï¼ˆåç»§ï¼‰
- å¤´èŠ‚ç‚¹çš„ `prev` ä¸º `null`
- å°¾èŠ‚ç‚¹çš„ `next` ä¸º `null`

è¿™ç§åŒæŒ‡é’ˆè®¾è®¡è®©èŠ‚ç‚¹å…·å¤‡"ç¯é¡¾å››å‘¨"çš„èƒ½åŠ›ã€‚

**åœ¨ React æºç ä¸­çš„åº”ç”¨ï¼š**

Fiber èŠ‚ç‚¹è™½ç„¶ä¸æ˜¯ä¸¥æ ¼çš„åŒå‘é“¾è¡¨ï¼Œä½†ä½¿ç”¨äº†ç±»ä¼¼çš„æ€æƒ³ï¼š

```javascript
// React Fiber èŠ‚ç‚¹ï¼ˆç®€åŒ–ï¼‰
class FiberNode {
  constructor(tag) {
    this.tag = tag;

    // "ä¸‰æŒ‡é’ˆ"ç»“æ„
    this.return = null;   // æŒ‡å‘çˆ¶èŠ‚ç‚¹ï¼ˆç±»ä¼¼ prevï¼Œä½†è¯­ä¹‰ä¸åŒï¼‰
    this.child = null;    // æŒ‡å‘ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹
    this.sibling = null;  // æŒ‡å‘ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼ˆç±»ä¼¼ nextï¼‰
  }
}
```

è€Œ Effect é“¾è¡¨åˆ™æ˜¯çœŸæ­£çš„åŒå‘é“¾è¡¨ï¼š

```javascript
// React Effect é“¾è¡¨
function createEffect(tag, create, destroy, deps) {
  const effect = {
    tag,
    create,
    destroy,
    deps,
    next: null  // æŒ‡å‘ä¸‹ä¸€ä¸ª Effectï¼ˆç¯å½¢é“¾è¡¨ï¼‰
  };
  return effect;
}
```

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šæ’å…¥æ“ä½œï¼ˆä¿®æ”¹ 4 ä¸ªæŒ‡é’ˆï¼‰ â•

**åœ¨åŒå‘é“¾è¡¨ä¸­æ’å…¥èŠ‚ç‚¹ï¼Œéœ€è¦ä¿®æ”¹ 4 ä¸ªæŒ‡é’ˆä»¥ä¿æŒåŒå‘è¿æ¥ã€‚**

```javascript
// åœ¨ node åæ’å…¥ newNode
function insertAfter(node, newNode) {
  const nextNode = node.next;

  // 1. newNode çš„æŒ‡é’ˆ
  newNode.prev = node;        // newNode.prev -> node
  newNode.next = nextNode;    // newNode.next -> åŸåç»§

  // 2. å‰é©±çš„æŒ‡é’ˆ
  node.next = newNode;        // node.next -> newNode

  // 3. åç»§çš„æŒ‡é’ˆï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  if (nextNode !== null) {
    nextNode.prev = newNode;  // åŸåç»§.prev -> newNode
  }
}

// åœ¨ node å‰æ’å…¥ newNode
function insertBefore(node, newNode) {
  const prevNode = node.prev;

  // 1. newNode çš„æŒ‡é’ˆ
  newNode.prev = prevNode;    // newNode.prev -> åŸå‰é©±
  newNode.next = node;        // newNode.next -> node

  // 2. åç»§çš„æŒ‡é’ˆ
  node.prev = newNode;        // node.prev -> newNode

  // 3. å‰é©±çš„æŒ‡é’ˆï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  if (prevNode !== null) {
    prevNode.next = newNode;  // åŸå‰é©±.next -> newNode
  }
}
```

**è¯¦ç»†è§£é‡Šï¼š**

æ’å…¥æ“ä½œçš„å…³é”®æ˜¯**ä¿æŒåŒå‘è¿æ¥çš„å®Œæ•´æ€§**ï¼š

**åœ¨ A <-> B ä¹‹é—´æ’å…¥ Nï¼Œå˜æˆ A <-> N <-> Bï¼š**
1. N.prev = Aï¼ˆæ–°èŠ‚ç‚¹æŒ‡å‘å‰é©±ï¼‰
2. N.next = Bï¼ˆæ–°èŠ‚ç‚¹æŒ‡å‘åç»§ï¼‰
3. A.next = Nï¼ˆå‰é©±æŒ‡å‘æ–°èŠ‚ç‚¹ï¼‰
4. B.prev = Nï¼ˆåç»§æŒ‡å‘æ–°èŠ‚ç‚¹ï¼‰

**æ—¶é—´å¤æ‚åº¦ï¼š** O(1)ï¼ˆåªéœ€ä¿®æ”¹å›ºå®šæ•°é‡çš„æŒ‡é’ˆï¼‰

**åœ¨ React æºç ä¸­çš„åº”ç”¨ï¼š**

React åœ¨æ„å»º Effect é“¾è¡¨æ—¶ä½¿ç”¨ç±»ä¼¼çš„æ’å…¥é€»è¾‘ï¼š

```javascript
// React æºç ï¼ˆpackages/react-reconciler/src/ReactFiberHooks.jsï¼‰
function pushEffect(tag, create, destroy, deps) {
  const effect = {
    tag,
    create,
    destroy,
    deps,
    next: null,
  };

  let componentUpdateQueue = currentlyRenderingFiber.updateQueue;

  if (componentUpdateQueue === null) {
    // åˆ›å»ºç¯å½¢é“¾è¡¨
    componentUpdateQueue = createFunctionComponentUpdateQueue();
    currentlyRenderingFiber.updateQueue = componentUpdateQueue;
    componentUpdateQueue.lastEffect = effect.next = effect;  // æŒ‡å‘è‡ªå·±ï¼Œå½¢æˆç¯
  } else {
    // æ’å…¥åˆ°ç¯å½¢é“¾è¡¨
    const lastEffect = componentUpdateQueue.lastEffect;

    if (lastEffect === null) {
      componentUpdateQueue.lastEffect = effect.next = effect;
    } else {
      const firstEffect = lastEffect.next;
      lastEffect.next = effect;       // ä¿®æ”¹å°¾èŠ‚ç‚¹çš„ next
      effect.next = firstEffect;      // æ–°èŠ‚ç‚¹æŒ‡å‘å¤´èŠ‚ç‚¹
      componentUpdateQueue.lastEffect = effect;  // æ›´æ–°å°¾èŠ‚ç‚¹
    }
  }

  return effect;
}
```

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šåˆ é™¤æ“ä½œï¼ˆä¿®æ”¹ 2 ä¸ªæŒ‡é’ˆï¼‰ âŒ

**åˆ é™¤åŒå‘é“¾è¡¨ä¸­çš„èŠ‚ç‚¹ï¼Œåªéœ€ä¿®æ”¹å‰é©±å’Œåç»§çš„æŒ‡é’ˆå³å¯ã€‚**

```javascript
// åˆ é™¤ node èŠ‚ç‚¹
function deleteNode(node) {
  const prevNode = node.prev;
  const nextNode = node.next;

  // 1. å‰é©±çš„ next æŒ‡å‘åç»§
  if (prevNode !== null) {
    prevNode.next = nextNode;
  }

  // 2. åç»§çš„ prev æŒ‡å‘å‰é©±
  if (nextNode !== null) {
    nextNode.prev = prevNode;
  }

  // 3. æ¸…ç©º node çš„æŒ‡é’ˆï¼ˆå¯é€‰ï¼Œä¾¿äº GCï¼‰
  node.prev = null;
  node.next = null;

  return node;
}

// ç¤ºä¾‹ï¼šA <-> B <-> Cï¼Œåˆ é™¤ B
const nodeA = new ListNode('A');
const nodeB = new ListNode('B');
const nodeC = new ListNode('C');

nodeA.next = nodeB;
nodeB.prev = nodeA;
nodeB.next = nodeC;
nodeC.prev = nodeB;

deleteNode(nodeB);
// ç»“æœï¼šA <-> C
console.log(nodeA.next.val);  // 'C'
console.log(nodeC.prev.val);  // 'A'
```

**è¯¦ç»†è§£é‡Šï¼š**

åˆ é™¤æ“ä½œçš„æ ¸å¿ƒæ˜¯**è·³è¿‡è¢«åˆ é™¤çš„èŠ‚ç‚¹ï¼Œé‡æ–°å»ºç«‹å‰åè¿æ¥**ï¼š

**åˆ é™¤ A <-> B <-> C ä¸­çš„ Bï¼š**
1. A.next = Cï¼ˆå‰é©±è·³è¿‡ Bï¼Œç›´æ¥æŒ‡å‘åç»§ï¼‰
2. C.prev = Aï¼ˆåç»§è·³è¿‡ Bï¼Œç›´æ¥æŒ‡å‘å‰é©±ï¼‰
3. B.prev = null, B.next = nullï¼ˆæ¸…ç©º B çš„æŒ‡é’ˆï¼Œä¾¿äºåƒåœ¾å›æ”¶ï¼‰

**æ—¶é—´å¤æ‚åº¦ï¼š** O(1)ï¼ˆåªéœ€ä¿®æ”¹å›ºå®šæ•°é‡çš„æŒ‡é’ˆï¼‰

**ä¼˜åŠ¿ï¼š** ä¸éœ€è¦éå†æ‰¾åˆ°å‰é©±èŠ‚ç‚¹ï¼ˆå› ä¸ºæœ‰ prev æŒ‡é’ˆï¼‰

**åœ¨ React æºç ä¸­çš„åº”ç”¨ï¼š**

React åœ¨å¤„ç† Fiber æ ‘æ—¶ï¼Œç»å¸¸éœ€è¦"è·³è¿‡"æŸäº›èŠ‚ç‚¹ï¼ˆå¦‚è¢«åˆ é™¤çš„ç»„ä»¶ï¼‰ï¼š

```javascript
// React æºç ï¼ˆpackages/react-reconciler/src/ReactFiberCommitWork.jsï¼‰
function commitDeletion(finishedRoot, current, renderPriorityLevel) {
  // åˆ é™¤ DOM èŠ‚ç‚¹åŠå…¶å­æ ‘

  // æ‰¾åˆ°çˆ¶ DOM èŠ‚ç‚¹
  const parentFiber = getHostParentFiber(current);

  // ä»çˆ¶èŠ‚ç‚¹ç§»é™¤å½“å‰ DOM
  if (parentFiber !== null) {
    switch (parentFiber.tag) {
      case HostComponent: {
        const parent = parentFiber.stateNode;
        removeChild(parent, current.stateNode);  // ä» DOM æ ‘ç§»é™¤
        break;
      }
      // ... å…¶ä»–ç±»å‹
    }
  }

  // é€’å½’åˆ é™¤å­ Fiber
  detachFiber(current);
}

function detachFiber(current) {
  const alternate = current.alternate;

  // æ¸…ç©ºæŒ‡é’ˆï¼Œå¸®åŠ© GC
  current.return = null;
  current.child = null;
  current.sibling = null;
  current.stateNode = null;

  if (alternate !== null) {
    // åŒæ—¶æ¸…ç©ºæ—§ Fiber
    detachFiber(alternate);
  }
}
```

è™½ç„¶ Fiber ä¸æ˜¯ä¸¥æ ¼çš„åŒå‘é“¾è¡¨ï¼Œä½†åˆ é™¤æ“ä½œçš„æ€æƒ³æ˜¯ä¸€è‡´çš„ï¼š**ä¿®æ”¹æŒ‡é’ˆ + æ¸…ç©ºå¼•ç”¨**ã€‚

---

## 4. ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½ç†è§£ React æºç æ ¸å¿ƒï¼š

### 4.1 åŒå‘é“¾è¡¨èŠ‚ç‚¹ç»“æ„

```javascript
class ListNode {
  constructor(val) {
    this.val = val;
    this.prev = null;
    this.next = null;
  }
}
```

**åº”ç”¨ï¼š** ç†è§£ Fiberã€Effectã€Hooks é“¾è¡¨çš„åŸºæœ¬ç»“æ„

### 4.2 æ’å…¥èŠ‚ç‚¹ï¼ˆåœ¨ node åæ’å…¥ï¼‰

```javascript
function insertAfter(node, newNode) {
  newNode.next = node.next;
  newNode.prev = node;

  if (node.next) {
    node.next.prev = newNode;
  }

  node.next = newNode;
}
```

**åº”ç”¨ï¼š** ç†è§£ React å¦‚ä½•æ’å…¥æ–°çš„ Effect æˆ– Hook

### 4.3 åˆ é™¤èŠ‚ç‚¹

```javascript
function deleteNode(node) {
  if (node.prev) node.prev.next = node.next;
  if (node.next) node.next.prev = node.prev;

  node.prev = null;
  node.next = null;
}
```

**åº”ç”¨ï¼š** ç†è§£ React å¦‚ä½•ç§»é™¤ Fiber æˆ– Effect

### 4.4 éå†é“¾è¡¨

```javascript
// å‘åéå†
function traverseForward(head) {
  let current = head;
  while (current !== null) {
    console.log(current.val);
    current = current.next;
  }
}

// å‘å‰éå†
function traverseBackward(tail) {
  let current = tail;
  while (current !== null) {
    console.log(current.val);
    current = current.prev;
  }
}
```

**åº”ç”¨ï¼š** ç†è§£ React å¦‚ä½•éå† Fiber æ ‘å’Œ Effect é“¾è¡¨

### 4.5 ç¯å½¢é“¾è¡¨ï¼ˆç‰¹æ®Šçš„åŒå‘é“¾è¡¨ï¼‰

```javascript
// åˆ›å»ºç¯å½¢é“¾è¡¨ï¼šA -> B -> C -> A
function createCircularList(values) {
  if (values.length === 0) return null;

  const nodes = values.map(val => new ListNode(val));

  // è¿æ¥èŠ‚ç‚¹
  for (let i = 0; i < nodes.length; i++) {
    nodes[i].next = nodes[(i + 1) % nodes.length];  // å°¾èŠ‚ç‚¹æŒ‡å‘å¤´èŠ‚ç‚¹
    nodes[i].prev = nodes[(i - 1 + nodes.length) % nodes.length];
  }

  return nodes[0];  // è¿”å›å¤´èŠ‚ç‚¹
}
```

**åº”ç”¨ï¼š** ç†è§£ React Hooks çš„ baseQueue ç¯å½¢é“¾è¡¨

---

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- âœ… ç†è§£ Fiber èŠ‚ç‚¹çš„ä¸‰æŒ‡é’ˆç»“æ„ï¼ˆchild/sibling/returnï¼‰
- âœ… ç†è§£ Effect é“¾è¡¨çš„æ’å…¥å’Œéå†
- âœ… ç†è§£ Hooks é“¾è¡¨çš„ç¯å½¢ç»“æ„
- âœ… çœ‹æ‡‚ React æºç ä¸­çš„é“¾è¡¨æ“ä½œ

---

## 5. ã€1ä¸ªç±»æ¯”ã€‘

### ç±»æ¯”1ï¼šåŒå‘é“¾è¡¨ = ç«è½¦è½¦å¢ ğŸš‚

**ç«è½¦çš„æ¯èŠ‚è½¦å¢éƒ½çŸ¥é“å‰ä¸€èŠ‚å’Œåä¸€èŠ‚è½¦å¢æ˜¯è°ï¼Œå¯ä»¥åŒå‘è¿æ¥å’Œåˆ†ç¦»ã€‚**

**ä¸¾ä¾‹ï¼š**

æƒ³è±¡ä¸€åˆ—ç«è½¦ï¼šAè½¦å¢ <-> Bè½¦å¢ <-> Cè½¦å¢

- **åŒå‘è¿æ¥**ï¼šBè½¦å¢æ—¢çŸ¥é“å‰é¢æ˜¯Aï¼Œä¹ŸçŸ¥é“åé¢æ˜¯C
- **æ’å…¥è½¦å¢**ï¼šåœ¨Bå’ŒCä¹‹é—´åŠ å…¥Nè½¦å¢ï¼Œåªéœ€è°ƒæ•´è¿æ¥å™¨
  - Bçš„åè¿æ¥å™¨è¿æ¥N
  - Cçš„å‰è¿æ¥å™¨è¿æ¥N
  - Nçš„å‰è¿æ¥å™¨è¿æ¥Bï¼Œåè¿æ¥å™¨è¿æ¥C
- **ç§»é™¤è½¦å¢**ï¼šæ‹†æ‰Bè½¦å¢ï¼Œç›´æ¥è¿æ¥Aå’ŒCå³å¯

```javascript
class TrainCar {
  constructor(number) {
    this.number = number;
    this.frontConnector = null;  // å‰è¿æ¥å™¨ï¼ˆprevï¼‰
    this.rearConnector = null;   // åè¿æ¥å™¨ï¼ˆnextï¼‰
  }
}

// å»ºç«‹ç«è½¦
const carA = new TrainCar('A');
const carB = new TrainCar('B');
const carC = new TrainCar('C');

// è¿æ¥è½¦å¢
carA.rearConnector = carB;
carB.frontConnector = carA;

carB.rearConnector = carC;
carC.frontConnector = carB;

// åœ¨Bå’ŒCä¹‹é—´æ’å…¥N
const carN = new TrainCar('N');
carN.frontConnector = carB;
carN.rearConnector = carC;

carB.rearConnector = carN;
carC.frontConnector = carN;
```

---

### ç±»æ¯”2ï¼šåŒå‘é“¾è¡¨ = éŸ³ä¹æ’­æ”¾åˆ—è¡¨ ğŸµ

**æ’­æ”¾åˆ—è¡¨ä¸­çš„æ­Œæ›²å¯ä»¥å‘å‰è·³åˆ°ä¸Šä¸€é¦–ï¼Œä¹Ÿå¯ä»¥å‘åè·³åˆ°ä¸‹ä¸€é¦–ã€‚**

**ä¸¾ä¾‹ï¼š**

```
[ä¸Šä¸€é¦–] æ­Œæ›²A <-> æ­Œæ›²B <-> æ­Œæ›²C [ä¸‹ä¸€é¦–]
```

- æ­£åœ¨æ’­æ”¾æ­Œæ›²B
- ç‚¹å‡»"ä¸Šä¸€é¦–"æŒ‰é’®ï¼šé€šè¿‡ `prev` æŒ‡é’ˆè·³åˆ°æ­Œæ›²A
- ç‚¹å‡»"ä¸‹ä¸€é¦–"æŒ‰é’®ï¼šé€šè¿‡ `next` æŒ‡é’ˆè·³åˆ°æ­Œæ›²C
- åˆ é™¤æ­Œæ›²Bï¼šè‡ªåŠ¨ä»Aè·³åˆ°C

```javascript
class Song {
  constructor(title) {
    this.title = title;
    this.prev = null;
    this.next = null;
  }
}

class Playlist {
  constructor() {
    this.current = null;
  }

  playPrevious() {
    if (this.current && this.current.prev) {
      this.current = this.current.prev;
      console.log('æ’­æ”¾:', this.current.title);
    }
  }

  playNext() {
    if (this.current && this.current.next) {
      this.current = this.current.next;
      console.log('æ’­æ”¾:', this.current.title);
    }
  }
}
```

---

### ç±»æ¯”3ï¼šåŒå‘é“¾è¡¨ = æµè§ˆå™¨å†å²è®°å½• ğŸŒ

**æµè§ˆå™¨çš„å‰è¿›/åé€€æŒ‰é’®é€šè¿‡åŒå‘é“¾è¡¨å®ç°å†å²è®°å½•å¯¼èˆªã€‚**

**ä¸¾ä¾‹ï¼š**

```
è®¿é—®é¡ºåºï¼šé¡µé¢A -> é¡µé¢B -> é¡µé¢C
å½“å‰ä½ç½®ï¼šé¡µé¢B

[åé€€] <- é¡µé¢A <-> é¡µé¢B <-> é¡µé¢C -> [å‰è¿›]
```

- ç‚¹å‡»"åé€€"ï¼šé€šè¿‡ `prev` æŒ‡é’ˆå›åˆ°é¡µé¢A
- ç‚¹å‡»"å‰è¿›"ï¼šé€šè¿‡ `next` æŒ‡é’ˆè¿›å…¥é¡µé¢C
- è®¿é—®æ–°é¡µé¢ï¼šåœ¨å½“å‰ä½ç½®åæ’å…¥æ–°èŠ‚ç‚¹ï¼Œæ¸…ç©ºåç»­å†å²

```javascript
class HistoryPage {
  constructor(url) {
    this.url = url;
    this.prev = null;
    this.next = null;
  }
}

class BrowserHistory {
  constructor(homepage) {
    this.current = new HistoryPage(homepage);
  }

  visit(url) {
    const newPage = new HistoryPage(url);
    newPage.prev = this.current;
    this.current.next = newPage;
    this.current = newPage;

    // æ¸…ç©º"å‰è¿›"å†å²ï¼ˆè®¿é—®æ–°é¡µé¢åæ— æ³•å‰è¿›ï¼‰
    this.current.next = null;
  }

  back() {
    if (this.current.prev) {
      this.current = this.current.prev;
      console.log('åé€€åˆ°:', this.current.url);
    }
  }

  forward() {
    if (this.current.next) {
      this.current = this.current.next;
      console.log('å‰è¿›åˆ°:', this.current.url);
    }
  }
}

// ç¤ºä¾‹
const history = new BrowserHistory('google.com');
history.visit('react.dev');        // google <-> react
history.visit('github.com');       // google <-> react <-> github
history.back();                    // å›åˆ° react
history.back();                    // å›åˆ° google
history.forward();                 // å‰è¿›åˆ° react
```

---

### ç±»æ¯”æ€»ç»“è¡¨

| åŒå‘é“¾è¡¨æ¦‚å¿µ | ç«è½¦è½¦å¢ | éŸ³ä¹æ’­æ”¾åˆ—è¡¨ | æµè§ˆå™¨å†å² | React åº”ç”¨ |
|------------|---------|-------------|-----------|-----------|
| èŠ‚ç‚¹ | è½¦å¢ | æ­Œæ›² | è®¿é—®çš„é¡µé¢ | Fiber/Hook/Effect |
| prev æŒ‡é’ˆ | å‰è¿æ¥å™¨ | ä¸Šä¸€é¦–æŒ‰é’® | åé€€æŒ‰é’® | return/prev |
| next æŒ‡é’ˆ | åè¿æ¥å™¨ | ä¸‹ä¸€é¦–æŒ‰é’® | å‰è¿›æŒ‰é’® | child/sibling/next |
| æ’å…¥ | åŠ æŒ‚è½¦å¢ | æ·»åŠ æ­Œæ›² | è®¿é—®æ–°é¡µé¢ | åˆ›å»ºæ–° Fiber/Hook |
| åˆ é™¤ | æ‹†å¸è½¦å¢ | åˆ é™¤æ­Œæ›² | æ¸…é™¤å†å² | å¸è½½ç»„ä»¶ |
| éå† | å·¡è§†è½¦å¢ | æ’­æ”¾åˆ—è¡¨ | æŸ¥çœ‹å†å² | workLoop éå† |

---

## 6. ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼šåŒå‘é“¾è¡¨æ¯”å•å‘é“¾è¡¨æ…¢ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

æ—¶é—´å¤æ‚åº¦ä¸Šï¼ŒåŒå‘é“¾è¡¨çš„æ’å…¥/åˆ é™¤å’Œå•å‘é“¾è¡¨ä¸€æ ·éƒ½æ˜¯ O(1)ã€‚

**å…³é”®åŒºåˆ«ï¼š**

| æ“ä½œ | å•å‘é“¾è¡¨ | åŒå‘é“¾è¡¨ |
|-----|---------|---------|
| åœ¨èŠ‚ç‚¹åæ’å…¥ | O(1) | O(1) |
| åœ¨èŠ‚ç‚¹å‰æ’å…¥ | O(n)ï¼ˆéœ€è¦æ‰¾å‰é©±ï¼‰ | O(1)ï¼ˆæœ‰ prevï¼‰ |
| åˆ é™¤èŠ‚ç‚¹ | O(n)ï¼ˆéœ€è¦æ‰¾å‰é©±ï¼‰ | O(1)ï¼ˆæœ‰ prevï¼‰ |
| ç©ºé—´å ç”¨ | æ¯èŠ‚ç‚¹ 1 ä¸ªæŒ‡é’ˆ | æ¯èŠ‚ç‚¹ 2 ä¸ªæŒ‡é’ˆ |

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

åŒå‘é“¾è¡¨æ¯ä¸ªèŠ‚ç‚¹å¤šä¸€ä¸ªæŒ‡é’ˆï¼Œç©ºé—´å ç”¨ç¡®å®æ›´å¤§ï¼Œä½†è¿™ä¸å½±å“æ—¶é—´å¤æ‚åº¦ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```javascript
// å•å‘é“¾è¡¨åˆ é™¤èŠ‚ç‚¹ï¼šéœ€è¦æ‰¾å‰é©±ï¼ˆO(n)ï¼‰
function deleteNode(head, targetNode) {
  if (head === targetNode) {
    return head.next;  // åˆ é™¤å¤´èŠ‚ç‚¹
  }

  let current = head;
  while (current.next !== null) {
    if (current.next === targetNode) {
      current.next = targetNode.next;  // æ‰¾åˆ°å‰é©±ï¼Œä¿®æ”¹æŒ‡é’ˆ
      break;
    }
    current = current.next;
  }
  return head;
}

// åŒå‘é“¾è¡¨åˆ é™¤èŠ‚ç‚¹ï¼šç›´æ¥ä¿®æ”¹ï¼ˆO(1)ï¼‰
function deleteNodeDouble(node) {
  if (node.prev) node.prev.next = node.next;
  if (node.next) node.next.prev = node.prev;
}
```

**React æºç ç¤ºä¾‹ï¼š**

React é€‰æ‹©åˆé€‚çš„é“¾è¡¨ç±»å‹ï¼š
- **Fiber æ ‘**ï¼šä¸‰æŒ‡é’ˆï¼ˆchild/sibling/returnï¼‰ï¼Œç±»ä¼¼å•å‘é“¾è¡¨ + çˆ¶æŒ‡é’ˆ
- **Effect é“¾è¡¨**ï¼šç¯å½¢é“¾è¡¨ï¼Œæ”¯æŒå¿«é€Ÿæ’å…¥
- **Hooks é“¾è¡¨**ï¼šå•å‘é“¾è¡¨ï¼ˆæŒ‰é¡ºåºè°ƒç”¨ï¼Œä¸éœ€è¦åŒå‘ï¼‰

---

### è¯¯åŒº2ï¼šæ‰€æœ‰é“¾è¡¨æ“ä½œéƒ½æ˜¯ O(1) âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

**O(1) çš„å‰ææ˜¯"å·²çŸ¥èŠ‚ç‚¹ä½ç½®"**ã€‚å¦‚æœéœ€è¦å…ˆæŸ¥æ‰¾èŠ‚ç‚¹ï¼Œæ—¶é—´å¤æ‚åº¦ä»æ˜¯ O(n)ã€‚

**å…³é”®åŒºåˆ«ï¼š**

| æ“ä½œ | å·²çŸ¥ä½ç½® | æœªçŸ¥ä½ç½®ï¼ˆéœ€è¦æŸ¥æ‰¾ï¼‰ |
|-----|---------|------------------|
| æ’å…¥ | O(1) | O(n) |
| åˆ é™¤ | O(1) | O(n) |
| æŸ¥æ‰¾ | - | O(n) |
| è®¿é—®ç¬¬ i ä¸ªå…ƒç´  | - | O(n) |

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

æ•™æå¸¸è¯´"é“¾è¡¨çš„æ’å…¥/åˆ é™¤æ˜¯ O(1)"ï¼Œä½†çœç•¥äº†"å·²çŸ¥ä½ç½®"è¿™ä¸ªå‰æã€‚

**æ­£ç¡®ç†è§£ï¼š**

```javascript
// åœºæ™¯1ï¼šå·²çŸ¥ä½ç½®çš„åˆ é™¤ï¼ˆO(1)ï¼‰
function deleteNode(node) {
  if (node.prev) node.prev.next = node.next;
  if (node.next) node.next.prev = node.prev;
}

// åœºæ™¯2ï¼šæ ¹æ®å€¼æŸ¥æ‰¾å¹¶åˆ é™¤ï¼ˆO(n)ï¼‰
function deleteByValue(head, val) {
  let current = head;

  // å…ˆæŸ¥æ‰¾èŠ‚ç‚¹ï¼ˆO(n)ï¼‰
  while (current !== null) {
    if (current.val === val) {
      // ç„¶ååˆ é™¤ï¼ˆO(1)ï¼‰
      deleteNode(current);
      break;
    }
    current = current.next;
  }
}
```

**React æºç ç¤ºä¾‹ï¼š**

React é€šå¸¸"å·²çŸ¥ä½ç½®"ï¼Œæ‰€ä»¥é“¾è¡¨æ“ä½œæ˜¯ O(1)ï¼š

```javascript
// React æºç ï¼ˆpackages/react-reconciler/src/ReactFiberHooks.jsï¼‰
function mountWorkInProgressHook() {
  const hook = {
    memoizedState: null,
    baseState: null,
    baseQueue: null,
    queue: null,
    next: null,  // ä¸‹ä¸€ä¸ª Hook
  };

  if (workInProgressHook === null) {
    // ç¬¬ä¸€ä¸ª Hook
    currentlyRenderingFiber.memoizedState = workInProgressHook = hook;
  } else {
    // æ’å…¥åˆ°é“¾è¡¨å°¾éƒ¨ï¼ˆå·²çŸ¥ä½ç½®ï¼ŒO(1)ï¼‰
    workInProgressHook = workInProgressHook.next = hook;
  }

  return workInProgressHook;
}
```

å› ä¸º React æŒ‰é¡ºåºåˆ›å»º Hooksï¼Œæ€»æ˜¯åœ¨å°¾éƒ¨æ’å…¥ï¼Œæ‰€ä»¥ä¸éœ€è¦æŸ¥æ‰¾ã€‚

---

### è¯¯åŒº3ï¼šç¯å½¢é“¾è¡¨å°±æ˜¯é¦–å°¾ç›¸è¿çš„é“¾è¡¨ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

ç¯å½¢é“¾è¡¨æœ‰ä¸¤ç§ï¼š
1. **å•å‘ç¯å½¢**ï¼šå°¾èŠ‚ç‚¹çš„ next æŒ‡å‘å¤´èŠ‚ç‚¹
2. **åŒå‘ç¯å½¢**ï¼šå°¾èŠ‚ç‚¹çš„ next æŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œå¤´èŠ‚ç‚¹çš„ prev æŒ‡å‘å°¾èŠ‚ç‚¹

å•çº¯"é¦–å°¾ç›¸è¿"åªæ˜¯å•å‘ç¯å½¢ï¼ŒåŒå‘ç¯å½¢è¿˜éœ€è¦å¤„ç† prev æŒ‡é’ˆã€‚

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

å¾ˆå¤šæ•™ç¨‹åªå±•ç¤ºå•å‘ç¯å½¢é“¾è¡¨çš„å®ç°ï¼Œå¿½ç•¥äº†åŒå‘ç¯å½¢ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```javascript
// å•å‘ç¯å½¢é“¾è¡¨
class CircularList {
  constructor(values) {
    const nodes = values.map(val => ({ val, next: null }));

    for (let i = 0; i < nodes.length; i++) {
      nodes[i].next = nodes[(i + 1) % nodes.length];  // å°¾èŠ‚ç‚¹æŒ‡å‘å¤´èŠ‚ç‚¹
    }

    this.head = nodes[0];
  }
}

// åŒå‘ç¯å½¢é“¾è¡¨
class DoublyCircularList {
  constructor(values) {
    const nodes = values.map(val => ({ val, prev: null, next: null }));

    for (let i = 0; i < nodes.length; i++) {
      nodes[i].next = nodes[(i + 1) % nodes.length];
      nodes[i].prev = nodes[(i - 1 + nodes.length) % nodes.length];
    }

    this.head = nodes[0];
  }
}
```

**React æºç ç¤ºä¾‹ï¼š**

React Hooks çš„ baseQueue æ˜¯å•å‘ç¯å½¢é“¾è¡¨ï¼š

```javascript
// React æºç ï¼ˆpackages/react-reconciler/src/ReactFiberHooks.jsï¼‰
const update = {
  lane,
  action,
  eagerReducer: null,
  eagerState: null,
  next: null,  // å•å‘æŒ‡é’ˆ
};

const pending = queue.pending;

if (pending === null) {
  // ç¬¬ä¸€ä¸ª updateï¼Œå½¢æˆç¯ï¼ˆæŒ‡å‘è‡ªå·±ï¼‰
  update.next = update;
} else {
  // æ’å…¥åˆ°ç¯ä¸­
  update.next = pending.next;  // æ–° update æŒ‡å‘å¤´èŠ‚ç‚¹
  pending.next = update;       // å°¾èŠ‚ç‚¹æŒ‡å‘æ–° update
}

queue.pending = update;  // pending å§‹ç»ˆæŒ‡å‘å°¾èŠ‚ç‚¹
```

æ³¨æ„ï¼šè¿™æ˜¯**å•å‘ç¯å½¢**ï¼Œæ²¡æœ‰ prev æŒ‡é’ˆã€‚

---

## 7. ã€å®æˆ˜ä»£ç ã€‘

### åŸºç¡€å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰

```javascript
// ===== 1. åŒå‘é“¾è¡¨èŠ‚ç‚¹å®šä¹‰ =====
console.log("=== 1. åŒå‘é“¾è¡¨èŠ‚ç‚¹å®šä¹‰ ===");

class ListNode {
  constructor(val) {
    this.val = val;
    this.prev = null;
    this.next = null;
  }
}

console.log("ListNode ç±»å·²å®šä¹‰");

// ===== 2. åŒå‘é“¾è¡¨ç±» =====
console.log("\n=== 2. åŒå‘é“¾è¡¨ç±» ===");

class DoublyLinkedList {
  constructor() {
    this.head = null;
    this.tail = null;
    this.size = 0;
  }

  // åœ¨å°¾éƒ¨æ·»åŠ èŠ‚ç‚¹
  append(val) {
    const newNode = new ListNode(val);

    if (this.head === null) {
      // ç©ºé“¾è¡¨
      this.head = newNode;
      this.tail = newNode;
    } else {
      // éç©ºé“¾è¡¨
      newNode.prev = this.tail;
      this.tail.next = newNode;
      this.tail = newNode;
    }

    this.size++;
    return this;
  }

  // åœ¨å¤´éƒ¨æ·»åŠ èŠ‚ç‚¹
  prepend(val) {
    const newNode = new ListNode(val);

    if (this.head === null) {
      this.head = newNode;
      this.tail = newNode;
    } else {
      newNode.next = this.head;
      this.head.prev = newNode;
      this.head = newNode;
    }

    this.size++;
    return this;
  }

  // åœ¨æŒ‡å®šèŠ‚ç‚¹åæ’å…¥
  insertAfter(node, val) {
    if (!node) return this;

    const newNode = new ListNode(val);
    newNode.next = node.next;
    newNode.prev = node;

    if (node.next) {
      node.next.prev = newNode;
    } else {
      // åœ¨å°¾èŠ‚ç‚¹åæ’å…¥
      this.tail = newNode;
    }

    node.next = newNode;
    this.size++;
    return this;
  }

  // åˆ é™¤èŠ‚ç‚¹
  delete(node) {
    if (!node) return this;

    if (node.prev) {
      node.prev.next = node.next;
    } else {
      // åˆ é™¤å¤´èŠ‚ç‚¹
      this.head = node.next;
    }

    if (node.next) {
      node.next.prev = node.prev;
    } else {
      // åˆ é™¤å°¾èŠ‚ç‚¹
      this.tail = node.prev;
    }

    node.prev = null;
    node.next = null;
    this.size--;
    return this;
  }

  // å‘å‰éå†ï¼ˆä»å¤´åˆ°å°¾ï¼‰
  traverseForward() {
    const result = [];
    let current = this.head;

    while (current !== null) {
      result.push(current.val);
      current = current.next;
    }

    return result;
  }

  // å‘åéå†ï¼ˆä»å°¾åˆ°å¤´ï¼‰
  traverseBackward() {
    const result = [];
    let current = this.tail;

    while (current !== null) {
      result.push(current.val);
      current = current.prev;
    }

    return result;
  }

  // æŸ¥æ‰¾èŠ‚ç‚¹
  find(val) {
    let current = this.head;

    while (current !== null) {
      if (current.val === val) {
        return current;
      }
      current = current.next;
    }

    return null;
  }
}

// åˆ›å»ºé“¾è¡¨
const list = new DoublyLinkedList();
list.append('A').append('B').append('C');

console.log("å‘å‰éå†:", list.traverseForward());  // ['A', 'B', 'C']
console.log("å‘åéå†:", list.traverseBackward()); // ['C', 'B', 'A']

// ===== 3. æ’å…¥æ“ä½œç¤ºä¾‹ =====
console.log("\n=== 3. æ’å…¥æ“ä½œç¤ºä¾‹ ===");

const nodeB = list.find('B');
list.insertAfter(nodeB, 'X');  // åœ¨ B åæ’å…¥ X

console.log("æ’å…¥Xå:", list.traverseForward());  // ['A', 'B', 'X', 'C']

list.prepend('Z');  // åœ¨å¤´éƒ¨æ’å…¥ Z

console.log("åœ¨å¤´éƒ¨æ’å…¥Z:", list.traverseForward());  // ['Z', 'A', 'B', 'X', 'C']

// ===== 4. åˆ é™¤æ“ä½œç¤ºä¾‹ =====
console.log("\n=== 4. åˆ é™¤æ“ä½œç¤ºä¾‹ ===");

const nodeX = list.find('X');
list.delete(nodeX);  // åˆ é™¤ X

console.log("åˆ é™¤Xå:", list.traverseForward());  // ['Z', 'A', 'B', 'C']

// ===== 5. ç¯å½¢é“¾è¡¨ç¤ºä¾‹ =====
console.log("\n=== 5. ç¯å½¢é“¾è¡¨ç¤ºä¾‹ ===");

class CircularDoublyLinkedList {
  constructor(values) {
    if (values.length === 0) {
      this.head = null;
      return;
    }

    const nodes = values.map(val => new ListNode(val));

    // å»ºç«‹åŒå‘ç¯å½¢è¿æ¥
    for (let i = 0; i < nodes.length; i++) {
      nodes[i].next = nodes[(i + 1) % nodes.length];
      nodes[i].prev = nodes[(i - 1 + nodes.length) % nodes.length];
    }

    this.head = nodes[0];
  }

  // ä»å¤´èŠ‚ç‚¹éå† n æ­¥
  traverse(n) {
    const result = [];
    let current = this.head;

    for (let i = 0; i < n; i++) {
      result.push(current.val);
      current = current.next;
    }

    return result;
  }
}

const circular = new CircularDoublyLinkedList(['A', 'B', 'C']);
console.log("ç¯å½¢éå†5æ­¥:", circular.traverse(5));  // ['A', 'B', 'C', 'A', 'B']
console.log("ä»Bå‘å‰:", circular.head.next.prev.val);  // 'A'
console.log("ä»Cå‘å:", circular.head.prev.next.val);  // 'A'

// ===== 6. React Hook é“¾è¡¨æ¨¡æ‹Ÿ =====
console.log("\n=== 6. React Hook é“¾è¡¨æ¨¡æ‹Ÿ ===");

class Hook {
  constructor(memoizedState) {
    this.memoizedState = memoizedState;
    this.next = null;
  }
}

// æ¨¡æ‹Ÿ React åˆ›å»º Hooks
let firstHook = null;
let lastHook = null;

function mountHook(initialState) {
  const hook = new Hook(initialState);

  if (firstHook === null) {
    // ç¬¬ä¸€ä¸ª Hook
    firstHook = lastHook = hook;
  } else {
    // è¿½åŠ åˆ°é“¾è¡¨å°¾éƒ¨
    lastHook.next = hook;
    lastHook = hook;
  }

  return hook;
}

// æ¨¡æ‹Ÿç»„ä»¶ä¸­çš„ Hooks
const useStateHook1 = mountHook(0);        // useState(0)
const useStateHook2 = mountHook('hello');  // useState('hello')
const useEffectHook = mountHook(null);     // useEffect(...)

// éå† Hooks é“¾è¡¨
function traverseHooks() {
  const result = [];
  let current = firstHook;

  while (current !== null) {
    result.push(current.memoizedState);
    current = current.next;
  }

  return result;
}

console.log("Hooks é“¾è¡¨:", traverseHooks());  // [0, 'hello', null]
```

### è¿è¡Œè¾“å‡ºç¤ºä¾‹

```
=== 1. åŒå‘é“¾è¡¨èŠ‚ç‚¹å®šä¹‰ ===
ListNode ç±»å·²å®šä¹‰

=== 2. åŒå‘é“¾è¡¨ç±» ===
å‘å‰éå†: [ 'A', 'B', 'C' ]
å‘åéå†: [ 'C', 'B', 'A' ]

=== 3. æ’å…¥æ“ä½œç¤ºä¾‹ ===
æ’å…¥Xå: [ 'A', 'B', 'X', 'C' ]
åœ¨å¤´éƒ¨æ’å…¥Z: [ 'Z', 'A', 'B', 'X', 'C' ]

=== 4. åˆ é™¤æ“ä½œç¤ºä¾‹ ===
åˆ é™¤Xå: [ 'Z', 'A', 'B', 'C' ]

=== 5. ç¯å½¢é“¾è¡¨ç¤ºä¾‹ ===
ç¯å½¢éå†5æ­¥: [ 'A', 'B', 'C', 'A', 'B' ]
ä»Bå‘å‰: A
ä»Cå‘å: A

=== 6. React Hook é“¾è¡¨æ¨¡æ‹Ÿ ===
Hooks é“¾è¡¨: [ 0, 'hello', null ]
```

---

### è¿›é˜¶ï¼šReact æºç å®ç°

```javascript
// React æºç ç‰‡æ®µï¼ˆpackages/react-reconciler/src/ReactFiberHooks.jsï¼‰

/**
 * Hook æ•°æ®ç»“æ„
 */
type Hook = {
  memoizedState: any,      // ä¸Šæ¬¡æ¸²æŸ“æ—¶çš„çŠ¶æ€
  baseState: any,          // åŸºç¡€çŠ¶æ€
  baseQueue: Update<any> | null,  // åŸºç¡€æ›´æ–°é˜Ÿåˆ—
  queue: UpdateQueue<any> | null,  // å¾…å¤„ç†çš„æ›´æ–°é˜Ÿåˆ—
  next: Hook | null,       // ä¸‹ä¸€ä¸ª Hookï¼ˆå•å‘é“¾è¡¨ï¼‰
};

/**
 * Update æ•°æ®ç»“æ„ï¼ˆç¯å½¢é“¾è¡¨ï¼‰
 */
type Update<S> = {
  lane: Lane,
  action: S | ((S) => S),
  eagerReducer: ((S, A) => S) | null,
  eagerState: S | null,
  next: Update<S>,  // ä¸‹ä¸€ä¸ª Updateï¼ˆç¯å½¢ï¼‰
};

/**
 * æŒ‚è½½é˜¶æ®µï¼šåˆ›å»ºæ–° Hook å¹¶æ·»åŠ åˆ°é“¾è¡¨
 */
function mountWorkInProgressHook(): Hook {
  const hook: Hook = {
    memoizedState: null,
    baseState: null,
    baseQueue: null,
    queue: null,
    next: null,  // åˆå§‹ä¸º null
  };

  if (workInProgressHook === null) {
    // ç¬¬ä¸€ä¸ª Hookï¼Œåˆ›å»ºé“¾è¡¨å¤´
    currentlyRenderingFiber.memoizedState = workInProgressHook = hook;
  } else {
    // åç»­ Hookï¼Œè¿½åŠ åˆ°é“¾è¡¨å°¾éƒ¨
    workInProgressHook = workInProgressHook.next = hook;
  }

  return workInProgressHook;
}

/**
 * æ›´æ–°é˜¶æ®µï¼šä» current Fiber å¤ç”¨ Hook
 */
function updateWorkInProgressHook(): Hook {
  let nextCurrentHook: Hook | null;

  if (currentHook === null) {
    // ç¬¬ä¸€ä¸ª Hook
    const current = currentlyRenderingFiber.alternate;
    if (current !== null) {
      nextCurrentHook = current.memoizedState;
    } else {
      nextCurrentHook = null;
    }
  } else {
    // åç»­ Hookï¼Œæ²¿ç€é“¾è¡¨å‘åç§»åŠ¨
    nextCurrentHook = currentHook.next;
  }

  let nextWorkInProgressHook: Hook | null;

  if (workInProgressHook === null) {
    nextWorkInProgressHook = currentlyRenderingFiber.memoizedState;
  } else {
    nextWorkInProgressHook = workInProgressHook.next;
  }

  if (nextWorkInProgressHook !== null) {
    // å¤ç”¨å·²æœ‰çš„ Hook
    workInProgressHook = nextWorkInProgressHook;
    nextWorkInProgressHook = workInProgressHook.next;

    currentHook = nextCurrentHook;
  } else {
    // å…‹éš† current Hook
    currentHook = nextCurrentHook;

    const newHook: Hook = {
      memoizedState: currentHook.memoizedState,
      baseState: currentHook.baseState,
      baseQueue: currentHook.baseQueue,
      queue: currentHook.queue,
      next: null,
    };

    if (workInProgressHook === null) {
      currentlyRenderingFiber.memoizedState = workInProgressHook = newHook;
    } else {
      workInProgressHook = workInProgressHook.next = newHook;
    }
  }

  return workInProgressHook;
}

/**
 * åˆ†å‘ setState æ›´æ–°ï¼ˆç¯å½¢é“¾è¡¨ï¼‰
 */
function dispatchAction<S, A>(
  fiber: Fiber,
  queue: UpdateQueue<S, A>,
  action: A,
) {
  const lane = requestUpdateLane(fiber);

  // åˆ›å»º Update å¯¹è±¡
  const update: Update<S, A> = {
    lane,
    action,
    eagerReducer: null,
    eagerState: null,
    next: null,  // åˆå§‹ä¸º null
  };

  // å°† Update æ’å…¥åˆ°ç¯å½¢é“¾è¡¨
  const pending = queue.pending;

  if (pending === null) {
    // ç¬¬ä¸€ä¸ª Updateï¼Œå½¢æˆç¯ï¼ˆæŒ‡å‘è‡ªå·±ï¼‰
    update.next = update;
  } else {
    // æ’å…¥åˆ°ç¯ä¸­ï¼š
    // æ–° update æŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œå°¾èŠ‚ç‚¹æŒ‡å‘æ–° update
    update.next = pending.next;
    pending.next = update;
  }

  // pending å§‹ç»ˆæŒ‡å‘æœ€æ–°çš„ Updateï¼ˆå°¾èŠ‚ç‚¹ï¼‰
  queue.pending = update;

  // ... åç»­è°ƒåº¦é€»è¾‘
}

/**
 * Effect é“¾è¡¨åˆ›å»º
 */
function pushEffect(tag, create, destroy, deps): Effect {
  const effect: Effect = {
    tag,
    create,
    destroy,
    deps,
    next: null,
  };

  let componentUpdateQueue = currentlyRenderingFiber.updateQueue;

  if (componentUpdateQueue === null) {
    // åˆ›å»º UpdateQueue å¹¶åˆå§‹åŒ–ç¯å½¢é“¾è¡¨
    componentUpdateQueue = createFunctionComponentUpdateQueue();
    currentlyRenderingFiber.updateQueue = componentUpdateQueue;
    componentUpdateQueue.lastEffect = effect.next = effect;  // æŒ‡å‘è‡ªå·±
  } else {
    const lastEffect = componentUpdateQueue.lastEffect;

    if (lastEffect === null) {
      componentUpdateQueue.lastEffect = effect.next = effect;
    } else {
      // æ’å…¥åˆ°ç¯ä¸­
      const firstEffect = lastEffect.next;
      lastEffect.next = effect;
      effect.next = firstEffect;
      componentUpdateQueue.lastEffect = effect;
    }
  }

  return effect;
}
```

**å…³é”®è¦ç‚¹ï¼š**

1. **Hooks é“¾è¡¨æ˜¯å•å‘çš„**ï¼š
   - é€šè¿‡ `next` æŒ‡é’ˆè¿æ¥
   - æŒ‚è½½æ—¶è¿½åŠ åˆ°å°¾éƒ¨ï¼ˆ`workInProgressHook.next = hook`ï¼‰
   - æ›´æ–°æ—¶æŒ‰é¡ºåºéå†ï¼ˆ`currentHook.next`ï¼‰

2. **Update é˜Ÿåˆ—æ˜¯ç¯å½¢é“¾è¡¨**ï¼š
   - `pending` æŒ‡å‘å°¾èŠ‚ç‚¹
   - `pending.next` æŒ‡å‘å¤´èŠ‚ç‚¹
   - æ’å…¥æ—¶ï¼šæ–°èŠ‚ç‚¹æŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œå°¾èŠ‚ç‚¹æŒ‡å‘æ–°èŠ‚ç‚¹

3. **Effect é“¾è¡¨ä¹Ÿæ˜¯ç¯å½¢é“¾è¡¨**ï¼š
   - `lastEffect` æŒ‡å‘å°¾èŠ‚ç‚¹
   - `lastEffect.next` æŒ‡å‘å¤´èŠ‚ç‚¹
   - ä¾¿äºå¿«é€Ÿæ’å…¥å’Œéå†

---

## 8. ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜1ï¼š"åŒå‘é“¾è¡¨å’Œæ•°ç»„æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå„è‡ªé€‚åˆä»€ä¹ˆåœºæ™¯ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"åŒå‘é“¾è¡¨å¯ä»¥å¿«é€Ÿæ’å…¥åˆ é™¤ï¼Œæ•°ç»„å¯ä»¥å¿«é€Ÿè®¿é—®å…ƒç´ ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **åŒå‘é“¾è¡¨å’Œæ•°ç»„çš„æ ¸å¿ƒåŒºåˆ«åœ¨äºå†…å­˜å¸ƒå±€å’Œæ“ä½œç‰¹æ€§ï¼š**
>
> 1. **å†…å­˜å¸ƒå±€ä¸åŒ**ï¼š
>    - æ•°ç»„ï¼šè¿ç»­å†…å­˜ï¼Œå…ƒç´ ç´§å¯†æ’åˆ—
>    - åŒå‘é“¾è¡¨ï¼šåˆ†æ•£å†…å­˜ï¼Œé€šè¿‡æŒ‡é’ˆè¿æ¥
>
> 2. **æ“ä½œå¤æ‚åº¦å¯¹æ¯”**ï¼š
>
> | æ“ä½œ | æ•°ç»„ | åŒå‘é“¾è¡¨ |
> |-----|------|---------|
> | éšæœºè®¿é—® arr[i] | O(1) | O(n)ï¼ˆéœ€è¦éå†ï¼‰ |
> | å¤´éƒ¨æ’å…¥/åˆ é™¤ | O(n)ï¼ˆéœ€è¦ç§»åŠ¨å…ƒç´ ï¼‰ | O(1) |
> | å°¾éƒ¨æ’å…¥/åˆ é™¤ | O(1)ï¼ˆamortizedï¼‰ | O(1) |
> | ä¸­é—´æ’å…¥/åˆ é™¤ï¼ˆå·²çŸ¥ä½ç½®ï¼‰ | O(n) | O(1) |
> | æŸ¥æ‰¾å…ƒç´  | O(n) | O(n) |
>
> 3. **ç©ºé—´å ç”¨**ï¼š
>    - æ•°ç»„ï¼šåªå­˜æ•°æ®ï¼Œç©ºé—´ç´§å‡‘
>    - åŒå‘é“¾è¡¨ï¼šæ¯ä¸ªèŠ‚ç‚¹é¢å¤–å­˜å‚¨ä¸¤ä¸ªæŒ‡é’ˆï¼Œç©ºé—´å ç”¨æ›´å¤§
>
> 4. **ç¼“å­˜å‹å¥½æ€§**ï¼š
>    - æ•°ç»„ï¼šè¿ç»­å†…å­˜ï¼Œç¼“å­˜å‘½ä¸­ç‡é«˜
>    - åŒå‘é“¾è¡¨ï¼šå†…å­˜åˆ†æ•£ï¼Œç¼“å­˜å‘½ä¸­ç‡ä½
>
> **é€‚ç”¨åœºæ™¯ï¼š**
>
> **æ•°ç»„é€‚åˆï¼š**
> - éœ€è¦é¢‘ç¹éšæœºè®¿é—®ï¼ˆå¦‚å›¾åƒå¤„ç†ã€çŸ©é˜µè¿ç®—ï¼‰
> - æ•°æ®é‡ç›¸å¯¹å›ºå®šï¼ˆå¦‚é…ç½®é¡¹ã€é™æ€åˆ—è¡¨ï¼‰
> - éœ€è¦éå†æ‰€æœ‰å…ƒç´ ï¼ˆç¼“å­˜å‹å¥½ï¼‰
>
> **åŒå‘é“¾è¡¨é€‚åˆï¼š**
> - é¢‘ç¹æ’å…¥/åˆ é™¤ï¼Œå°¤å…¶æ˜¯ä¸­é—´ä½ç½®ï¼ˆå¦‚ç¼–è¾‘å™¨çš„æ’¤é”€/é‡åšï¼‰
> - æ•°æ®é‡åŠ¨æ€å˜åŒ–ä¸”ä¸ç¡®å®šï¼ˆå¦‚ä»»åŠ¡é˜Ÿåˆ—ï¼‰
> - éœ€è¦åŒå‘éå†ï¼ˆå¦‚æµè§ˆå™¨å†å²è®°å½•ï¼‰
>
> **åœ¨ React æºç ä¸­çš„åº”ç”¨ï¼š**
>
> React æ ¹æ®åœºæ™¯é€‰æ‹©æ•°æ®ç»“æ„ï¼š
> - **Hooks é“¾è¡¨**ï¼šç»„ä»¶å†… Hooks æŒ‰é¡ºåºè°ƒç”¨ï¼Œä½¿ç”¨å•å‘é“¾è¡¨ï¼ˆæ— éœ€éšæœºè®¿é—®ï¼‰
> - **Effect é“¾è¡¨**ï¼šEffects éœ€è¦æŒ‰é¡ºåºæ‰§è¡Œï¼Œä½¿ç”¨ç¯å½¢é“¾è¡¨ï¼ˆæ–¹ä¾¿éå†ï¼‰
> - **children æ•°ç»„**ï¼šå­ç»„ä»¶å¯èƒ½éœ€è¦æŒ‰ç´¢å¼•è®¿é—®ï¼Œä½¿ç”¨æ•°ç»„
>
> ```javascript
> // Fiber èŠ‚ç‚¹çš„ children ç”¨æ•°ç»„è¡¨ç¤º
> const element = (
>   <div>
>     <span>A</span>  {/* children[0] */}
>     <span>B</span>  {/* children[1] */}
>   </div>
> );
>
> // ä½† Fiber ä¹‹é—´çš„è¿æ¥ç”¨é“¾è¡¨ï¼ˆchild/siblingï¼‰
> ```

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… ä»å¤šä¸ªç»´åº¦å¯¹æ¯”ï¼ˆå†…å­˜ã€æ—¶é—´ã€ç©ºé—´ã€ç¼“å­˜ï¼‰
2. âœ… æä¾›å…·ä½“çš„å¤æ‚åº¦å¯¹æ¯”è¡¨æ ¼
3. âœ… ç»™å‡ºå®é™…åº”ç”¨åœºæ™¯
4. âœ… ç»“åˆ React æºç å±•ç¤ºçœŸå®åº”ç”¨

---

### é—®é¢˜2ï¼š"React Hooks ä¸ºä»€ä¹ˆå¿…é¡»æŒ‰é¡ºåºè°ƒç”¨ï¼Ÿå’Œé“¾è¡¨æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"å› ä¸º Hooks ä¿å­˜åœ¨é“¾è¡¨é‡Œï¼Œé¡ºåºå˜äº†å°±æ‰¾ä¸åˆ°å¯¹åº”çš„ Hook äº†ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **Hooks å¿…é¡»æŒ‰é¡ºåºè°ƒç”¨çš„æ ¹æœ¬åŸå› æ˜¯ React ä½¿ç”¨å•å‘é“¾è¡¨å­˜å‚¨ Hooksï¼Œä¾èµ–è°ƒç”¨é¡ºåºæ¥åŒ¹é…å¯¹åº”çš„ Hookï¼š**
>
> 1. **Hooks çš„å­˜å‚¨ç»“æ„ï¼šå•å‘é“¾è¡¨**
>
> ```javascript
> // Fiber èŠ‚ç‚¹å­˜å‚¨ Hooks é“¾è¡¨
> fiber.memoizedState = {
>   memoizedState: 0,        // useState(0) çš„çŠ¶æ€
>   next: {
>     memoizedState: [],     // useState([]) çš„çŠ¶æ€
>     next: {
>       memoizedState: null, // useEffect(...) çš„çŠ¶æ€
>       next: null
>     }
>   }
> };
> ```
>
> 2. **æ›´æ–°æ—¶çš„åŒ¹é…æœºåˆ¶ï¼šæŒ‰ä½ç½®åŒ¹é…**
>
> React ä¸å­˜å‚¨ Hook çš„"åå­—"æˆ–"å”¯ä¸€æ ‡è¯†"ï¼Œè€Œæ˜¯**æŒ‰é“¾è¡¨ä½ç½®**åŒ¹é…ï¼š
>
> ```javascript
> // é¦–æ¬¡æ¸²æŸ“
> function MyComponent() {
>   const [count, setCount] = useState(0);      // Hook #0
>   const [name, setName] = useState('React');  // Hook #1
>   useEffect(() => { ... });                   // Hook #2
> }
>
> // æ›´æ–°æ¸²æŸ“
> function MyComponent() {
>   const [count, setCount] = useState(0);      // è¯»å– Hook #0 âœ…
>   const [name, setName] = useState('React');  // è¯»å– Hook #1 âœ…
>   useEffect(() => { ... });                   // è¯»å– Hook #2 âœ…
> }
> ```
>
> React æŒ‰é¡ºåºéå†é“¾è¡¨ï¼Œç¬¬1æ¬¡è°ƒç”¨å–é“¾è¡¨ç¬¬1ä¸ªèŠ‚ç‚¹ï¼Œç¬¬2æ¬¡è°ƒç”¨å–ç¬¬2ä¸ªèŠ‚ç‚¹...
>
> 3. **å¦‚æœé¡ºåºå˜äº†ä¼šæ€æ ·ï¼Ÿ**
>
> ```javascript
> // é¦–æ¬¡æ¸²æŸ“
> function MyComponent({ showName }) {
>   const [count, setCount] = useState(0);      // Hook #0: count
>
>   if (showName) {
>     const [name, setName] = useState('React'); // Hook #1: name
>   }
>
>   useEffect(() => { ... });                   // Hook #2 æˆ– #1ï¼ˆå–å†³äº showNameï¼‰
> }
>
> // å¦‚æœ showName ä» true å˜ false
> // Hook #0: count âœ…
> // Hook #1: useEffect âŒï¼ˆæœŸæœ›æ˜¯ nameï¼Œå®é™…æ˜¯ effectï¼‰
> // Hook #2: ç¼ºå¤± âŒï¼ˆæœŸæœ›æ˜¯ effectï¼Œä½†é“¾è¡¨å·²ç»“æŸï¼‰
> ```
>
> ç±»å‹ä¸åŒ¹é…ï¼ŒReact æŠ¥é”™ï¼š**Rendered fewer hooks than expected.**
>
> 4. **ä¸ºä»€ä¹ˆä¸ç”¨ Map æˆ–å¯¹è±¡å­˜å‚¨ï¼Ÿ**
>
> å¯ä»¥ç”¨ `{ count: Hook, name: Hook }` å­˜å‚¨ï¼Œä½†ï¼š
> - éœ€è¦ä¸ºæ¯ä¸ª Hook å‘½åï¼ˆéº»çƒ¦ä¸”å®¹æ˜“å†²çªï¼‰
> - Map æŸ¥æ‰¾è™½ç„¶æ˜¯ O(1)ï¼Œä½†æœ‰å“ˆå¸Œè®¡ç®—å¼€é”€
> - é“¾è¡¨æ›´ç®€å•ï¼Œè°ƒç”¨é¡ºåºå¤©ç„¶å°±æ˜¯"ç´¢å¼•"
>
> 5. **React å¦‚ä½•æ£€æµ‹é¡ºåºé”™è¯¯ï¼Ÿ**
>
> ```javascript
> // React æºç ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
> function updateWorkInProgressHook(): Hook {
>   let nextCurrentHook: Hook | null;
>
>   if (currentHook === null) {
>     // ç¬¬ä¸€ä¸ª Hook
>     nextCurrentHook = currentlyRenderingFiber.alternate.memoizedState;
>   } else {
>     // åç»­ Hookï¼Œå‘åç§»åŠ¨
>     nextCurrentHook = currentHook.next;
>   }
>
>   // æ£€æŸ¥é“¾è¡¨æ˜¯å¦è¿‡æ—©ç»“æŸ
>   if (nextCurrentHook === null) {
>     throw new Error('Rendered fewer hooks than expected.');
>   }
>
>   currentHook = nextCurrentHook;
>   // ...
> }
> ```
>
> **æ€»ç»“ï¼š**
>
> React Hooks çš„é¡ºåºè§„åˆ™æ˜¯**æ•°æ®ç»“æ„å†³å®šçš„è®¾è®¡çº¦æŸ**ï¼š
> - ä½¿ç”¨é“¾è¡¨å­˜å‚¨ Hooks
> - é€šè¿‡è°ƒç”¨é¡ºåºåŒ¹é…é“¾è¡¨ä½ç½®
> - é¡ºåºå˜åŒ–å¯¼è‡´åŒ¹é…é”™è¯¯
>
> è¿™æ˜¯ä¸€ç§"ç”¨ç®€å•çš„æ•°æ®ç»“æ„æ¢å–ä½¿ç”¨çº¦æŸ"çš„è®¾è®¡ï¼šç‰ºç‰²äº†çµæ´»æ€§ï¼ˆä¸èƒ½æ¡ä»¶è°ƒç”¨ï¼‰ï¼Œæ¢æ¥äº†å®ç°çš„ç®€æ´æ€§ã€‚

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**
1. âœ… æ·±å…¥æºç å±‚é¢è§£é‡ŠåŸç†
2. âœ… ç”¨å…·ä½“ç¤ºä¾‹å±•ç¤ºé¡ºåºå˜åŒ–çš„åæœ
3. âœ… æ¢è®¨äº†"ä¸ºä»€ä¹ˆä¸ç”¨å…¶ä»–æ•°æ®ç»“æ„"
4. âœ… å±•ç¤ºäº† React çš„è®¾è®¡æƒè¡¡æ€è€ƒ

---

## 9. ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šåŒå‘é“¾è¡¨çš„ç›´è§‰ç†è§£ ğŸ¯

**ä¸€å¥è¯ï¼š** åŒå‘é“¾è¡¨å°±æ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ½çŸ¥é“"å‰ä¸€ä¸ª"å’Œ"åä¸€ä¸ª"æ˜¯è°ã€‚

**ä¸¾ä¾‹ï¼š**

ç«è½¦è½¦å¢ï¼šæ¯èŠ‚è½¦å¢éƒ½æœ‰å‰åä¸¤ä¸ªè¿æ¥å™¨
- å‘å‰è¿æ¥å™¨ï¼ˆprevï¼‰ï¼šè¿æ¥å‰ä¸€èŠ‚è½¦å¢
- å‘åè¿æ¥å™¨ï¼ˆnextï¼‰ï¼šè¿æ¥åä¸€èŠ‚è½¦å¢

**åº”ç”¨ï¼š** React Fiber çš„ return æŒ‡é’ˆï¼ˆçˆ¶èŠ‚ç‚¹ï¼‰+ sibling æŒ‡é’ˆï¼ˆå…„å¼ŸèŠ‚ç‚¹ï¼‰= åŒå‘éå†

---

### å¡ç‰‡2ï¼šåŒå‘é“¾è¡¨ vs å•å‘é“¾è¡¨ âš–ï¸

**ä¸€å¥è¯ï¼š** åŒå‘é“¾è¡¨å¤šä¸€ä¸ª prev æŒ‡é’ˆï¼Œå¯ä»¥åŒå‘éå†å’Œå¿«é€Ÿåˆ é™¤ã€‚

**ä¸¾ä¾‹ï¼š**

```javascript
// å•å‘é“¾è¡¨ï¼šåªèƒ½å‘å‰èµ°
node -> node -> node -> null

// åŒå‘é“¾è¡¨ï¼šå¯ä»¥å‰åèµ°
null <- node <-> node <-> node -> null
```

**åº”ç”¨ï¼š** React Hooks ç”¨å•å‘é“¾è¡¨ï¼ˆåªéœ€æŒ‰é¡ºåºéå†ï¼‰ï¼ŒEffect é“¾è¡¨ç”¨ç¯å½¢é“¾è¡¨ï¼ˆéœ€è¦å¿«é€Ÿæ’å…¥ï¼‰

---

### å¡ç‰‡3ï¼šæ’å…¥èŠ‚ç‚¹çš„å››ä¸ªæŒ‡é’ˆ â•

**ä¸€å¥è¯ï¼š** åœ¨ A <-> B ä¹‹é—´æ’å…¥ Nï¼Œéœ€è¦ä¿®æ”¹ 4 ä¸ªæŒ‡é’ˆã€‚

**ä¸¾ä¾‹ï¼š**

```javascript
// æ’å…¥å‰ï¼šA <-> B
// æ’å…¥åï¼šA <-> N <-> B

N.prev = A;   // 1
N.next = B;   // 2
A.next = N;   // 3
B.prev = N;   // 4
```

**åº”ç”¨ï¼š** React pushEffect å‡½æ•°æ’å…¥æ–°çš„ Effect åˆ°é“¾è¡¨

---

### å¡ç‰‡4ï¼šåˆ é™¤èŠ‚ç‚¹çš„ä¸¤ä¸ªæŒ‡é’ˆ âŒ

**ä¸€å¥è¯ï¼š** åˆ é™¤ A <-> B <-> C ä¸­çš„ Bï¼Œåªéœ€ä¿®æ”¹ A å’Œ C çš„æŒ‡é’ˆã€‚

**ä¸¾ä¾‹ï¼š**

```javascript
// åˆ é™¤å‰ï¼šA <-> B <-> C
// åˆ é™¤åï¼šA <-> C

A.next = C;   // è·³è¿‡ B
C.prev = A;   // è·³è¿‡ B
B.prev = null;  // æ¸…ç©º B çš„æŒ‡é’ˆï¼ˆå¯é€‰ï¼‰
B.next = null;
```

**åº”ç”¨ï¼š** React å¸è½½ç»„ä»¶æ—¶æ¸…ç©º Fiber èŠ‚ç‚¹çš„æŒ‡é’ˆ

---

### å¡ç‰‡5ï¼šåŒå‘éå†çš„ä»·å€¼ ğŸ”„

**ä¸€å¥è¯ï¼š** åŒå‘é“¾è¡¨å¯ä»¥ä»ä»»æ„ä½ç½®å‘å‰æˆ–å‘åéå†ã€‚

**ä¸¾ä¾‹ï¼š**

```javascript
// å‘å‰éå†åˆ°å¤´èŠ‚ç‚¹
while (node.prev !== null) {
  node = node.prev;
}

// å‘åéå†åˆ°å°¾èŠ‚ç‚¹
while (node.next !== null) {
  node = node.next;
}
```

**åº”ç”¨ï¼š** æµè§ˆå™¨å†å²è®°å½•ï¼ˆåé€€/å‰è¿›æŒ‰é’®ï¼‰

---

### å¡ç‰‡6ï¼šç¯å½¢é“¾è¡¨çš„å·§å¦™ä¹‹å¤„ ğŸ”

**ä¸€å¥è¯ï¼š** å°¾èŠ‚ç‚¹çš„ next æŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œå½¢æˆç¯ï¼Œä¾¿äºå¿«é€Ÿæ’å…¥å’Œéå†ã€‚

**ä¸¾ä¾‹ï¼š**

```javascript
// ç¯å½¢é“¾è¡¨ï¼šA -> B -> C -> A
head.prev.next === head;  // true
tail.next === head;       // true
```

**åº”ç”¨ï¼š** React Hooks çš„ baseQueue å’Œ Effect é“¾è¡¨éƒ½æ˜¯ç¯å½¢

---

### å¡ç‰‡7ï¼šHooks é“¾è¡¨çš„è®¾è®¡ ğŸ“

**ä¸€å¥è¯ï¼š** React Hooks æŒ‰è°ƒç”¨é¡ºåºå½¢æˆå•å‘é“¾è¡¨ï¼Œé€šè¿‡ä½ç½®åŒ¹é… Hookã€‚

**ä¸¾ä¾‹ï¼š**

```javascript
// ç»„ä»¶ä¸­çš„ Hooks
useState(0);       // Hook #0
useState('hi');    // Hook #1
useEffect(...);    // Hook #2

// å¯¹åº”é“¾è¡¨
fiber.memoizedState -> Hook#0 -> Hook#1 -> Hook#2 -> null
```

**åº”ç”¨ï¼š** è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Hooks å¿…é¡»æŒ‰é¡ºåºè°ƒç”¨

---

### å¡ç‰‡8ï¼šEffect é“¾è¡¨çš„ç¯å½¢ç»“æ„ ğŸ¡

**ä¸€å¥è¯ï¼š** Effect é“¾è¡¨æ˜¯ç¯å½¢çš„ï¼ŒlastEffect æŒ‡å‘å°¾èŠ‚ç‚¹ï¼Œæ–¹ä¾¿æ’å…¥ã€‚

**ä¸¾ä¾‹ï¼š**

```javascript
// pending æŒ‡å‘å°¾èŠ‚ç‚¹
// pending.next æŒ‡å‘å¤´èŠ‚ç‚¹
pending.next = firstEffect;

// æ’å…¥æ–° Effect
newEffect.next = firstEffect;
pending.next = newEffect;
pending = newEffect;  // æ›´æ–°å°¾èŠ‚ç‚¹
```

**åº”ç”¨ï¼š** React dispatchAction æ’å…¥ Update åˆ°ç¯å½¢é˜Ÿåˆ—

---

### å¡ç‰‡9ï¼šé“¾è¡¨çš„ç©ºé—´å¤æ‚åº¦ ğŸ’¾

**ä¸€å¥è¯ï¼š** é“¾è¡¨çš„é¢å¤–ç©ºé—´æ˜¯ O(n)ï¼ˆæ¯ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆï¼‰ã€‚

**ä¸¾ä¾‹ï¼š**

```javascript
// å•å‘é“¾è¡¨ï¼šæ¯èŠ‚ç‚¹ 1 ä¸ªæŒ‡é’ˆ
// n ä¸ªèŠ‚ç‚¹ = n ä¸ª next æŒ‡é’ˆ

// åŒå‘é“¾è¡¨ï¼šæ¯èŠ‚ç‚¹ 2 ä¸ªæŒ‡é’ˆ
// n ä¸ªèŠ‚ç‚¹ = n ä¸ª prev + n ä¸ª next = 2n ä¸ªæŒ‡é’ˆ
```

**åº”ç”¨ï¼š** React ä¸ºäº†å¯ä¸­æ–­æ¸²æŸ“ï¼Œæ„¿æ„ç‰ºç‰²é¢å¤–ç©ºé—´å­˜å‚¨ Fiber é“¾è¡¨

---

### å¡ç‰‡10ï¼šæ€»ç»“ä¸å»¶ä¼¸ ğŸ“

**ä¸€å¥è¯ï¼š** åŒå‘é“¾è¡¨é€šè¿‡åŒæŒ‡é’ˆå®ç°é«˜æ•ˆæ’å…¥/åˆ é™¤å’ŒåŒå‘éå†ï¼Œæ˜¯ React æ•°æ®ç»“æ„çš„åŸºç¡€ã€‚

**æ ¸å¿ƒè¦ç‚¹ï¼š**

1. **èŠ‚ç‚¹ç»“æ„**ï¼šprev + next åŒæŒ‡é’ˆ
2. **æ“ä½œå¤æ‚åº¦**ï¼šæ’å…¥/åˆ é™¤ O(1)ï¼ˆå·²çŸ¥ä½ç½®ï¼‰
3. **ç¯å½¢é“¾è¡¨**ï¼šå°¾èŠ‚ç‚¹æŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œå½¢æˆç¯
4. **React åº”ç”¨**ï¼šFiber é“¾è¡¨ã€Hooks é“¾è¡¨ã€Effect é“¾è¡¨

**å»¶ä¼¸å­¦ä¹ ï¼š**
- å¾ªç¯é“¾è¡¨ vs ç¯å½¢é“¾è¡¨
- LRU ç¼“å­˜ï¼ˆåŒå‘é“¾è¡¨ + å“ˆå¸Œè¡¨ï¼‰
- React Fiber æ¶æ„çš„å®Œæ•´æ•°æ®ç»“æ„
- React Hooks çš„å®ç°åŸç†

---

## 10. ã€ä¸€å¥è¯æ€»ç»“ã€‘

**åŒå‘é“¾è¡¨æ˜¯æ¯ä¸ªèŠ‚ç‚¹é€šè¿‡ prev/next åŒæŒ‡é’ˆè¿æ¥å‰åèŠ‚ç‚¹çš„æ•°æ®ç»“æ„ï¼Œæ”¯æŒ O(1) æ’å…¥/åˆ é™¤å’ŒåŒå‘éå†ï¼ŒReact åœ¨ Fiber èŠ‚ç‚¹ï¼ˆreturn/child/siblingï¼‰ã€Hooks é“¾è¡¨ã€Effect é“¾è¡¨ä¸­å¹¿æ³›ä½¿ç”¨é“¾è¡¨æ€æƒ³å®ç°é«˜æ•ˆçš„çŠ¶æ€ç®¡ç†å’Œå‰¯ä½œç”¨è°ƒåº¦ã€‚**

---

## é™„å½•

### å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] ç†è§£åŒå‘é“¾è¡¨çš„èŠ‚ç‚¹ç»“æ„ï¼ˆprev + nextï¼‰
- [ ] æŒæ¡æ’å…¥æ“ä½œï¼ˆä¿®æ”¹ 4 ä¸ªæŒ‡é’ˆï¼‰
- [ ] æŒæ¡åˆ é™¤æ“ä½œï¼ˆä¿®æ”¹ 2 ä¸ªæŒ‡é’ˆï¼‰
- [ ] ç†è§£ç¯å½¢é“¾è¡¨çš„ç‰¹ç‚¹ï¼ˆå°¾èŠ‚ç‚¹æŒ‡å‘å¤´èŠ‚ç‚¹ï¼‰
- [ ] ç†è§£ React Hooks é“¾è¡¨çš„å­˜å‚¨ç»“æ„
- [ ] çŸ¥é“ä¸ºä»€ä¹ˆ Hooks å¿…é¡»æŒ‰é¡ºåºè°ƒç”¨
- [ ] ç†è§£ React Effect é“¾è¡¨çš„ç¯å½¢ç»“æ„
- [ ] èƒ½å¤Ÿåˆ†æé“¾è¡¨æ“ä½œçš„æ—¶é—´å¤æ‚åº¦

### ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®

1. **ä½è¿ç®—ä¸ä¼˜å…ˆçº§**ï¼šå­¦ä¹  React Lane æ¨¡å‹ä¸­çš„ä½è¿ç®—
2. **LRU ç¼“å­˜**ï¼šåŒå‘é“¾è¡¨çš„ç»å…¸åº”ç”¨
3. **React Fiber æ¶æ„**ï¼šæ·±å…¥ç†è§£ Fiber æ ‘çš„ä¸‰æŒ‡é’ˆç»“æ„
4. **React Hooks å®ç°**ï¼šå­¦ä¹  Hooks çš„å®Œæ•´å®ç°åŸç†

### å¿«é€Ÿå‚è€ƒå¡

| é“¾è¡¨æ¦‚å¿µ | å…³é”®ç‚¹ | React åº”ç”¨ |
|---------|--------|------------|
| åŒå‘é“¾è¡¨èŠ‚ç‚¹ | prev + next | Fiber çš„ return/sibling |
| å•å‘é“¾è¡¨ | åªæœ‰ next | Hooks é“¾è¡¨ |
| ç¯å½¢é“¾è¡¨ | tail.next = head | Effect é“¾è¡¨ã€Update é˜Ÿåˆ— |
| æ’å…¥æ“ä½œ | ä¿®æ”¹ 4 ä¸ªæŒ‡é’ˆï¼ˆO(1)ï¼‰ | pushEffect |
| åˆ é™¤æ“ä½œ | ä¿®æ”¹ 2 ä¸ªæŒ‡é’ˆï¼ˆO(1)ï¼‰ | detachFiber |
| éå† | æ²¿ç€ next/prev æŒ‡é’ˆ | workLoop |
| é¡ºåºä¾èµ– | é“¾è¡¨ä½ç½® = è°ƒç”¨é¡ºåº | Hooks è§„åˆ™ |
| ç©ºé—´å¤æ‚åº¦ | O(n)ï¼ˆé¢å¤–æŒ‡é’ˆï¼‰ | Fiber æ ‘çš„å†…å­˜å ç”¨ |

---

**ç‰ˆæœ¬ï¼š** v1.0
**åˆ›å»ºæ—¥æœŸï¼š** 2025-12-06
**é€‚ç”¨äºï¼š** React 19 æºç å­¦ä¹ 
**å‰ç½®çŸ¥è¯†ï¼š** JavaScript åŸºç¡€ã€æ•°æ®ç»“æ„åŸºç¡€
**åç»­å­¦ä¹ ï¼š** ä½è¿ç®—ã€Fiber æ¶æ„ã€Hooks å®ç°
