# åŒç¼“å†²æœºåˆ¶

## ä¸€ã€ã€30å­—æ ¸å¿ƒã€‘

**åŒç¼“å†²æœºåˆ¶é€šè¿‡currentæ ‘ï¼ˆå±å¹•æ˜¾ç¤ºï¼‰å’ŒworkInProgressæ ‘ï¼ˆå†…å­˜æ„å»ºï¼‰äº’ç›¸åˆ‡æ¢ï¼Œç”¨alternateåŒå‘è¿æ¥ï¼Œå®ç°æ— é—ªçƒæ›´æ–°ã€‚**

---

## äºŒã€ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### åŒç¼“å†²æœºåˆ¶çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**åŒç¼“å†² = ä¸¤ä¸ªç¼“å†²åŒº + äº¤æ›¿ä½¿ç”¨ + ä¸€æ¬¡æ€§åˆ‡æ¢**

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

åŒç¼“å†²çš„æ ¸å¿ƒæ€æƒ³ï¼šç”¨æˆ·çœ‹ä¸€ä¸ªï¼Œæˆ‘ä»¬æ”¹å¦ä¸€ä¸ªï¼Œæ”¹å®Œåä¸€æ¬¡æ€§åˆ‡æ¢ã€‚è¿™æ ·ç”¨æˆ·æ°¸è¿œçœ‹åˆ°çš„æ˜¯å®Œæ•´çš„ç”»é¢ï¼Œä¸ä¼šçœ‹åˆ°"æ”¹åˆ°ä¸€åŠ"çš„ä¸­é—´çŠ¶æ€ã€‚

#### 2. ä¸ºä»€ä¹ˆéœ€è¦åŒç¼“å†²æœºåˆ¶ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•é¿å…ç”¨æˆ·çœ‹åˆ°UIæ›´æ–°çš„ä¸­é—´è¿‡ç¨‹ï¼Ÿ**

æƒ³è±¡ä¸€ä¸‹å¦‚æœæ²¡æœ‰åŒç¼“å†²ä¼šæ€æ ·ï¼š

```javascript
// æ²¡æœ‰åŒç¼“å†²ï¼šç›´æ¥åœ¨å½“å‰æ ‘ä¸Šä¿®æ”¹
function updateWithoutDoubleBuffer(fiber) {
  // 1. åˆ é™¤æ—§å­èŠ‚ç‚¹
  removeOldChildren(fiber);           // â† ç”¨æˆ·çœ‹åˆ°ç©ºç™½ï¼

  // 2. åˆ›å»ºæ–°å­èŠ‚ç‚¹ï¼ˆè€—æ—¶æ“ä½œï¼‰
  createNewChildren(fiber);           // â† ç”¨æˆ·çœ‹åˆ°é€ä¸ªæ·»åŠ ï¼

  // 3. æ›´æ–°DOMå±æ€§
  updateDOMProperties(fiber);         // â† ç”¨æˆ·çœ‹åˆ°å±æ€§å˜åŒ–è¿‡ç¨‹ï¼
}

// ç”¨æˆ·ä½“éªŒï¼š
// [æœ‰å†…å®¹] â†’ [ç©ºç™½] â†’ [éƒ¨åˆ†å†…å®¹] â†’ [éƒ¨åˆ†å†…å®¹] â†’ [å®Œæ•´å†…å®¹]
//           â†‘ é—ªçƒï¼      â†‘ æŠ–åŠ¨ï¼        â†‘ å¸ƒå±€è·³åŠ¨ï¼
```

**é—®é¢˜æ‰€åœ¨ï¼š**
- **è§†è§‰é—ªçƒ**ï¼šåˆ é™¤æ—§å†…å®¹åˆ°æ·»åŠ æ–°å†…å®¹ä¹‹é—´æœ‰ç©ºç™½æœŸ
- **å¸ƒå±€æŠ–åŠ¨**ï¼šé€ä¸ªæ·»åŠ å…ƒç´ å¯¼è‡´å¸ƒå±€åå¤è®¡ç®—
- **ä¸­é—´çŠ¶æ€å¯è§**ï¼šç”¨æˆ·çœ‹åˆ°ä¸å®Œæ•´çš„UI

**Reactéœ€è¦çš„èƒ½åŠ›ï¼š**
- åœ¨åå°æ„å»ºæ–°UIï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
- æ„å»ºå®Œæˆåï¼Œä¸€æ¬¡æ€§åˆ‡æ¢ï¼Œç¬é—´å®Œæˆ
- æ—§UIå¯ä»¥å¤ç”¨ï¼Œå‡å°‘åˆ›å»º/é”€æ¯æˆæœ¬

#### 3. åŒç¼“å†²çš„ä¸‰å±‚ä»·å€¼

##### ä»·å€¼1ï¼šæ— é—ªçƒæ›´æ–° âœ¨

ç”¨æˆ·å§‹ç»ˆçœ‹åˆ°å®Œæ•´çš„UIï¼Œæ›´æ–°è¿‡ç¨‹åœ¨åå°è¿›è¡Œï¼š

```javascript
// åŒç¼“å†²æœºåˆ¶
const currentTree = {
  type: 'div',
  children: ['æ—§å†…å®¹1', 'æ—§å†…å®¹2'],
  isVisible: true        // ç”¨æˆ·çœ‹å¾—åˆ°
};

const workInProgressTree = {
  type: 'div',
  children: ['æ–°å†…å®¹1', 'æ–°å†…å®¹2', 'æ–°å†…å®¹3'],
  isVisible: false       // ç”¨æˆ·çœ‹ä¸åˆ°
};

// æ„å»ºæ–°æ ‘ï¼ˆç”¨æˆ·æ— æ„ŸçŸ¥ï¼‰
buildNewTree(workInProgressTree);  // åœ¨å†…å­˜ä¸­è¿›è¡Œ

// æ„å»ºå®Œæˆåï¼Œä¸€æ¬¡æ€§åˆ‡æ¢
function commitRoot() {
  currentTree.isVisible = false;
  workInProgressTree.isVisible = true;

  // ç”¨æˆ·ä½“éªŒï¼š[æ—§UI] â†’ [æ–°UI]ï¼ˆç¬é—´åˆ‡æ¢ï¼Œæ— ä¸­é—´çŠ¶æ€ï¼‰
}
```

##### ä»·å€¼2ï¼šæ€§èƒ½ä¼˜åŒ– ğŸš€

é€šè¿‡alternateå¤ç”¨FiberèŠ‚ç‚¹ï¼Œé¿å…é¢‘ç¹åˆ›å»º/é”€æ¯å¯¹è±¡ï¼š

```javascript
// ç¬¬ä¸€æ¬¡æ›´æ–°ï¼šåˆ›å»ºworkInProgressæ ‘
const current = { type: 'div', alternate: null };
const workInProgress = { type: 'div', alternate: current };
current.alternate = workInProgress;

// commitåï¼ŒworkInProgresså˜æˆæ–°çš„current
root.current = workInProgress;

// ç¬¬äºŒæ¬¡æ›´æ–°ï¼šç›´æ¥å¤ç”¨åŸæ¥çš„currentï¼ˆç°åœ¨æ˜¯alternateï¼‰
const newWorkInProgress = current;  // å¤ç”¨å¯¹è±¡ï¼
newWorkInProgress.props = newProps;  // åªæ›´æ–°å˜åŒ–çš„å­—æ®µ

// å¤ç”¨ç‡æé«˜ï¼š
// - æœªå˜åŒ–çš„èŠ‚ç‚¹ï¼šå®Œå…¨å¤ç”¨ï¼ˆè¿propséƒ½ä¸æ›´æ–°ï¼‰
// - å˜åŒ–çš„èŠ‚ç‚¹ï¼šå¤ç”¨å¯¹è±¡ï¼Œåªæ›´æ–°å­—æ®µ
// - æ–°å¢çš„èŠ‚ç‚¹ï¼šæ‰åˆ›å»ºæ–°å¯¹è±¡
```

**æ€§èƒ½æ•°æ®ï¼ˆå‡è®¾ï¼‰ï¼š**
- æ— å¤ç”¨ï¼šæ¯æ¬¡æ›´æ–°åˆ›å»º1000ä¸ªå¯¹è±¡ â†’ GCå‹åŠ›å¤§
- åŒç¼“å†²å¤ç”¨ï¼šæ¯æ¬¡æ›´æ–°åˆ›å»º10ä¸ªå¯¹è±¡ â†’ GCå‹åŠ›å°90%

##### ä»·å€¼3ï¼šæ”¯æŒå¯ä¸­æ–­æ¸²æŸ“ â¸ï¸

åœ¨workInProgressæ ‘ä¸Šå·¥ä½œï¼Œéšæ—¶å¯ä»¥åºŸå¼ƒé‡æ¥ï¼š

```javascript
// åœºæ™¯ï¼šæ­£åœ¨æ„å»ºæ–°æ ‘ï¼Œçªç„¶æ¥äº†é«˜ä¼˜å…ˆçº§æ›´æ–°

// 1. æ­£åœ¨æ„å»ºworkInProgressæ ‘
let workInProgress = createWorkInProgress(current, lowPriorityProps);
buildTreePartially(workInProgress);  // æ„å»ºåˆ°ä¸€åŠ...

// 2. é«˜ä¼˜å…ˆçº§æ›´æ–°åˆ°æ¥
if (hasHighPriorityUpdate()) {
  // ç›´æ¥åºŸå¼ƒå½“å‰workInProgress
  workInProgress = null;

  // é‡æ–°ä»currentåˆ›å»ºæ–°çš„workInProgress
  workInProgress = createWorkInProgress(current, highPriorityProps);
  buildTree(workInProgress);  // é‡æ–°æ„å»º
}

// 3. currentæ ‘å§‹ç»ˆå®Œæ•´ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥

// å¦‚æœæ²¡æœ‰åŒç¼“å†²ï¼š
// - æ— æ³•åºŸå¼ƒï¼ˆåªæœ‰ä¸€æ£µæ ‘ï¼ŒåºŸå¼ƒåç”¨æˆ·çœ‹åˆ°ç©ºç™½ï¼‰
// - æ— æ³•ä¸­æ–­ï¼ˆä¸­æ–­åæ ‘æ˜¯ä¸å®Œæ•´çš„ï¼‰
```

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼ React å®ç°

**æ¨ç†é“¾ï¼š**

```
1. Reactéœ€è¦æ›´æ–°UIï¼Œä½†ä¸èƒ½è®©ç”¨æˆ·çœ‹åˆ°ä¸­é—´è¿‡ç¨‹
   â†“
2. éœ€è¦ä¸€ä¸ª"åå°åŒºåŸŸ"æ„å»ºæ–°UI
   â†“
3. åˆ›å»ºworkInProgressæ ‘åœ¨å†…å­˜ä¸­æ„å»º
   â†“
4. éœ€è¦ä¿ç•™å½“å‰UIä¾›ç”¨æˆ·æŸ¥çœ‹
   â†“
5. ä¿ç•™currentæ ‘æ˜¾ç¤ºåœ¨å±å¹•ä¸Š
   â†“
6. ä¸¤æ£µæ ‘éœ€è¦å…³è”ï¼ˆæ–°æ ‘åŸºäºæ—§æ ‘æ„å»ºï¼‰
   â†“
7. ç”¨alternateæŒ‡é’ˆè¿æ¥åŒæ ‘
   â†“
8. æ„å»ºå®Œæˆåéœ€è¦åˆ‡æ¢
   â†“
9. ä¿®æ”¹root.currentæŒ‡é’ˆï¼ˆO(1)æ—¶é—´ï¼‰
   â†“
10. æ—§æ ‘ä¸åˆ é™¤ï¼Œæˆä¸ºä¸‹æ¬¡æ›´æ–°çš„workInProgressåŸºç¡€
   â†“
11. å®ç°äº†åŒç¼“å†²æœºåˆ¶
```

**ä¸ºä»€ä¹ˆReactçš„åŒç¼“å†²è®¾è®¡å¦‚æ­¤æˆåŠŸï¼Ÿ**

1. **æŒ‡é’ˆåˆ‡æ¢æˆæœ¬æä½**ï¼šO(1)æ—¶é—´ï¼Œä¸€è¡Œä»£ç å®Œæˆåˆ‡æ¢
2. **å†…å­˜å¤ç”¨ç‡æé«˜**ï¼šä¸¤æ£µæ ‘è½®æµæ‰®æ¼”è§’è‰²ï¼Œå¯¹è±¡å¤ç”¨ç‡90%+
3. **å¤©ç„¶æ”¯æŒä¸­æ–­**ï¼šworkInProgresså¯åºŸå¼ƒï¼Œcurrentå§‹ç»ˆå®Œæ•´
4. **å¤©ç„¶æ”¯æŒå›æ»š**ï¼šå‡ºé”™æ—¶ï¼Œä¸¢å¼ƒworkInProgressï¼Œcurrentä¸å—å½±å“
5. **å¤©ç„¶æ”¯æŒbailout**ï¼šå¯¹æ¯”currentå’ŒworkInProgressçš„propsï¼Œå†³å®šæ˜¯å¦è·³è¿‡

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**åŒç¼“å†²æœºåˆ¶é€šè¿‡ç»´æŠ¤currentå’ŒworkInProgressä¸¤æ£µFiberæ ‘ï¼Œåœ¨workInProgressä¸Šæ„å»ºæ–°UIï¼Œç”¨æˆ·æŸ¥çœ‹currentï¼Œæ„å»ºå®Œæˆåé€šè¿‡æŒ‡é’ˆåˆ‡æ¢å®ç°æ— é—ªçƒæ›´æ–°ï¼Œé€šè¿‡alternateè¿æ¥å®ç°å¯¹è±¡å¤ç”¨ï¼Œæ˜¯Reacté«˜æ€§èƒ½ã€å¯ä¸­æ–­æ¸²æŸ“çš„åŸºçŸ³ã€‚**

---

## ä¸‰ã€ã€3ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šcurrentæ ‘ vs workInProgressæ ‘ ğŸŒ²ğŸŒ²

**currentæ ‘æ˜¯å½“å‰å±å¹•æ˜¾ç¤ºçš„Fiberæ ‘ï¼ŒworkInProgressæ ‘æ˜¯å†…å­˜ä¸­æ­£åœ¨æ„å»ºçš„æ–°Fiberæ ‘ï¼Œä¸¤è€…é€šè¿‡alternateæŒ‡é’ˆåŒå‘è¿æ¥ã€‚**

```javascript
// ===== 1. åŒæ ‘çš„å®šä¹‰ =====

// currentæ ‘ï¼šå½“å‰å±å¹•æ˜¾ç¤ºçš„UI
const currentTree = {
  type: 'div',
  props: { className: 'old' },
  child: currentChild,
  sibling: null,
  return: null,
  alternate: null,  // æŒ‡å‘workInProgressæ ‘
  stateNode: realDOMNode  // çœŸå®DOMèŠ‚ç‚¹å¼•ç”¨
};

// workInProgressæ ‘ï¼šå†…å­˜ä¸­æ­£åœ¨æ„å»ºçš„æ–°UI
const workInProgressTree = {
  type: 'div',
  props: { className: 'new' },
  child: workInProgressChild,
  sibling: null,
  return: null,
  alternate: null,  // æŒ‡å‘currentæ ‘
  stateNode: realDOMNode  // å¤ç”¨åŒä¸€ä¸ªDOMèŠ‚ç‚¹ï¼
};

// ===== 2. åŒæ ‘çš„è§’è‰² =====

// FiberRootNodeï¼ˆæ ¹èŠ‚ç‚¹ï¼‰
const root = {
  current: currentTree,           // æŒ‡å‘å½“å‰æ ‘
  finishedWork: null              // æŒ‡å‘å®Œæˆçš„workInProgressæ ‘
};

// renderé˜¶æ®µï¼šåœ¨workInProgressæ ‘ä¸Šå·¥ä½œ
function renderPhase() {
  let workInProgress = root.current.alternate;

  if (workInProgress === null) {
    // é¦–æ¬¡æ¸²æŸ“æˆ–å¤ç”¨ä¸å¯ç”¨ï¼Œåˆ›å»ºæ–°æ ‘
    workInProgress = createWorkInProgress(root.current, newProps);
  }

  // åœ¨workInProgressæ ‘ä¸Šè¿›è¡Œreconcile
  workLoopSync(workInProgress);

  // å®Œæˆåä¿å­˜åˆ°finishedWork
  root.finishedWork = workInProgress;
}

// commité˜¶æ®µï¼šåˆ‡æ¢æŒ‡é’ˆ
function commitPhase() {
  const finishedWork = root.finishedWork;

  // æ‰§è¡ŒDOMæ“ä½œ...

  // åˆ‡æ¢æŒ‡é’ˆï¼šworkInProgresså˜æˆæ–°çš„current
  root.current = finishedWork;

  // æ­¤æ—¶ï¼š
  // - root.currentæŒ‡å‘æ–°æ ‘ï¼ˆç”¨æˆ·çœ‹åˆ°çš„ï¼‰
  // - æ—§æ ‘é€šè¿‡alternateå¯è®¿é—®ï¼ˆä¸‹æ¬¡å¤ç”¨ï¼‰
}

// ===== 3. åŒæ ‘çš„ç”Ÿå‘½å‘¨æœŸ =====

console.log('=== åŒæ ‘çš„ç”Ÿå‘½å‘¨æœŸ ===');

// åˆå§‹çŠ¶æ€ï¼šåªæœ‰currentæ ‘
let state1 = {
  current: { type: 'div', props: { text: 'v1' }, alternate: null }
};
console.log('çŠ¶æ€1ï¼ˆåˆå§‹ï¼‰:', state1.current.props.text);  // v1

// ç¬¬ä¸€æ¬¡æ›´æ–°ï¼šåˆ›å»ºworkInProgressæ ‘
let workInProgress1 = {
  type: 'div',
  props: { text: 'v2' },
  alternate: state1.current
};
state1.current.alternate = workInProgress1;
console.log('ç¬¬ä¸€æ¬¡æ›´æ–°ï¼šæ„å»ºworkInProgressæ ‘');

// commitååˆ‡æ¢
state1.current = workInProgress1;
console.log('çŠ¶æ€2ï¼ˆç¬¬ä¸€æ¬¡æ›´æ–°åï¼‰:', state1.current.props.text);  // v2

// ç¬¬äºŒæ¬¡æ›´æ–°ï¼šå¤ç”¨æ—§æ ‘ï¼ˆåŸæ¥çš„currentï¼‰
let workInProgress2 = workInProgress1.alternate;  // å¤ç”¨ï¼
workInProgress2.props = { text: 'v3' };
console.log('ç¬¬äºŒæ¬¡æ›´æ–°ï¼šå¤ç”¨æ—§æ ‘');

// commitåå†æ¬¡åˆ‡æ¢
state1.current = workInProgress2;
console.log('çŠ¶æ€3ï¼ˆç¬¬äºŒæ¬¡æ›´æ–°åï¼‰:', state1.current.props.text);  // v3
```

**è¯¦ç»†è§£é‡Šï¼š**

**åŒæ ‘çš„åˆ†å·¥ï¼š**

| æ ‘ | è§’è‰² | å¯è§æ€§ | ç”¨é€” | DOMå¼•ç”¨ |
|----|------|--------|------|---------|
| **current** | å½“å‰æ˜¾ç¤ºçš„UI | ç”¨æˆ·å¯è§ | æ¸²æŸ“åˆ°å±å¹• | æœ‰çœŸå®DOM |
| **workInProgress** | æ­£åœ¨æ„å»ºçš„UI | ç”¨æˆ·ä¸å¯è§ | åå°è®¡ç®— | å¤ç”¨currentçš„DOMæˆ–åˆ›å»ºæ–°DOM |

**åŒæ ‘çš„åˆ‡æ¢æ—¶æœºï¼š**

```
renderé˜¶æ®µå¼€å§‹
  â†“
åˆ›å»º/å¤ç”¨workInProgressæ ‘
  â†“
åœ¨workInProgressä¸Šè¿›è¡Œreconcileï¼ˆdiffã€åˆ›å»ºFiberèŠ‚ç‚¹ï¼‰
  â†“
renderé˜¶æ®µç»“æŸï¼ŒworkInProgressæ ‘æ„å»ºå®Œæˆ
  â†“
commité˜¶æ®µå¼€å§‹
  â†“
æ‰§è¡ŒDOMæ“ä½œï¼ˆæ’å…¥ã€æ›´æ–°ã€åˆ é™¤ï¼‰
  â†“
åˆ‡æ¢æŒ‡é’ˆï¼šroot.current = workInProgress
  â†“
commité˜¶æ®µç»“æŸ
  â†“
è§’è‰²äº’æ¢ï¼š
  - æ–°current = åŸworkInProgress
  - æ–°workInProgressåŸºç¡€ = åŸcurrent
```

**åœ¨ React æºç ä¸­çš„åº”ç”¨ï¼š**

```javascript
// packages/react-reconciler/src/ReactFiberWorkLoop.js

function prepareFreshStack(root, lanes) {
  root.finishedWork = null;
  root.finishedLanes = NoLanes;

  // ä»currentåˆ›å»ºworkInProgress
  let workInProgress = createWorkInProgress(root.current, null);
  return workInProgress;
}

function commitRoot(root) {
  const finishedWork = root.finishedWork;
  const lanes = root.finishedLanes;

  // commité˜¶æ®µçš„ä¸‰ä¸ªå­é˜¶æ®µ
  commitBeforeMutationEffects(root, finishedWork);
  commitMutationEffects(root, finishedWork, lanes);
  commitLayoutEffects(finishedWork, root, lanes);

  // åˆ‡æ¢æŒ‡é’ˆ
  root.current = finishedWork;
}
```

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šalternateåŒå‘ç»‘å®šæœºåˆ¶ ğŸ”—

**æ¯ä¸ªFiberèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªalternateæŒ‡é’ˆï¼Œcurrentæ ‘çš„èŠ‚ç‚¹å’ŒworkInProgressæ ‘çš„å¯¹åº”èŠ‚ç‚¹é€šè¿‡alternateç›¸äº’å¼•ç”¨ï¼Œå½¢æˆåŒå‘ç»‘å®šã€‚**

```javascript
// ===== 1. alternateçš„åŒå‘ç»‘å®š =====

const currentFiber = {
  type: 'div',
  key: null,
  props: { id: 'root' },
  memoizedState: { count: 0 },
  alternate: null
};

const workInProgressFiber = {
  type: 'div',
  key: null,
  props: { id: 'root' },
  memoizedState: { count: 1 },
  alternate: null
};

// å»ºç«‹åŒå‘è¿æ¥
currentFiber.alternate = workInProgressFiber;
workInProgressFiber.alternate = currentFiber;

console.log('åŒå‘ç»‘å®šéªŒè¯:');
console.log('current.alternate === workInProgress:', currentFiber.alternate === workInProgressFiber);  // true
console.log('workInProgress.alternate === current:', workInProgressFiber.alternate === currentFiber);  // true

// ===== 2. createWorkInProgresså‡½æ•° =====

function createWorkInProgress(current, pendingProps) {
  let workInProgress = current.alternate;

  if (workInProgress === null) {
    // é¦–æ¬¡æ›´æ–°ï¼šåˆ›å»ºæ–°FiberèŠ‚ç‚¹
    console.log('é¦–æ¬¡æ›´æ–°ï¼šåˆ›å»ºæ–°çš„workInProgressèŠ‚ç‚¹');

    workInProgress = {
      tag: current.tag,
      type: current.type,
      key: current.key,
      stateNode: current.stateNode,  // å¤ç”¨DOMèŠ‚ç‚¹ï¼

      return: null,
      child: null,
      sibling: null,

      pendingProps: pendingProps,
      memoizedProps: null,
      memoizedState: null,

      alternate: current,  // æŒ‡å‘current
      flags: 0
    };

    // currentä¹ŸæŒ‡å‘workInProgress
    current.alternate = workInProgress;
  } else {
    // åç»­æ›´æ–°ï¼šå¤ç”¨å·²æœ‰çš„alternateèŠ‚ç‚¹
    console.log('åç»­æ›´æ–°ï¼šå¤ç”¨å·²æœ‰çš„alternateèŠ‚ç‚¹');

    workInProgress.pendingProps = pendingProps;
    workInProgress.type = current.type;

    // é‡ç½®å‰¯ä½œç”¨
    workInProgress.flags = 0;
    workInProgress.subtreeFlags = 0;
    workInProgress.deletions = null;
  }

  // å¤ç”¨ä¸å˜çš„å­—æ®µ
  workInProgress.childLanes = current.childLanes;
  workInProgress.lanes = current.lanes;

  workInProgress.child = current.child;
  workInProgress.memoizedProps = current.memoizedProps;
  workInProgress.memoizedState = current.memoizedState;

  return workInProgress;
}

// ===== 3. å®Œæ•´çš„æ›´æ–°å‘¨æœŸæ¼”ç¤º =====

console.log('\n=== å®Œæ•´çš„æ›´æ–°å‘¨æœŸ ===');

// åˆå§‹çŠ¶æ€
let root = {
  current: {
    type: 'App',
    props: { version: 1 },
    alternate: null
  }
};

console.log('åˆå§‹ç‰ˆæœ¬:', root.current.props.version);

// ç¬¬ä¸€æ¬¡æ›´æ–°
console.log('\n--- ç¬¬ä¸€æ¬¡æ›´æ–° ---');
let wip1 = createWorkInProgress(root.current, { version: 2 });
console.log('workInProgressç‰ˆæœ¬:', wip1.pendingProps.version);
console.log('current.alternate === workInProgress:', root.current.alternate === wip1);

// commit
root.current = wip1;
console.log('commitåç‰ˆæœ¬:', root.current.props.version);

// ç¬¬äºŒæ¬¡æ›´æ–°ï¼ˆå¤ç”¨ï¼‰
console.log('\n--- ç¬¬äºŒæ¬¡æ›´æ–°ï¼ˆå¤ç”¨ï¼‰---');
let wip2 = createWorkInProgress(root.current, { version: 3 });
console.log('workInProgressç‰ˆæœ¬:', wip2.pendingProps.version);
console.log('å¤ç”¨äº†åŸæ¥çš„FiberèŠ‚ç‚¹:', wip2 === root.current.alternate);

// commit
root.current = wip2;
console.log('commitåç‰ˆæœ¬:', root.current.props.version);

// ===== 4. alternateçš„ä¸‰å¤§ç”¨é€” =====

function demonstrateAlternateUsages(current, workInProgress) {
  console.log('\n=== alternateçš„ä¸‰å¤§ç”¨é€” ===');

  // ç”¨é€”1ï¼šå¤ç”¨FiberèŠ‚ç‚¹
  console.log('ç”¨é€”1ï¼šå¤ç”¨FiberèŠ‚ç‚¹');
  if (current.alternate !== null) {
    console.log('  â†’ å¤ç”¨å·²æœ‰èŠ‚ç‚¹ï¼Œé¿å…åˆ›å»ºæ–°å¯¹è±¡');
  }

  // ç”¨é€”2ï¼šå¯¹æ¯”propsï¼ˆbailoutä¼˜åŒ–ï¼‰
  console.log('ç”¨é€”2ï¼šå¯¹æ¯”propsï¼ˆbailoutä¼˜åŒ–ï¼‰');
  if (current.memoizedProps === workInProgress.pendingProps) {
    console.log('  â†’ propsæœªå˜åŒ–ï¼Œè·³è¿‡å­æ ‘æ›´æ–°');
    return bailoutOnAlreadyFinishedWork(current, workInProgress);
  }

  // ç”¨é€”3ï¼šé”™è¯¯æ¢å¤
  console.log('ç”¨é€”3ï¼šé”™è¯¯æ¢å¤');
  try {
    updateComponent(workInProgress);
  } catch (error) {
    console.log('  â†’ æ›´æ–°å‡ºé”™ï¼Œä¸¢å¼ƒworkInProgressï¼Œcurrentä¸å—å½±å“');
    workInProgress = null;
    // currentæ ‘ä¾ç„¶å®Œæ•´ï¼Œç”¨æˆ·çœ‹åˆ°çš„UIä¸å˜
  }
}

function bailoutOnAlreadyFinishedWork(current, workInProgress) {
  // è·³è¿‡å½“å‰èŠ‚ç‚¹ï¼Œä½†æ£€æŸ¥å­èŠ‚ç‚¹æ˜¯å¦éœ€è¦æ›´æ–°
  if ((current.childLanes & renderLanes) === 0) {
    // å­æ ‘ä¹Ÿä¸éœ€è¦æ›´æ–°ï¼Œç›´æ¥è¿”å›
    return null;
  }

  // å­æ ‘éœ€è¦æ›´æ–°ï¼Œå¤ç”¨å­èŠ‚ç‚¹
  cloneChildFibers(current, workInProgress);
  return workInProgress.child;
}

function updateComponent(workInProgress) {
  // æ¨¡æ‹Ÿç»„ä»¶æ›´æ–°é€»è¾‘
  console.log('  â†’ æ›´æ–°ç»„ä»¶...');
}

function cloneChildFibers(current, workInProgress) {
  // å¤ç”¨å­FiberèŠ‚ç‚¹
  workInProgress.child = current.child;
}
```

**è¯¦ç»†è§£é‡Šï¼š**

**alternateçš„å…³é”®ä½œç”¨ï¼š**

1. **å¯¹è±¡å¤ç”¨æ± **ï¼š
   - ä¸¤æ£µæ ‘è½®æµæ‰®æ¼”currentå’ŒworkInProgress
   - æ¯æ¬¡æ›´æ–°ï¼Œæ—§currentå˜æˆæ–°workInProgressçš„åŸºç¡€
   - å¤ç”¨ç‡æé«˜ï¼ˆ90%+çš„èŠ‚ç‚¹è¢«å¤ç”¨ï¼‰

2. **bailoutä¼˜åŒ–çš„åŸºç¡€**ï¼š
   ```javascript
   if (current.memoizedProps === workInProgress.pendingProps) {
     // propsæ²¡å˜ï¼Œè·³è¿‡æ•´ä¸ªå­æ ‘
     return bailoutOnAlreadyFinishedWork(current, workInProgress);
   }
   ```

3. **é”™è¯¯è¾¹ç•Œçš„æ”¯æŒ**ï¼š
   - workInProgresså‡ºé”™ï¼Œç›´æ¥ä¸¢å¼ƒ
   - currentä¿æŒå®Œæ•´ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
   - Reactçš„é”™è¯¯æ¢å¤èƒ½åŠ›

**åœ¨ React æºç ä¸­çš„åº”ç”¨ï¼š**

```javascript
// packages/react-reconciler/src/ReactFiber.js

export function createWorkInProgress(current: Fiber, pendingProps: any): Fiber {
  let workInProgress = current.alternate;

  if (workInProgress === null) {
    // ä½¿ç”¨createFiberåˆ›å»ºæ–°èŠ‚ç‚¹
    workInProgress = createFiber(
      current.tag,
      pendingProps,
      current.key,
      current.mode,
    );
    workInProgress.elementType = current.elementType;
    workInProgress.type = current.type;
    workInProgress.stateNode = current.stateNode;

    // å»ºç«‹åŒå‘è¿æ¥
    workInProgress.alternate = current;
    current.alternate = workInProgress;
  } else {
    // å¤ç”¨èŠ‚ç‚¹
    workInProgress.pendingProps = pendingProps;
    workInProgress.type = current.type;

    // æ¸…ç©ºå‰¯ä½œç”¨
    workInProgress.flags = NoFlags;
    workInProgress.subtreeFlags = NoFlags;
    workInProgress.deletions = null;
  }

  // å¤ç”¨lanesã€childç­‰
  workInProgress.childLanes = current.childLanes;
  workInProgress.lanes = current.lanes;

  workInProgress.child = current.child;
  workInProgress.memoizedProps = current.memoizedProps;
  workInProgress.memoizedState = current.memoizedState;
  workInProgress.updateQueue = current.updateQueue;

  return workInProgress;
}
```

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šcommité˜¶æ®µçš„æŒ‡é’ˆåˆ‡æ¢ ğŸ”€

**renderé˜¶æ®µåœ¨workInProgressæ ‘ä¸Šå·¥ä½œï¼Œcommité˜¶æ®µæ‰§è¡ŒDOMæ“ä½œå¹¶åˆ‡æ¢root.currentæŒ‡é’ˆï¼Œä½¿workInProgresså˜æˆæ–°çš„currentï¼Œæ—§currentå˜æˆæ–°çš„workInProgressåŸºç¡€ã€‚**

```javascript
// ===== 1. å®Œæ•´çš„render-commitæµç¨‹ =====

console.log('=== å®Œæ•´çš„render-commitæµç¨‹ ===\n');

// åˆå§‹çŠ¶æ€
const root = {
  current: {
    type: 'div',
    props: { text: 'åˆå§‹å†…å®¹' },
    child: null,
    alternate: null,
    stateNode: document.createElement('div')  // çœŸå®DOM
  },
  finishedWork: null
};

root.current.stateNode.textContent = root.current.props.text;
console.log('åˆå§‹DOMå†…å®¹:', root.current.stateNode.textContent);

// ===== 2. Renderé˜¶æ®µ =====
console.log('\n--- Renderé˜¶æ®µå¼€å§‹ ---');

function renderPhase(root, newProps) {
  console.log('åˆ›å»ºworkInProgressæ ‘...');

  // åˆ›å»ºworkInProgress
  let workInProgress = root.current.alternate;
  if (workInProgress === null) {
    workInProgress = {
      type: root.current.type,
      props: newProps,
      child: null,
      alternate: root.current,
      stateNode: root.current.stateNode,  // å¤ç”¨DOMèŠ‚ç‚¹
      flags: 0b00000100  // Updateæ ‡è®°
    };
    root.current.alternate = workInProgress;
  } else {
    workInProgress.props = newProps;
    workInProgress.flags = 0b00000100;
  }

  console.log('workInProgress.props:', workInProgress.props.text);

  // æ¨¡æ‹Ÿdiffç®—æ³•
  if (root.current.props.text !== workInProgress.props.text) {
    console.log('æ£€æµ‹åˆ°propså˜åŒ–ï¼Œæ ‡è®°Updateå‰¯ä½œç”¨');
    workInProgress.flags |= 0b00000100;  // Update
  }

  // ä¿å­˜åˆ°finishedWork
  root.finishedWork = workInProgress;
  console.log('renderé˜¶æ®µå®Œæˆï¼ŒfinishedWorkå·²è®¾ç½®');

  return workInProgress;
}

const workInProgress = renderPhase(root, { text: 'æ›´æ–°åçš„å†…å®¹' });

console.log('\ncurrentæ ‘çš„props:', root.current.props.text);
console.log('workInProgressæ ‘çš„props:', root.finishedWork.props.text);
console.log('å½“å‰DOMå†…å®¹ï¼ˆæœªcommitï¼‰:', root.current.stateNode.textContent);

// ===== 3. Commité˜¶æ®µ =====
console.log('\n--- Commité˜¶æ®µå¼€å§‹ ---');

function commitPhase(root) {
  const finishedWork = root.finishedWork;
  if (finishedWork === null) {
    console.log('æ²¡æœ‰å¾…æäº¤çš„work');
    return;
  }

  console.log('æ‰§è¡ŒDOMæ“ä½œ...');

  // å­é˜¶æ®µ1ï¼šbefore mutationï¼ˆDOMæ“ä½œå‰ï¼‰
  console.log('  1. before mutationé˜¶æ®µ');
  commitBeforeMutationEffects(finishedWork);

  // å­é˜¶æ®µ2ï¼šmutationï¼ˆæ‰§è¡ŒDOMæ“ä½œï¼‰
  console.log('  2. mutationé˜¶æ®µ');
  commitMutationEffects(finishedWork);

  // ã€å…³é”®ã€‘åˆ‡æ¢æŒ‡é’ˆ
  console.log('  3. åˆ‡æ¢æŒ‡é’ˆï¼šroot.current = finishedWork');
  const previousCurrent = root.current;
  root.current = finishedWork;

  console.log('     ä¹‹å‰çš„current:', previousCurrent.props.text);
  console.log('     æ–°çš„current:', root.current.props.text);

  // å­é˜¶æ®µ3ï¼šlayoutï¼ˆDOMæ“ä½œåï¼‰
  console.log('  4. layouté˜¶æ®µ');
  commitLayoutEffects(finishedWork, root);

  // æ¸…ç©ºfinishedWork
  root.finishedWork = null;

  console.log('commité˜¶æ®µå®Œæˆ');
}

function commitBeforeMutationEffects(finishedWork) {
  // getSnapshotBeforeUpdateç­‰
  console.log('    â†’ æ‰§è¡ŒgetSnapshotBeforeUpdate');
}

function commitMutationEffects(finishedWork) {
  // æ‰§è¡ŒDOMæ“ä½œ
  const flags = finishedWork.flags;
  const Update = 0b00000100;

  if (flags & Update) {
    console.log('    â†’ æ›´æ–°DOMå†…å®¹');
    finishedWork.stateNode.textContent = finishedWork.props.text;
  }
}

function commitLayoutEffects(finishedWork, root) {
  // componentDidMount/Updateã€useLayoutEffectç­‰
  console.log('    â†’ æ‰§è¡ŒuseLayoutEffect');
}

commitPhase(root);

console.log('\næœ€ç»ˆDOMå†…å®¹:', root.current.stateNode.textContent);

// ===== 4. è§’è‰²äº’æ¢æ¼”ç¤º =====
console.log('\n=== è§’è‰²äº’æ¢æ¼”ç¤º ===');

console.log('ç¬¬ä¸€æ¬¡æ›´æ–°å‰:');
console.log('  currentæŒ‡å‘:', 'FiberA');
console.log('  workInProgressåŸºç¡€:', 'nullï¼ˆåˆ›å»ºæ–°FiberBï¼‰');

console.log('\nç¬¬ä¸€æ¬¡commitå:');
console.log('  currentæŒ‡å‘:', 'FiberBï¼ˆåŸworkInProgressï¼‰');
console.log('  FiberAè§’è‰²:', 'é€šè¿‡alternateå¯è®¿é—®ï¼Œç­‰å¾…å¤ç”¨');

console.log('\nç¬¬äºŒæ¬¡æ›´æ–°å‰:');
console.log('  currentæŒ‡å‘:', 'FiberB');
console.log('  workInProgressåŸºç¡€:', 'FiberAï¼ˆå¤ç”¨ï¼ï¼‰');

console.log('\nç¬¬äºŒæ¬¡commitå:');
console.log('  currentæŒ‡å‘:', 'FiberAï¼ˆå¤ç”¨çš„ï¼‰');
console.log('  FiberBè§’è‰²:', 'é€šè¿‡alternateå¯è®¿é—®ï¼Œç­‰å¾…å¤ç”¨');

console.log('\nç»“è®ºï¼šä¸¤ä¸ªFiberèŠ‚ç‚¹è½®æµæ‰®æ¼”currentå’ŒworkInProgressè§’è‰²');

// ===== 5. æŒ‡é’ˆåˆ‡æ¢çš„æ—¶æœº =====
console.log('\n=== æŒ‡é’ˆåˆ‡æ¢çš„æ—¶æœº ===');

function demonstrateCommitPhases() {
  const timeline = [
    { phase: 'before mutation', currentPointer: 'old', userSees: 'old DOM' },
    { phase: 'mutationå¼€å§‹', currentPointer: 'old', userSees: 'old DOM' },
    { phase: 'mutationè¿›è¡Œä¸­', currentPointer: 'old', userSees: 'old DOM' },
    { phase: 'åˆ‡æ¢æŒ‡é’ˆ', currentPointer: 'new', userSees: 'old DOMï¼ˆDOMæ“ä½œæœªå®Œæˆï¼‰' },
    { phase: 'mutationå®Œæˆ', currentPointer: 'new', userSees: 'new DOM' },
    { phase: 'layout', currentPointer: 'new', userSees: 'new DOM' }
  ];

  timeline.forEach((step, index) => {
    console.log(`${index + 1}. ${step.phase}`);
    console.log(`   root.current: ${step.currentPointer}`);
    console.log(`   ç”¨æˆ·çœ‹åˆ°: ${step.userSees}`);
  });
}

demonstrateCommitPhases();

console.log('\nå…³é”®ç‚¹ï¼šæŒ‡é’ˆåˆ‡æ¢åœ¨mutationé˜¶æ®µè¿›è¡Œï¼Œä½†DOMæ“ä½œæ˜¯åŒæ­¥å®Œæˆçš„ï¼Œç”¨æˆ·æ„ŸçŸ¥ä¸åˆ°ä¸­é—´çŠ¶æ€');
```

**è¯¦ç»†è§£é‡Šï¼š**

**commité˜¶æ®µçš„ä¸‰ä¸ªå­é˜¶æ®µï¼š**

1. **before mutation**ï¼ˆDOMæ“ä½œå‰ï¼‰
   - æ‰§è¡Œ`getSnapshotBeforeUpdate`
   - æ­¤æ—¶`root.current`è¿˜æ˜¯æ—§æ ‘
   - å¯ä»¥è¯»å–æ›´æ–°å‰çš„DOMçŠ¶æ€

2. **mutation**ï¼ˆDOMæ“ä½œï¼‰
   - æ‰§è¡ŒDOMçš„æ’å…¥ã€æ›´æ–°ã€åˆ é™¤
   - **åœ¨è¿™ä¸ªé˜¶æ®µåˆ‡æ¢æŒ‡é’ˆ**ï¼š`root.current = finishedWork`
   - DOMæ“ä½œæ˜¯åŒæ­¥çš„ï¼Œç”¨æˆ·ç¬é—´çœ‹åˆ°æ–°UI

3. **layout**ï¼ˆDOMæ“ä½œåï¼‰
   - æ‰§è¡Œ`componentDidMount/Update`
   - æ‰§è¡Œ`useLayoutEffect`
   - æ­¤æ—¶`root.current`å·²ç»æ˜¯æ–°æ ‘
   - å¯ä»¥è¯»å–æ›´æ–°åçš„DOMçŠ¶æ€

**æŒ‡é’ˆåˆ‡æ¢çš„å…³é”®ç‰¹æ€§ï¼š**

- **åˆ‡æ¢æˆæœ¬**ï¼šO(1)ï¼Œåªéœ€ä¿®æ”¹ä¸€ä¸ªæŒ‡é’ˆ
- **åˆ‡æ¢æ—¶æœº**ï¼šmutationé˜¶æ®µï¼ŒDOMæ“ä½œåŒæ­¥å®Œæˆ
- **ç”¨æˆ·ä½“éªŒ**ï¼šç¬é—´åˆ‡æ¢ï¼Œæ— ä¸­é—´çŠ¶æ€
- **é”™è¯¯æ¢å¤**ï¼šå‡ºé”™æ—¶ä¸åˆ‡æ¢ï¼Œcurrentä¿æŒä¸å˜

**åœ¨ React æºç ä¸­çš„åº”ç”¨ï¼š**

```javascript
// packages/react-reconciler/src/ReactFiberWorkLoop.js

function commitRootImpl(root, renderPriorityLevel) {
  const finishedWork = root.finishedWork;
  const lanes = root.finishedLanes;

  // æ¸…ç©ºï¼Œé˜²æ­¢é‡å¤commit
  root.finishedWork = null;
  root.finishedLanes = NoLanes;

  // before mutationé˜¶æ®µ
  commitBeforeMutationEffects(root, finishedWork);

  // mutationé˜¶æ®µ
  commitMutationEffects(root, finishedWork, lanes);

  // ã€å…³é”®ã€‘åˆ‡æ¢æŒ‡é’ˆ
  root.current = finishedWork;

  // layouté˜¶æ®µ
  commitLayoutEffects(finishedWork, root, lanes);

  // è§¦å‘åç»­è°ƒåº¦
  ensureRootIsScheduled(root, now());
}
```

---

## å››ã€ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½ç†è§£ React åŒç¼“å†²æœºåˆ¶çš„æ ¸å¿ƒï¼š

### 4.1 currentå’ŒworkInProgressçš„è§’è‰²

**æ ¸å¿ƒï¼š**currentæ˜¾ç¤ºåœ¨å±å¹•ï¼ŒworkInProgressåœ¨å†…å­˜æ„å»ºï¼Œcommitååˆ‡æ¢

```javascript
const root = {
  current: currentTree,         // ç”¨æˆ·çœ‹åˆ°çš„
  finishedWork: workInProgressTree  // åå°æ„å»ºçš„
};

// renderé˜¶æ®µï¼šæ„å»ºworkInProgress
buildTree(workInProgressTree);

// commité˜¶æ®µï¼šåˆ‡æ¢æŒ‡é’ˆ
root.current = workInProgressTree;
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£ä¸ºä»€ä¹ˆç”¨æˆ·çœ‹ä¸åˆ°æ›´æ–°è¿‡ç¨‹
- ç†è§£Reactå¦‚ä½•é¿å…é—ªçƒ
- ä¸ºå­¦ä¹ renderå’Œcommité˜¶æ®µæ‰“åŸºç¡€

---

### 4.2 alternateçš„åŒå‘ç»‘å®š

**æ ¸å¿ƒï¼š**ä¸¤æ£µæ ‘çš„å¯¹åº”èŠ‚ç‚¹é€šè¿‡alternateç›¸äº’å¼•ç”¨

```javascript
current.alternate = workInProgress;
workInProgress.alternate = current;

// è®¿é—®å¯¹åº”èŠ‚ç‚¹
const wipNode = currentNode.alternate;
const curNode = wipNode.alternate;
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£å¦‚ä½•å¤ç”¨FiberèŠ‚ç‚¹
- ç†è§£createWorkInProgressçš„åŸç†
- ä¸ºç†è§£æ€§èƒ½ä¼˜åŒ–æ‰“åŸºç¡€

---

### 4.3 FiberèŠ‚ç‚¹çš„å¤ç”¨

**æ ¸å¿ƒï¼š**é¦–æ¬¡åˆ›å»ºï¼Œåç»­å¤ç”¨alternate

```javascript
function createWorkInProgress(current, props) {
  let wip = current.alternate;
  if (wip === null) {
    wip = createFiber(...);  // åˆ›å»º
  } else {
    wip.props = props;        // å¤ç”¨
  }
  return wip;
}
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£Reactçš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
- ç†è§£ä¸ºä»€ä¹ˆæ›´æ–°ä¸ä¼šåˆ›å»ºå¤§é‡å¯¹è±¡
- ä¸ºç†è§£GCå‹å¥½è®¾è®¡æ‰“åŸºç¡€

---

### 4.4 æŒ‡é’ˆåˆ‡æ¢çš„æ—¶æœº

**æ ¸å¿ƒï¼š**commité˜¶æ®µçš„mutationå­é˜¶æ®µåˆ‡æ¢

```
renderé˜¶æ®µ â†’ æ„å»ºworkInProgress
  â†“
commit before mutation â†’ root.currentè¿˜æ˜¯æ—§æ ‘
  â†“
commit mutation â†’ åˆ‡æ¢root.current = finishedWork
  â†“
commit layout â†’ root.currentå·²æ˜¯æ–°æ ‘
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£getSnapshotBeforeUpdateçš„æ—¶æœº
- ç†è§£useLayoutEffectçš„æ‰§è¡Œæ—¶æœº
- ä¸ºç†è§£commité˜¶æ®µæ‰“åŸºç¡€

---

### 4.5 åŒç¼“å†²çš„æ€§èƒ½ä¼˜åŠ¿

**æ ¸å¿ƒï¼š**å¤ç”¨å¯¹è±¡ã€æ‰¹é‡æ“ä½œã€ä¸€æ¬¡æ€§åˆ‡æ¢

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| å¯¹è±¡å¤ç”¨ | 90%+èŠ‚ç‚¹è¢«å¤ç”¨ï¼Œå‡å°‘GC |
| æ‰¹é‡æ“ä½œ | æ‰€æœ‰DOMæ“ä½œåœ¨commité˜¶æ®µæ‰¹é‡æ‰§è¡Œ |
| ä¸€æ¬¡æ€§åˆ‡æ¢ | O(1)æ—¶é—´ï¼Œæ— ä¸­é—´çŠ¶æ€ |

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£Reactçš„æ€§èƒ½ä¼˜åŒ–åŸç†
- ç†è§£ä¸ºä»€ä¹ˆReactæ›´æ–°å¿«
- ä¸ºæ€§èƒ½è°ƒä¼˜æ‰“åŸºç¡€

---

## äº”ã€ã€1ä¸ªç±»æ¯”ã€‘

### ç±»æ¯”1ï¼šåŒç¼“å†² = è£…ä¿®æˆ¿å­ ğŸ ğŸ”¨

**è§£é‡Šç›¸ä¼¼æ€§ï¼š**

æƒ³è±¡ä½ æ­£åœ¨ä½çš„æˆ¿å­éœ€è¦é‡æ–°è£…ä¿®ã€‚å¦‚æœç›´æ¥åœ¨å½“å‰æˆ¿å­é‡Œè£…ä¿®ï¼Œä½ ä¼šé‡åˆ°ï¼š
- **æ— å¤„å¯ä½**ï¼šæ‹†æ‰æ—§å®¶å…·ï¼Œæ–°å®¶å…·è¿˜æ²¡åˆ°ï¼Œä¸­é—´æœ‰ç©ºç™½æœŸ
- **ç”Ÿæ´»ä¸ä¾¿**ï¼šå¢™é¢åˆ·åˆ°ä¸€åŠï¼Œåœ°æ¿é“ºåˆ°ä¸€åŠï¼Œåˆ°å¤„æ˜¯å»ºæ
- **ä½“éªŒç³Ÿç³•**ï¼šç°å°˜ã€å™ªéŸ³ã€æ··ä¹±

**Reactçš„åŒç¼“å†²æœºåˆ¶å°±åƒï¼š**

```javascript
// å½“å‰ä½çš„æˆ¿å­ï¼ˆcurrentæ ‘ï¼‰
const æ—§æˆ¿å­ = {
  çŠ¶æ€: 'å¯ä»¥å±…ä½',
  å®¶å…·: ['æ—§æ²™å‘', 'æ—§ç”µè§†', 'æ—§åºŠ'],
  ç”¨æˆ·: 'æ­£åœ¨å±…ä½',  // ç”¨æˆ·çœ‹å¾—åˆ°
  alternate: æ–°æˆ¿å­
};

// æ­£åœ¨è£…ä¿®çš„æˆ¿å­ï¼ˆworkInProgressæ ‘ï¼‰
const æ–°æˆ¿å­ = {
  çŠ¶æ€: 'è£…ä¿®ä¸­',
  å®¶å…·: ['æ–°æ²™å‘', 'æ–°ç”µè§†', 'æ–°åºŠ', 'æ–°ä¹¦æ¶'],
  ç”¨æˆ·: 'ä¸å¯è§',  // ç”¨æˆ·çœ‹ä¸åˆ°
  alternate: æ—§æˆ¿å­
};

// è£…ä¿®è¿‡ç¨‹ï¼ˆrenderé˜¶æ®µï¼‰
function è£…ä¿®æˆ¿å­(æ–°æˆ¿å­) {
  console.log('åœ¨æ–°æˆ¿å­é‡Œè£…ä¿®...');
  console.log('æ‹†å¢™ã€åˆ·æ¼†ã€é“ºåœ°æ¿...');
  console.log('ç”¨æˆ·ä»åœ¨æ—§æˆ¿å­é‡Œï¼Œæ— æ„ŸçŸ¥');

  æ–°æˆ¿å­.çŠ¶æ€ = 'è£…ä¿®å®Œæˆ';
}

è£…ä¿®æˆ¿å­(æ–°æˆ¿å­);

// æ¬å®¶ï¼ˆcommité˜¶æ®µï¼‰
function æ¬å®¶() {
  console.log('è£…ä¿®å®Œæˆï¼Œå‡†å¤‡æ¬å®¶');

  // ä¸€æ¬¡æ€§æ¬å®¶ï¼ˆæŒ‡é’ˆåˆ‡æ¢ï¼‰
  ç”¨æˆ·.å½“å‰ä½æ‰€ = æ–°æˆ¿å­;

  console.log('æ¬å®¶å®Œæˆï¼Œç”¨æˆ·ç°åœ¨ä½æ–°æˆ¿å­');
  console.log('æ—§æˆ¿å­ç©ºå‡ºæ¥ï¼Œä¸‹æ¬¡è£…ä¿®ç»§ç»­ç”¨');
}

æ¬å®¶();
```

**å¯¹åº”å…³ç³»ï¼š**

| Reactæ¦‚å¿µ | è£…ä¿®ç±»æ¯” |
|-----------|----------|
| currentæ ‘ | æ­£åœ¨ä½çš„æ—§æˆ¿å­ï¼ˆç”¨æˆ·å¯è§ï¼‰ |
| workInProgressæ ‘ | æ­£åœ¨è£…ä¿®çš„æ–°æˆ¿å­ï¼ˆç”¨æˆ·ä¸å¯è§ï¼‰ |
| renderé˜¶æ®µ | åœ¨æ–°æˆ¿å­é‡Œè£…ä¿®ï¼ˆåå°å·¥ä½œï¼‰ |
| commité˜¶æ®µ | æ¬å®¶ï¼ˆä¸€æ¬¡æ€§åˆ‡æ¢ï¼‰ |
| alternate | ä¸¤å¥—æˆ¿å­çš„é’¥åŒ™ï¼ˆäº’ç›¸å…³è”ï¼‰ |
| å¯¹è±¡å¤ç”¨ | æ—§æˆ¿å­ä¸‹æ¬¡ç»§ç»­ç”¨ï¼ˆä¸æ‹†ï¼‰ |

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

1. **ä¸å½±å“ç”¨æˆ·**ï¼šç”¨æˆ·ç»§ç»­ä½æ—§æˆ¿å­ï¼Œä¸å—è£…ä¿®å½±å“
2. **ä¸€æ¬¡æ€§åˆ‡æ¢**ï¼šè£…ä¿®å®Œæˆåä¸€å¤©æ¬å®¶ï¼Œä¸æ˜¯ä¸€ä¸ªæˆ¿é—´ä¸€ä¸ªæˆ¿é—´æ¬
3. **èµ„æºå¤ç”¨**ï¼šæ—§æˆ¿å­ä¸æ‹†ï¼Œä¸‹æ¬¡è£…ä¿®ç»§ç»­ç”¨
4. **å¯ä»¥åæ‚”**ï¼šè£…ä¿®åˆ°ä¸€åŠå‘ç°ä¸å–œæ¬¢ï¼Œå¯ä»¥é‡æ–°è£…ï¼Œæ—§æˆ¿å­ä¸å—å½±å“

---

### ç±»æ¯”2ï¼šåŒç¼“å†² = æ¼”å‘˜æ¢è£… ğŸ­

**è§£é‡Šç›¸ä¼¼æ€§ï¼š**

èˆå°å‰§æ¼”å‘˜éœ€è¦æ¢æœè£…ï¼Œå¦‚æœç›´æ¥åœ¨èˆå°ä¸Šæ¢ï¼š
- **å°´å°¬**ï¼šè§‚ä¼—çœ‹åˆ°æ¢è¡£æœè¿‡ç¨‹
- **ä¸­æ–­**ï¼šè¡¨æ¼”æš‚åœï¼Œè§‚ä¼—ä½“éªŒå·®
- **é£é™©**ï¼šæ¢åˆ°ä¸€åŠå‘ç°æœè£…æœ‰é—®é¢˜

**Reactçš„åŒç¼“å†²æœºåˆ¶å°±åƒï¼š**

```javascript
// èˆå°ï¼ˆcurrentæ ‘ï¼‰
const èˆå° = {
  æ¼”å‘˜: 'ç©¿ç€å¤è£…',
  è§‚ä¼—: 'æ­£åœ¨è§‚çœ‹',
  çŠ¶æ€: 'è¡¨æ¼”ä¸­'
};

// åå°ï¼ˆworkInProgressæ ‘ï¼‰
const åå° = {
  æ¼”å‘˜: 'æ­£åœ¨æ¢ç°ä»£è£…',
  è§‚ä¼—: 'çœ‹ä¸åˆ°',
  çŠ¶æ€: 'å‡†å¤‡ä¸­'
};

// æ¢è£…è¿‡ç¨‹ï¼ˆrenderé˜¶æ®µï¼‰
function æ¢è£…() {
  console.log('æ¼”å‘˜åœ¨åå°æ¢è£…...');
  console.log('è„±æ‰å¤è£…ï¼Œç©¿ä¸Šç°ä»£è£…');
  console.log('æ£€æŸ¥å¦†å®¹ï¼Œè°ƒæ•´å‘å‹');
  console.log('è§‚ä¼—çœ‹åˆ°çš„ä»æ˜¯èˆå°ä¸Šçš„å¤è£…è¡¨æ¼”');

  åå°.çŠ¶æ€ = 'å‡†å¤‡å°±ç»ª';
}

æ¢è£…();

// åˆ‡æ¢åˆ°èˆå°ï¼ˆcommité˜¶æ®µï¼‰
function èµ°åˆ°èˆå°() {
  console.log('åå°æ¢è£…å®Œæˆ');
  console.log('æ¼”å‘˜èµ°åˆ°èˆå°');

  // è§‚ä¼—çœ‹åˆ°çš„ç¬é—´åˆ‡æ¢
  è§‚ä¼—.çœ‹åˆ° = åå°.æ¼”å‘˜;

  console.log('è§‚ä¼—ç°åœ¨çœ‹åˆ°ç°ä»£è£…');
  console.log('èˆå°ç©ºå‡ºæ¥ï¼Œæˆä¸ºä¸‹æ¬¡æ¢è£…çš„åå°');
}

èµ°åˆ°èˆå°();
```

**å¯¹åº”å…³ç³»ï¼š**

| Reactæ¦‚å¿µ | æ¼”å‘˜æ¢è£…ç±»æ¯” |
|-----------|--------------|
| currentæ ‘ | èˆå°ä¸Šè¡¨æ¼”ï¼ˆè§‚ä¼—å¯è§ï¼‰ |
| workInProgressæ ‘ | åå°æ¢è£…ï¼ˆè§‚ä¼—ä¸å¯è§ï¼‰ |
| renderé˜¶æ®µ | åœ¨åå°æ¢è£…ï¼ˆå‡†å¤‡å·¥ä½œï¼‰ |
| commité˜¶æ®µ | èµ°åˆ°èˆå°ï¼ˆç¬é—´åˆ‡æ¢ï¼‰ |
| alternate | èˆå°å’Œåå°ï¼ˆè§’è‰²äº’æ¢ï¼‰ |
| ä¸­æ–­æ›´æ–° | æ¢è£…åˆ°ä¸€åŠï¼Œæ¢å›åŸè£… |

---

### ç±»æ¯”3ï¼šåŒç¼“å†² = æ¸¸æˆç”»é¢æ¸²æŸ“ ğŸ®

**è§£é‡Šç›¸ä¼¼æ€§ï¼š**

æ¸¸æˆå¼•æ“æ¸²æŸ“ç”»é¢æ—¶ï¼Œå¦‚æœç›´æ¥åœ¨å±å¹•ä¸Šç”»ï¼š
- **é—ªçƒ**ï¼šæ¸…ç©ºå±å¹•åˆ°ç»˜åˆ¶æ–°ç”»é¢ä¹‹é—´æœ‰é»‘å±
- **æ’•è£‚**ï¼šç”»åˆ°ä¸€åŠåˆ‡æ¢å¸§ï¼Œç”»é¢ä¸å®Œæ•´
- **å¡é¡¿**ï¼šç”¨æˆ·çœ‹åˆ°ç»˜åˆ¶è¿‡ç¨‹

**ç»å…¸çš„åŒç¼“å†²æ¸²æŸ“ï¼š**

```javascript
// å‰å°ç¼“å†²ï¼ˆcurrentæ ‘ï¼‰
const å‰å°ç¼“å†² = {
  å†…å®¹: 'ç¬¬100å¸§ç”»é¢',
  æ˜¾ç¤ºå™¨: 'æ­£åœ¨æ˜¾ç¤º',
  ç”¨æˆ·: 'å¯è§'
};

// åå°ç¼“å†²ï¼ˆworkInProgressæ ‘ï¼‰
const åå°ç¼“å†² = {
  å†…å®¹: 'æ­£åœ¨ç»˜åˆ¶ç¬¬101å¸§',
  æ˜¾ç¤ºå™¨: 'æœªè¿æ¥',
  ç”¨æˆ·: 'ä¸å¯è§'
};

// æ¸²æŸ“è¿‡ç¨‹ï¼ˆrenderé˜¶æ®µï¼‰
function æ¸²æŸ“ä¸‹ä¸€å¸§() {
  console.log('åœ¨åå°ç¼“å†²ç»˜åˆ¶æ–°ç”»é¢...');
  console.log('æ¸…ç©ºåå°ç¼“å†²');
  console.log('ç»˜åˆ¶èƒŒæ™¯ã€è§’è‰²ã€ç‰¹æ•ˆ...');
  console.log('ç”¨æˆ·çœ‹åˆ°çš„ä»æ˜¯å‰å°ç¼“å†²çš„ç¬¬100å¸§');

  åå°ç¼“å†².å†…å®¹ = 'ç¬¬101å¸§ç”»é¢ï¼ˆå®Œæ•´ï¼‰';
}

æ¸²æŸ“ä¸‹ä¸€å¸§();

// åˆ‡æ¢ç¼“å†²ï¼ˆcommité˜¶æ®µï¼‰
function åˆ‡æ¢ç¼“å†²() {
  console.log('åå°ç¼“å†²ç»˜åˆ¶å®Œæˆ');

  // VSyncä¿¡å·åˆ°æ¥ï¼Œåˆ‡æ¢ç¼“å†²æŒ‡é’ˆ
  æ˜¾ç¤ºå™¨.å½“å‰ç¼“å†² = åå°ç¼“å†²;

  console.log('ç”¨æˆ·ç°åœ¨çœ‹åˆ°ç¬¬101å¸§');
  console.log('å‰å°ç¼“å†²ç©ºå‡ºæ¥ï¼Œæˆä¸ºä¸‹ä¸€å¸§çš„åå°ç¼“å†²');
}

åˆ‡æ¢ç¼“å†²();
```

**å¯¹åº”å…³ç³»ï¼š**

| Reactæ¦‚å¿µ | æ¸¸æˆåŒç¼“å†²ç±»æ¯” |
|-----------|---------------|
| currentæ ‘ | å‰å°å¸§ç¼“å†²ï¼ˆæ˜¾ç¤ºå™¨æ˜¾ç¤ºï¼‰ |
| workInProgressæ ‘ | åå°å¸§ç¼“å†²ï¼ˆGPUç»˜åˆ¶ï¼‰ |
| renderé˜¶æ®µ | åœ¨åå°ç¼“å†²ç»˜åˆ¶ |
| commité˜¶æ®µ | VSyncåˆ‡æ¢ç¼“å†²æŒ‡é’ˆ |
| alternate | ä¸¤ä¸ªç¼“å†²åŒºï¼ˆè½®æµä½¿ç”¨ï¼‰ |
| å¤ç”¨ | ç¼“å†²åŒºä¸é”€æ¯ï¼Œè½®æµæ¸²æŸ“ |

**ä¸ºä»€ä¹ˆæ¸¸æˆå¿…é¡»ç”¨åŒç¼“å†²ï¼Ÿ**

1. **60FPSè¦æ±‚**ï¼šæ¯16.67msåˆ‡æ¢ä¸€æ¬¡ç”»é¢
2. **ç”»é¢å®Œæ•´**ï¼šåªæ˜¾ç¤ºå®Œå…¨ç»˜åˆ¶å¥½çš„å¸§
3. **æ— é—ªçƒ**ï¼šä¸ä¼šçœ‹åˆ°æ¸…ç©ºå±å¹•çš„é»‘å±
4. **æ— æ’•è£‚**ï¼šVSyncåŒæ­¥åˆ‡æ¢ï¼Œä¸ä¼šç”»åˆ°ä¸€åŠ

Reactçš„åŒç¼“å†²æœºåˆ¶å€Ÿé‰´äº†æ¸¸æˆå¼•æ“çš„æ€æƒ³ï¼

---

### ç±»æ¯”4ï¼šåŒç¼“å†² = äº¤é€šä¿¡å·ç¯åˆ‡æ¢ ğŸš¦

**è§£é‡Šç›¸ä¼¼æ€§ï¼š**

çº¢ç»¿ç¯åˆ‡æ¢æ—¶ï¼Œå¦‚æœæ²¡æœ‰ç¼“å†²æœºåˆ¶ï¼š
- **å±é™©**ï¼šçº¢ç¯ç›´æ¥å˜ç»¿ç¯ï¼Œå¯èƒ½æœ‰è½¦è¿˜åœ¨é€šè¿‡
- **æ··ä¹±**ï¼šè·¯å£æ‰€æœ‰ç¯åŒæ—¶å˜ï¼Œä¸çŸ¥é“è¯¥å¬è°çš„

**Reactçš„åŒç¼“å†²ç±»ä¼¼äºï¼š**

```javascript
// å½“å‰ç”Ÿæ•ˆçš„ç¯ï¼ˆcurrentæ ‘ï¼‰
const å½“å‰ç¯ = {
  å—åŒ—: 'ç»¿ç¯',
  ä¸œè¥¿: 'çº¢ç¯',
  è¡Œäºº: 'ç­‰å¾…',
  ç”Ÿæ•ˆ: true
};

// ä¸‹ä¸€ä¸ªçŠ¶æ€ï¼ˆworkInProgressæ ‘ï¼‰
const ä¸‹ä¸ªçŠ¶æ€ = {
  å—åŒ—: 'çº¢ç¯',
  ä¸œè¥¿: 'ç»¿ç¯',
  è¡Œäºº: 'å¯é€šè¡Œ',
  ç”Ÿæ•ˆ: false
};

// å‡†å¤‡åˆ‡æ¢ï¼ˆrenderé˜¶æ®µï¼‰
function å‡†å¤‡åˆ‡æ¢() {
  console.log('è®¡ç®—ä¸‹ä¸€ä¸ªç¯çš„çŠ¶æ€...');
  console.log('ç¡®ä¿é€»è¾‘æ­£ç¡®ï¼šå—åŒ—çº¢ç¯æ—¶ï¼Œä¸œè¥¿æ‰èƒ½ç»¿ç¯');
  console.log('å‡†å¤‡å®Œæˆï¼Œç­‰å¾…åˆ‡æ¢æ—¶æœº');
}

// åˆ‡æ¢ç¯ï¼ˆcommité˜¶æ®µï¼‰
function åˆ‡æ¢ç¯() {
  console.log('é»„ç¯è¿‡æ¸¡æœŸç»“æŸ');

  // ä¸€æ¬¡æ€§åˆ‡æ¢æ‰€æœ‰ç¯
  è·¯å£.å½“å‰çŠ¶æ€ = ä¸‹ä¸ªçŠ¶æ€;

  console.log('æ‰€æœ‰ç¯åŒæ—¶åˆ‡æ¢ï¼Œæ— è¿‡æ¸¡æœŸæ··ä¹±');
}
```

**å¯¹åº”å…³ç³»ï¼š**

- **å½“å‰ç¯** = currentæ ‘ï¼ˆå¸æœºéµå®ˆçš„ï¼‰
- **ä¸‹ä¸ªçŠ¶æ€** = workInProgressæ ‘ï¼ˆåå°è®¡ç®—çš„ï¼‰
- **åˆ‡æ¢** = commitï¼ˆä¸€æ¬¡æ€§åˆ‡æ¢ï¼Œæ— ä¸­é—´æ€ï¼‰

---

### ç±»æ¯”æ€»ç»“è¡¨

| Reactæ¦‚å¿µ | è£…ä¿®æˆ¿å­ | æ¼”å‘˜æ¢è£… | æ¸¸æˆæ¸²æŸ“ | äº¤é€šä¿¡å· |
|-----------|----------|----------|----------|----------|
| current | æ­£åœ¨ä½çš„æˆ¿å­ | èˆå°è¡¨æ¼” | å‰å°ç¼“å†² | å½“å‰ç”Ÿæ•ˆçš„ç¯ |
| workInProgress | è£…ä¿®ä¸­çš„æˆ¿å­ | åå°æ¢è£… | åå°ç¼“å†² | ä¸‹ä¸€ä¸ªçŠ¶æ€ |
| renderé˜¶æ®µ | è£…ä¿®è¿‡ç¨‹ | æ¢è£…è¿‡ç¨‹ | ç»˜åˆ¶ç”»é¢ | è®¡ç®—é€»è¾‘ |
| commité˜¶æ®µ | æ¬å®¶ | èµ°åˆ°èˆå° | åˆ‡æ¢ç¼“å†² | åˆ‡æ¢ä¿¡å· |
| æ— ä¸­é—´æ€ | ä¸æ˜¯ä¸€ä¸ªæˆ¿é—´ä¸€ä¸ªæˆ¿é—´æ¬ | ä¸åœ¨èˆå°ä¸Šæ¢ | ä¸åœ¨å±å¹•ä¸Šç”» | ä¸ä¼šç»¿çº¢åŒæ—¶äº® |
| å¯¹è±¡å¤ç”¨ | æ—§æˆ¿å­ä¸‹æ¬¡ç»§ç»­ç”¨ | èˆå°åå°è½®æµç”¨ | ç¼“å†²åŒºè½®æµç”¨ | çŠ¶æ€å¯¹è±¡å¤ç”¨ |

---

## å…­ã€ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼šåŒæ ‘å ç”¨åŒå€å†…å­˜ï¼Œæµªè´¹èµ„æº âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

è™½ç„¶æœ‰ä¸¤æ£µæ ‘ï¼Œä½†å®é™…å†…å­˜å ç”¨è¿œå°äº2å€ï¼Œå› ä¸ºï¼š

1. **å¯¹è±¡å¤ç”¨ç‡æé«˜**ï¼š
   ```javascript
   // æœªå˜åŒ–çš„èŠ‚ç‚¹ï¼šå®Œå…¨å¤ç”¨ï¼Œä¸åˆ›å»ºæ–°å¯¹è±¡
   if (oldProps === newProps && type === oldType) {
     workInProgress.child = current.child;  // ç›´æ¥å¤ç”¨ï¼
   }
   ```

2. **åªæœ‰å˜åŒ–çš„è·¯å¾„åˆ›å»ºæ–°èŠ‚ç‚¹**ï¼š
   ```javascript
   // å‡è®¾ç»„ä»¶æ ‘æœ‰1000ä¸ªèŠ‚ç‚¹
   // æŸæ¬¡æ›´æ–°åªæ”¹äº†1ä¸ªæŒ‰é’®çš„æ–‡å­—

   // å˜åŒ–çš„è·¯å¾„ï¼šæ ¹ â†’ Page â†’ Buttonï¼ˆ3ä¸ªèŠ‚ç‚¹ï¼‰
   // åˆ›å»ºæ–°FiberèŠ‚ç‚¹ï¼š3ä¸ª
   // å¤ç”¨çš„èŠ‚ç‚¹ï¼š997ä¸ª

   // å†…å­˜å¢é•¿ï¼š~0.3%ï¼ˆè€Œé100%ï¼‰
   ```

3. **DOMèŠ‚ç‚¹å…±äº«**ï¼š
   ```javascript
   // currentå’ŒworkInProgresså…±äº«åŒä¸€ä¸ªDOMèŠ‚ç‚¹
   currentFiber.stateNode = domElement;
   workInProgressFiber.stateNode = domElement;  // åŒä¸€ä¸ªï¼

   // DOMèŠ‚ç‚¹çš„å†…å­˜å ç”¨è¿œå¤§äºFiberèŠ‚ç‚¹
   // å…±äº«DOMèŠ‚ç‚¹èŠ‚çœäº†å¤§é‡å†…å­˜
   ```

**å®é™…å†…å­˜å ç”¨åˆ†æï¼š**

```javascript
// å‡è®¾ä¸€ä¸ªåº”ç”¨æœ‰1000ä¸ªç»„ä»¶èŠ‚ç‚¹

// é¦–æ¬¡æ¸²æŸ“
const memoryFirstRender = {
  fiberNodes: 1000,           // 1000ä¸ªFiberèŠ‚ç‚¹
  domNodes: 1000,             // 1000ä¸ªDOMèŠ‚ç‚¹
  total: 'å‡è®¾10MB'
};

// ç¬¬ä¸€æ¬¡æ›´æ–°ï¼ˆæ”¹äº†10ä¸ªç»„ä»¶ï¼‰
const memoryFirstUpdate = {
  fiberNodes: 1000 + 1000,    // currentæ ‘1000 + wipæ ‘1000
  domNodes: 1000,             // DOMå…±äº«ï¼Œè¿˜æ˜¯1000ä¸ª
  actualNewObjects: 10,       // å®é™…åªåˆ›å»ºäº†10ä¸ªæ–°Fiber
  total: 'å‡è®¾10.1MBï¼ˆå¢é•¿1%ï¼‰'
};

// ç¬¬äºŒæ¬¡æ›´æ–°ï¼ˆå¤ç”¨alternateï¼‰
const memorySecondUpdate = {
  fiberNodes: 1000 + 1000,    // è¿˜æ˜¯ä¸¤æ£µæ ‘
  domNodes: 1000,             // DOMå…±äº«
  actualNewObjects: 0,        // å®Œå…¨å¤ç”¨ï¼Œ0ä¸ªæ–°å¯¹è±¡
  total: 'å‡è®¾10.1MBï¼ˆæ— å¢é•¿ï¼‰'
};

console.log('ç»“è®ºï¼šåŒç¼“å†²æœºåˆ¶çš„å†…å­˜å ç”¨æ¥è¿‘å•æ ‘ï¼Œè¿œå°äº2å€');
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

å› ä¸º"åŒæ ‘"è¿™ä¸ªåå­—ç»™äºº"åŒå€"çš„æ„Ÿè§‰ã€‚ä½†å®é™…ä¸Šï¼š
- **å¯¹è±¡çº§å¤ç”¨**ï¼šåªå¤ç”¨å˜åŒ–çš„èŠ‚ç‚¹
- **DOMçº§å…±äº«**ï¼šä¸¤æ£µæ ‘å…±äº«DOMèŠ‚ç‚¹
- **GCå‹å¥½**ï¼šå¤ç”¨å¯¹è±¡å‡å°‘GCå‹åŠ›

**æ­£ç¡®ç†è§£ï¼š**

åŒç¼“å†²çš„å†…å­˜å¢é•¿ä¸»è¦æ¥è‡ªï¼š
- å˜åŒ–çš„èŠ‚ç‚¹è·¯å¾„ï¼ˆé€šå¸¸<10%ï¼‰
- æ–°å¢çš„èŠ‚ç‚¹ï¼ˆçœŸæ­£çš„æ–°ç»„ä»¶ï¼‰
- FiberèŠ‚ç‚¹çš„å…ƒä¿¡æ¯å­—æ®µï¼ˆç›¸æ¯”DOMèŠ‚ç‚¹å¾ˆå°ï¼‰

å®é™…å†…å­˜å ç”¨ï¼š1~1.1å€å•æ ‘ï¼ˆè€Œé2å€ï¼‰

---

### è¯¯åŒº2ï¼šæ¯æ¬¡æ›´æ–°éƒ½æ„å»ºå®Œæ•´çš„workInProgressæ ‘ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

Reacté€šè¿‡**bailoutä¼˜åŒ–**ï¼Œæœªå˜åŒ–çš„å­æ ‘ç›´æ¥å¤ç”¨ï¼Œä¸ä¼šé‡æ–°æ„å»ºï¼š

```javascript
function beginWork(current, workInProgress, renderLanes) {
  // bailoutä¼˜åŒ–ï¼špropsæœªå˜åŒ– && æ— å¼ºåˆ¶æ›´æ–°
  if (
    current !== null &&
    oldProps === newProps &&
    !hasContextChanged() &&
    !includesLegacyContextChanges() &&
    (workInProgress.lanes & renderLanes) === NoLanes
  ) {
    console.log('bailoutï¼šè·³è¿‡æ­¤èŠ‚ç‚¹åŠå…¶å­æ ‘');

    // ç›´æ¥å¤ç”¨å­èŠ‚ç‚¹ï¼Œä¸è¿›å…¥reconcile
    return bailoutOnAlreadyFinishedWork(current, workInProgress, renderLanes);
  }

  // æœ‰å˜åŒ–ï¼Œæ‰è¿›å…¥reconcile
  return reconcileChildren(current, workInProgress, nextChildren, renderLanes);
}

function bailoutOnAlreadyFinishedWork(current, workInProgress, renderLanes) {
  // æ£€æŸ¥å­æ ‘æ˜¯å¦æœ‰æ›´æ–°
  if ((current.childLanes & renderLanes) === NoLanes) {
    // å­æ ‘ä¹Ÿæ²¡æ›´æ–°ï¼Œç›´æ¥è¿”å›nullï¼ˆè·³è¿‡å­æ ‘ï¼‰
    return null;
  }

  // å­æ ‘æœ‰æ›´æ–°ï¼Œå¤ç”¨å­èŠ‚ç‚¹ç»§ç»­éå†
  cloneChildFibers(current, workInProgress);
  return workInProgress.child;
}
```

**å®é™…åœºæ™¯æ¼”ç¤ºï¼š**

```javascript
// å‡è®¾ç»„ä»¶æ ‘
//        App
//       /   \
//     List  Sidebar
//    /  |  \
//  Item1 Item2 Item3

// æ›´æ–°ï¼šåªæ”¹å˜Item2çš„æ–‡å­—

// workInProgressæ ‘çš„æ„å»ºï¼š
const buildProcess = {
  App: {
    action: 'è¿›å…¥beginWork',
    reason: 'æ ¹èŠ‚ç‚¹ï¼Œå¿…é¡»å¤„ç†',
    result: 'ç»§ç»­å­èŠ‚ç‚¹'
  },
  List: {
    action: 'è¿›å…¥beginWork',
    reason: 'propsæœªå˜ï¼Œä½†å­æ ‘æœ‰æ›´æ–°ï¼ˆchildLanesï¼‰',
    result: 'å¤ç”¨è‡ªèº«ï¼Œç»§ç»­å­èŠ‚ç‚¹'
  },
  Sidebar: {
    action: 'bailout',
    reason: 'propsæœªå˜ && childLanesä¸ºç©º',
    result: 'è·³è¿‡æ•´ä¸ªSidebarå­æ ‘'
  },
  Item1: {
    action: 'bailout',
    reason: 'propsæœªå˜',
    result: 'è·³è¿‡'
  },
  Item2: {
    action: 'è¿›å…¥reconcile',
    reason: 'propså˜åŒ–',
    result: 'åˆ›å»ºæ–°FiberèŠ‚ç‚¹'
  },
  Item3: {
    action: 'bailout',
    reason: 'propsæœªå˜',
    result: 'è·³è¿‡'
  }
};

// æ€»ç»“ï¼š
// - å®é™…å¤„ç†çš„èŠ‚ç‚¹ï¼šAppã€Listã€Item2ï¼ˆ3ä¸ªï¼‰
// - bailoutè·³è¿‡çš„ï¼šSidebarã€Item1ã€Item3ï¼ˆ3ä¸ªï¼‰
// - åˆ›å»ºæ–°å¯¹è±¡çš„ï¼šItem2ï¼ˆ1ä¸ªï¼‰
// - æ•ˆç‡æå‡ï¼š50%çš„èŠ‚ç‚¹è¢«è·³è¿‡
```

**bailoutçš„æ¡ä»¶ï¼š**

1. `oldProps === newProps`ï¼ˆå¼•ç”¨ç›¸ç­‰ï¼‰
2. `context`æœªå˜åŒ–
3. å½“å‰èŠ‚ç‚¹æ— æ›´æ–°ä»»åŠ¡ï¼ˆ`lanes`ä¸ºç©ºï¼‰
4. å­æ ‘æ— æ›´æ–°ä»»åŠ¡ï¼ˆ`childLanes`ä¸ºç©ºï¼‰

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

å› ä¸º"æ„å»ºworkInProgressæ ‘"å¬èµ·æ¥åƒ"é‡æ–°æ„å»ºæ•´æ£µæ ‘"ã€‚ä½†å®é™…ä¸Šï¼š
- åª**éå†**æ•´æ£µæ ‘ï¼ˆæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼‰
- åª**åˆ›å»º**å˜åŒ–çš„èŠ‚ç‚¹
- **bailout**è·³è¿‡æœªå˜åŒ–çš„å­æ ‘

**æ­£ç¡®ç†è§£ï¼š**

```javascript
// workInProgressæ ‘çš„æ„å»º = éå† + é€‰æ‹©æ€§åˆ›å»º

function buildWorkInProgressTree(root) {
  let current = root.current;
  let workInProgress = root.current.alternate;

  // éå†æ ‘ï¼ˆå¿…é¡»ï¼‰
  while (workInProgress !== null) {
    if (shouldUpdate(workInProgress)) {
      // æœ‰å˜åŒ–ï¼šåˆ›å»ºæ–°èŠ‚ç‚¹æˆ–æ›´æ–°
      updateNode(workInProgress);
    } else {
      // æ— å˜åŒ–ï¼šbailoutï¼Œè·³è¿‡å­æ ‘
      skipSubtree(workInProgress);
    }

    workInProgress = getNextWorkInProgress(workInProgress);
  }
}

// å¤§éƒ¨åˆ†æ›´æ–°åªå½±å“å±€éƒ¨ï¼Œbailoutè·³è¿‡90%+çš„èŠ‚ç‚¹
```

---

### è¯¯åŒº3ï¼šåˆ‡æ¢åæ—§currentæ ‘è¢«é”€æ¯ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

åˆ‡æ¢åï¼Œæ—§currentæ ‘å˜æˆæ–°workInProgressçš„alternateï¼Œ**ä¸ä¼šè¢«é”€æ¯**ï¼Œè€Œæ˜¯ç­‰å¾…ä¸‹æ¬¡å¤ç”¨ï¼š

```javascript
// ç¬¬ä¸€æ¬¡æ›´æ–°å‰
const state1 = {
  current: FiberTreeA,
  alternate: null
};

// ç¬¬ä¸€æ¬¡æ›´æ–°ï¼šåˆ›å»ºTreeB
const TreeB = createWorkInProgress(FiberTreeA, newProps);
FiberTreeA.alternate = TreeB;
TreeB.alternate = FiberTreeA;

// ç¬¬ä¸€æ¬¡commitï¼šåˆ‡æ¢æŒ‡é’ˆ
state1.current = TreeB;

// æ­¤æ—¶TreeAçš„çŠ¶æ€ï¼š
console.log('TreeAè¿˜åœ¨å†…å­˜ä¸­:', TreeA !== null);              // true
console.log('TreeAå¯é€šè¿‡alternateè®¿é—®:', TreeB.alternate === TreeA);  // true
console.log('TreeAç­‰å¾…å¤ç”¨:', true);

// ç¬¬äºŒæ¬¡æ›´æ–°ï¼šå¤ç”¨TreeA
const TreeA_reused = createWorkInProgress(TreeB, newerProps);
console.log('å¤ç”¨äº†TreeA:', TreeA_reused === TreeA);         // true

// ç¬¬äºŒæ¬¡commitï¼šåˆ‡æ¢å›TreeA
state1.current = TreeA_reused;

// æ­¤æ—¶TreeBçš„çŠ¶æ€ï¼š
console.log('TreeBè¿˜åœ¨å†…å­˜ä¸­:', TreeB !== null);              // true
console.log('TreeBå¯é€šè¿‡alternateè®¿é—®:', TreeA.alternate === TreeB);  // true
console.log('TreeBç­‰å¾…å¤ç”¨:', true);
```

**è§’è‰²äº’æ¢æ¼”ç¤ºï¼š**

```javascript
const lifecycle = [
  { time: 'T0', current: 'TreeA', alternate: 'null', phase: 'åˆå§‹æ¸²æŸ“' },
  { time: 'T1', current: 'TreeA', alternate: 'TreeBï¼ˆåˆ›å»ºï¼‰', phase: 'ç¬¬1æ¬¡æ›´æ–°render' },
  { time: 'T2', current: 'TreeB', alternate: 'TreeA', phase: 'ç¬¬1æ¬¡æ›´æ–°commit' },
  { time: 'T3', current: 'TreeB', alternate: 'TreeAï¼ˆå¤ç”¨ï¼‰', phase: 'ç¬¬2æ¬¡æ›´æ–°render' },
  { time: 'T4', current: 'TreeA', alternate: 'TreeB', phase: 'ç¬¬2æ¬¡æ›´æ–°commit' },
  { time: 'T5', current: 'TreeA', alternate: 'TreeBï¼ˆå¤ç”¨ï¼‰', phase: 'ç¬¬3æ¬¡æ›´æ–°render' },
  { time: 'T6', current: 'TreeB', alternate: 'TreeA', phase: 'ç¬¬3æ¬¡æ›´æ–°commit' }
];

lifecycle.forEach(state => {
  console.log(`${state.time} ${state.phase}:`);
  console.log(`  current â†’ ${state.current}`);
  console.log(`  alternate â†’ ${state.alternate}`);
});

console.log('\nç»“è®ºï¼šTreeAå’ŒTreeBè½®æµæ‰®æ¼”currentå’Œalternateè§’è‰²ï¼Œæ°¸ä¸é”€æ¯');
```

**ä»€ä¹ˆæ—¶å€™ä¼šé”€æ¯FiberèŠ‚ç‚¹ï¼Ÿ**

åªæœ‰ä¸¤ç§æƒ…å†µï¼š
1. **ç»„ä»¶è¢«åˆ é™¤**ï¼š
   ```javascript
   // ç»„ä»¶ä»æ ‘ä¸Šç§»é™¤
   <div>
     {showChild && <Child />}  // showChildå˜falseæ—¶ï¼ŒChildçš„Fiberè¢«æ ‡è®°åˆ é™¤
   </div>
   ```

2. **å¸è½½æ•´ä¸ªåº”ç”¨**ï¼š
   ```javascript
   root.unmount();  // æ•´ä¸ªFiberæ ‘è¢«é”€æ¯
   ```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

å› ä¸º"åˆ‡æ¢"è¿™ä¸ªè¯å®¹æ˜“è®©äººè”æƒ³åˆ°"æ›¿æ¢"ã€‚ä½†å®é™…ä¸Šï¼š
- **åˆ‡æ¢**ï¼šæ”¹å˜æŒ‡é’ˆæ–¹å‘ï¼Œä¸é”€æ¯å¯¹è±¡
- **äº’æ¢**ï¼šcurrentå’ŒworkInProgressè§’è‰²äº’æ¢
- **å¤ç”¨**ï¼šä¸¤æ£µæ ‘æ°¸ä¹…å­˜åœ¨ï¼Œè½®æµä½¿ç”¨

**æ­£ç¡®ç†è§£ï¼š**

```javascript
// åŒç¼“å†² = ä¸¤ä¸ªå¯¹è±¡ + ä¸€ä¸ªæŒ‡é’ˆ + è§’è‰²äº’æ¢

const buffer1 = { data: 'A' };
const buffer2 = { data: 'B' };
let current = buffer1;  // æŒ‡é’ˆ

// ç¬¬ä¸€æ¬¡åˆ‡æ¢
current = buffer2;  // æŒ‡é’ˆæŒ‡å‘buffer2
// buffer1æ²¡æœ‰è¢«é”€æ¯ï¼Œåªæ˜¯ä¸æ˜¯currentäº†

// ç¬¬äºŒæ¬¡åˆ‡æ¢
current = buffer1;  // æŒ‡é’ˆæŒ‡å‘buffer1
// buffer2æ²¡æœ‰è¢«é”€æ¯ï¼Œè§’è‰²äº’æ¢äº†

// ä¸¤ä¸ªå¯¹è±¡æ°¸ä¹…å­˜åœ¨ï¼ŒæŒ‡é’ˆåœ¨å®ƒä»¬ä¹‹é—´åˆ‡æ¢
```

---

## ä¸ƒã€ã€å®æˆ˜ä»£ç ã€‘

### åŸºç¡€å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰

```javascript
// ===== 1. åŒç¼“å†²æœºåˆ¶çš„åŸºç¡€å®ç° =====
console.log("=== 1. åŒç¼“å†²æœºåˆ¶çš„åŸºç¡€å®ç° ===\n");

// FiberNodeç±»
class FiberNode {
  constructor(tag, type, key) {
    this.tag = tag;
    this.type = type;
    this.key = key;

    this.return = null;
    this.child = null;
    this.sibling = null;

    this.pendingProps = null;
    this.memoizedProps = null;
    this.memoizedState = null;

    this.alternate = null;
    this.flags = 0;

    this.stateNode = null;
  }
}

// FiberRootNodeç±»
class FiberRootNode {
  constructor() {
    this.current = null;      // æŒ‡å‘currentæ ‘
    this.finishedWork = null; // æŒ‡å‘å®Œæˆçš„workInProgressæ ‘
  }
}

// ===== 2. createWorkInProgresså‡½æ•° =====
console.log("=== 2. createWorkInProgresså‡½æ•° ===\n");

function createWorkInProgress(current, pendingProps) {
  let workInProgress = current.alternate;

  if (workInProgress === null) {
    // é¦–æ¬¡æ›´æ–°ï¼šåˆ›å»ºæ–°FiberèŠ‚ç‚¹
    console.log('  â†’ åˆ›å»ºæ–°çš„workInProgressèŠ‚ç‚¹');

    workInProgress = new FiberNode(current.tag, current.type, current.key);
    workInProgress.stateNode = current.stateNode;  // å¤ç”¨DOMèŠ‚ç‚¹

    // å»ºç«‹åŒå‘è¿æ¥
    workInProgress.alternate = current;
    current.alternate = workInProgress;
  } else {
    // åç»­æ›´æ–°ï¼šå¤ç”¨alternateèŠ‚ç‚¹
    console.log('  â†’ å¤ç”¨å·²æœ‰çš„alternateèŠ‚ç‚¹');

    // é‡ç½®å‰¯ä½œç”¨
    workInProgress.flags = 0;
  }

  // è®¾ç½®props
  workInProgress.pendingProps = pendingProps;

  // å¤ç”¨childï¼ˆåç»­å¯èƒ½ä¼šæ›´æ–°ï¼‰
  workInProgress.child = current.child;
  workInProgress.memoizedProps = current.memoizedProps;
  workInProgress.memoizedState = current.memoizedState;

  return workInProgress;
}

// ===== 3. å®Œæ•´çš„æ›´æ–°æµç¨‹æ¼”ç¤º =====
console.log("=== 3. å®Œæ•´çš„æ›´æ–°æµç¨‹æ¼”ç¤º ===\n");

// åˆå§‹åŒ–root
const root = new FiberRootNode();

// åˆå§‹æ¸²æŸ“
const initialFiber = new FiberNode('HostComponent', 'div', null);
initialFiber.pendingProps = { className: 'container', text: 'åˆå§‹å†…å®¹' };
initialFiber.memoizedProps = initialFiber.pendingProps;
initialFiber.stateNode = { textContent: 'åˆå§‹å†…å®¹' };  // æ¨¡æ‹ŸDOMèŠ‚ç‚¹

root.current = initialFiber;

console.log('åˆå§‹æ¸²æŸ“å®Œæˆ:');
console.log('  currentæ ‘çš„props:', root.current.memoizedProps);
console.log('  DOMå†…å®¹:', root.current.stateNode.textContent);
console.log('');

// ===== ç¬¬ä¸€æ¬¡æ›´æ–° =====
console.log('--- ç¬¬ä¸€æ¬¡æ›´æ–° ---');

// renderé˜¶æ®µ
console.log('Renderé˜¶æ®µï¼š');
const workInProgress1 = createWorkInProgress(
  root.current,
  { className: 'container', text: 'ç¬¬ä¸€æ¬¡æ›´æ–°' }
);
console.log('  workInProgressçš„props:', workInProgress1.pendingProps);
console.log('  current.alternate === workInProgress:', root.current.alternate === workInProgress1);
console.log('');

// ä¿å­˜åˆ°finishedWork
root.finishedWork = workInProgress1;

// commité˜¶æ®µ
console.log('Commité˜¶æ®µï¼š');
console.log('  æ‰§è¡ŒDOMæ“ä½œ...');
workInProgress1.stateNode.textContent = workInProgress1.pendingProps.text;
workInProgress1.memoizedProps = workInProgress1.pendingProps;

console.log('  åˆ‡æ¢æŒ‡é’ˆ: root.current = finishedWork');
const oldCurrent1 = root.current;
root.current = root.finishedWork;
root.finishedWork = null;

console.log('  ä¹‹å‰çš„current:', oldCurrent1.memoizedProps.text);
console.log('  æ–°çš„current:', root.current.memoizedProps.text);
console.log('  DOMå†…å®¹:', root.current.stateNode.textContent);
console.log('');

// ===== ç¬¬äºŒæ¬¡æ›´æ–°ï¼ˆå¤ç”¨ï¼‰=====
console.log('--- ç¬¬äºŒæ¬¡æ›´æ–°ï¼ˆå¤ç”¨ï¼‰---');

console.log('Renderé˜¶æ®µï¼š');
const workInProgress2 = createWorkInProgress(
  root.current,
  { className: 'container', text: 'ç¬¬äºŒæ¬¡æ›´æ–°' }
);
console.log('  workInProgressçš„props:', workInProgress2.pendingProps);
console.log('  å¤ç”¨äº†åŸæ¥çš„FiberèŠ‚ç‚¹:', workInProgress2 === oldCurrent1);
console.log('');

root.finishedWork = workInProgress2;

console.log('Commité˜¶æ®µï¼š');
console.log('  æ‰§è¡ŒDOMæ“ä½œ...');
workInProgress2.stateNode.textContent = workInProgress2.pendingProps.text;
workInProgress2.memoizedProps = workInProgress2.pendingProps;

console.log('  åˆ‡æ¢æŒ‡é’ˆ: root.current = finishedWork');
const oldCurrent2 = root.current;
root.current = root.finishedWork;
root.finishedWork = null;

console.log('  ä¹‹å‰çš„current:', oldCurrent2.memoizedProps.text);
console.log('  æ–°çš„current:', root.current.memoizedProps.text);
console.log('  DOMå†…å®¹:', root.current.stateNode.textContent);
console.log('');

// ===== 4. bailoutä¼˜åŒ–æ¼”ç¤º =====
console.log("=== 4. bailoutä¼˜åŒ–æ¼”ç¤º ===\n");

function bailoutOnAlreadyFinishedWork(current, workInProgress) {
  console.log(`  â†’ bailout: è·³è¿‡èŠ‚ç‚¹ ${workInProgress.type}`);

  // å¤ç”¨å­èŠ‚ç‚¹
  workInProgress.child = current.child;

  return workInProgress.child;
}

function beginWork(current, workInProgress) {
  console.log(`beginWork: ${workInProgress.type}`);

  // bailoutæ£€æŸ¥
  const oldProps = current.memoizedProps;
  const newProps = workInProgress.pendingProps;

  if (oldProps === newProps) {
    // propsæœªå˜åŒ–ï¼Œbailout
    return bailoutOnAlreadyFinishedWork(current, workInProgress);
  }

  // propså˜åŒ–ï¼Œç»§ç»­reconcile
  console.log(`  â†’ propså˜åŒ–ï¼Œç»§ç»­reconcile`);
  return reconcileChildren(current, workInProgress);
}

function reconcileChildren(current, workInProgress) {
  console.log(`  â†’ reconcileå­èŠ‚ç‚¹`);
  // è¿™é‡Œç®€åŒ–ï¼Œå®é™…ä¼šdiffå­èŠ‚ç‚¹
  return workInProgress.child;
}

// æ„å»ºæµ‹è¯•æ ‘
const parentFiber = new FiberNode('HostComponent', 'div', null);
parentFiber.pendingProps = { id: 'parent' };
parentFiber.memoizedProps = { id: 'parent' };

const child1 = new FiberNode('HostComponent', 'span', '1');
child1.pendingProps = { text: 'unchanged' };
child1.memoizedProps = { text: 'unchanged' };

const child2 = new FiberNode('HostComponent', 'span', '2');
child2.pendingProps = { text: 'changed' };
child2.memoizedProps = { text: 'old' };

parentFiber.child = child1;
child1.sibling = child2;
child1.return = parentFiber;
child2.return = parentFiber;

// åˆ›å»ºworkInProgress
const wipParent = createWorkInProgress(parentFiber, { id: 'parent' });
const wipChild1 = createWorkInProgress(child1, { text: 'unchanged' });
const wipChild2 = createWorkInProgress(child2, { text: 'changed' });

wipParent.child = wipChild1;
wipChild1.sibling = wipChild2;

// æ¨¡æ‹ŸbeginWork
console.log('æ¨¡æ‹ŸbeginWorkè¿‡ç¨‹:');
beginWork(parentFiber, wipParent);
beginWork(child1, wipChild1);  // bailout
beginWork(child2, wipChild2);  // ç»§ç»­æ›´æ–°

console.log('');

// ===== 5. åŒæ ‘å¯è§†åŒ– =====
console.log("=== 5. åŒæ ‘å¯è§†åŒ– ===\n");

function visualizeDoubleBuffer() {
  console.log('åˆå§‹çŠ¶æ€:');
  console.log('  [currentæ ‘]          [workInProgressæ ‘]');
  console.log('      App                    null');
  console.log('');

  console.log('ç¬¬ä¸€æ¬¡æ›´æ–°renderé˜¶æ®µ:');
  console.log('  [currentæ ‘]          [workInProgressæ ‘]');
  console.log('      App   â†alternateâ†’      App\'');
  console.log('       â†“                       â†“');
  console.log('     List                   List\'');
  console.log('');

  console.log('ç¬¬ä¸€æ¬¡æ›´æ–°commitå:');
  console.log('  [currentæ ‘]          [alternateæ ‘]');
  console.log('      App\'  â†alternateâ†’      App');
  console.log('       â†“                       â†“');
  console.log('     List\'                   List');
  console.log('  (æ–°current)            (ç­‰å¾…å¤ç”¨)');
  console.log('');

  console.log('ç¬¬äºŒæ¬¡æ›´æ–°renderé˜¶æ®µ:');
  console.log('  [currentæ ‘]          [workInProgressæ ‘ï¼ˆå¤ç”¨ï¼‰]');
  console.log('      App\'  â†alternateâ†’      App (å¤ç”¨!)');
  console.log('       â†“                       â†“');
  console.log('     List\'                   List (å¤ç”¨!)');
  console.log('');
}

visualizeDoubleBuffer();

// ===== 6. å†…å­˜å¤ç”¨ç»Ÿè®¡ =====
console.log("=== 6. å†…å­˜å¤ç”¨ç»Ÿè®¡ ===\n");

class MemoryStats {
  constructor() {
    this.created = 0;
    this.reused = 0;
  }

  trackCreate() {
    this.created++;
  }

  trackReuse() {
    this.reused++;
  }

  report() {
    const total = this.created + this.reused;
    const reuseRate = total === 0 ? 0 : (this.reused / total * 100).toFixed(1);

    console.log('å†…å­˜å¤ç”¨ç»Ÿè®¡:');
    console.log(`  åˆ›å»ºæ–°å¯¹è±¡: ${this.created}`);
    console.log(`  å¤ç”¨å¯¹è±¡: ${this.reused}`);
    console.log(`  æ€»æ“ä½œ: ${total}`);
    console.log(`  å¤ç”¨ç‡: ${reuseRate}%`);
  }
}

const stats = new MemoryStats();

// æ¨¡æ‹Ÿå¤šæ¬¡æ›´æ–°
function simulateUpdates(count) {
  let currentTree = new FiberNode('HostComponent', 'div', null);
  stats.trackCreate();

  for (let i = 0; i < count; i++) {
    const wip = createWorkInProgress(currentTree, { version: i });

    if (currentTree.alternate === null) {
      stats.trackCreate();  // åˆ›å»ºæ–°èŠ‚ç‚¹
    } else {
      stats.trackReuse();    // å¤ç”¨èŠ‚ç‚¹
    }

    // æ¨¡æ‹Ÿcommit
    currentTree = wip;
  }
}

simulateUpdates(10);
stats.report();

console.log('\n=== æ‰€æœ‰æ¼”ç¤ºå®Œæˆ ===');
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼š**

```
=== 1. åŒç¼“å†²æœºåˆ¶çš„åŸºç¡€å®ç° ===

=== 2. createWorkInProgresså‡½æ•° ===

=== 3. å®Œæ•´çš„æ›´æ–°æµç¨‹æ¼”ç¤º ===

åˆå§‹æ¸²æŸ“å®Œæˆ:
  currentæ ‘çš„props: { className: 'container', text: 'åˆå§‹å†…å®¹' }
  DOMå†…å®¹: åˆå§‹å†…å®¹

--- ç¬¬ä¸€æ¬¡æ›´æ–° ---
Renderé˜¶æ®µï¼š
  â†’ åˆ›å»ºæ–°çš„workInProgressèŠ‚ç‚¹
  workInProgressçš„props: { className: 'container', text: 'ç¬¬ä¸€æ¬¡æ›´æ–°' }
  current.alternate === workInProgress: true

Commité˜¶æ®µï¼š
  æ‰§è¡ŒDOMæ“ä½œ...
  åˆ‡æ¢æŒ‡é’ˆ: root.current = finishedWork
  ä¹‹å‰çš„current: åˆå§‹å†…å®¹
  æ–°çš„current: ç¬¬ä¸€æ¬¡æ›´æ–°
  DOMå†…å®¹: ç¬¬ä¸€æ¬¡æ›´æ–°

--- ç¬¬äºŒæ¬¡æ›´æ–°ï¼ˆå¤ç”¨ï¼‰---
Renderé˜¶æ®µï¼š
  â†’ å¤ç”¨å·²æœ‰çš„alternateèŠ‚ç‚¹
  workInProgressçš„props: { className: 'container', text: 'ç¬¬äºŒæ¬¡æ›´æ–°' }
  å¤ç”¨äº†åŸæ¥çš„FiberèŠ‚ç‚¹: true

Commité˜¶æ®µï¼š
  æ‰§è¡ŒDOMæ“ä½œ...
  åˆ‡æ¢æŒ‡é’ˆ: root.current = finishedWork
  ä¹‹å‰çš„current: ç¬¬ä¸€æ¬¡æ›´æ–°
  æ–°çš„current: ç¬¬äºŒæ¬¡æ›´æ–°
  DOMå†…å®¹: ç¬¬äºŒæ¬¡æ›´æ–°

=== 4. bailoutä¼˜åŒ–æ¼”ç¤º ===

  â†’ åˆ›å»ºæ–°çš„workInProgressèŠ‚ç‚¹
  â†’ å¤ç”¨å·²æœ‰çš„alternateèŠ‚ç‚¹
  â†’ å¤ç”¨å·²æœ‰çš„alternateèŠ‚ç‚¹
æ¨¡æ‹ŸbeginWorkè¿‡ç¨‹:
beginWork: div
  â†’ propsæœªå˜åŒ–ï¼Œç»§ç»­æ£€æŸ¥å­èŠ‚ç‚¹
beginWork: span
  â†’ bailout: è·³è¿‡èŠ‚ç‚¹ span
beginWork: span
  â†’ propså˜åŒ–ï¼Œç»§ç»­reconcile
  â†’ reconcileå­èŠ‚ç‚¹

=== 5. åŒæ ‘å¯è§†åŒ– ===

åˆå§‹çŠ¶æ€:
  [currentæ ‘]          [workInProgressæ ‘]
      App                    null

ç¬¬ä¸€æ¬¡æ›´æ–°renderé˜¶æ®µ:
  [currentæ ‘]          [workInProgressæ ‘]
      App   â†alternateâ†’      App'
       â†“                       â†“
     List                   List'

ç¬¬ä¸€æ¬¡æ›´æ–°commitå:
  [currentæ ‘]          [alternateæ ‘]
      App'  â†alternateâ†’      App
       â†“                       â†“
     List'                   List
  (æ–°current)            (ç­‰å¾…å¤ç”¨)

ç¬¬äºŒæ¬¡æ›´æ–°renderé˜¶æ®µ:
  [currentæ ‘]          [workInProgressæ ‘ï¼ˆå¤ç”¨ï¼‰]
      App'  â†alternateâ†’      App (å¤ç”¨!)
       â†“                       â†“
     List'                   List (å¤ç”¨!)

=== 6. å†…å­˜å¤ç”¨ç»Ÿè®¡ ===

å†…å­˜å¤ç”¨ç»Ÿè®¡:
  åˆ›å»ºæ–°å¯¹è±¡: 2
  å¤ç”¨å¯¹è±¡: 9
  æ€»æ“ä½œ: 11
  å¤ç”¨ç‡: 81.8%

=== æ‰€æœ‰æ¼”ç¤ºå®Œæˆ ===
```

---

### è¿›é˜¶ï¼šReactæºç å®ç°

```javascript
// React 19æºç ç‰‡æ®µ

// ===== 1. createWorkInProgress =====
// packages/react-reconciler/src/ReactFiber.js

export function createWorkInProgress(current: Fiber, pendingProps: any): Fiber {
  let workInProgress = current.alternate;

  if (workInProgress === null) {
    // Mounté˜¶æ®µæˆ–å¤ç”¨ä¸å¯ç”¨
    workInProgress = createFiber(
      current.tag,
      pendingProps,
      current.key,
      current.mode,
    );
    workInProgress.elementType = current.elementType;
    workInProgress.type = current.type;
    workInProgress.stateNode = current.stateNode;

    // å»ºç«‹åŒå‘è¿æ¥
    workInProgress.alternate = current;
    current.alternate = workInProgress;
  } else {
    // Updateé˜¶æ®µï¼šå¤ç”¨alternate
    workInProgress.pendingProps = pendingProps;
    workInProgress.type = current.type;

    // é‡ç½®å‰¯ä½œç”¨
    workInProgress.flags = NoFlags;
    workInProgress.subtreeFlags = NoFlags;
    workInProgress.deletions = null;
  }

  // å¤ç”¨lanes
  workInProgress.childLanes = current.childLanes;
  workInProgress.lanes = current.lanes;

  // å¤ç”¨stateå’Œprops
  workInProgress.child = current.child;
  workInProgress.memoizedProps = current.memoizedProps;
  workInProgress.memoizedState = current.memoizedState;
  workInProgress.updateQueue = current.updateQueue;

  // å¤ç”¨dependencies
  const currentDependencies = current.dependencies;
  workInProgress.dependencies =
    currentDependencies === null
      ? null
      : {
          lanes: currentDependencies.lanes,
          firstContext: currentDependencies.firstContext,
        };

  workInProgress.sibling = current.sibling;
  workInProgress.index = current.index;
  workInProgress.ref = current.ref;

  return workInProgress;
}

// ===== 2. prepareFreshStack =====
// packages/react-reconciler/src/ReactFiberWorkLoop.js

function prepareFreshStack(root: FiberRoot, lanes: Lanes): Fiber {
  root.finishedWork = null;
  root.finishedLanes = NoLanes;

  // ä¸­æ–­ä¹‹å‰çš„work
  if (workInProgress !== null) {
    interruptedWork = workInProgress.return;
    while (interruptedWork !== null) {
      const current = interruptedWork.alternate;
      unwindInterruptedWork(
        current,
        interruptedWork,
        workInProgressRootRenderLanes,
      );
      interruptedWork = interruptedWork.return;
    }
  }

  // åˆ›å»ºworkInProgressæ ‘
  workInProgressRoot = root;
  const rootWorkInProgress = createWorkInProgress(root.current, null);
  workInProgress = rootWorkInProgress;
  workInProgressRootRenderLanes = renderLanes = lanes;
  workInProgressRootExitStatus = RootInProgress;

  return rootWorkInProgress;
}

// ===== 3. commitRoot =====
// packages/react-reconciler/src/ReactFiberWorkLoop.js

function commitRoot(
  root: FiberRoot,
  recoverableErrors: null | Array<CapturedValue<mixed>>,
  transitions: Array<Transition> | null,
) {
  const previousUpdateLanePriority = getCurrentUpdatePriority();
  const prevTransition = ReactCurrentBatchConfig.transition;

  try {
    ReactCurrentBatchConfig.transition = null;
    setCurrentUpdatePriority(DiscreteEventPriority);
    commitRootImpl(
      root,
      recoverableErrors,
      transitions,
      previousUpdateLanePriority,
    );
  } finally {
    ReactCurrentBatchConfig.transition = prevTransition;
    setCurrentUpdatePriority(previousUpdateLanePriority);
  }

  return null;
}

function commitRootImpl(
  root: FiberRoot,
  recoverableErrors: null | Array<CapturedValue<mixed>>,
  transitions: Array<Transition> | null,
  renderPriorityLevel: EventPriority,
) {
  const finishedWork = root.finishedWork;
  const lanes = root.finishedLanes;

  if (finishedWork === null) {
    return null;
  }

  root.finishedWork = null;
  root.finishedLanes = NoLanes;

  // before mutationé˜¶æ®µ
  const shouldFireAfterActiveInstanceBlur = commitBeforeMutationEffects(
    root,
    finishedWork,
  );

  // mutationé˜¶æ®µ
  commitMutationEffects(root, finishedWork, lanes);

  // ã€å…³é”®ã€‘åˆ‡æ¢æŒ‡é’ˆ
  root.current = finishedWork;

  // layouté˜¶æ®µ
  commitLayoutEffects(finishedWork, root, lanes);

  // è¯·æ±‚åç»­è°ƒåº¦
  ensureRootIsScheduled(root, now());

  return null;
}

// ===== 4. bailoutä¼˜åŒ– =====
// packages/react-reconciler/src/ReactFiberBeginWork.js

function bailoutOnAlreadyFinishedWork(
  current: Fiber | null,
  workInProgress: Fiber,
  renderLanes: Lanes,
): Fiber | null {
  if (current !== null) {
    // å¤ç”¨props
    workInProgress.dependencies = current.dependencies;
  }

  // æ ‡è®°è·³è¿‡çš„lanes
  markSkippedUpdateLanes(workInProgress.lanes);

  // æ£€æŸ¥å­æ ‘æ˜¯å¦æœ‰work
  if (!includesSomeLane(renderLanes, workInProgress.childLanes)) {
    // å­æ ‘ä¹Ÿæ²¡æœ‰workï¼Œå®Œå…¨è·³è¿‡
    return null;
  }

  // å­æ ‘æœ‰workï¼Œå¤ç”¨å­èŠ‚ç‚¹ç»§ç»­
  cloneChildFibers(current, workInProgress);
  return workInProgress.child;
}

// ===== 5. cloneChildFibers =====
// packages/react-reconciler/src/ReactChildFiber.js

export function cloneChildFibers(
  current: Fiber | null,
  workInProgress: Fiber,
): void {
  if (current !== null && workInProgress.child !== current.child) {
    throw new Error('Resuming work not yet implemented.');
  }

  if (workInProgress.child === null) {
    return;
  }

  let currentChild = workInProgress.child;
  let newChild = createWorkInProgress(currentChild, currentChild.pendingProps);
  workInProgress.child = newChild;

  newChild.return = workInProgress;
  while (currentChild.sibling !== null) {
    currentChild = currentChild.sibling;
    newChild = newChild.sibling = createWorkInProgress(
      currentChild,
      currentChild.pendingProps,
    );
    newChild.return = workInProgress;
  }
  newChild.sibling = null;
}
```

**å…³é”®æºç æ–‡ä»¶ï¼š**
- `packages/react-reconciler/src/ReactFiber.js` - createWorkInProgress
- `packages/react-reconciler/src/ReactFiberWorkLoop.js` - prepareFreshStack, commitRoot
- `packages/react-reconciler/src/ReactFiberBeginWork.js` - bailoutOnAlreadyFinishedWork
- `packages/react-reconciler/src/ReactChildFiber.js` - cloneChildFibers

---

## å…«ã€ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜1ï¼š"Reactä¸ºä»€ä¹ˆéœ€è¦åŒç¼“å†²æœºåˆ¶ï¼Ÿå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"åŒç¼“å†²æœºåˆ¶å¯ä»¥æé«˜æ€§èƒ½ï¼Œé¿å…é¡µé¢é—ªçƒã€‚Reactç”¨ä¸¤æ£µæ ‘ï¼Œä¸€æ£µæ˜¾ç¤ºï¼Œä¸€æ£µæ„å»ºï¼Œæ„å»ºå®Œæˆååˆ‡æ¢ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **Reactçš„åŒç¼“å†²æœºåˆ¶ä»ä¸‰ä¸ªå±‚é¢è§£å†³äº†å…³é”®é—®é¢˜ï¼š**
>
> **1. ç”¨æˆ·ä½“éªŒå±‚é¢ï¼šæ— é—ªçƒæ›´æ–°**
>
> å¦‚æœç›´æ¥åœ¨å½“å‰æ ‘ä¸Šä¿®æ”¹ï¼Œç”¨æˆ·ä¼šçœ‹åˆ°UIæ›´æ–°çš„ä¸­é—´è¿‡ç¨‹ï¼š
> - åˆ é™¤æ—§å…ƒç´  â†’ ç©ºç™½æœŸ â†’ æ·»åŠ æ–°å…ƒç´  â†’ é—ªçƒ
> - é€ä¸ªæ›´æ–°DOMå±æ€§ â†’ å¸ƒå±€æŠ–åŠ¨
> - é‡æ–°æ¸²æŸ“å­æ ‘ â†’ çœ‹åˆ°ä¸å®Œæ•´çš„UI
>
> åŒç¼“å†²æœºåˆ¶åœ¨workInProgressæ ‘ä¸Šæ„å»ºæ–°UIï¼Œç”¨æˆ·çœ‹currentæ ‘ï¼Œæ„å»ºå®Œæˆåä¸€æ¬¡æ€§åˆ‡æ¢æŒ‡é’ˆï¼Œç”¨æˆ·ä½“éªŒä» `[æ—§UI] â†’ [ä¸­é—´æ€] â†’ [æ–°UI]` å˜æˆ `[æ—§UI] â†’ [æ–°UI]`ï¼Œç¬é—´å®Œæˆã€‚
>
> **2. æ€§èƒ½å±‚é¢ï¼šå¯¹è±¡å¤ç”¨ + æ‰¹é‡æ“ä½œ**
>
> - **å¯¹è±¡å¤ç”¨**ï¼šä¸¤æ£µæ ‘é€šè¿‡alternateè½®æµæ‰®æ¼”currentå’ŒworkInProgressï¼Œå¤ç”¨ç‡90%+
> - **bailoutä¼˜åŒ–**ï¼šå¯¹æ¯”currentå’ŒworkInProgressçš„propsï¼Œè·³è¿‡æœªå˜åŒ–çš„å­æ ‘
> - **æ‰¹é‡æ“ä½œ**ï¼šæ‰€æœ‰DOMæ“ä½œæ”¶é›†åˆ°commité˜¶æ®µæ‰¹é‡æ‰§è¡Œï¼Œå‡å°‘å¸ƒå±€è®¡ç®—
>
> ```javascript
> // æ— åŒç¼“å†²ï¼šè¾¹è®¡ç®—è¾¹æ›´æ–°DOM
> updateDOM(node1);  // è§¦å‘å¸ƒå±€è®¡ç®—
> updateDOM(node2);  // å†æ¬¡è§¦å‘
> updateDOM(node3);  // å†æ¬¡è§¦å‘
>
> // åŒç¼“å†²ï¼šå…ˆè®¡ç®—ï¼Œå†æ‰¹é‡æ›´æ–°
> calculateChanges(wip);    // åœ¨å†…å­˜ä¸­è®¡ç®—
> commitAllChanges(wip);    // æ‰¹é‡æ›´æ–°DOMï¼ˆä¸€æ¬¡å¸ƒå±€è®¡ç®—ï¼‰
> ```
>
> **3. æ¶æ„å±‚é¢ï¼šæ”¯æŒå¯ä¸­æ–­æ¸²æŸ“**
>
> åŒç¼“å†²æ˜¯å¯ä¸­æ–­æ¸²æŸ“çš„åŸºç¡€ï¼š
> - workInProgressæ ‘å¯ä»¥åºŸå¼ƒé‡æ¥ï¼ˆé«˜ä¼˜å…ˆçº§ä»»åŠ¡æ‰“æ–­ä½ä¼˜å…ˆçº§ï¼‰
> - currentæ ‘å§‹ç»ˆå®Œæ•´ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
> - å‡ºé”™æ—¶ä¸¢å¼ƒworkInProgressï¼Œcurrentä¸å—å½±å“
>
> ```javascript
> // æ­£åœ¨æ„å»ºä½ä¼˜å…ˆçº§æ›´æ–°
> buildWorkInProgressTree(lowPriorityUpdate);
>
> // é«˜ä¼˜å…ˆçº§æ›´æ–°åˆ°æ¥
> if (hasHighPriorityUpdate()) {
>   workInProgress = null;  // åºŸå¼ƒå½“å‰work
>   buildWorkInProgressTree(highPriorityUpdate);  // é‡æ–°æ„å»º
> }
> // currentæ ‘å®Œæ•´ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
> ```
>
> **åœ¨å®é™…å·¥ä½œä¸­çš„åº”ç”¨ï¼š**
> - ç†è§£ä¸ºä»€ä¹ˆReactæ›´æ–°å¿«ï¼ˆå¯¹è±¡å¤ç”¨+æ‰¹é‡æ“ä½œï¼‰
> - ç†è§£ä¸ºä»€ä¹ˆå¹¶å‘æ¨¡å¼èƒ½ä¸­æ–­ï¼ˆåŒç¼“å†²æ”¯æŒï¼‰
> - æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘ä¸å¿…è¦çš„re-renderï¼Œæé«˜bailoutå‘½ä¸­ç‡

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**

1. âœ… ä»ç”¨æˆ·ä½“éªŒã€æ€§èƒ½ã€æ¶æ„ä¸‰å±‚åˆ†æ
2. âœ… å¯¹æ¯”æœ‰åŒç¼“å†²å’Œæ— åŒç¼“å†²çš„åŒºåˆ«
3. âœ… ç»“åˆä»£ç ç¤ºä¾‹è¯´æ˜æœºåˆ¶
4. âœ… è”ç³»å®é™…å·¥ä½œä¸­çš„åº”ç”¨

---

### é—®é¢˜2ï¼š"currentæ ‘å’ŒworkInProgressæ ‘æ˜¯å¦‚ä½•åä½œçš„ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"currentæ ‘æ˜¯å½“å‰æ˜¾ç¤ºçš„ï¼ŒworkInProgressæ ‘æ˜¯æ­£åœ¨æ„å»ºçš„ï¼Œé€šè¿‡alternateæŒ‡é’ˆè¿æ¥ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **currentå’ŒworkInProgressæ ‘çš„åä½œå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š**
>
> **1. Renderé˜¶æ®µï¼šåœ¨workInProgressæ ‘ä¸Šå·¥ä½œ**
>
> ```javascript
> // åˆ›å»º/å¤ç”¨workInProgress
> let wip = current.alternate || createFiber(...);
>
> // åœ¨wipä¸Šè¿›è¡Œdiffå’Œæ›´æ–°
> while (wip !== null) {
>   // beginWork: å¯¹æ¯”propsï¼Œå†³å®šæ˜¯å¦æ›´æ–°
>   if (current.memoizedProps === wip.pendingProps) {
>     bailout(wip);  // è·³è¿‡
>   } else {
>     reconcile(wip);  // æ›´æ–°
>   }
>
>   wip = getNextFiber(wip);
> }
> ```
>
> å…³é”®ç‚¹ï¼š
> - currentæ ‘ä¿æŒä¸å˜ï¼Œç”¨æˆ·çœ‹åˆ°ç¨³å®šçš„UI
> - workInProgressæ ‘åœ¨å†…å­˜ä¸­æ„å»ºï¼Œéšæ—¶å¯åºŸå¼ƒ
> - é€šè¿‡alternateè®¿é—®currentï¼Œè¿›è¡Œpropså¯¹æ¯”
>
> **2. Commité˜¶æ®µï¼šåˆ‡æ¢æŒ‡é’ˆ + è§’è‰²äº’æ¢**
>
> ```javascript
> // before mutation: root.currentè¿˜æ˜¯æ—§æ ‘
> commitBeforeMutationEffects(finishedWork);
>
> // mutation: æ‰§è¡ŒDOMæ“ä½œ + åˆ‡æ¢æŒ‡é’ˆ
> commitMutationEffects(finishedWork);
> root.current = finishedWork;  // â† åˆ‡æ¢ï¼
>
> // layout: root.currentå·²æ˜¯æ–°æ ‘
> commitLayoutEffects(finishedWork);
> ```
>
> è§’è‰²äº’æ¢ï¼š
> - commitå‰ï¼šcurrent = TreeA, alternate = TreeB
> - commitåï¼šcurrent = TreeB, alternate = TreeA
> - TreeAå’ŒTreeBè§’è‰²äº’æ¢ï¼Œéƒ½ä¸é”€æ¯
>
> **3. ä¸‹æ¬¡æ›´æ–°ï¼šå¤ç”¨alternate**
>
> ```javascript
> // ç¬¬äºŒæ¬¡æ›´æ–°
> const wip = current.alternate;  // å¤ç”¨TreeAï¼
>
> if (wip !== null) {
>   // é‡ç½®flagsï¼Œæ›´æ–°props
>   wip.flags = 0;
>   wip.pendingProps = newProps;
>   return wip;  // è¿”å›å¤ç”¨çš„èŠ‚ç‚¹
> }
> ```
>
> å¤ç”¨ç‡æé«˜ï¼š
> - æœªå˜åŒ–çš„èŠ‚ç‚¹ï¼šå®Œå…¨å¤ç”¨ï¼ˆè¿propséƒ½ä¸æ›´æ–°ï¼‰
> - å˜åŒ–çš„èŠ‚ç‚¹ï¼šå¤ç”¨å¯¹è±¡ï¼Œåªæ›´æ–°å­—æ®µ
> - æ–°å¢çš„èŠ‚ç‚¹ï¼šæ‰åˆ›å»ºæ–°å¯¹è±¡
>
> **åä½œçš„å…³é”®è®¾è®¡ï¼š**
> - **alternateåŒå‘ç»‘å®š**ï¼šä¸¤æ£µæ ‘äº’ç›¸å¼•ç”¨ï¼Œè½®æµä½¿ç”¨
> - **æŒ‡é’ˆåˆ‡æ¢æˆæœ¬ä½**ï¼šO(1)æ—¶é—´ï¼Œä¸€è¡Œä»£ç å®Œæˆ
> - **bailoutä¼˜åŒ–**ï¼šå¯¹æ¯”currentå’Œwipçš„propsï¼Œè·³è¿‡å­æ ‘
> - **é”™è¯¯éš”ç¦»**ï¼šwipå‡ºé”™ä¸å½±å“current
>
> **åœ¨å®é™…å·¥ä½œä¸­çš„åº”ç”¨ï¼š**
> - ç†è§£getSnapshotBeforeUpdateçš„æ—¶æœºï¼ˆbefore mutationï¼Œcurrentè¿˜æ˜¯æ—§æ ‘ï¼‰
> - ç†è§£useLayoutEffectçš„æ—¶æœºï¼ˆlayoutï¼Œcurrentå·²æ˜¯æ–°æ ‘ï¼‰
> - ç†è§£ä¸ºä»€ä¹ˆpropså¯¹æ¯”ç”¨`===`ï¼ˆbailoutä¼˜åŒ–çš„åŸºç¡€ï¼‰

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**

1. âœ… åˆ†é˜¶æ®µè¯¦ç»†è¯´æ˜åä½œè¿‡ç¨‹
2. âœ… ç»“åˆä»£ç ç¤ºä¾‹å’Œæ—¶é—´çº¿
3. âœ… è¯´æ˜è§’è‰²äº’æ¢å’Œå¤ç”¨æœºåˆ¶
4. âœ… è”ç³»å®é™…çš„ç”Ÿå‘½å‘¨æœŸå’Œä¼˜åŒ–

---

## ä¹ã€ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šåŒç¼“å†²çš„æœ¬è´¨ ğŸ¯

**ä¸€å¥è¯ï¼š** åŒç¼“å†² = ä¸¤ä¸ªç¼“å†²åŒº + äº¤æ›¿ä½¿ç”¨ + ä¸€æ¬¡æ€§åˆ‡æ¢ï¼Œé¿å…ç”¨æˆ·çœ‹åˆ°ä¸­é—´çŠ¶æ€ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
const buffer1 = 'å®Œæ•´ç”»é¢A';
const buffer2 = 'æ­£åœ¨ç»˜åˆ¶B...';
ç”¨æˆ·çœ‹åˆ°: buffer1;

// ç»˜åˆ¶å®Œæˆï¼Œä¸€æ¬¡æ€§åˆ‡æ¢
ç”¨æˆ·çœ‹åˆ°: buffer2;
```

**åº”ç”¨ï¼š** Reactç”¨currentå’ŒworkInProgressä¸¤æ£µæ ‘ï¼Œç”¨æˆ·çœ‹currentï¼Œæ„å»ºwipï¼Œå®Œæˆååˆ‡æ¢ã€‚

---

### å¡ç‰‡2ï¼šcurrentæ ‘çš„è§’è‰² ğŸ“º

**ä¸€å¥è¯ï¼š** currentæ ‘æ˜¯å½“å‰å±å¹•æ˜¾ç¤ºçš„Fiberæ ‘ï¼Œç”¨æˆ·å¯è§ï¼Œå§‹ç»ˆä¿æŒå®Œæ•´çŠ¶æ€ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
root.current = {
  type: 'App',
  stateNode: realDOM,  // çœŸå®DOMå¼•ç”¨
  ç”¨æˆ·å¯è§: true
};
```

**åº”ç”¨ï¼š** commité˜¶æ®µå‰ï¼Œroot.currentæ˜¯æ—§æ ‘ï¼›commitåï¼Œroot.currentæ˜¯æ–°æ ‘ã€‚

---

### å¡ç‰‡3ï¼šworkInProgressæ ‘çš„è§’è‰² ğŸ”§

**ä¸€å¥è¯ï¼š** workInProgressæ ‘æ˜¯å†…å­˜ä¸­æ­£åœ¨æ„å»ºçš„æ–°Fiberæ ‘ï¼Œç”¨æˆ·ä¸å¯è§ï¼Œå¯éšæ—¶åºŸå¼ƒã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
root.finishedWork = {
  type: 'App',
  stateNode: realDOM,  // å¤ç”¨DOM
  ç”¨æˆ·å¯è§: false
};
```

**åº”ç”¨ï¼š** renderé˜¶æ®µåœ¨wipæ ‘ä¸Šå·¥ä½œï¼Œcommité˜¶æ®µå˜æˆæ–°çš„currentã€‚

---

### å¡ç‰‡4ï¼šalternateåŒå‘ç»‘å®š ğŸ”—

**ä¸€å¥è¯ï¼š** currentå’ŒworkInProgressé€šè¿‡alternateæŒ‡é’ˆåŒå‘è¿æ¥ï¼Œå®ç°å¯¹è±¡å¤ç”¨ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
current.alternate = workInProgress;
workInProgress.alternate = current;
// åŒå‘å¼•ç”¨
```

**åº”ç”¨ï¼š** createWorkInProgresså‡½æ•°é€šè¿‡current.alternateè·å–æˆ–åˆ›å»ºwipèŠ‚ç‚¹ã€‚

---

### å¡ç‰‡5ï¼šcreateWorkInProgressçš„å¤ç”¨é€»è¾‘ â™»ï¸

**ä¸€å¥è¯ï¼š** é¦–æ¬¡åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œåç»­å¤ç”¨alternateï¼Œåªé‡ç½®flagså’Œæ›´æ–°propsã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
let wip = current.alternate;
if (wip === null) {
  wip = new Fiber(...);  // åˆ›å»º
} else {
  wip.flags = 0;          // å¤ç”¨
}
```

**åº”ç”¨ï¼š** 90%+çš„æ›´æ–°å¤ç”¨å¯¹è±¡ï¼Œå‡å°‘GCå‹åŠ›ã€‚

---

### å¡ç‰‡6ï¼šcommité˜¶æ®µçš„æŒ‡é’ˆåˆ‡æ¢ ğŸ”€

**ä¸€å¥è¯ï¼š** commitçš„mutationå­é˜¶æ®µåˆ‡æ¢root.currentæŒ‡é’ˆï¼Œä½¿wipå˜æˆæ–°currentã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
// before mutation: current = oldTree
commitMutationEffects();
root.current = finishedWork;  // åˆ‡æ¢
// layout: current = newTree
```

**åº”ç”¨ï¼š** åˆ‡æ¢æˆæœ¬O(1)ï¼Œç”¨æˆ·ç¬é—´çœ‹åˆ°æ–°UIã€‚

---

### å¡ç‰‡7ï¼šbailoutä¼˜åŒ– â­ï¸

**ä¸€å¥è¯ï¼š** propsæœªå˜åŒ–æ—¶è·³è¿‡èŠ‚ç‚¹åŠå…¶å­æ ‘ï¼Œé¿å…ä¸å¿…è¦çš„æ›´æ–°ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
if (current.memoizedProps === wip.pendingProps) {
  return bailout(wip);  // è·³è¿‡å­æ ‘
}
```

**åº”ç”¨ï¼š** æé«˜æ›´æ–°æ€§èƒ½ï¼Œå‡å°‘90%+çš„èŠ‚ç‚¹å¤„ç†ã€‚

---

### å¡ç‰‡8ï¼šè§’è‰²äº’æ¢ ğŸ­

**ä¸€å¥è¯ï¼š** commitåï¼Œcurrentå’ŒworkInProgressè§’è‰²äº’æ¢ï¼Œä¸¤ä¸ªå¯¹è±¡æ°¸ä¹…å­˜åœ¨ã€‚

**ä¸¾ä¾‹ï¼š**
```
T1: current=A, wip=B â†’ T2: current=B, wip=A
T3: current=A, wip=B â†’ T4: current=B, wip=A
ï¼ˆAå’ŒBè½®æµæ‰®æ¼”è§’è‰²ï¼‰
```

**åº”ç”¨ï¼š** ä¸¤ä¸ªFiberèŠ‚ç‚¹è½®æµä½¿ç”¨ï¼Œæ°¸ä¸é”€æ¯ï¼ˆé™¤éç»„ä»¶å¸è½½ï¼‰ã€‚

---

### å¡ç‰‡9ï¼šå†…å­˜å ç”¨ ğŸ’¾

**ä¸€å¥è¯ï¼š** è™½ç„¶æœ‰ä¸¤æ£µæ ‘ï¼Œä½†é€šè¿‡å¤ç”¨å’Œbailoutï¼Œå®é™…å†…å­˜å¢é•¿<10%ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
// 1000ä¸ªç»„ä»¶ï¼Œæ”¹10ä¸ª
// åˆ›å»ºæ–°Fiber: 10ä¸ª
// å¤ç”¨Fiber: 990ä¸ª
// å†…å­˜å¢é•¿: ~1%
```

**åº”ç”¨ï¼š** åŒç¼“å†²ä¸æµªè´¹å†…å­˜ï¼ŒGCå‹å¥½ã€‚

---

### å¡ç‰‡10ï¼šå¯ä¸­æ–­æ¸²æŸ“çš„åŸºç¡€ â¸ï¸

**ä¸€å¥è¯ï¼š** workInProgresså¯åºŸå¼ƒï¼Œcurrentä¿æŒå®Œæ•´ï¼Œæ”¯æŒé«˜ä¼˜å…ˆçº§æ‰“æ–­ä½ä¼˜å…ˆçº§ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
// æ„å»ºä½ä¼˜å…ˆçº§æ›´æ–°
buildWIP(lowPriority);

// é«˜ä¼˜å…ˆçº§åˆ°æ¥ï¼ŒåºŸå¼ƒwip
wip = null;
buildWIP(highPriority);
// currentä¸å—å½±å“
```

**åº”ç”¨ï¼š** Reactå¹¶å‘æ¨¡å¼çš„åŸºçŸ³ã€‚

---

## åã€ã€ä¸€å¥è¯æ€»ç»“ã€‘

**åŒç¼“å†²æœºåˆ¶é€šè¿‡ç»´æŠ¤currentå’ŒworkInProgressä¸¤æ£µFiberæ ‘ï¼Œåœ¨workInProgressæ ‘ä¸Šè¿›è¡Œdiffå’Œæ›´æ–°ï¼ˆç”¨æˆ·ä¸å¯è§ï¼‰ï¼Œæ„å»ºå®Œæˆåé€šè¿‡åˆ‡æ¢root.currentæŒ‡é’ˆå®ç°ç¬é—´æ›´æ–°ï¼ˆç”¨æˆ·å¯è§ï¼‰ï¼Œé€šè¿‡alternateåŒå‘è¿æ¥å®ç°å¯¹è±¡å¤ç”¨ï¼Œé€šè¿‡bailoutä¼˜åŒ–è·³è¿‡æœªå˜åŒ–å­æ ‘ï¼Œæ˜¯Reactå®ç°æ— é—ªçƒæ›´æ–°ã€é«˜æ€§èƒ½æ¸²æŸ“ã€å¯ä¸­æ–­æ¸²æŸ“çš„æ ¸å¿ƒæœºåˆ¶ã€‚**

---

## é™„å½•ï¼šå­¦ä¹ æ£€æŸ¥æ¸…å•

### åŸºç¡€ç†è§£
- [ ] ç†è§£åŒç¼“å†²çš„æœ¬è´¨ï¼ˆä¸¤ä¸ªç¼“å†²åŒº+äº¤æ›¿ä½¿ç”¨ï¼‰
- [ ] çŸ¥é“currentå’ŒworkInProgressçš„è§’è‰²
- [ ] ç†è§£alternateçš„åŒå‘ç»‘å®š
- [ ] çŸ¥é“commité˜¶æ®µçš„æŒ‡é’ˆåˆ‡æ¢æ—¶æœº
- [ ] ç†è§£ä¸ºä»€ä¹ˆéœ€è¦åŒç¼“å†²

### æ ¸å¿ƒæ¦‚å¿µ
- [ ] æŒæ¡createWorkInProgressçš„å¤ç”¨é€»è¾‘
- [ ] ç†è§£è§’è‰²äº’æ¢æœºåˆ¶
- [ ] æŒæ¡bailoutä¼˜åŒ–åŸç†
- [ ] ç†è§£commitä¸‰ä¸ªå­é˜¶æ®µ
- [ ] çŸ¥é“åŒæ ‘çš„å†…å­˜å ç”¨

### è¿›é˜¶åº”ç”¨
- [ ] ç†è§£ä¸ºä»€ä¹ˆèƒ½æ”¯æŒå¯ä¸­æ–­æ¸²æŸ“
- [ ] ç†è§£åŒç¼“å†²çš„æ€§èƒ½ä¼˜åŠ¿
- [ ] ç†è§£é”™è¯¯æ¢å¤æœºåˆ¶
- [ ] çŸ¥é“getSnapshotBeforeUpdateçš„æ—¶æœº
- [ ] çŸ¥é“useLayoutEffectçš„æ—¶æœº

### å®é™…åº”ç”¨
- [ ] èƒ½è§£é‡Šä¸ºä»€ä¹ˆReactæ›´æ–°ä¸é—ªçƒ
- [ ] èƒ½è¯´å‡ºåŒç¼“å†²çš„æ€§èƒ½ä¼˜åŠ¿
- [ ] èƒ½å¯¹æ¯”æœ‰æ— åŒç¼“å†²çš„åŒºåˆ«
- [ ] èƒ½è”ç³»å¹¶å‘æ¨¡å¼çš„å®ç°
- [ ] èƒ½å›ç­”é¢è¯•å¸¸è§é—®é¢˜

---

## ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®

**å·²æŒæ¡ï¼š** FiberèŠ‚ç‚¹ç»“æ„ã€åŒç¼“å†²æœºåˆ¶

**æ¥ä¸‹æ¥å­¦ä¹ ï¼š**
1. **å·¥ä½œå¾ªç¯** - æ·±å…¥ç†è§£workLoopå¦‚ä½•éå†Fiberæ ‘
2. **beginWorkå’ŒcompleteWork** - ç†è§£renderé˜¶æ®µçš„å…·ä½“å·¥ä½œ
3. **commité˜¶æ®µ** - ç†è§£DOMæ“ä½œçš„æ‰§è¡Œæ—¶æœº
4. **Laneä¼˜å…ˆçº§æ¨¡å‹** - ç†è§£å¹¶å‘æ¨¡å¼çš„è°ƒåº¦æœºåˆ¶

---

## å‚è€ƒèµ„æº

**Reactå®˜æ–¹æ–‡æ¡£ï¼š**
- [React Fiber Architecture](https://github.com/acdlite/react-fiber-architecture)
- [Concurrent Mode](https://legacy.reactjs.org/docs/concurrent-mode-intro.html)

**æºç æ–‡ä»¶ï¼š**
- `packages/react-reconciler/src/ReactFiber.js`
- `packages/react-reconciler/src/ReactFiberWorkLoop.js`
- `packages/react-reconciler/src/ReactFiberBeginWork.js`

**æ¨èé˜…è¯»ï¼š**
- ã€Šæ·±å…¥ç†è§£React Fiberæ¶æ„ã€‹
- ã€ŠReactæŠ€æœ¯æ­ç§˜ - åŒç¼“å†²æœºåˆ¶ã€‹

---

**ç‰ˆæœ¬ï¼š** v1.0
**åˆ›å»ºæ—¶é—´ï¼š** 2025-12-06
**é€‚ç”¨Reactç‰ˆæœ¬ï¼š** React 19
**ä½œè€…ï¼š** Claude Code
**é¡¹ç›®ï¼š** React19 æºç å­¦ä¹  - Fiberæ¶æ„ç³»åˆ—
