# å·¥ä½œå¾ªç¯

## ä¸€ã€ã€30å­—æ ¸å¿ƒã€‘

**workLoopæ˜¯Fiberæ¶æ„çš„æ ¸å¿ƒå¾ªç¯ï¼Œé€šè¿‡performUnitOfWorkå¤„ç†æ¯ä¸ªå·¥ä½œå•å…ƒï¼Œç”¨beginWorkå‘ä¸‹ã€completeWorkå‘ä¸Šï¼Œå®ç°å¯ä¸­æ–­çš„å¢é‡æ¸²æŸ“ã€‚**

---

## äºŒã€ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### å·¥ä½œå¾ªç¯çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**å·¥ä½œå¾ªç¯ = whileå¾ªç¯ + å¤„ç†ä¸€ä¸ªå·¥ä½œå•å…ƒ + æŒ‡é’ˆç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª**

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

```javascript
function workLoop() {
  while (workInProgress !== null) {
    workInProgress = performUnitOfWork(workInProgress);
  }
}
```

å°±æ˜¯è¿™ä¹ˆç®€å•ï¼šä¸€ä¸ªå¾ªç¯ï¼Œæ¯æ¬¡å¤„ç†ä¸€ä¸ªFiberèŠ‚ç‚¹ï¼Œç›´åˆ°å¤„ç†å®Œæ‰€æœ‰èŠ‚ç‚¹ã€‚

#### 2. ä¸ºä»€ä¹ˆéœ€è¦å·¥ä½œå¾ªç¯ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•å°†é€’å½’è°ƒç”¨æ ˆæ”¹ä¸ºå¯ä¸­æ–­çš„å¾ªç¯ï¼Ÿ**

React 16ä¹‹å‰ä½¿ç”¨é€’å½’éå†è™šæ‹ŸDOMæ ‘ï¼š

```javascript
// æ—§ç‰ˆReactçš„é€’å½’æ¸²æŸ“
function renderTree(vdom) {
  // å¤„ç†å½“å‰èŠ‚ç‚¹
  processNode(vdom);

  // é€’å½’å¤„ç†å­èŠ‚ç‚¹
  vdom.children.forEach(child => {
    renderTree(child);  // é€’å½’è°ƒç”¨
  });
}

// é—®é¢˜ï¼š
// 1. æ— æ³•ä¸­æ–­ï¼šè°ƒç”¨æ ˆç”±JSå¼•æ“æ§åˆ¶ï¼Œå¿…é¡»æ‰§è¡Œå®Œæ‰èƒ½é€€å‡º
// 2. æ— æ³•æš‚åœï¼šé€’å½’åˆ°ä¸€åŠæ— æ³•ä¿å­˜çŠ¶æ€
// 3. æ— æ³•ä¼˜å…ˆçº§è°ƒåº¦ï¼šä¸€æ—¦å¼€å§‹å°±å¿…é¡»å®Œæˆ
```

**Reactéœ€è¦çš„èƒ½åŠ›ï¼š**
- å¯ä»¥ä¸­æ–­ï¼šå¤„ç†ä¸€éƒ¨åˆ†èŠ‚ç‚¹åè®©å‡ºæ§åˆ¶æƒ
- å¯ä»¥æš‚åœï¼šä¿å­˜å½“å‰è¿›åº¦ï¼Œç¨åç»§ç»­
- å¯ä»¥è°ƒåº¦ï¼šæ ¹æ®ä¼˜å…ˆçº§å†³å®šæ˜¯å¦ç»§ç»­

#### 3. å·¥ä½œå¾ªç¯çš„ä¸‰å±‚ä»·å€¼

##### ä»·å€¼1ï¼šå¯ä¸­æ–­æ¸²æŸ“ â¸ï¸

é€šè¿‡whileå¾ªç¯ + shouldYieldæ£€æŸ¥ï¼Œå®ç°å¯ä¸­æ–­ï¼š

```javascript
// åŒæ­¥æ¨¡å¼ï¼šä¸å¯ä¸­æ–­
function workLoopSync() {
  while (workInProgress !== null) {
    workInProgress = performUnitOfWork(workInProgress);
  }
}

// å¹¶å‘æ¨¡å¼ï¼šå¯ä¸­æ–­
function workLoopConcurrent() {
  while (workInProgress !== null && !shouldYield()) {
    workInProgress = performUnitOfWork(workInProgress);
  }
  // shouldYield()è¿”å›trueæ—¶ä¸­æ–­ï¼Œä¸‹æ¬¡ç»§ç»­
}
```

**å…³é”®è®¾è®¡ï¼š**
- `workInProgress`å˜é‡ä¿å­˜å½“å‰è¿›åº¦
- å¾ªç¯é€€å‡ºåï¼Œ`workInProgress`ä»åœ¨å†…å­˜ä¸­
- ä¸‹æ¬¡è°ƒç”¨workLoopæ—¶ï¼Œä»`workInProgress`ç»§ç»­

##### ä»·å€¼2ï¼šå¢é‡æ¸²æŸ“ ğŸ“¦

å°†å¤§ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªå·¥ä½œå•å…ƒï¼Œé€ä¸ªå¤„ç†ï¼š

```javascript
// å‡è®¾æœ‰1000ä¸ªç»„ä»¶éœ€è¦æ¸²æŸ“
// æ—§æ–¹æ¡ˆï¼šä¸€æ¬¡æ€§å¤„ç†1000ä¸ªï¼ˆé˜»å¡ä¸»çº¿ç¨‹16ms+ï¼‰
// æ–°æ–¹æ¡ˆï¼šæ‹†åˆ†æˆå¤šä¸ª5msçš„å°ä»»åŠ¡

function performUnitOfWork(unitOfWork) {
  // å¤„ç†1ä¸ªå·¥ä½œå•å…ƒ
  beginWork(unitOfWork);
  completeWork(unitOfWork);

  // è¿”å›ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ
  return getNextFiber(unitOfWork);
}

// æ¯ä¸ªå·¥ä½œå•å…ƒæ‰§è¡Œæ—¶é—´å¾ˆçŸ­ï¼ˆ<1msï¼‰
// å¤„ç†10ä¸ªå·¥ä½œå•å…ƒåï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦è®©å‡ºï¼ˆ5msï¼‰
// è®©å‡ºåï¼Œç”¨æˆ·äº¤äº’å¯ä»¥æ’å…¥æ‰§è¡Œ
```

**æ—¶é—´åˆ‡ç‰‡ç¤ºä¾‹ï¼š**
```
æ—¶é—´çº¿ï¼š
[æ¸²æŸ“10ä¸ªèŠ‚ç‚¹ï¼ˆ5msï¼‰] [ç”¨æˆ·ç‚¹å‡»ï¼ˆ10msï¼‰] [æ¸²æŸ“10ä¸ªèŠ‚ç‚¹ï¼ˆ5msï¼‰] [æ¸²æŸ“10ä¸ªèŠ‚ç‚¹ï¼ˆ5msï¼‰]
â†‘å¯ä¸­æ–­              â†‘å“åº”åŠæ—¶          â†‘ç»§ç»­æ¸²æŸ“            â†‘å®Œæˆ
```

##### ä»·å€¼3ï¼šæ·±åº¦ä¼˜å…ˆéå† ğŸŒ³

workLoopé…åˆperformUnitOfWorkå®ç°DFSï¼š

```javascript
function performUnitOfWork(unitOfWork) {
  // beginWorkï¼šå‘ä¸‹å¤„ç†
  const next = beginWork(unitOfWork);

  if (next !== null) {
    // æœ‰childï¼Œè¿”å›childï¼ˆæ·±åº¦ä¼˜å…ˆï¼‰
    return next;
  }

  // æ²¡æœ‰childï¼Œè¿›å…¥completeWork
  let completedWork = unitOfWork;
  while (completedWork !== null) {
    completeWork(completedWork);

    // æ£€æŸ¥sibling
    if (completedWork.sibling !== null) {
      return completedWork.sibling;
    }

    // å›åˆ°çˆ¶èŠ‚ç‚¹
    completedWork = completedWork.return;
  }

  return null;
}
```

**éå†é¡ºåºï¼š**
```
        A
       / \
      B   C
     /
    D

éå†ï¼šA(beginWork) â†’ B(beginWork) â†’ D(beginWork) â†’ D(completeWork)
     â†’ B(completeWork) â†’ C(beginWork) â†’ C(completeWork) â†’ A(completeWork)
```

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼ React å®ç°

**æ¨ç†é“¾ï¼š**

```
1. Reactéœ€è¦å¯ä¸­æ–­æ¸²æŸ“
   â†“
2. é€’å½’è°ƒç”¨æ ˆæ— æ³•ä¸­æ–­ï¼ˆç”±JSå¼•æ“æ§åˆ¶ï¼‰
   â†“
3. éœ€è¦ç”¨æ˜¾å¼æ•°æ®ç»“æ„æ›¿ä»£é€’å½’
   â†“
4. è®¾è®¡FiberèŠ‚ç‚¹ï¼ˆä¸‰æŒ‡é’ˆé“¾è¡¨æ ‘ï¼‰
   â†“
5. ç”¨whileå¾ªç¯æ›¿ä»£é€’å½’
   â†“
6. å¾ªç¯ä½“ï¼šå¤„ç†ä¸€ä¸ªå·¥ä½œå•å…ƒï¼ˆperformUnitOfWorkï¼‰
   â†“
7. ç”¨workInProgresså˜é‡ä¿å­˜è¿›åº¦
   â†“
8. æ·»åŠ shouldYieldæ£€æŸ¥ï¼ˆå¹¶å‘æ¨¡å¼ï¼‰
   â†“
9. å®ç°äº†workLoopå·¥ä½œå¾ªç¯
   â†“
10. æ”¯æŒå¯ä¸­æ–­ã€å¯æš‚åœã€å¯è°ƒåº¦çš„æ¸²æŸ“
```

**ä¸ºä»€ä¹ˆworkLoopè®¾è®¡å¦‚æ­¤æˆåŠŸï¼Ÿ**

1. **ç®€å•**ï¼šæ ¸å¿ƒåªæ˜¯ä¸€ä¸ªwhileå¾ªç¯
2. **å¯æ§**ï¼šå®Œå…¨æ§åˆ¶éå†è¿‡ç¨‹ï¼ˆä¸ä¾èµ–è°ƒç”¨æ ˆï¼‰
3. **çµæ´»**ï¼šå¯ä»¥æ·»åŠ ä»»ä½•æ§åˆ¶é€»è¾‘ï¼ˆshouldYieldã€ä¼˜å…ˆçº§æ£€æŸ¥ï¼‰
4. **é«˜æ•ˆ**ï¼šæ¯ä¸ªå·¥ä½œå•å…ƒæ‰§è¡Œæ—¶é—´çŸ­ï¼Œå“åº”æ€§å¥½

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**å·¥ä½œå¾ªç¯é€šè¿‡whileå¾ªç¯ + performUnitOfWorkå¤„ç†å·¥ä½œå•å…ƒ + workInProgressä¿å­˜è¿›åº¦ï¼Œå°†é€’å½’è°ƒç”¨æ ˆæ”¹ä¸ºå¯æ§çš„å¾ªç¯ï¼Œé…åˆshouldYieldå®ç°å¯ä¸­æ–­ï¼Œé…åˆä¸‰æŒ‡é’ˆå®ç°æ·±åº¦ä¼˜å…ˆéå†ï¼Œæ˜¯React Fiberæ¶æ„å®ç°å¢é‡æ¸²æŸ“å’Œå¹¶å‘æ¨¡å¼çš„æ ¸å¿ƒæœºåˆ¶ã€‚**

---

## ä¸‰ã€ã€3ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šworkLoopå‡½æ•°ï¼ˆåŒæ­¥ vs å¹¶å‘ï¼‰ğŸ”„

**workLoopæ˜¯Reactæ¸²æŸ“çš„æ ¸å¿ƒå¾ªç¯ï¼ŒåŒæ­¥æ¨¡å¼ä¸‹ä¸€æ¬¡æ€§å®Œæˆï¼Œå¹¶å‘æ¨¡å¼ä¸‹å¯ä¸­æ–­è®©å‡ºæ§åˆ¶æƒã€‚**

```javascript
// ===== 1. åŒæ­¥workLoopï¼ˆä¸å¯ä¸­æ–­ï¼‰=====
function workLoopSync() {
  // å¾ªç¯å¤„ç†æ‰€æœ‰å·¥ä½œå•å…ƒï¼Œç›´åˆ°å®Œæˆ
  while (workInProgress !== null) {
    workInProgress = performUnitOfWork(workInProgress);
  }
}

// ä½¿ç”¨åœºæ™¯ï¼š
// - åŒæ­¥æ¸²æŸ“ï¼ˆReactDOM.renderï¼‰
// - ä¼˜å…ˆçº§ä¸ºSyncLaneçš„æ›´æ–°
// - å¿…é¡»ç«‹å³å®Œæˆçš„æ›´æ–°

// ===== 2. å¹¶å‘workLoopï¼ˆå¯ä¸­æ–­ï¼‰=====
function workLoopConcurrent() {
  // å¾ªç¯å¤„ç†å·¥ä½œå•å…ƒï¼Œä½†å¯ä»¥ä¸­æ–­
  while (workInProgress !== null && !shouldYield()) {
    workInProgress = performUnitOfWork(workInProgress);
  }
}

function shouldYield() {
  // æ£€æŸ¥æ˜¯å¦éœ€è¦è®©å‡ºæ§åˆ¶æƒ
  const currentTime = getCurrentTime();
  return currentTime >= deadline;
}

// ä½¿ç”¨åœºæ™¯ï¼š
// - å¹¶å‘æ¸²æŸ“ï¼ˆConcurrent Modeï¼‰
// - ä¼˜å…ˆçº§ä¸ºDefaultLaneç­‰çš„æ›´æ–°
// - å¯ä»¥è¢«æ‰“æ–­çš„æ›´æ–°

// ===== 3. å®Œæ•´çš„æ¸²æŸ“å…¥å£ =====
function renderRootSync(root, lanes) {
  // å‡†å¤‡å·¥ä½œ
  prepareFreshStack(root, lanes);

  // æ‰§è¡ŒåŒæ­¥workLoop
  workLoopSync();

  // æ¸²æŸ“å®Œæˆ
  root.finishedWork = workInProgress;
}

function renderRootConcurrent(root, lanes) {
  // å‡†å¤‡å·¥ä½œ
  prepareFreshStack(root, lanes);

  do {
    try {
      // æ‰§è¡Œå¹¶å‘workLoop
      workLoopConcurrent();
      break;
    } catch (thrownValue) {
      handleError(root, thrownValue);
    }
  } while (true);

  // æ£€æŸ¥æ˜¯å¦å®Œæˆ
  if (workInProgress !== null) {
    // æœªå®Œæˆï¼Œç­‰å¾…ä¸‹æ¬¡è°ƒåº¦
    return RootInProgress;
  }

  // å®Œæˆ
  return RootCompleted;
}

// ===== 4. æ—¶é—´åˆ‡ç‰‡æ¼”ç¤º =====
console.log('=== æ—¶é—´åˆ‡ç‰‡æ¼”ç¤º ===\n');

const frameYieldMs = 5;  // æ¯å¸§è®©å‡ºæ—¶é—´ï¼š5ms
let deadline = performance.now() + frameYieldMs;

function getCurrentTime() {
  return performance.now();
}

function shouldYieldToHost() {
  return getCurrentTime() >= deadline;
}

// æ¨¡æ‹Ÿå¹¶å‘æ¸²æŸ“
function simulateConcurrentRender(fiberCount) {
  console.log(`å¼€å§‹æ¸²æŸ“ ${fiberCount} ä¸ªFiberèŠ‚ç‚¹\n`);

  let processedCount = 0;
  let yieldCount = 0;
  const startTime = performance.now();

  while (processedCount < fiberCount) {
    // å¤„ç†ä¸€ä¸ªå·¥ä½œå•å…ƒ
    processedCount++;

    // æ£€æŸ¥æ˜¯å¦éœ€è¦è®©å‡º
    if (shouldYieldToHost()) {
      yieldCount++;
      console.log(`å¤„ç†äº† ${processedCount} ä¸ªèŠ‚ç‚¹ï¼Œè®©å‡ºæ§åˆ¶æƒï¼ˆ${yieldCount}æ¬¡ï¼‰`);

      // æ¨¡æ‹Ÿç”¨æˆ·äº¤äº’æˆ–å…¶ä»–é«˜ä¼˜å…ˆçº§ä»»åŠ¡
      const interruptionTime = 2;  // æ¨¡æ‹Ÿ2msçš„å…¶ä»–ä»»åŠ¡

      // æ›´æ–°deadline
      deadline = performance.now() + frameYieldMs;
    }
  }

  const totalTime = performance.now() - startTime;
  console.log(`\næ¸²æŸ“å®Œæˆï¼š`);
  console.log(`  æ€»èŠ‚ç‚¹ï¼š${fiberCount}`);
  console.log(`  è®©å‡ºæ¬¡æ•°ï¼š${yieldCount}`);
  console.log(`  æ€»è€—æ—¶ï¼š${totalTime.toFixed(2)}ms`);
}

simulateConcurrentRender(100);
```

**è¯¦ç»†è§£é‡Šï¼š**

**åŒæ­¥ vs å¹¶å‘çš„åŒºåˆ«ï¼š**

| ç‰¹æ€§ | åŒæ­¥æ¨¡å¼ | å¹¶å‘æ¨¡å¼ |
|------|---------|---------|
| å¾ªç¯æ¡ä»¶ | `workInProgress !== null` | `workInProgress !== null && !shouldYield()` |
| ä¸­æ–­æ€§ | ä¸å¯ä¸­æ–­ | å¯ä¸­æ–­ |
| å“åº”æ€§ | é˜»å¡ä¸»çº¿ç¨‹ | å“åº”å¼ï¼Œä¸é˜»å¡ |
| ä½¿ç”¨åœºæ™¯ | ReactDOM.renderã€SyncLane | Concurrent Modeã€DefaultLane |
| æ‰§è¡Œæ—¶é—´ | å¯èƒ½å¾ˆé•¿ | è¢«æ‹†åˆ†æˆ5msåˆ‡ç‰‡ |

**shouldYieldçš„å®ç°åŸç†ï¼š**

```javascript
// ç®€åŒ–ç‰ˆshouldYield
function shouldYield() {
  // 1. æ£€æŸ¥æ—¶é—´ï¼šæ˜¯å¦è¶…è¿‡5ms
  if (getCurrentTime() >= deadline) {
    return true;
  }

  // 2. æ£€æŸ¥ç”¨æˆ·è¾“å…¥ï¼šæ˜¯å¦æœ‰pendingçš„ç”¨æˆ·äº¤äº’
  if (needsPaint) {
    return true;
  }

  // 3. æ£€æŸ¥å…¶ä»–ä»»åŠ¡ï¼šæ˜¯å¦æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡
  if (hasHigherPriorityWork()) {
    return true;
  }

  return false;
}
```

**åœ¨ React æºç ä¸­çš„åº”ç”¨ï¼š**

```javascript
// packages/react-reconciler/src/ReactFiberWorkLoop.js

function workLoopSync() {
  while (workInProgress !== null) {
    performUnitOfWork(workInProgress);
  }
}

function workLoopConcurrent() {
  while (workInProgress !== null && !shouldYield()) {
    performUnitOfWork(workInProgress);
  }
}

// packages/scheduler/src/forks/Scheduler.js

function shouldYieldToHost() {
  const timeElapsed = getCurrentTime() - startTime;
  if (timeElapsed < frameInterval) {
    // è¿˜åœ¨å½“å‰å¸§å†…ï¼Œä¸éœ€è¦è®©å‡º
    return false;
  }

  // éœ€è¦è®©å‡ºç»™æµè§ˆå™¨
  return true;
}
```

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šperformUnitOfWorkï¼ˆå·¥ä½œå•å…ƒï¼‰âš™ï¸

**performUnitOfWorkå¤„ç†ä¸€ä¸ªFiberèŠ‚ç‚¹ï¼Œé€šè¿‡beginWorkå‘ä¸‹åˆ›å»ºå­èŠ‚ç‚¹ï¼Œé€šè¿‡completeWorkå‘ä¸Šå®ŒæˆèŠ‚ç‚¹ï¼Œè¿”å›ä¸‹ä¸€ä¸ªè¦å¤„ç†çš„èŠ‚ç‚¹ã€‚**

```javascript
// ===== 1. performUnitOfWorkçš„å®Œæ•´å®ç° =====

function performUnitOfWork(unitOfWork) {
  // è·å–currentèŠ‚ç‚¹ï¼ˆæ—§æ ‘ï¼‰
  const current = unitOfWork.alternate;

  // ===== beginWorké˜¶æ®µï¼šå‘ä¸‹å¤„ç† =====
  let next = beginWork(current, unitOfWork, renderLanes);

  // æ›´æ–°memoizedProps
  unitOfWork.memoizedProps = unitOfWork.pendingProps;

  if (next === null) {
    // æ²¡æœ‰childï¼Œè¿›å…¥completeWorké˜¶æ®µ
    completeUnitOfWork(unitOfWork);
  } else {
    // æœ‰childï¼Œç»§ç»­å¤„ç†child
    workInProgress = next;
  }
}

// ===== 2. beginWorkï¼šå‘ä¸‹å¤„ç†èŠ‚ç‚¹ =====

function beginWork(current, workInProgress, renderLanes) {
  console.log(`beginWork: ${workInProgress.type}`);

  // bailoutæ£€æŸ¥
  if (current !== null) {
    const oldProps = current.memoizedProps;
    const newProps = workInProgress.pendingProps;

    if (oldProps === newProps && !hasContextChanged()) {
      // propsæœªå˜åŒ–ï¼Œbailout
      return bailoutOnAlreadyFinishedWork(current, workInProgress, renderLanes);
    }
  }

  // æ ¹æ®tagç±»å‹å¤„ç†èŠ‚ç‚¹
  switch (workInProgress.tag) {
    case FunctionComponent: {
      const Component = workInProgress.type;
      const props = workInProgress.pendingProps;
      return updateFunctionComponent(
        current,
        workInProgress,
        Component,
        props,
        renderLanes
      );
    }
    case ClassComponent: {
      return updateClassComponent(current, workInProgress, renderLanes);
    }
    case HostComponent: {
      return updateHostComponent(current, workInProgress, renderLanes);
    }
    default:
      throw new Error('Unknown unit of work tag');
  }
}

// ===== 3. completeUnitOfWorkï¼šå‘ä¸Šå®ŒæˆèŠ‚ç‚¹ =====

function completeUnitOfWork(unitOfWork) {
  let completedWork = unitOfWork;

  do {
    console.log(`completeWork: ${completedWork.type}`);

    const current = completedWork.alternate;
    const returnFiber = completedWork.return;

    // ===== completeWorkï¼šå®Œæˆå½“å‰èŠ‚ç‚¹ =====
    completeWork(current, completedWork, renderLanes);

    // ===== æ”¶é›†å‰¯ä½œç”¨ =====
    if (returnFiber !== null) {
      // å°†å­èŠ‚ç‚¹çš„å‰¯ä½œç”¨å†’æ³¡åˆ°çˆ¶èŠ‚ç‚¹
      if (completedWork.flags !== NoFlags) {
        returnFiber.subtreeFlags |= completedWork.flags;
      }
      returnFiber.subtreeFlags |= completedWork.subtreeFlags;
    }

    // ===== æ£€æŸ¥sibling =====
    const siblingFiber = completedWork.sibling;
    if (siblingFiber !== null) {
      // æœ‰siblingï¼Œç»§ç»­å¤„ç†sibling
      workInProgress = siblingFiber;
      return;
    }

    // ===== å›åˆ°çˆ¶èŠ‚ç‚¹ =====
    completedWork = returnFiber;
    workInProgress = completedWork;
  } while (completedWork !== null);

  // éå†å®Œæˆ
  if (workInProgressRootExitStatus === RootInProgress) {
    workInProgressRootExitStatus = RootCompleted;
  }
}

// ===== 4. completeWorkï¼šå®ŒæˆèŠ‚ç‚¹çš„å·¥ä½œ =====

function completeWork(current, workInProgress, renderLanes) {
  const newProps = workInProgress.pendingProps;

  switch (workInProgress.tag) {
    case HostComponent: {
      if (current !== null && workInProgress.stateNode != null) {
        // Updateï¼šæ ‡è®°Update flag
        updateHostComponent(current, workInProgress, newProps);
      } else {
        // Mountï¼šåˆ›å»ºDOMèŠ‚ç‚¹
        const instance = createInstance(workInProgress.type, newProps);
        appendAllChildren(instance, workInProgress);
        workInProgress.stateNode = instance;
      }
      return null;
    }
    case FunctionComponent: {
      // å‡½æ•°ç»„ä»¶æ²¡æœ‰DOMèŠ‚ç‚¹
      return null;
    }
    default:
      return null;
  }
}

// ===== 5. å®Œæ•´çš„éå†æ¼”ç¤º =====

console.log('\n=== å®Œæ•´çš„éå†æ¼”ç¤º ===\n');

// æ„å»ºFiberæ ‘
class FiberNode {
  constructor(type, tag) {
    this.type = type;
    this.tag = tag;
    this.child = null;
    this.sibling = null;
    this.return = null;
    this.alternate = null;
    this.pendingProps = {};
    this.memoizedProps = null;
    this.flags = 0;
  }
}

// åˆ›å»ºæ ‘ç»“æ„
//       App
//      /   \
//    div    p
//    /
//  span

const App = new FiberNode('App', 'FunctionComponent');
const div = new FiberNode('div', 'HostComponent');
const p = new FiberNode('p', 'HostComponent');
const span = new FiberNode('span', 'HostComponent');

App.child = div;
div.sibling = p;
div.child = span;

div.return = App;
p.return = App;
span.return = div;

// æ¨¡æ‹ŸworkLoop
let workInProgress = App;
const traversalOrder = [];

function simulateWorkLoop() {
  while (workInProgress !== null) {
    const current = workInProgress;

    // beginWork
    traversalOrder.push(`beginWork(${current.type})`);

    // è·å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
    let next = current.child;

    if (next === null) {
      // completeWork
      let completedWork = current;

      while (completedWork !== null) {
        traversalOrder.push(`completeWork(${completedWork.type})`);

        if (completedWork.sibling !== null) {
          next = completedWork.sibling;
          break;
        }

        completedWork = completedWork.return;
      }
    }

    workInProgress = next;
  }
}

simulateWorkLoop();

console.log('éå†é¡ºåº:');
traversalOrder.forEach((step, index) => {
  console.log(`  ${index + 1}. ${step}`);
});
```

**è¯¦ç»†è§£é‡Šï¼š**

**performUnitOfWorkçš„ä¸‰ä¸ªé˜¶æ®µï¼š**

1. **beginWorké˜¶æ®µ**ï¼ˆå‘ä¸‹ï¼‰ï¼š
   - å¤„ç†å½“å‰èŠ‚ç‚¹
   - æ ¹æ®tagç±»å‹è°ƒç”¨ä¸åŒçš„updateå‡½æ•°
   - åˆ›å»º/å¤ç”¨å­FiberèŠ‚ç‚¹
   - è¿”å›childï¼ˆå¦‚æœæœ‰ï¼‰

2. **completeWorké˜¶æ®µ**ï¼ˆå‘ä¸Šï¼‰ï¼š
   - å®Œæˆå½“å‰èŠ‚ç‚¹çš„å·¥ä½œ
   - åˆ›å»ºæˆ–æ›´æ–°DOMèŠ‚ç‚¹
   - æ”¶é›†å‰¯ä½œç”¨
   - å†’æ³¡subtreeFlags

3. **éå†æ§åˆ¶**ï¼š
   - æœ‰child â†’ è¿”å›childï¼ˆæ·±åº¦ä¼˜å…ˆï¼‰
   - æ— child â†’ è¿›å…¥completeWork â†’ æ‰¾sibling
   - æ— sibling â†’ å›åˆ°çˆ¶èŠ‚ç‚¹ â†’ ç»§ç»­æ‰¾sibling

**éå†é¡ºåºç¤ºä¾‹ï¼š**

```
è¾“å…¥æ ‘ï¼š
       App
      /   \
    div    p
    /
  span

éå†é¡ºåºï¼š
1. beginWork(App)       â†’ è¿›å…¥App
2. beginWork(div)       â†’ è¿›å…¥div
3. beginWork(span)      â†’ è¿›å…¥span
4. completeWork(span)   â†’ spanæ²¡æœ‰childï¼Œå®Œæˆspan
5. completeWork(div)    â†’ spanæ²¡æœ‰siblingï¼Œå›åˆ°divï¼Œå®Œæˆdiv
6. beginWork(p)         â†’ divæœ‰sibling pï¼Œè¿›å…¥p
7. completeWork(p)      â†’ pæ²¡æœ‰childï¼Œå®Œæˆp
8. completeWork(App)    â†’ pæ²¡æœ‰siblingï¼Œå›åˆ°Appï¼Œå®ŒæˆApp
```

**åœ¨ React æºç ä¸­çš„åº”ç”¨ï¼š**

```javascript
// packages/react-reconciler/src/ReactFiberWorkLoop.js

function performUnitOfWork(unitOfWork: Fiber): void {
  const current = unitOfWork.alternate;

  let next;
  if (enableProfilerTimer && (unitOfWork.mode & ProfileMode) !== NoMode) {
    startProfilerTimer(unitOfWork);
    next = beginWork(current, unitOfWork, renderLanes);
    stopProfilerTimerIfRunningAndRecordDelta(unitOfWork, true);
  } else {
    next = beginWork(current, unitOfWork, renderLanes);
  }

  unitOfWork.memoizedProps = unitOfWork.pendingProps;

  if (next === null) {
    completeUnitOfWork(unitOfWork);
  } else {
    workInProgress = next;
  }
}
```

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šéå†ç­–ç•¥ï¼ˆchild â†’ sibling â†’ returnï¼‰ğŸ§­

**Fiberæ ‘çš„éå†ç­–ç•¥æ˜¯ä¼˜å…ˆè®¿é—®childï¼ˆæ·±åº¦ä¼˜å…ˆï¼‰ï¼Œæ— childè®¿é—®siblingï¼ˆå…„å¼ŸèŠ‚ç‚¹ï¼‰ï¼Œæ— siblingå›æº¯returnï¼ˆçˆ¶èŠ‚ç‚¹ï¼‰ï¼Œç›´åˆ°å›åˆ°æ ¹èŠ‚ç‚¹ã€‚**

```javascript
// ===== 1. éå†ç­–ç•¥çš„æ ¸å¿ƒé€»è¾‘ =====

function getNextFiber(fiber) {
  // 1. ä¼˜å…ˆè®¿é—®childï¼ˆæ·±åº¦ä¼˜å…ˆï¼‰
  if (fiber.child !== null) {
    console.log(`  â†’ è¿›å…¥child: ${fiber.child.type}`);
    return fiber.child;
  }

  // 2. æ²¡æœ‰childï¼Œæ‰¾siblingæˆ–å›æº¯
  let nextFiber = fiber;
  while (nextFiber !== null) {
    // æ£€æŸ¥sibling
    if (nextFiber.sibling !== null) {
      console.log(`  â†’ è®¿é—®sibling: ${nextFiber.sibling.type}`);
      return nextFiber.sibling;
    }

    // æ²¡æœ‰siblingï¼Œå›æº¯åˆ°çˆ¶èŠ‚ç‚¹
    console.log(`  â†’ å›æº¯åˆ°return: ${nextFiber.return ? nextFiber.return.type : 'null'}`);
    nextFiber = nextFiber.return;
  }

  // éå†å®Œæˆ
  return null;
}

// ===== 2. æ·±åº¦ä¼˜å…ˆéå†å¯è§†åŒ– =====

console.log('\n=== æ·±åº¦ä¼˜å…ˆéå†å¯è§†åŒ– ===\n');

// æ„å»ºæ ‘
//         A
//       / | \
//      B  E  F
//     / \
//    C   D

class SimpleFiber {
  constructor(name) {
    this.name = name;
    this.child = null;
    this.sibling = null;
    this.return = null;
  }
}

const A = new SimpleFiber('A');
const B = new SimpleFiber('B');
const C = new SimpleFiber('C');
const D = new SimpleFiber('D');
const E = new SimpleFiber('E');
const F = new SimpleFiber('F');

A.child = B;
B.sibling = E;
E.sibling = F;
B.child = C;
C.sibling = D;

B.return = A;
E.return = A;
F.return = A;
C.return = B;
D.return = B;

// éå†
let current = A;
const visitOrder = [];

console.log('æ ‘ç»“æ„:');
console.log('         A');
console.log('       / | \\');
console.log('      B  E  F');
console.log('     / \\');
console.log('    C   D');
console.log('');

console.log('éå†è¿‡ç¨‹:');
while (current !== null) {
  visitOrder.push(current.name);
  console.log(`è®¿é—®: ${current.name}`);
  current = getNextFiber(current);
}

console.log(`\nè®¿é—®é¡ºåº: ${visitOrder.join(' â†’ ')}`);

// ===== 3. éå†ç­–ç•¥çš„è¯¦ç»†æ­¥éª¤ =====

console.log('\n=== éå†ç­–ç•¥çš„è¯¦ç»†æ­¥éª¤ ===\n');

const steps = [
  { current: 'A', action: 'child', next: 'B', reason: 'Aæœ‰child B' },
  { current: 'B', action: 'child', next: 'C', reason: 'Bæœ‰child C' },
  { current: 'C', action: 'sibling', next: 'D', reason: 'Cæ²¡æœ‰childï¼Œæœ‰sibling D' },
  { current: 'D', action: 'returnâ†’sibling', next: 'E', reason: 'Dæ²¡æœ‰child/siblingï¼Œå›åˆ°Bï¼ŒBæœ‰sibling E' },
  { current: 'E', action: 'sibling', next: 'F', reason: 'Eæ²¡æœ‰childï¼Œæœ‰sibling F' },
  { current: 'F', action: 'returnâ†’return', next: 'null', reason: 'Fæ²¡æœ‰child/siblingï¼Œå›åˆ°Aï¼ŒAæ²¡æœ‰sibling/returnï¼Œéå†å®Œæˆ' }
];

steps.forEach((step, index) => {
  console.log(`æ­¥éª¤${index + 1}:`);
  console.log(`  å½“å‰èŠ‚ç‚¹: ${step.current}`);
  console.log(`  åŠ¨ä½œ: ${step.action}`);
  console.log(`  ä¸‹ä¸€ä¸ªèŠ‚ç‚¹: ${step.next}`);
  console.log(`  åŸå› : ${step.reason}`);
  console.log('');
});

// ===== 4. ä¸ºä»€ä¹ˆé€‰æ‹©DFSè€ŒéBFSï¼Ÿ =====

console.log('=== ä¸ºä»€ä¹ˆé€‰æ‹©DFSè€ŒéBFSï¼Ÿ ===\n');

const comparison = {
  DFS: {
    éå†é¡ºåº: 'A â†’ B â†’ C â†’ D â†’ E â†’ F',
    å†…å­˜å ç”¨: 'O(h) - åªä¿å­˜å½“å‰è·¯å¾„',
    é€‚ç”¨åœºæ™¯: 'éœ€è¦å…ˆå¤„ç†å­èŠ‚ç‚¹ï¼ˆReactçš„completeWorkï¼‰',
    å®ç°æ–¹å¼: 'é€’å½’ or æ ˆ or ä¸‰æŒ‡é’ˆé“¾è¡¨',
    Reacté€‰æ‹©åŸå› : 'å…ˆåˆ›å»ºå­ç»„ä»¶ï¼Œçˆ¶ç»„ä»¶æ‰èƒ½ç¡®å®šæœ€ç»ˆçŠ¶æ€'
  },
  BFS: {
    éå†é¡ºåº: 'A â†’ B â†’ E â†’ F â†’ C â†’ D',
    å†…å­˜å ç”¨: 'O(w) - ä¿å­˜æ•´å±‚èŠ‚ç‚¹',
    é€‚ç”¨åœºæ™¯: 'éœ€è¦æŒ‰å±‚çº§å¤„ç†',
    å®ç°æ–¹å¼: 'é˜Ÿåˆ—',
    ä¸é€‚åˆReactçš„åŸå› : 'çˆ¶ç»„ä»¶éœ€è¦ç­‰å¾…å­ç»„ä»¶å®Œæˆæ‰èƒ½ç¡®å®šprops'
  }
};

console.log('DFS (Reactä½¿ç”¨):');
Object.entries(comparison.DFS).forEach(([key, value]) => {
  console.log(`  ${key}: ${value}`);
});

console.log('\nBFS (ä¸é€‚åˆReact):');
Object.entries(comparison.BFS).forEach(([key, value]) => {
  console.log(`  ${key}: ${value}`);
});

// ===== 5. ä¸­æ–­å’Œæ¢å¤æ¼”ç¤º =====

console.log('\n=== ä¸­æ–­å’Œæ¢å¤æ¼”ç¤º ===\n');

// æ¨¡æ‹Ÿä¸­æ–­
let interrupted = null;

function simulateInterrupt() {
  let fiber = A;
  let count = 0;

  console.log('å¼€å§‹éå†...');

  while (fiber !== null) {
    count++;
    console.log(`  å¤„ç†: ${fiber.name}`);

    // æ¨¡æ‹Ÿä¸­æ–­æ¡ä»¶ï¼šå¤„ç†3ä¸ªèŠ‚ç‚¹åä¸­æ–­
    if (count === 3) {
      interrupted = fiber;
      console.log(`\nä¸­æ–­ï¼ä¿å­˜è¿›åº¦: ${interrupted.name}\n`);
      break;
    }

    fiber = getNextFiber(fiber);
  }

  // æ¢å¤
  console.log('æ¢å¤éå†...');
  fiber = getNextFiber(interrupted);

  while (fiber !== null) {
    console.log(`  å¤„ç†: ${fiber.name}`);
    fiber = getNextFiber(fiber);
  }

  console.log('\néå†å®Œæˆï¼');
}

simulateInterrupt();
```

**è¯¦ç»†è§£é‡Šï¼š**

**éå†ç­–ç•¥çš„ä¸‰ä¸ªè§„åˆ™ï¼š**

1. **è§„åˆ™1ï¼šä¼˜å…ˆchildï¼ˆæ·±åº¦ä¼˜å…ˆï¼‰**
   - å¦‚æœå½“å‰èŠ‚ç‚¹æœ‰childï¼Œç«‹å³è®¿é—®child
   - ä½“ç°"æ·±åº¦ä¼˜å…ˆ"ï¼šå…ˆæ·±å…¥ï¼Œå†å¹¿åº¦

2. **è§„åˆ™2ï¼šæ— childæ‰¾siblingï¼ˆåŒå±‚éå†ï¼‰**
   - å½“å‰èŠ‚ç‚¹æ²¡æœ‰childï¼Œæ£€æŸ¥æ˜¯å¦æœ‰sibling
   - æœ‰siblingï¼Œè®¿é—®sibling
   - ä½“ç°"åŒå±‚éå†"ï¼šå¤„ç†å®Œä¸€ä¸ªå­æ ‘ï¼Œå¤„ç†ä¸‹ä¸€ä¸ªå­æ ‘

3. **è§„åˆ™3ï¼šæ— siblingå›æº¯returnï¼ˆå›åˆ°çˆ¶èŠ‚ç‚¹ï¼‰**
   - å½“å‰èŠ‚ç‚¹æ²¡æœ‰childå’Œsiblingï¼Œå›æº¯åˆ°çˆ¶èŠ‚ç‚¹
   - åœ¨çˆ¶èŠ‚ç‚¹ç»§ç»­æ‰¾sibling
   - ç›´åˆ°å›åˆ°æ ¹èŠ‚ç‚¹ä¸”æ ¹èŠ‚ç‚¹æ²¡æœ‰siblingï¼Œéå†å®Œæˆ

**ä¸ºä»€ä¹ˆReacté€‰æ‹©DFSï¼Ÿ**

1. **ç¬¦åˆç»„ä»¶æ¸²æŸ“é¡ºåº**ï¼š
   - éœ€è¦å…ˆæ¸²æŸ“å­ç»„ä»¶ï¼Œæ‰èƒ½ç¡®å®šçˆ¶ç»„ä»¶çš„children
   - completeWorké˜¶æ®µéœ€è¦ä»å¶å­èŠ‚ç‚¹å‘ä¸Šæ”¶é›†å‰¯ä½œç”¨

2. **å†…å­˜å ç”¨å°**ï¼š
   - DFSåªéœ€ä¿å­˜å½“å‰è·¯å¾„ï¼ˆO(h)ç©ºé—´ï¼‰
   - BFSéœ€è¦ä¿å­˜æ•´å±‚èŠ‚ç‚¹ï¼ˆO(w)ç©ºé—´ï¼‰
   - å¯¹äºæ·±æ ‘ï¼ŒDFSæ›´é«˜æ•ˆ

3. **å¤©ç„¶æ”¯æŒå¯ä¸­æ–­**ï¼š
   - ä¿å­˜å½“å‰fiberæŒ‡é’ˆå³å¯
   - æ¢å¤æ—¶ä»è¯¥æŒ‡é’ˆç»§ç»­

**åœ¨ React æºç ä¸­çš„åº”ç”¨ï¼š**

```javascript
// packages/react-reconciler/src/ReactFiberWorkLoop.js

function completeUnitOfWork(unitOfWork: Fiber): void {
  let completedWork = unitOfWork;

  do {
    const current = completedWork.alternate;
    const returnFiber = completedWork.return;

    let next;
    next = completeWork(current, completedWork, renderLanes);

    if (next !== null) {
      workInProgress = next;
      return;
    }

    // æ£€æŸ¥sibling
    const siblingFiber = completedWork.sibling;
    if (siblingFiber !== null) {
      // æœ‰siblingï¼Œç»§ç»­å¤„ç†
      workInProgress = siblingFiber;
      return;
    }

    // å›åˆ°çˆ¶èŠ‚ç‚¹
    completedWork = returnFiber;
    workInProgress = completedWork;
  } while (completedWork !== null);

  // éå†å®Œæˆ
  if (workInProgressRootExitStatus === RootInProgress) {
    workInProgressRootExitStatus = RootCompleted;
  }
}
```

---

## å››ã€ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½ç†è§£ React workLoop çš„æ ¸å¿ƒï¼š

### 4.1 workLoopçš„åŸºæœ¬ç»“æ„

**æ ¸å¿ƒï¼š**whileå¾ªç¯ + å¤„ç†å·¥ä½œå•å…ƒ + ç§»åŠ¨æŒ‡é’ˆ

```javascript
function workLoop() {
  while (workInProgress !== null) {
    workInProgress = performUnitOfWork(workInProgress);
  }
}
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£Reactå¦‚ä½•éå†Fiberæ ‘
- ç†è§£å¯ä¸­æ–­æ¸²æŸ“çš„åŸºç¡€
- ä¸ºå­¦ä¹ å¹¶å‘æ¨¡å¼æ‰“åŸºç¡€

---

### 4.2 åŒæ­¥ vs å¹¶å‘æ¨¡å¼

**æ ¸å¿ƒï¼š**å¹¶å‘æ¨¡å¼å¤šäº†shouldYieldæ£€æŸ¥

```javascript
// åŒæ­¥
while (workInProgress !== null) {
  performUnitOfWork(workInProgress);
}

// å¹¶å‘
while (workInProgress !== null && !shouldYield()) {
  performUnitOfWork(workInProgress);
}
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£æ—¶é—´åˆ‡ç‰‡çš„å®ç°
- ç†è§£ä¸ºä»€ä¹ˆå¹¶å‘æ¨¡å¼å“åº”å¿«
- ä¸ºç†è§£Scheduleræ‰“åŸºç¡€

---

### 4.3 performUnitOfWorkçš„ä¸¤ä¸ªé˜¶æ®µ

**æ ¸å¿ƒï¼š**beginWorkå‘ä¸‹ + completeWorkå‘ä¸Š

```javascript
function performUnitOfWork(fiber) {
  // å‘ä¸‹ï¼šå¤„ç†å½“å‰èŠ‚ç‚¹ï¼Œè¿”å›child
  const next = beginWork(fiber);

  if (next) return next;  // æœ‰child

  // å‘ä¸Šï¼šå®ŒæˆèŠ‚ç‚¹ï¼Œæ‰¾siblingæˆ–return
  completeUnitOfWork(fiber);
}
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£éå†çš„ä¸¤ä¸ªé˜¶æ®µ
- ç†è§£å‰¯ä½œç”¨æ”¶é›†çš„æ—¶æœº
- ä¸ºå­¦ä¹ beginWork/completeWorkæ‰“åŸºç¡€

---

### 4.4 éå†ç­–ç•¥

**æ ¸å¿ƒï¼š**child â†’ sibling â†’ return

```
ä¼˜å…ˆçº§ï¼š
1. childï¼ˆæ·±åº¦ä¼˜å…ˆï¼‰
2. siblingï¼ˆåŒå±‚éå†ï¼‰
3. returnï¼ˆå›æº¯ï¼‰
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£Fiberæ ‘çš„éå†é¡ºåº
- ç†è§£ä¸ºä»€ä¹ˆæ˜¯æ·±åº¦ä¼˜å…ˆ
- ä¸ºç†è§£reconcileæ‰“åŸºç¡€

---

### 4.5 ä¸­æ–­å’Œæ¢å¤

**æ ¸å¿ƒï¼š**workInProgressä¿å­˜è¿›åº¦

```javascript
// ä¸­æ–­
if (shouldYield()) {
  break;  // workInProgressä¿ç•™
}

// æ¢å¤
workLoop();  // ä»workInProgressç»§ç»­
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£å¦‚ä½•ä¿å­˜æ¸²æŸ“è¿›åº¦
- ç†è§£é«˜ä¼˜å…ˆçº§å¦‚ä½•æ‰“æ–­ä½ä¼˜å…ˆçº§
- ä¸ºç†è§£å¹¶å‘ç‰¹æ€§æ‰“åŸºç¡€

---

## äº”ã€ã€1ä¸ªç±»æ¯”ã€‘

### ç±»æ¯”1ï¼šworkLoop = è£…é…æµæ°´çº¿ ğŸ­

**è§£é‡Šç›¸ä¼¼æ€§ï¼š**

æƒ³è±¡ä¸€ä¸ªæ±½è½¦è£…é…æµæ°´çº¿ï¼Œæ¯ä¸ªå·¥ä½å¤„ç†ä¸€ä¸ªé›¶ä»¶ï¼Œé›¶ä»¶æŒ‰é¡ºåºæµè½¬ï¼š

```javascript
// è£…é…æµæ°´çº¿
function assemblyLine() {
  let currentPart = firstPart;  // ç¬¬ä¸€ä¸ªé›¶ä»¶

  while (currentPart !== null) {
    // å¤„ç†å½“å‰é›¶ä»¶
    processedPart = assemblePart(currentPart);

    // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªé›¶ä»¶
    currentPart = getNextPart(processedPart);
  }
}

// workLoop
function workLoop() {
  let workInProgress = firstFiber;

  while (workInProgress !== null) {
    workInProgress = performUnitOfWork(workInProgress);
  }
}
```

**å¯¹åº”å…³ç³»ï¼š**

| Reactæ¦‚å¿µ | è£…é…æµæ°´çº¿ç±»æ¯” |
|-----------|----------------|
| workLoop | æµæ°´çº¿æ€»æ§ç³»ç»Ÿ |
| workInProgress | å½“å‰æ­£åœ¨å¤„ç†çš„é›¶ä»¶ |
| performUnitOfWork | ä¸€ä¸ªå·¥ä½çš„æ“ä½œ |
| beginWork | å®‰è£…é›¶ä»¶ |
| completeWork | æ£€æŸ¥è´¨é‡ |
| shouldYield | ç­æ¬¡æ—¶é—´åˆ°ï¼Œè®©å‡ºæµæ°´çº¿ |

**å¯ä¸­æ–­çš„æµæ°´çº¿ï¼š**
```
æ­£å¸¸ç­æ¬¡ï¼š
[å¤„ç†é›¶ä»¶1-10] [å¤„ç†é›¶ä»¶11-20] [å¤„ç†é›¶ä»¶21-30]

ç´§æ€¥æ’å•ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰ï¼š
[å¤„ç†é›¶ä»¶1-5] [æš‚åœï¼Œå¤„ç†ç´§æ€¥è®¢å•] [ç»§ç»­é›¶ä»¶6-10]
                â†‘ è®©å‡ºæµæ°´çº¿      â†‘ æ¢å¤ç”Ÿäº§
```

---

### ç±»æ¯”2ï¼šworkLoop = é©¬æ‹‰æ¾æ¯”èµ› ğŸƒ

**è§£é‡Šç›¸ä¼¼æ€§ï¼š**

é©¬æ‹‰æ¾æ¯”èµ›éœ€è¦è·‘å®Œ42å…¬é‡Œï¼Œå¯ä»¥è®¾ç½®æ£€æŸ¥ç‚¹ä¼‘æ¯ï¼š

```javascript
// é©¬æ‹‰æ¾ï¼ˆåŒæ­¥æ¨¡å¼ï¼‰
function marathonSync() {
  let distance = 0;

  // ä¸€å£æ°”è·‘å®Œ
  while (distance < 42) {
    distance += runOneKilometer();
  }
}

// é©¬æ‹‰æ¾ï¼ˆå¹¶å‘æ¨¡å¼ï¼‰
function marathonConcurrent() {
  let distance = 0;

  // è·‘ä¸€æ®µä¼‘æ¯ä¸€ä¸‹
  while (distance < 42 && !tooTired()) {
    distance += runOneKilometer();
  }

  if (distance < 42) {
    // ä¼‘æ¯åç»§ç»­
    setTimeout(() => marathonConcurrent(), 1000);
  }
}
```

**å¯¹åº”å…³ç³»ï¼š**

| Reactæ¦‚å¿µ | é©¬æ‹‰æ¾ç±»æ¯” |
|-----------|-----------|
| workLoop | è·‘é©¬æ‹‰æ¾ |
| performUnitOfWork | è·‘1å…¬é‡Œ |
| shouldYield | æ£€æŸ¥æ˜¯å¦ç´¯äº† |
| ä¸­æ–­ | ä¼‘æ¯è¡¥ç»™ |
| æ¢å¤ | ç»§ç»­è·‘ |
| workInProgress | å½“å‰è·‘åˆ°çš„ä½ç½® |

**ä¸ºä»€ä¹ˆè¦åˆ†æ®µè·‘ï¼Ÿ**
- **åŒæ­¥**ï¼šä¸€å£æ°”è·‘å®Œï¼Œä¸­é—´ä¸èƒ½ä¼‘æ¯ï¼Œç´¯æ­»äºº
- **å¹¶å‘**ï¼šè·‘5å…¬é‡Œä¼‘æ¯ä¸€ä¸‹ï¼Œè¡¥ç»™ã€å–æ°´ï¼Œæ›´å¥åº·

---

### ç±»æ¯”3ï¼šworkLoop = è¯»ä¹¦ç”¨ä¹¦ç­¾ ğŸ“–

**è§£é‡Šç›¸ä¼¼æ€§ï¼š**

è¯»ä¸€æœ¬ä¹¦ï¼Œå¯ä»¥ç”¨ä¹¦ç­¾æ ‡è®°è¿›åº¦ï¼Œä¸‹æ¬¡ç»§ç»­ï¼š

```javascript
// è¯»ä¹¦
function readBook() {
  let currentPage = bookmark || 1;  // ä»ä¹¦ç­¾ä½ç½®å¼€å§‹

  while (currentPage <= totalPages && !sleepy()) {
    readOnePage(currentPage);
    currentPage++;
  }

  // ä¿å­˜è¿›åº¦
  bookmark = currentPage;
}
```

**å¯¹åº”å…³ç³»ï¼š**

| Reactæ¦‚å¿µ | è¯»ä¹¦ç±»æ¯” |
|-----------|---------|
| workLoop | è¯»ä¹¦ |
| workInProgress | ä¹¦ç­¾ |
| performUnitOfWork | è¯»ä¸€é¡µ |
| shouldYield | å›°äº†/æœ‰äº‹äº† |
| ä¸­æ–­ | å¤¹ä¸Šä¹¦ç­¾ï¼Œä¸‹æ¬¡ç»§ç»­ |
| æ¢å¤ | æ‰“å¼€ä¹¦ç­¾ï¼Œç»§ç»­è¯» |

**ä¸ºä»€ä¹ˆéœ€è¦ä¹¦ç­¾ï¼Ÿ**
- ä¸€æ¬¡è¯»ä¸å®Œæ•´æœ¬ä¹¦
- ä¸­é€”å¯èƒ½è¢«æ‰“æ–­ï¼ˆç”µè¯ã€åƒé¥­ï¼‰
- ä¿å­˜è¿›åº¦ï¼Œéšæ—¶æ¢å¤

---

### ç±»æ¯”æ€»ç»“è¡¨

| Reactæ¦‚å¿µ | è£…é…æµæ°´çº¿ | é©¬æ‹‰æ¾ | è¯»ä¹¦ |
|-----------|-----------|--------|------|
| workLoop | æµæ°´çº¿ç³»ç»Ÿ | è·‘é©¬æ‹‰æ¾ | è¯»ä¹¦ |
| workInProgress | å½“å‰é›¶ä»¶ | å½“å‰ä½ç½® | ä¹¦ç­¾ |
| performUnitOfWork | å¤„ç†ä¸€ä¸ªé›¶ä»¶ | è·‘1å…¬é‡Œ | è¯»1é¡µ |
| shouldYield | ç­æ¬¡æ—¶é—´åˆ° | ç´¯äº† | å›°äº†/è¢«æ‰“æ–­ |
| ä¸­æ–­ | è®©å‡ºæµæ°´çº¿ | ä¼‘æ¯è¡¥ç»™ | å¤¹ä¹¦ç­¾ |
| æ¢å¤ | ç»§ç»­ç”Ÿäº§ | ç»§ç»­è·‘ | ç»§ç»­è¯» |

---

## å…­ã€ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼šworkLoopéå†æ‰€æœ‰FiberèŠ‚ç‚¹ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

é€šè¿‡bailoutä¼˜åŒ–ï¼Œå¤§éƒ¨åˆ†èŠ‚ç‚¹è¢«è·³è¿‡ï¼š

```javascript
function beginWork(current, workInProgress) {
  // bailoutæ£€æŸ¥
  if (oldProps === newProps && !hasContextChanged()) {
    // è·³è¿‡æ•´ä¸ªå­æ ‘ï¼
    return bailoutOnAlreadyFinishedWork(workInProgress);
  }

  // åªæœ‰å˜åŒ–çš„èŠ‚ç‚¹æ‰reconcile
  return reconcileChildren(workInProgress);
}
```

**å®é™…åœºæ™¯ï¼š**
```
// ç»„ä»¶æ ‘1000ä¸ªèŠ‚ç‚¹ï¼ŒæŸæ¬¡æ›´æ–°åªæ”¹äº†1ä¸ªæŒ‰é’®çš„æ–‡å­—

beginWorkéå†èŠ‚ç‚¹ï¼š
- æ ¹èŠ‚ç‚¹ â†’ Page â†’ Layout â†’ Buttonï¼ˆ20ä¸ªèŠ‚ç‚¹ï¼‰
- å…¶ä»–980ä¸ªèŠ‚ç‚¹ï¼šbailoutè·³è¿‡

å®é™…å¤„ç†ï¼š20ä¸ªèŠ‚ç‚¹ï¼ˆ2%ï¼‰
è·³è¿‡ï¼š980ä¸ªèŠ‚ç‚¹ï¼ˆ98%ï¼‰
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

å› ä¸ºwhileå¾ªç¯"çœ‹èµ·æ¥"ä¼šéå†æ‰€æœ‰èŠ‚ç‚¹ã€‚ä½†å®é™…ä¸Šï¼š
- whileå¾ªç¯éå†**æ‰€æœ‰èŠ‚ç‚¹**ï¼ˆæ£€æŸ¥ï¼‰
- beginWorkåªå¤„ç†**å˜åŒ–çš„èŠ‚ç‚¹**ï¼ˆæ›´æ–°ï¼‰
- bailoutè·³è¿‡**æœªå˜åŒ–çš„å­æ ‘**ï¼ˆä¼˜åŒ–ï¼‰

**æ­£ç¡®ç†è§£ï¼š**

workLoop = éå† + é€‰æ‹©æ€§å¤„ç†
- éå†ï¼šO(n)ï¼Œä½†å¾ˆå¿«ï¼ˆåªæ£€æŸ¥propsï¼‰
- å¤„ç†ï¼šO(m)ï¼Œm << nï¼ˆåªæ›´æ–°å˜åŒ–çš„ï¼‰

---

### è¯¯åŒº2ï¼šå¹¶å‘æ¨¡å¼é¢‘ç¹ä¸­æ–­ï¼Œå½±å“æ€§èƒ½ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

Reactæ™ºèƒ½è°ƒåº¦ï¼Œåªåœ¨å¿…è¦æ—¶ä¸­æ–­ï¼š

```javascript
function shouldYield() {
  // 1. æ£€æŸ¥æ—¶é—´ï¼š5mså†…ä¸ä¸­æ–­
  if (getCurrentTime() - startTime < 5) {
    return false;
  }

  // 2. æ£€æŸ¥ä»»åŠ¡ï¼šæ²¡æœ‰ç´§æ€¥ä»»åŠ¡ä¸ä¸­æ–­
  if (!hasHigherPriorityWork()) {
    return false;
  }

  // åªæœ‰è¶…æ—¶ä¸”æœ‰ç´§æ€¥ä»»åŠ¡æ‰ä¸­æ–­
  return true;
}
```

**å®é™…åœºæ™¯ï¼š**
```
// æ¸²æŸ“1000ä¸ªèŠ‚ç‚¹

æƒ…å†µ1ï¼šæ— ç”¨æˆ·äº¤äº’
  â†’ ä¸€æ¬¡æ€§å®Œæˆï¼Œ0æ¬¡ä¸­æ–­

æƒ…å†µ2ï¼š5msåç”¨æˆ·ç‚¹å‡»
  â†’ ä¸­æ–­1æ¬¡ï¼Œå¤„ç†ç‚¹å‡»ï¼Œç»§ç»­æ¸²æŸ“

æƒ…å†µ3ï¼šç”¨æˆ·ç–¯ç‹‚ç‚¹å‡»
  â†’ ä¸­æ–­å¤šæ¬¡ï¼Œä½†æ¯æ¬¡ç‚¹å‡»éƒ½èƒ½å¿«é€Ÿå“åº”
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

å› ä¸º"å¯ä¸­æ–­"å¬èµ·æ¥åƒ"ä¼šé¢‘ç¹ä¸­æ–­"ã€‚ä½†å®é™…ä¸Šï¼š
- **å¯ä¸­æ–­** â‰  **é¢‘ç¹ä¸­æ–­**
- åªåœ¨å¿…è¦æ—¶ä¸­æ–­ï¼ˆè¶…æ—¶ + æœ‰ç´§æ€¥ä»»åŠ¡ï¼‰
- å¤§éƒ¨åˆ†æƒ…å†µä¸€æ¬¡æ€§å®Œæˆ

**æ­£ç¡®ç†è§£ï¼š**

å¹¶å‘æ¨¡å¼ = å¯ä¸­æ–­ + æ™ºèƒ½è°ƒåº¦
- æ²¡æœ‰ç´§æ€¥ä»»åŠ¡ï¼šä¸€æ¬¡æ€§å®Œæˆï¼ˆå¿«ï¼‰
- æœ‰ç´§æ€¥ä»»åŠ¡ï¼šè®©å‡ºæ§åˆ¶æƒï¼ˆå“åº”å¿«ï¼‰

---

### è¯¯åŒº3ï¼šä¸­æ–­åä»å¤´å¼€å§‹ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

workInProgressä¿å­˜äº†ç²¾ç¡®çš„è¿›åº¦ï¼š

```javascript
// ä¸­æ–­æ—¶
function workLoopConcurrent() {
  while (workInProgress !== null && !shouldYield()) {
    workInProgress = performUnitOfWork(workInProgress);
  }

  // ä¸­æ–­ï¼workInProgress = ç¬¬50ä¸ªèŠ‚ç‚¹
}

// æ¢å¤æ—¶
function resumeWork() {
  // ä»ç¬¬50ä¸ªèŠ‚ç‚¹ç»§ç»­ï¼Œä¸æ˜¯ä»ç¬¬1ä¸ªï¼
  workLoopConcurrent();
}
```

**ä¸­æ–­å’Œæ¢å¤æ¼”ç¤ºï¼š**
```
æ€»å…±100ä¸ªèŠ‚ç‚¹ï¼š

[å¤„ç†1-50] shouldYield()=trueï¼Œä¸­æ–­
  â†“ workInProgress = èŠ‚ç‚¹50
[å¤„ç†ç”¨æˆ·ç‚¹å‡»]
  â†“
[å¤„ç†51-100] ä»workInProgressç»§ç»­
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

å› ä¸ºå…¶ä»–æ¡†æ¶å¯èƒ½éœ€è¦é‡æ–°å¼€å§‹ã€‚ä½†Reactï¼š
- **FiberèŠ‚ç‚¹**ï¼šæ˜¾å¼æ•°æ®ç»“æ„ï¼Œå¯ä¿å­˜
- **workInProgress**ï¼šå…¨å±€å˜é‡ï¼Œè·¨è°ƒç”¨ä¿æŒ
- **çŠ¶æ€å®Œæ•´**ï¼šmemoizedStateä¸ä¸¢å¤±

**æ­£ç¡®ç†è§£ï¼š**

ä¸­æ–­ = æš‚åœ + ä¿å­˜æŒ‡é’ˆ
- æš‚åœï¼šé€€å‡ºworkLoop
- ä¿å­˜ï¼šworkInProgressåœ¨å†…å­˜ä¸­
- æ¢å¤ï¼šä»workInProgressç»§ç»­ï¼ŒO(1)æ¢å¤æˆæœ¬

---

## ä¸ƒã€ã€å®æˆ˜ä»£ç ã€‘

### åŸºç¡€å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰

```javascript
// ===== 1. åŸºç¡€workLoopå®ç° =====
console.log("=== 1. åŸºç¡€workLoopå®ç° ===\n");

let workInProgress = null;

function workLoop() {
  console.log('workLoopå¼€å§‹');

  while (workInProgress !== null) {
    console.log(`  å¤„ç†: ${workInProgress.name}`);
    workInProgress = performUnitOfWork(workInProgress);
  }

  console.log('workLoopå®Œæˆ\n');
}

function performUnitOfWork(fiber) {
  // æ¨¡æ‹ŸbeginWork
  console.log(`    beginWork(${fiber.name})`);

  // è¿”å›childï¼ˆå¦‚æœæœ‰ï¼‰
  if (fiber.child) {
    return fiber.child;
  }

  // æ¨¡æ‹ŸcompleteWork
  let current = fiber;
  while (current) {
    console.log(`    completeWork(${current.name})`);

    if (current.sibling) {
      return current.sibling;
    }

    current = current.return;
  }

  return null;
}

// æ„å»ºç®€å•æ ‘
//    A
//   / \
//  B   C

const A = { name: 'A', child: null, sibling: null, return: null };
const B = { name: 'B', child: null, sibling: null, return: A };
const C = { name: 'C', child: null, sibling: null, return: A };

A.child = B;
B.sibling = C;

workInProgress = A;
workLoop();

// ===== 2. å¹¶å‘workLoopå®ç° =====
console.log("=== 2. å¹¶å‘workLoopå®ç° ===\n");

let deadline = 0;
const frameInterval = 5;  // 5msæ—¶é—´åˆ‡ç‰‡

function getCurrentTime() {
  return performance.now();
}

function shouldYield() {
  return getCurrentTime() >= deadline;
}

function workLoopConcurrent() {
  console.log('å¹¶å‘workLoopå¼€å§‹');

  while (workInProgress !== null && !shouldYield()) {
    console.log(`  å¤„ç†: ${workInProgress.name}`);
    workInProgress = performUnitOfWork(workInProgress);
  }

  if (workInProgress !== null) {
    console.log(`ä¸­æ–­ï¼è¿˜æœ‰${countRemaining(workInProgress)}ä¸ªèŠ‚ç‚¹æœªå¤„ç†\n`);
    return 'RootInProgress';
  }

  console.log('å¹¶å‘workLoopå®Œæˆ\n');
  return 'RootCompleted';
}

function countRemaining(fiber) {
  let count = 0;
  let current = fiber;

  while (current) {
    count++;
    current = getNext(current);
  }

  return count;
}

function getNext(fiber) {
  if (fiber.child) return fiber.child;

  while (fiber) {
    if (fiber.sibling) return fiber.sibling;
    fiber = fiber.return;
  }

  return null;
}

// æ¨¡æ‹Ÿå¹¶å‘æ¸²æŸ“
deadline = getCurrentTime() + frameInterval;
workInProgress = A;

let status = workLoopConcurrent();
while (status === 'RootInProgress') {
  console.log('æ¢å¤æ¸²æŸ“...');
  deadline = getCurrentTime() + frameInterval;
  status = workLoopConcurrent();
}

// ===== 3. å®Œæ•´çš„renderæµç¨‹ =====
console.log("=== 3. å®Œæ•´çš„renderæµç¨‹ ===\n");

function renderRoot(root, isConcurrent) {
  console.log(`å¼€å§‹æ¸²æŸ“ï¼ˆ${isConcurrent ? 'å¹¶å‘' : 'åŒæ­¥'}æ¨¡å¼ï¼‰`);

  // å‡†å¤‡workInProgressæ ‘
  workInProgress = root;

  if (isConcurrent) {
    deadline = getCurrentTime() + frameInterval;
    let status = workLoopConcurrent();

    while (status === 'RootInProgress') {
      deadline = getCurrentTime() + frameInterval;
      status = workLoopConcurrent();
    }
  } else {
    workLoop();
  }

  console.log('æ¸²æŸ“å®Œæˆ\n');
}

// æµ‹è¯•
workInProgress = null;
const root = { name: 'Root', child: A, sibling: null, return: null };
A.return = root;

renderRoot(root, false);  // åŒæ­¥æ¨¡å¼

workInProgress = null;
A.return = root;
renderRoot(root, true);   // å¹¶å‘æ¨¡å¼

console.log('=== æ‰€æœ‰æ¼”ç¤ºå®Œæˆ ===');
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼š**

```
=== 1. åŸºç¡€workLoopå®ç° ===

workLoopå¼€å§‹
  å¤„ç†: A
    beginWork(A)
  å¤„ç†: B
    beginWork(B)
    completeWork(B)
  å¤„ç†: C
    beginWork(C)
    completeWork(C)
    completeWork(A)
workLoopå®Œæˆ

=== 2. å¹¶å‘workLoopå®ç° ===

å¹¶å‘workLoopå¼€å§‹
  å¤„ç†: A
  å¤„ç†: B
ä¸­æ–­ï¼è¿˜æœ‰1ä¸ªèŠ‚ç‚¹æœªå¤„ç†

æ¢å¤æ¸²æŸ“...
å¹¶å‘workLoopå¼€å§‹
  å¤„ç†: C
å¹¶å‘workLoopå®Œæˆ

=== 3. å®Œæ•´çš„renderæµç¨‹ ===

å¼€å§‹æ¸²æŸ“ï¼ˆåŒæ­¥æ¨¡å¼ï¼‰
workLoopå¼€å§‹
  å¤„ç†: Root
  å¤„ç†: A
  å¤„ç†: B
  å¤„ç†: C
workLoopå®Œæˆ
æ¸²æŸ“å®Œæˆ

å¼€å§‹æ¸²æŸ“ï¼ˆå¹¶å‘æ¨¡å¼ï¼‰
å¹¶å‘workLoopå¼€å§‹
  å¤„ç†: Root
  å¤„ç†: A
ä¸­æ–­ï¼è¿˜æœ‰2ä¸ªèŠ‚ç‚¹æœªå¤„ç†
æ¢å¤æ¸²æŸ“...
å¹¶å‘workLoopå¼€å§‹
  å¤„ç†: B
  å¤„ç†: C
å¹¶å‘workLoopå®Œæˆ
æ¸²æŸ“å®Œæˆ

=== æ‰€æœ‰æ¼”ç¤ºå®Œæˆ ===
```

---

### è¿›é˜¶ï¼šReactæºç å®ç°

```javascript
// React 19æºç ç‰‡æ®µ

// ===== 1. workLoop =====
// packages/react-reconciler/src/ReactFiberWorkLoop.js

function workLoopSync() {
  while (workInProgress !== null) {
    performUnitOfWork(workInProgress);
  }
}

function workLoopConcurrent() {
  while (workInProgress !== null && !shouldYield()) {
    performUnitOfWork(workInProgress);
  }
}

// ===== 2. performUnitOfWork =====

function performUnitOfWork(unitOfWork: Fiber): void {
  const current = unitOfWork.alternate;

  let next;
  if (enableProfilerTimer && (unitOfWork.mode & ProfileMode) !== NoMode) {
    startProfilerTimer(unitOfWork);
    next = beginWork(current, unitOfWork, renderLanes);
    stopProfilerTimerIfRunningAndRecordDelta(unitOfWork, true);
  } else {
    next = beginWork(current, unitOfWork, renderLanes);
  }

  unitOfWork.memoizedProps = unitOfWork.pendingProps;

  if (next === null) {
    completeUnitOfWork(unitOfWork);
  } else {
    workInProgress = next;
  }
}

// ===== 3. renderRoot =====

function renderRootSync(root: FiberRoot, lanes: Lanes) {
  const prevExecutionContext = executionContext;
  executionContext |= RenderContext;

  if (workInProgressRoot !== root || workInProgressRootRenderLanes !== lanes) {
    prepareFreshStack(root, lanes);
  }

  do {
    try {
      workLoopSync();
      break;
    } catch (thrownValue) {
      handleError(root, thrownValue);
    }
  } while (true);

  executionContext = prevExecutionContext;

  if (workInProgress !== null) {
    throw new Error('Cannot commit an incomplete root');
  }

  workInProgressRoot = null;
  workInProgressRootRenderLanes = NoLanes;

  return workInProgressRootExitStatus;
}

function renderRootConcurrent(root: FiberRoot, lanes: Lanes) {
  const prevExecutionContext = executionContext;
  executionContext |= RenderContext;

  if (workInProgressRoot !== root || workInProgressRootRenderLanes !== lanes) {
    prepareFreshStack(root, lanes);
  }

  do {
    try {
      workLoopConcurrent();
      break;
    } catch (thrownValue) {
      handleError(root, thrownValue);
    }
  } while (true);

  executionContext = prevExecutionContext;

  if (workInProgress !== null) {
    return RootInProgress;
  } else {
    return workInProgressRootExitStatus;
  }
}
```

**å…³é”®æºç æ–‡ä»¶ï¼š**
- `packages/react-reconciler/src/ReactFiberWorkLoop.js` - workLoopæ ¸å¿ƒé€»è¾‘
- `packages/react-reconciler/src/ReactFiberBeginWork.js` - beginWorkå®ç°
- `packages/react-reconciler/src/ReactFiberCompleteWork.js` - completeWorkå®ç°
- `packages/scheduler/src/forks/Scheduler.js` - shouldYieldå®ç°

---

## å…«ã€ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜ï¼š"Reactçš„workLoopå¦‚ä½•å®ç°å¯ä¸­æ–­æ¸²æŸ“ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"Reactç”¨whileå¾ªç¯å¤„ç†FiberèŠ‚ç‚¹ï¼Œæ¯æ¬¡å¤„ç†ä¸€ä¸ªï¼Œé€šè¿‡shouldYieldåˆ¤æ–­æ˜¯å¦éœ€è¦ä¸­æ–­ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **workLoopçš„å¯ä¸­æ–­æ¸²æŸ“åŸºäºä¸‰ä¸ªæ ¸å¿ƒè®¾è®¡ï¼š**
>
> **1. æ˜¾å¼æ•°æ®ç»“æ„æ›¿ä»£é€’å½’è°ƒç”¨æ ˆ**
>
> é€’å½’æ— æ³•ä¸­æ–­ï¼Œå› ä¸ºè°ƒç”¨æ ˆç”±JSå¼•æ“æ§åˆ¶ã€‚Reacté€šè¿‡FiberèŠ‚ç‚¹ï¼ˆä¸‰æŒ‡é’ˆé“¾è¡¨æ ‘ï¼‰å°†éšå¼è°ƒç”¨æ ˆæ˜¾å¼åŒ–ï¼š
>
> ```javascript
> // æ—§æ–¹æ¡ˆï¼ˆé€’å½’ï¼Œæ— æ³•ä¸­æ–­ï¼‰
> function render(vdom) {
>   vdom.children.forEach(child => render(child));
> }
>
> // æ–°æ–¹æ¡ˆï¼ˆå¾ªç¯+æŒ‡é’ˆï¼Œå¯ä¸­æ–­ï¼‰
> function workLoop() {
>   while (workInProgress !== null && !shouldYield()) {
>     workInProgress = performUnitOfWork(workInProgress);
>   }
> }
> ```
>
> **2. æ—¶é—´åˆ‡ç‰‡ + shouldYieldæ£€æŸ¥**
>
> Reactå°†æ¸²æŸ“æ‹†åˆ†æˆ5msçš„æ—¶é—´åˆ‡ç‰‡ï¼Œæ¯ä¸ªåˆ‡ç‰‡å¤„ç†å¤šä¸ªFiberèŠ‚ç‚¹ã€‚é€šè¿‡shouldYieldæ£€æŸ¥æ˜¯å¦è¶…æ—¶ï¼š
>
> ```javascript
> function shouldYield() {
>   return getCurrentTime() >= deadline;  // è¶…è¿‡5ms
> }
> ```
>
> è¶…æ—¶åé€€å‡ºå¾ªç¯ï¼Œè®©å‡ºä¸»çº¿ç¨‹ç»™æµè§ˆå™¨ï¼Œç”¨æˆ·äº¤äº’å¯ä»¥æ’å…¥æ‰§è¡Œã€‚
>
> **3. workInProgressä¿å­˜ç²¾ç¡®è¿›åº¦**
>
> ä¸­æ–­æ—¶ï¼ŒworkInProgresså˜é‡ä¿å­˜å½“å‰å¤„ç†åˆ°å“ªä¸ªFiberèŠ‚ç‚¹ã€‚æ¢å¤æ—¶ï¼Œä»è¯¥èŠ‚ç‚¹ç»§ç»­ï¼š
>
> ```javascript
> // ä¸­æ–­æ—¶
> workInProgress = ç¬¬50ä¸ªèŠ‚ç‚¹;
>
> // æ¢å¤æ—¶
> workLoop();  // ä»ç¬¬50ä¸ªèŠ‚ç‚¹ç»§ç»­
> ```
>
> **å®é™…æ•ˆæœï¼š**
> - æ— ç”¨æˆ·äº¤äº’ï¼šä¸€æ¬¡æ€§å®Œæˆï¼Œ0æ¬¡ä¸­æ–­
> - æœ‰ç”¨æˆ·äº¤äº’ï¼šæ¯5msæ£€æŸ¥ä¸€æ¬¡ï¼Œå¿…è¦æ—¶è®©å‡º
> - ç”¨æˆ·æ„ŸçŸ¥ï¼šUIå§‹ç»ˆå“åº”ï¼Œæ— å¡é¡¿
>
> **åœ¨å®é™…å·¥ä½œä¸­çš„åº”ç”¨ï¼š**
> - ç†è§£ä¸ºä»€ä¹ˆConcurrent Modeå“åº”å¿«
> - ç†è§£ä¸ºä»€ä¹ˆå¤§åˆ—è¡¨æ¸²æŸ“ä¸å¡é¡¿
> - æ€§èƒ½ä¼˜åŒ–ï¼šæ‹†åˆ†å¤§ç»„ä»¶ï¼Œæé«˜å¯ä¸­æ–­æ€§

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**

1. âœ… ä»é€’å½’åˆ°å¾ªç¯çš„æœ¬è´¨å˜åŒ–
2. âœ… è¯´æ˜æ—¶é—´åˆ‡ç‰‡å’ŒshouldYieldæœºåˆ¶
3. âœ… è§£é‡Šå¦‚ä½•ä¿å­˜å’Œæ¢å¤è¿›åº¦
4. âœ… è”ç³»å®é™…åº”ç”¨å’Œæ€§èƒ½ä¼˜åŒ–

---

## ä¹ã€ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šworkLoopçš„æœ¬è´¨ ğŸ”„

**ä¸€å¥è¯ï¼š** workLoop = whileå¾ªç¯ + å¤„ç†å·¥ä½œå•å…ƒ + æŒ‡é’ˆç§»åŠ¨

**ä¸¾ä¾‹ï¼š**
```javascript
while (workInProgress !== null) {
  workInProgress = performUnitOfWork(workInProgress);
}
```

**åº”ç”¨ï¼š** Reactæ¸²æŸ“çš„æ ¸å¿ƒå¾ªç¯ï¼Œéå†æ•´æ£µFiberæ ‘ã€‚

---

### å¡ç‰‡2ï¼šåŒæ­¥ vs å¹¶å‘ âš¡

**ä¸€å¥è¯ï¼š** åŒæ­¥ä¸€æ¬¡æ€§å®Œæˆï¼Œå¹¶å‘å¯ä¸­æ–­è®©å‡ºã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
// åŒæ­¥
while (wip !== null) { /*...*/ }

// å¹¶å‘
while (wip !== null && !shouldYield()) { /*...*/ }
```

**åº”ç”¨ï¼š** å¹¶å‘æ¨¡å¼å“åº”å¿«ï¼Œç”¨æˆ·ä½“éªŒå¥½ã€‚

---

### å¡ç‰‡3ï¼šperformUnitOfWork ğŸ› ï¸

**ä¸€å¥è¯ï¼š** å¤„ç†ä¸€ä¸ªFiberèŠ‚ç‚¹ï¼ŒbeginWorkå‘ä¸‹ï¼ŒcompleteWorkå‘ä¸Šã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
const next = beginWork(fiber);
if (!next) completeWork(fiber);
```

**åº”ç”¨ï¼š** æ¯ä¸ªå·¥ä½œå•å…ƒæ‰§è¡Œæ—¶é—´çŸ­ï¼Œæ”¯æŒå¯ä¸­æ–­ã€‚

---

### å¡ç‰‡4ï¼šéå†ç­–ç•¥ ğŸ§­

**ä¸€å¥è¯ï¼š** ä¼˜å…ˆchildï¼Œæ— childè®¿é—®siblingï¼Œæ— siblingå›æº¯returnã€‚

**ä¸¾ä¾‹ï¼š**
```
A â†’ A.child â†’ B â†’ B.sibling â†’ C
```

**åº”ç”¨ï¼š** æ·±åº¦ä¼˜å…ˆéå†ï¼Œå…ˆå¤„ç†å­èŠ‚ç‚¹ã€‚

---

### å¡ç‰‡5ï¼šæ—¶é—´åˆ‡ç‰‡ â±ï¸

**ä¸€å¥è¯ï¼š** æ¯5msæ£€æŸ¥ä¸€æ¬¡shouldYieldï¼Œè¶…æ—¶è®©å‡ºæ§åˆ¶æƒã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
if (getCurrentTime() >= deadline) {
  break;  // è®©å‡º
}
```

**åº”ç”¨ï¼š** ä¿è¯UIå“åº”ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡ã€‚

---

### å¡ç‰‡6ï¼šä¸­æ–­å’Œæ¢å¤ â¸ï¸

**ä¸€å¥è¯ï¼š** workInProgressä¿å­˜è¿›åº¦ï¼Œä¸­æ–­åä»è¯¥èŠ‚ç‚¹ç»§ç»­ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
// ä¸­æ–­
workInProgress = èŠ‚ç‚¹50;

// æ¢å¤
workLoop();  // ä»èŠ‚ç‚¹50ç»§ç»­
```

**åº”ç”¨ï¼š** æ”¯æŒé«˜ä¼˜å…ˆçº§ä»»åŠ¡æ‰“æ–­ä½ä¼˜å…ˆçº§ã€‚

---

### å¡ç‰‡7ï¼šbailoutä¼˜åŒ– â­ï¸

**ä¸€å¥è¯ï¼š** propsæœªå˜åŒ–ï¼Œè·³è¿‡èŠ‚ç‚¹åŠå…¶å­æ ‘ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
if (oldProps === newProps) {
  return bailout(fiber);  // è·³è¿‡
}
```

**åº”ç”¨ï¼š** 90%+çš„èŠ‚ç‚¹è¢«è·³è¿‡ï¼Œæå‡æ€§èƒ½ã€‚

---

### å¡ç‰‡8ï¼šbeginWorké˜¶æ®µ â¬‡ï¸

**ä¸€å¥è¯ï¼š** å‘ä¸‹å¤„ç†èŠ‚ç‚¹ï¼Œåˆ›å»º/å¤ç”¨å­Fiberã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
const child = beginWork(fiber);
return child;  // è¿”å›childç»§ç»­
```

**åº”ç”¨ï¼š** è¿›å…¥å­æ ‘ï¼Œæ·±åº¦ä¼˜å…ˆã€‚

---

### å¡ç‰‡9ï¼šcompleteWorké˜¶æ®µ â¬†ï¸

**ä¸€å¥è¯ï¼š** å‘ä¸Šå®ŒæˆèŠ‚ç‚¹ï¼Œåˆ›å»ºDOMï¼Œæ”¶é›†å‰¯ä½œç”¨ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
completeWork(fiber);
return fiber.sibling || fiber.return;
```

**åº”ç”¨ï¼š** å›æº¯åˆ°çˆ¶èŠ‚ç‚¹ï¼Œæ”¶é›†å‰¯ä½œç”¨é“¾ã€‚

---

### å¡ç‰‡10ï¼šDFSçš„ä¼˜åŠ¿ ğŸŒ³

**ä¸€å¥è¯ï¼š** æ·±åº¦ä¼˜å…ˆï¼Œå…ˆå¤„ç†å­èŠ‚ç‚¹ï¼Œå†…å­˜å ç”¨å°ã€‚

**ä¸¾ä¾‹ï¼š**
```
DFS: A â†’ B â†’ C â†’ Dï¼ˆæ·±å…¥ï¼‰
BFS: A â†’ B â†’ C â†’ Dï¼ˆå¹¿åº¦ï¼‰
```

**åº”ç”¨ï¼š** ç¬¦åˆç»„ä»¶æ¸²æŸ“é¡ºåºï¼Œæ”¯æŒcompleteWorkå‘ä¸Šæ”¶é›†ã€‚

---

## åã€ã€ä¸€å¥è¯æ€»ç»“ã€‘

**workLoopæ˜¯Fiberæ¶æ„çš„æ ¸å¿ƒå¾ªç¯ï¼Œé€šè¿‡whileå¾ªç¯éå†Fiberæ ‘ï¼Œæ¯æ¬¡è°ƒç”¨performUnitOfWorkå¤„ç†ä¸€ä¸ªå·¥ä½œå•å…ƒï¼ˆbeginWorkå‘ä¸‹åˆ›å»ºå­èŠ‚ç‚¹ï¼ŒcompleteWorkå‘ä¸Šæ”¶é›†å‰¯ä½œç”¨ï¼‰ï¼Œç”¨workInProgresså˜é‡ä¿å­˜è¿›åº¦ï¼Œé€šè¿‡shouldYieldæ£€æŸ¥å®ç°å¯ä¸­æ–­ï¼ˆå¹¶å‘æ¨¡å¼ï¼‰ï¼Œé…åˆbailoutä¼˜åŒ–è·³è¿‡æœªå˜åŒ–å­æ ‘ï¼Œæ˜¯Reactå®ç°å¢é‡æ¸²æŸ“ã€æ—¶é—´åˆ‡ç‰‡ã€å¹¶å‘æ¨¡å¼çš„åŸºçŸ³ã€‚**

---

## é™„å½•ï¼šå­¦ä¹ æ£€æŸ¥æ¸…å•

### åŸºç¡€ç†è§£
- [ ] ç†è§£workLoopçš„whileå¾ªç¯ç»“æ„
- [ ] çŸ¥é“åŒæ­¥å’Œå¹¶å‘æ¨¡å¼çš„åŒºåˆ«
- [ ] ç†è§£performUnitOfWorkçš„ä½œç”¨
- [ ] çŸ¥é“éå†ç­–ç•¥ï¼ˆchildâ†’siblingâ†’returnï¼‰
- [ ] ç†è§£workInProgressçš„ä½œç”¨

### æ ¸å¿ƒæ¦‚å¿µ
- [ ] æŒæ¡æ—¶é—´åˆ‡ç‰‡çš„å®ç°
- [ ] ç†è§£shouldYieldçš„æ£€æŸ¥é€»è¾‘
- [ ] æŒæ¡ä¸­æ–­å’Œæ¢å¤æœºåˆ¶
- [ ] ç†è§£beginWorkå’ŒcompleteWorkçš„é…åˆ
- [ ] çŸ¥é“bailoutä¼˜åŒ–åŸç†

### è¿›é˜¶åº”ç”¨
- [ ] ç†è§£ä¸ºä»€ä¹ˆé€‰æ‹©DFSè€ŒéBFS
- [ ] ç†è§£å¯ä¸­æ–­æ¸²æŸ“çš„å®ç°åŸç†
- [ ] ç†è§£å¹¶å‘æ¨¡å¼çš„æ€§èƒ½ä¼˜åŠ¿
- [ ] çŸ¥é“Reactæºç ä¸­çš„å®ç°ç»†èŠ‚
- [ ] èƒ½è§£é‡ŠworkLoopå’ŒSchedulerçš„å…³ç³»

### å®é™…åº”ç”¨
- [ ] èƒ½è§£é‡Šä¸ºä»€ä¹ˆReactä¸å¡é¡¿
- [ ] èƒ½è¯´å‡ºæ—¶é—´åˆ‡ç‰‡çš„å¥½å¤„
- [ ] èƒ½å¯¹æ¯”é€’å½’å’Œå¾ªç¯çš„åŒºåˆ«
- [ ] èƒ½è”ç³»å®é™…çš„æ€§èƒ½ä¼˜åŒ–
- [ ] èƒ½å›ç­”é¢è¯•å¸¸è§é—®é¢˜

---

## ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®

**å·²æŒæ¡ï¼š** FiberèŠ‚ç‚¹ç»“æ„ã€åŒç¼“å†²æœºåˆ¶ã€å·¥ä½œå¾ªç¯

**æ¥ä¸‹æ¥å­¦ä¹ ï¼š**
1. **beginWorkè¯¦è§£** - æ·±å…¥ç†è§£diffç®—æ³•å’Œreconcileè¿‡ç¨‹
2. **completeWorkè¯¦è§£** - ç†è§£DOMåˆ›å»ºå’Œå‰¯ä½œç”¨æ”¶é›†
3. **commité˜¶æ®µ** - ç†è§£DOMæ“ä½œçš„æ‰§è¡Œæ—¶æœº
4. **Schedulerè°ƒåº¦å™¨** - ç†è§£ä¼˜å…ˆçº§è°ƒåº¦å’Œæ—¶é—´åˆ‡ç‰‡

---

## å‚è€ƒèµ„æº

**Reactå®˜æ–¹æ–‡æ¡£ï¼š**
- [React Fiber Architecture](https://github.com/acdlite/react-fiber-architecture)
- [Concurrent Mode](https://legacy.reactjs.org/docs/concurrent-mode-intro.html)

**æºç æ–‡ä»¶ï¼š**
- `packages/react-reconciler/src/ReactFiberWorkLoop.js`
- `packages/react-reconciler/src/ReactFiberBeginWork.js`
- `packages/react-reconciler/src/ReactFiberCompleteWork.js`
- `packages/scheduler/src/forks/Scheduler.js`

**æ¨èé˜…è¯»ï¼š**
- ã€Šæ·±å…¥ç†è§£React Fiberæ¶æ„ã€‹
- ã€ŠReactæŠ€æœ¯æ­ç§˜ - workLoopå·¥ä½œå¾ªç¯ã€‹

---

**ç‰ˆæœ¬ï¼š** v1.0
**åˆ›å»ºæ—¶é—´ï¼š** 2025-12-06
**é€‚ç”¨Reactç‰ˆæœ¬ï¼š** React 19
**ä½œè€…ï¼š** Claude Code
**é¡¹ç›®ï¼š** React19 æºç å­¦ä¹  - Fiberæ¶æ„ç³»åˆ—
