# æ—¶é—´åˆ‡ç‰‡

## ä¸€ã€ã€30å­—æ ¸å¿ƒã€‘

**æ—¶é—´åˆ‡ç‰‡æ˜¯å°†é•¿ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªå°ä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡æ‰§è¡Œ5msåæ£€æŸ¥shouldYield()ï¼Œå¦‚æœè¶…æ—¶åˆ™è®©å‡ºæ§åˆ¶æƒï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚**

---

## äºŒã€ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### æ—¶é—´åˆ‡ç‰‡çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**æ—¶é—´åˆ‡ç‰‡ = å®šæ—¶æ£€æŸ¥ + ä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒ**

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

æ—¶é—´åˆ‡ç‰‡æœ¬è´¨ä¸Šå°±æ˜¯åœ¨æ‰§è¡Œä»»åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œå®šæœŸæ£€æŸ¥æ˜¯å¦åº”è¯¥æš‚åœï¼ˆshouldYieldï¼‰ï¼Œå¦‚æœåº”è¯¥æš‚åœï¼Œå°±ä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒï¼Œè®©æµè§ˆå™¨æœ‰æœºä¼šå¤„ç†å…¶ä»–äº‹æƒ…ï¼ˆå¦‚ç”¨æˆ·è¾“å…¥ã€é¡µé¢æ¸²æŸ“ï¼‰ã€‚

```javascript
// æœ€åŸºç¡€çš„æ—¶é—´åˆ‡ç‰‡é€»è¾‘
while (hasWork()) {
  if (shouldYield()) {
    // æ—¶é—´åˆ°äº†ï¼Œæš‚åœå·¥ä½œï¼Œè®©å‡ºæ§åˆ¶æƒ
    scheduleContinueLater();
    return;
  }
  doWork();  // æ‰§è¡Œä¸€å°å—å·¥ä½œ
}
```

#### 2. ä¸ºä»€ä¹ˆéœ€è¦æ—¶é—´åˆ‡ç‰‡ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•é¿å…é•¿æ—¶é—´é˜»å¡ä¸»çº¿ç¨‹å¯¼è‡´é¡µé¢å¡é¡¿ï¼Ÿ**

JavaScript æ˜¯å•çº¿ç¨‹çš„ï¼Œä¸»çº¿ç¨‹è´Ÿè´£ï¼š
- æ‰§è¡Œ JavaScript ä»£ç 
- å¤„ç†ç”¨æˆ·äº¤äº’ï¼ˆç‚¹å‡»ã€è¾“å…¥ã€æ»šåŠ¨ï¼‰
- æ¸²æŸ“é¡µé¢ï¼ˆå¸ƒå±€ã€ç»˜åˆ¶ï¼‰

å¦‚æœä¸€ä¸ª JavaScript ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼ˆå¦‚ 100msï¼‰ï¼Œä¸»çº¿ç¨‹ä¼šè¢«å ç”¨ï¼ŒæœŸé—´ï¼š
- âŒ ç”¨æˆ·ç‚¹å‡»æŒ‰é’®ï¼Œæ²¡æœ‰ååº”
- âŒ è¾“å…¥æ¡†æ‰“å­—ï¼Œå¡é¡¿å»¶è¿Ÿ
- âŒ é¡µé¢æ»šåŠ¨ï¼Œä¸æµç•…
- âŒ åŠ¨ç”»åœæ­¢ï¼Œç”»é¢å¡ä½

```javascript
// æ²¡æœ‰æ—¶é—´åˆ‡ç‰‡ï¼šé•¿ä»»åŠ¡é˜»å¡ä¸»çº¿ç¨‹
function processLargeList(list) {
  // å¤„ç† 10000 ä¸ªå…ƒç´ ï¼Œå‡è®¾éœ€è¦ 100ms
  for (let i = 0; i < list.length; i++) {
    processItem(list[i]);  // å¤„ç†æ¯ä¸ªå…ƒç´ 
  }
  // 100ms å†…ï¼Œä¸»çº¿ç¨‹è¢«å®Œå…¨å ç”¨
  // ç”¨æˆ·ä»»ä½•æ“ä½œéƒ½å¾—ä¸åˆ°å“åº”
}

// æœ‰æ—¶é—´åˆ‡ç‰‡ï¼šæ‹†åˆ†æˆå°ä»»åŠ¡
function processLargeListWithSlicing(list) {
  let i = 0;

  function processChunk() {
    const start = performance.now();

    // æ‰§è¡Œä¸€å°å—å·¥ä½œï¼Œç›´åˆ°æ—¶é—´ç‰‡ç”¨å®Œ
    while (i < list.length && performance.now() - start < 5) {
      processItem(list[i]);
      i++;
    }

    if (i < list.length) {
      // è¿˜æœ‰å·¥ä½œï¼Œè®©å‡ºæ§åˆ¶æƒï¼Œç¨åç»§ç»­
      setTimeout(processChunk, 0);
    }
  }

  processChunk();
}
```

**é—®é¢˜æ‰€åœ¨ï¼š**
- æ²¡æœ‰æ—¶é—´åˆ‡ç‰‡ï¼š100ms çš„é•¿ä»»åŠ¡ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œç”¨æˆ·æ„Ÿè§‰å¡é¡¿
- æœ‰æ—¶é—´åˆ‡ç‰‡ï¼šæ¯ 5ms æš‚åœä¸€æ¬¡ï¼Œè®©æµè§ˆå™¨æœ‰æœºä¼šå¤„ç†å…¶ä»–äº‹æƒ…

#### 3. æ—¶é—´åˆ‡ç‰‡çš„ä¸‰å±‚ä»·å€¼

##### ä»·å€¼1ï¼šä¿æŒé¡µé¢å“åº”æ€§

é€šè¿‡å®šæœŸè®©å‡ºæ§åˆ¶æƒï¼Œæµè§ˆå™¨å¯ä»¥åŠæ—¶å“åº”ç”¨æˆ·è¾“å…¥ã€‚

```javascript
// åœºæ™¯ï¼šç”¨æˆ·åœ¨ç¼–è¾‘å™¨ä¸­æ‰“å­—ï¼ŒåŒæ—¶åå°åœ¨å¤„ç†å¤§æ•°æ®

// æ²¡æœ‰æ—¶é—´åˆ‡ç‰‡ï¼š
function processData() {
  for (let i = 0; i < 10000; i++) {
    heavyComputation();  // 100ms
  }
  // 100ms å†…ç”¨æˆ·æ‰“å­—æ²¡æœ‰ååº”
}

// æœ‰æ—¶é—´åˆ‡ç‰‡ï¼š
function processDataWithSlicing() {
  let i = 0;

  function work() {
    const start = performance.now();

    while (i < 10000 && performance.now() - start < 5) {
      heavyComputation();
      i++;
    }

    if (i < 10000) {
      // æ¯ 5ms æš‚åœï¼Œè®©ç”¨æˆ·è¾“å…¥å¾—åˆ°å¤„ç†
      scheduleCallback(work);
    }
  }

  work();
}
```

**æ•ˆæœï¼š**
- ç”¨æˆ·æ‰“å­—æ—¶ï¼Œæ¯ 5ms å°±æœ‰æœºä¼šå¤„ç†è¾“å…¥äº‹ä»¶
- å³ä½¿åå°åœ¨å¤„ç†å¤§æ•°æ®ï¼Œç”¨æˆ·ä¹Ÿä¸ä¼šæ„Ÿè§‰å¡é¡¿

##### ä»·å€¼2ï¼šé¿å…é•¿ä»»åŠ¡é˜»å¡æ¸²æŸ“

æµè§ˆå™¨çš„æ¸²æŸ“æµç¨‹ï¼ˆ60fps = 16.6ms/å¸§ï¼‰éœ€è¦ä¸»çº¿ç¨‹ç©ºé—²æ‰èƒ½æ‰§è¡Œã€‚

```javascript
// æµè§ˆå™¨æ¯ä¸€å¸§çš„å·¥ä½œï¼š
// 1. å¤„ç†è¾“å…¥äº‹ä»¶ï¼ˆç‚¹å‡»ã€æ»šåŠ¨ï¼‰
// 2. æ‰§è¡Œ JavaScriptï¼ˆrequestAnimationFrameå›è°ƒã€å¾®ä»»åŠ¡ï¼‰
// 3. å¸ƒå±€è®¡ç®—ï¼ˆLayoutï¼‰
// 4. ç»˜åˆ¶ï¼ˆPaintï¼‰
// 5. åˆæˆï¼ˆCompositeï¼‰

// å¦‚æœ JavaScript æ‰§è¡Œè¶…è¿‡ 16.6msï¼š
function longTask() {
  for (let i = 0; i < 100000; i++) {
    // è€—æ—¶ 50ms
  }
}
// ç»“æœï¼šè¿™ä¸€å¸§çš„å¸ƒå±€ã€ç»˜åˆ¶ã€åˆæˆéƒ½æ— æ³•æ‰§è¡Œ
// ç”¨æˆ·çœ‹åˆ°çš„ç”»é¢åœæ­¢æ›´æ–°ï¼Œæ‰å¸§å¡é¡¿

// æœ‰æ—¶é—´åˆ‡ç‰‡ï¼š
function slicedTask() {
  // æ¯ 5ms æš‚åœï¼Œè®©æµè§ˆå™¨æœ‰æœºä¼šæ¸²æŸ“
}
// ç»“æœï¼šæµè§ˆå™¨å¯ä»¥åœ¨æš‚åœæœŸé—´æ‰§è¡Œæ¸²æŸ“æµç¨‹
// ä¿æŒ 60fps çš„æµç•…åº¦
```

**æ—¶é—´è®¡ç®—ï¼š**
- 60fps = 16.6ms/å¸§
- å¦‚æœæ¯ 5ms æš‚åœä¸€æ¬¡ï¼Œæµè§ˆå™¨æœ‰ 11.6ms ç”¨äºæ¸²æŸ“
- ä¿è¯äº†é¡µé¢çš„æµç•…æ€§

##### ä»·å€¼3ï¼šå¯ä¸­æ–­çš„ä»»åŠ¡è°ƒåº¦

é…åˆä¼˜å…ˆçº§ç³»ç»Ÿï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡å¯ä»¥åœ¨æ—¶é—´ç‰‡ç”¨å®Œæ—¶è¢«é«˜ä¼˜å…ˆçº§ä»»åŠ¡æŠ¢å ã€‚

```javascript
// åœºæ™¯ï¼šä½ä¼˜å…ˆçº§ä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡æ¥äº†

// æ²¡æœ‰æ—¶é—´åˆ‡ç‰‡ï¼šä½ä¼˜å…ˆçº§ä»»åŠ¡å¿…é¡»æ‰§è¡Œå®Œ
function lowPriorityTask() {
  for (let i = 0; i < 10000; i++) {
    // å¿…é¡»æ‰§è¡Œå®Œï¼Œæ— æ³•ä¸­æ–­
    process(i);
  }
  // é«˜ä¼˜å…ˆçº§ä»»åŠ¡åªèƒ½ç­‰å¾…
}

// æœ‰æ—¶é—´åˆ‡ç‰‡ï¼šä½ä¼˜å…ˆçº§ä»»åŠ¡å¯ä»¥è¢«ä¸­æ–­
function lowPriorityTaskWithSlicing() {
  let i = 0;

  function work() {
    while (i < 10000) {
      if (shouldYield()) {
        // æ£€æŸ¥æ˜¯å¦æœ‰æ›´é«˜ä¼˜å…ˆçº§ä»»åŠ¡
        if (hasHigherPriorityWork()) {
          // ä¸­æ–­å½“å‰ä»»åŠ¡ï¼Œå…ˆæ‰§è¡Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡
          scheduleCallback(NormalPriority, work);
          return;
        }
      }

      process(i);
      i++;
    }
  }

  work();
}
```

**å…³é”®ç‚¹ï¼š**
- æ—¶é—´åˆ‡ç‰‡æä¾›äº†æ£€æŸ¥ç‚¹ï¼ˆshouldYieldï¼‰
- æ£€æŸ¥ç‚¹å…è®¸ä»»åŠ¡è¢«ä¸­æ–­
- ä¸­æ–­åå¯ä»¥è°ƒåº¦æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼ React å®ç°

**æ¨ç†é“¾ï¼š**
```
1. å‰æï¼šJavaScript å•çº¿ç¨‹ï¼Œé•¿ä»»åŠ¡ä¼šé˜»å¡ä¸»çº¿ç¨‹
   â†“
2. æ¨å¯¼ï¼šéœ€è¦å°†é•¿ä»»åŠ¡æ‹†åˆ†æˆå°ä»»åŠ¡
   â†“
3. æ¨å¯¼ï¼šå¦‚ä½•åˆ¤æ–­ä»€ä¹ˆæ—¶å€™æš‚åœï¼Ÿè®¾å®šä¸€ä¸ªæ—¶é—´ç‰‡é•¿åº¦
   â†“
4. æ¨å¯¼ï¼šæ—¶é—´ç‰‡å¤šé•¿åˆé€‚ï¼Ÿ16.6msï¼ˆä¸€å¸§ï¼‰ï¼Ÿå¤ªé•¿äº†
   â†“
5. æ¨å¯¼ï¼šè€ƒè™‘æµè§ˆå™¨æ¸²æŸ“å¼€é”€ï¼ˆ5-10msï¼‰ï¼Œç•™ç»™ JS çš„æ—¶é—´çº¦ 5ms
   â†“
6. æ¨å¯¼ï¼šæ¯æ‰§è¡Œ 5ms å°±æ£€æŸ¥æ˜¯å¦åº”è¯¥æš‚åœï¼ˆshouldYieldï¼‰
   â†“
7. æ¨å¯¼ï¼šå¦‚ä½•å®ç°æš‚åœåç»§ç»­ï¼Ÿå°†å‰©ä½™å·¥ä½œé‡æ–°è°ƒåº¦
   â†“
8. æ¨å¯¼ï¼šç”¨ä»€ä¹ˆæœºåˆ¶é‡æ–°è°ƒåº¦ï¼ŸsetTimeoutï¼ŸMessageChannelï¼Ÿ
   â†“
9. æ¨å¯¼ï¼šMessageChannel ä¼˜äº setTimeoutï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰
   â†“
10. æœ€ç»ˆåº”ç”¨ï¼šReact Scheduler çš„æ—¶é—´åˆ‡ç‰‡æœºåˆ¶
    - yieldInterval = 5ms
    - shouldYield() æ£€æŸ¥æ˜¯å¦è¶…æ—¶
    - MessageChannel å®ç°å¼‚æ­¥è°ƒåº¦
```

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**æ—¶é—´åˆ‡ç‰‡æ˜¯é€šè¿‡å®šæœŸæ£€æŸ¥ï¼ˆæ¯5msï¼‰ä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒçš„æœºåˆ¶ï¼Œé¿å…é•¿ä»»åŠ¡é˜»å¡ä¸»çº¿ç¨‹ï¼Œä¿è¯é¡µé¢å“åº”æ€§å’Œæ¸²æŸ“æµç•…åº¦ã€‚**

---

## ä¸‰ã€ã€3ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šyieldIntervalï¼ˆæ—¶é—´ç‰‡é•¿åº¦ï¼‰ â±ï¸

**æ—¶é—´ç‰‡é•¿åº¦æ˜¯æ¯æ¬¡æ‰§è¡Œä»»åŠ¡çš„æœ€å¤§æ—¶é—´ï¼ŒReact Scheduler é»˜è®¤ä¸º 5msã€‚**

```javascript
// React Scheduler çš„æ—¶é—´ç‰‡é•¿åº¦
let yieldInterval = 5;  // 5ms

// è·å–æ—¶é—´ç‰‡é•¿åº¦
export function getCurrentYieldInterval() {
  return yieldInterval;
}

// è®¾ç½®æ—¶é—´ç‰‡é•¿åº¦ï¼ˆç”¨äºæµ‹è¯•æˆ–ç‰¹æ®Šåœºæ™¯ï¼‰
export function setYieldInterval(newYieldInterval) {
  if (newYieldInterval > 0) {
    yieldInterval = newYieldInterval;
  }
}
```

**è¯¦ç»†è§£é‡Šï¼š**

ä¸ºä»€ä¹ˆæ˜¯ 5msï¼Ÿ

1. **æµè§ˆå™¨ä¸€å¸§çš„æ—¶é—´**ï¼š60fps = 16.6ms/å¸§
2. **æµè§ˆå™¨æ¸²æŸ“å¼€é”€**ï¼šå¸ƒå±€ã€ç»˜åˆ¶ã€åˆæˆçº¦éœ€è¦ 5-10ms
3. **ç•™ç»™ JavaScript çš„æ—¶é—´**ï¼š16.6ms - 10ms â‰ˆ 5-6ms
4. **å®‰å…¨è¾¹ç•Œ**ï¼šé€‰æ‹© 5ms ä½œä¸ºæ—¶é—´ç‰‡é•¿åº¦ï¼Œç•™æœ‰ä½™åœ°

```javascript
// ä¸€å¸§çš„æ—¶é—´åˆ†é…ï¼ˆ60fpsï¼‰
const frameTime = 16.6;  // ms

// æµè§ˆå™¨æ¸²æŸ“å¼€é”€ï¼ˆä¼°ç®—ï¼‰
const renderOverhead = 10;  // msï¼ˆå¸ƒå±€+ç»˜åˆ¶+åˆæˆï¼‰

// ç•™ç»™ JavaScript çš„æ—¶é—´
const jsTime = frameTime - renderOverhead;  // â‰ˆ 6.6ms

// React é€‰æ‹© 5ms ä½œä¸ºæ—¶é—´ç‰‡é•¿åº¦
const yieldInterval = 5;  // ms
```

**æ—¶é—´ç‰‡é•¿åº¦çš„æƒè¡¡ï¼š**

| æ—¶é—´ç‰‡é•¿åº¦ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|-----------|------|------|
| å¤ªçŸ­ï¼ˆ1msï¼‰ | å“åº”æ€§æå¥½ | è°ƒåº¦å¼€é”€å¤§ï¼Œæ•ˆç‡ä½ |
| é€‚ä¸­ï¼ˆ5msï¼‰ | å“åº”æ€§å’Œæ•ˆç‡å¹³è¡¡ | - |
| å¤ªé•¿ï¼ˆ16msï¼‰ | æ•ˆç‡é«˜ | å¯èƒ½é˜»å¡ä¸€å¸§ï¼Œå¡é¡¿ |

**åœ¨ React æºç /å¼€å‘ä¸­çš„åº”ç”¨ï¼š**

```javascript
// packages/scheduler/src/forks/Scheduler.js

// é»˜è®¤æ—¶é—´ç‰‡é•¿åº¦ 5ms
let yieldInterval = 5;

// åœ¨ workLoop ä¸­ä½¿ç”¨
function workLoop(hasTimeRemaining, initialTime) {
  let currentTime = initialTime;
  currentTask = peek(taskQueue);

  while (currentTask !== null) {
    // æ£€æŸ¥æ˜¯å¦åº”è¯¥è®©å‡ºæ§åˆ¶æƒ
    if (shouldYield()) {
      // æ—¶é—´ç‰‡ç”¨å®Œï¼Œæš‚åœå·¥ä½œ
      break;
    }

    // æ‰§è¡Œä»»åŠ¡
    performWork(currentTask);

    currentTime = getCurrentTime();
    currentTask = peek(taskQueue);
  }
}
```

---

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šshouldYield()ï¼ˆè®©å‡ºåˆ¤æ–­ï¼‰ ğŸš¦

**shouldYield() æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦è¶…è¿‡æˆªæ­¢æ—¶é—´ï¼Œå†³å®šæ˜¯å¦åº”è¯¥è®©å‡ºæ§åˆ¶æƒã€‚**

```javascript
// ç®€åŒ–ç‰ˆ shouldYield å®ç°
let deadline = 0;  // å½“å‰æ—¶é—´ç‰‡çš„æˆªæ­¢æ—¶é—´

function shouldYield() {
  const currentTime = getCurrentTime();
  return currentTime >= deadline;
}

// è®¾ç½®æˆªæ­¢æ—¶é—´
function resetDeadline() {
  deadline = getCurrentTime() + yieldInterval;
}
```

**è¯¦ç»†è§£é‡Šï¼š**

shouldYield() çš„åˆ¤æ–­é€»è¾‘ï¼š

```javascript
// å®Œæ•´çš„ shouldYield å®ç°
function shouldYieldToHost() {
  const currentTime = getCurrentTime();

  // 1. æ£€æŸ¥æ—¶é—´ç‰‡æ˜¯å¦ç”¨å®Œ
  if (currentTime >= deadline) {
    // æ—¶é—´ç‰‡ç”¨å®Œï¼Œåº”è¯¥è®©å‡º
    return true;
  }

  // 2. å¦‚æœæ”¯æŒ isInputPendingï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„ç”¨æˆ·è¾“å…¥
  if (enableIsInputPending && navigator.scheduling?.isInputPending) {
    const hasInput = navigator.scheduling.isInputPending();
    if (hasInput) {
      // æœ‰ç”¨æˆ·è¾“å…¥ï¼Œåº”è¯¥è®©å‡º
      return true;
    }
  }

  // 3. å¦åˆ™ï¼Œç»§ç»­æ‰§è¡Œ
  return false;
}
```

**åˆ¤æ–­ä¾æ®ï¼š**

1. **æ—¶é—´æ£€æŸ¥**ï¼š`currentTime >= deadline`
   - deadline = å½“å‰å¸§å¼€å§‹æ—¶é—´ + yieldInterval (5ms)
   - å¦‚æœå½“å‰æ—¶é—´è¶…è¿‡ deadlineï¼Œè¯´æ˜æ—¶é—´ç‰‡ç”¨å®Œäº†

2. **è¾“å…¥æ£€æŸ¥**ï¼ˆå¯é€‰ï¼‰ï¼š`navigator.scheduling.isInputPending()`
   - æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„ç”¨æˆ·è¾“å…¥äº‹ä»¶
   - å¦‚æœæœ‰ï¼Œå³ä½¿æ—¶é—´ç‰‡è¿˜æ²¡ç”¨å®Œï¼Œä¹Ÿåº”è¯¥è®©å‡ºæ§åˆ¶æƒ
   - è¿™æ˜¯ä¸€ä¸ªå®éªŒæ€§ APIï¼Œä¸æ˜¯æ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒ

**æ—¶é—´çº¿ç¤ºä¾‹ï¼š**

```
æ—¶é—´è½´ï¼š
0ms          5ms         10ms        15ms
|            |           |           |
å¼€å§‹æ‰§è¡Œ      deadline    ç»§ç»­æ‰§è¡Œ     deadline
             â†“                      â†“
             shouldYield() = true   shouldYield() = true

ç¤ºä¾‹ï¼š
t = 0ms:   resetDeadline() â†’ deadline = 5ms
t = 3ms:   shouldYield() â†’ 3 < 5 â†’ falseï¼ˆç»§ç»­æ‰§è¡Œï¼‰
t = 5ms:   shouldYield() â†’ 5 >= 5 â†’ trueï¼ˆè®©å‡ºæ§åˆ¶æƒï¼‰
t = 6ms:   resetDeadline() â†’ deadline = 11ms
t = 8ms:   shouldYield() â†’ 8 < 11 â†’ falseï¼ˆç»§ç»­æ‰§è¡Œï¼‰
t = 11ms:  shouldYield() â†’ 11 >= 11 â†’ trueï¼ˆè®©å‡ºæ§åˆ¶æƒï¼‰
```

**åœ¨ React æºç /å¼€å‘ä¸­çš„åº”ç”¨ï¼š**

```javascript
// React Scheduler çš„ workLoop
function workLoop(hasTimeRemaining, initialTime) {
  let currentTime = initialTime;
  currentTask = peek(taskQueue);

  while (currentTask !== null) {
    // å…³é”®åˆ¤æ–­ï¼šä»»åŠ¡æœªè¿‡æœŸ ä¸” åº”è¯¥è®©å‡ºæ§åˆ¶æƒ
    if (
      currentTask.expirationTime > currentTime &&
      (!hasTimeRemaining || shouldYieldToHost())
    ) {
      // æ—¶é—´ç‰‡ç”¨å®Œï¼Œé€€å‡ºå¾ªç¯
      break;
    }

    // æ‰§è¡Œä»»åŠ¡
    const callback = currentTask.callback;
    callback();

    // ç§»é™¤å·²å®Œæˆçš„ä»»åŠ¡
    pop(taskQueue);
    currentTask = peek(taskQueue);
    currentTime = getCurrentTime();
  }

  // è¿”å›æ˜¯å¦è¿˜æœ‰æ›´å¤šå·¥ä½œ
  return currentTask !== null;
}
```

---

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šMessageChannelï¼ˆå¼‚æ­¥è°ƒåº¦ï¼‰ ğŸ“¬

**MessageChannel æ˜¯ React Scheduler ç”¨äºå®ç°å¼‚æ­¥è°ƒåº¦çš„æœºåˆ¶ï¼Œä¼˜äº setTimeout(0)ã€‚**

```javascript
// ä½¿ç”¨ MessageChannel å®ç°å¼‚æ­¥è°ƒåº¦
const channel = new MessageChannel();
const port = channel.port2;

// è®¾ç½®æ¶ˆæ¯å¤„ç†å‡½æ•°
channel.port1.onmessage = performWorkUntilDeadline;

// è¯·æ±‚è°ƒåº¦
function requestHostCallback(callback) {
  scheduledHostCallback = callback;
  if (!isMessageLoopRunning) {
    isMessageLoopRunning = true;
    port.postMessage(null);  // å‘é€æ¶ˆæ¯ï¼Œè§¦å‘å¼‚æ­¥è°ƒåº¦
  }
}

// æ‰§è¡Œå·¥ä½œç›´åˆ°æ—¶é—´ç‰‡ç”¨å®Œ
function performWorkUntilDeadline() {
  if (scheduledHostCallback !== null) {
    const currentTime = getCurrentTime();
    deadline = currentTime + yieldInterval;  // è®¾ç½®æˆªæ­¢æ—¶é—´

    const hasTimeRemaining = true;
    let hasMoreWork = true;

    try {
      // æ‰§è¡Œè°ƒåº¦çš„å›è°ƒ
      hasMoreWork = scheduledHostCallback(hasTimeRemaining, currentTime);
    } finally {
      if (hasMoreWork) {
        // è¿˜æœ‰æ›´å¤šå·¥ä½œï¼Œç»§ç»­è°ƒåº¦
        port.postMessage(null);
      } else {
        isMessageLoopRunning = false;
        scheduledHostCallback = null;
      }
    }
  }
}
```

**è¯¦ç»†è§£é‡Šï¼š**

ä¸ºä»€ä¹ˆç”¨ MessageChannel è€Œä¸æ˜¯ setTimeoutï¼Ÿ

1. **ä¼˜å…ˆçº§æ›´é«˜**ï¼š
   - MessageChannel æ˜¯å®ä»»åŠ¡ï¼Œä½†ä¼˜å…ˆçº§é«˜äº setTimeout
   - åœ¨äº‹ä»¶å¾ªç¯ä¸­ï¼ŒMessageChannel ä¼šæ›´æ—©æ‰§è¡Œ

2. **é€’å½’è°ƒç”¨æ›´é«˜æ•ˆ**ï¼š
   - setTimeout çš„æœ€å°å»¶è¿Ÿæ˜¯ 4msï¼ˆæµè§ˆå™¨é™åˆ¶ï¼‰
   - MessageChannel æ²¡æœ‰è¿™ä¸ªé™åˆ¶ï¼Œå¯ä»¥ç«‹å³è°ƒåº¦

3. **é¿å…åµŒå¥—é™åˆ¶**ï¼š
   - setTimeout åµŒå¥—è¶…è¿‡ 5 å±‚åï¼Œæœ€å°å»¶è¿Ÿå˜ä¸º 4ms
   - MessageChannel æ²¡æœ‰è¿™ä¸ªé™åˆ¶

**å¯¹æ¯”ç¤ºä¾‹ï¼š**

```javascript
// setTimeout å®ç°å¼‚æ­¥è°ƒåº¦
function scheduleWithSetTimeout(callback) {
  setTimeout(() => {
    callback();
  }, 0);
}

// MessageChannel å®ç°å¼‚æ­¥è°ƒåº¦
const channel = new MessageChannel();
channel.port1.onmessage = () => {
  callback();
};

function scheduleWithMessageChannel(callback) {
  channel.port2.postMessage(null);
}

// æ€§èƒ½å¯¹æ¯”ï¼š
// setTimeout:     çº¦ 4ms å»¶è¿Ÿï¼ˆæµè§ˆå™¨é™åˆ¶ï¼‰
// MessageChannel: çº¦ 0-1ms å»¶è¿Ÿï¼ˆæ›´å¿«ï¼‰
```

**æ‰§è¡Œæ—¶æœºå¯¹æ¯”ï¼š**

```javascript
// äº‹ä»¶å¾ªç¯çš„ä»»åŠ¡æ‰§è¡Œé¡ºåº
console.log('1. åŒæ­¥ä»£ç ');

Promise.resolve().then(() => {
  console.log('2. å¾®ä»»åŠ¡ï¼ˆPromiseï¼‰');
});

const channel = new MessageChannel();
channel.port1.onmessage = () => {
  console.log('3. MessageChannelï¼ˆå®ä»»åŠ¡ï¼‰');
};
channel.port2.postMessage(null);

setTimeout(() => {
  console.log('4. setTimeoutï¼ˆå®ä»»åŠ¡ï¼‰');
}, 0);

// è¾“å‡ºé¡ºåºï¼š
// 1. åŒæ­¥ä»£ç 
// 2. å¾®ä»»åŠ¡ï¼ˆPromiseï¼‰
// 3. MessageChannelï¼ˆå®ä»»åŠ¡ï¼‰
// 4. setTimeoutï¼ˆå®ä»»åŠ¡ï¼‰

// MessageChannel æ¯” setTimeout å…ˆæ‰§è¡Œ
```

**åœ¨ React æºç /å¼€å‘ä¸­çš„åº”ç”¨ï¼š**

```javascript
// packages/scheduler/src/forks/Scheduler.js

// åˆ›å»º MessageChannel
const channel = new MessageChannel();
const port = channel.port2;
channel.port1.onmessage = performWorkUntilDeadline;

// è¯·æ±‚è°ƒåº¦
let scheduledHostCallback = null;
let isMessageLoopRunning = false;

function requestHostCallback(callback) {
  scheduledHostCallback = callback;

  if (!isMessageLoopRunning) {
    isMessageLoopRunning = true;
    port.postMessage(null);  // è§¦å‘å¼‚æ­¥è°ƒåº¦
  }
}

// æ‰§è¡Œå·¥ä½œç›´åˆ°æ—¶é—´ç‰‡ç”¨å®Œ
function performWorkUntilDeadline() {
  if (scheduledHostCallback !== null) {
    const currentTime = getCurrentTime();

    // è®¾ç½®å½“å‰æ—¶é—´ç‰‡çš„æˆªæ­¢æ—¶é—´
    deadline = currentTime + yieldInterval;

    const hasTimeRemaining = true;
    let hasMoreWork = true;

    try {
      // æ‰§è¡Œå·¥ä½œå¾ªç¯
      hasMoreWork = scheduledHostCallback(hasTimeRemaining, currentTime);
    } finally {
      if (hasMoreWork) {
        // è¿˜æœ‰å·¥ä½œï¼Œç»§ç»­è°ƒåº¦
        port.postMessage(null);
      } else {
        // å·¥ä½œå®Œæˆ
        isMessageLoopRunning = false;
        scheduledHostCallback = null;
      }
    }
  } else {
    isMessageLoopRunning = false;
  }
}
```

---

## å››ã€ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½ç†è§£ React Scheduler æ—¶é—´åˆ‡ç‰‡çš„æ ¸å¿ƒï¼š

### 4.1 æ—¶é—´åˆ‡ç‰‡çš„æ ¸å¿ƒé€»è¾‘

**3ä¸ªå…³é”®æ­¥éª¤ï¼š**

```javascript
// 1. è®¾ç½®æ—¶é—´ç‰‡é•¿åº¦
const yieldInterval = 5;  // 5ms

// 2. å·¥ä½œå¾ªç¯ä¸­æ£€æŸ¥æ˜¯å¦åº”è¯¥è®©å‡º
while (hasWork()) {
  if (shouldYield()) {
    // æ—¶é—´ç‰‡ç”¨å®Œï¼Œè®©å‡ºæ§åˆ¶æƒ
    scheduleContinueLater();
    break;
  }
  doWork();
}

// 3. ä½¿ç”¨ MessageChannel é‡æ–°è°ƒåº¦
const channel = new MessageChannel();
channel.port1.onmessage = continueWork;
channel.port2.postMessage(null);
```

### 4.2 shouldYield() çš„åˆ¤æ–­é€»è¾‘

**æ ¸å¿ƒå…¬å¼ï¼š**

```javascript
// æˆªæ­¢æ—¶é—´ = å¼€å§‹æ—¶é—´ + æ—¶é—´ç‰‡é•¿åº¦
deadline = startTime + yieldInterval;

// æ˜¯å¦åº”è¯¥è®©å‡º = å½“å‰æ—¶é—´ >= æˆªæ­¢æ—¶é—´
shouldYield = (currentTime >= deadline);
```

**ç¤ºä¾‹ï¼š**

```javascript
const startTime = 1000;     // å¼€å§‹æ—¶é—´ 1000ms
const yieldInterval = 5;    // æ—¶é—´ç‰‡ 5ms
const deadline = 1005;      // æˆªæ­¢æ—¶é—´ 1005ms

// t = 1003ms: 1003 < 1005 â†’ falseï¼ˆç»§ç»­æ‰§è¡Œï¼‰
// t = 1005ms: 1005 >= 1005 â†’ trueï¼ˆè®©å‡ºæ§åˆ¶æƒï¼‰
```

### 4.3 ä¸ºä»€ä¹ˆç”¨ MessageChannel

**3ä¸ªå…³é”®åŸå› ï¼š**

1. **ä¼˜å…ˆçº§é«˜äº setTimeout**ï¼šæ›´å¿«æ‰§è¡Œ
2. **æ²¡æœ‰ 4ms æœ€å°å»¶è¿Ÿ**ï¼šsetTimeout æœ‰ 4ms é™åˆ¶
3. **æ²¡æœ‰åµŒå¥—é™åˆ¶**ï¼šsetTimeout åµŒå¥—5å±‚åå»¶è¿Ÿå¢åŠ 

```javascript
// MessageChannel æ¯” setTimeout æ›´é€‚åˆæ—¶é—´åˆ‡ç‰‡
// setTimeout:     4ms+ å»¶è¿Ÿ
// MessageChannel: ~0ms å»¶è¿Ÿ
```

### 4.4 æ—¶é—´ç‰‡é•¿åº¦ä¸ºä»€ä¹ˆæ˜¯ 5ms

**è®¡ç®—é€»è¾‘ï¼š**

```
ä¸€å¸§æ—¶é—´ï¼š16.6msï¼ˆ60fpsï¼‰
æ¸²æŸ“å¼€é”€ï¼š~10msï¼ˆå¸ƒå±€+ç»˜åˆ¶+åˆæˆï¼‰
JSæ—¶é—´ï¼š 16.6 - 10 = 6.6ms
å®‰å…¨å€¼ï¼š 5msï¼ˆç•™æœ‰ä½™åœ°ï¼‰
```

### 4.5 æ—¶é—´åˆ‡ç‰‡çš„å®é™…æ•ˆæœ

**å¯¹æ¯”ï¼š**

```javascript
// æ²¡æœ‰æ—¶é—´åˆ‡ç‰‡ï¼š100ms é•¿ä»»åŠ¡é˜»å¡ä¸»çº¿ç¨‹
function processWithoutSlicing() {
  for (let i = 0; i < 10000; i++) {
    heavyWork();  // 100ms
  }
  // ç”¨æˆ·è¾“å…¥å¾—ä¸åˆ°å“åº”
}

// æœ‰æ—¶é—´åˆ‡ç‰‡ï¼šæ¯ 5ms æš‚åœï¼Œè®©ç”¨æˆ·è¾“å…¥å¾—åˆ°å¤„ç†
function processWithSlicing() {
  let i = 0;
  function work() {
    const start = performance.now();
    while (i < 10000 && performance.now() - start < 5) {
      heavyWork();
      i++;
    }
    if (i < 10000) {
      scheduleCallback(work);  // ç»§ç»­
    }
  }
  work();
}
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£æ—¶é—´åˆ‡ç‰‡å¦‚ä½•é¿å…é˜»å¡ä¸»çº¿ç¨‹
- çŸ¥é“ shouldYield() å¦‚ä½•åˆ¤æ–­æ˜¯å¦åº”è¯¥è®©å‡ºæ§åˆ¶æƒ
- æ˜ç™½ä¸ºä»€ä¹ˆ MessageChannel ä¼˜äº setTimeout
- ç†è§£æ—¶é—´ç‰‡é•¿åº¦ 5ms çš„è®¾è®¡åŸå› 
- ä¸ºåç»­å­¦ä¹ ä»»åŠ¡è°ƒåº¦ã€ä¼˜å…ˆçº§æ‰“ä¸‹åŸºç¡€

---

## äº”ã€ã€1ä¸ªç±»æ¯”ã€‘

ç”¨ç”Ÿæ´»åœºæ™¯ç±»æ¯”å¸®åŠ©ç†è§£æ—¶é—´åˆ‡ç‰‡ï¼š

### ç±»æ¯”1ï¼šåšé¥­æ—¶ç©¿æ’æ´—ç¢— = æ—¶é—´åˆ‡ç‰‡ ğŸ³

**React æ¦‚å¿µ**ï¼šæ—¶é—´åˆ‡ç‰‡å°†é•¿ä»»åŠ¡æ‹†åˆ†æˆå°ä»»åŠ¡ï¼Œå®šæœŸè®©å‡ºæ§åˆ¶æƒ

**ç”Ÿæ´»åœºæ™¯**ï¼šåšé¥­æ—¶ä¸æ˜¯ä¸€ç›´åˆ‡èœï¼Œè€Œæ˜¯åˆ‡5åˆ†é’Ÿèœåæ´—1åˆ†é’Ÿç¢—ï¼Œé¿å…æ‰‹ç´¯

**ç›¸ä¼¼æ€§è§£é‡Šï¼š**

```javascript
// æ²¡æœ‰æ—¶é—´åˆ‡ç‰‡ï¼šä¸€ç›´åˆ‡èœç›´åˆ°åˆ‡å®Œ
function cookWithoutSlicing() {
  for (let i = 0; i < 100; i++) {
    åˆ‡èœ();  // ä¸€ç›´åˆ‡ï¼Œæ‰‹å¾ˆç´¯
  }
  æ´—ç¢—();  // èœåˆ‡å®Œæ‰èƒ½æ´—ç¢—
}

// æœ‰æ—¶é—´åˆ‡ç‰‡ï¼šåˆ‡ä¸€ä¼šå„¿èœï¼Œæ´—ä¸€ä¼šå„¿ç¢—
function cookWithSlicing() {
  let i = 0;

  function work() {
    const start = Date.now();

    // åˆ‡èœ 5åˆ†é’Ÿ
    while (i < 100 && Date.now() - start < 5 * 60 * 1000) {
      åˆ‡èœ();
      i++;
    }

    // æ´—ç¢— 1åˆ†é’Ÿ
    æ´—ç¢—();

    // è¿˜æœ‰èœæ²¡åˆ‡å®Œï¼Œç»§ç»­
    if (i < 100) {
      setTimeout(work, 1 * 60 * 1000);
    }
  }

  work();
}
```

**ä¸¾ä¾‹ï¼š**

å‘¨æœ«åšé¥­ï¼Œéœ€è¦åˆ‡100æ ¹èƒ¡èåœï¼š

**æ²¡æœ‰æ—¶é—´åˆ‡ç‰‡ï¼š**
- ä¸€å£æ°”åˆ‡å®Œ100æ ¹èƒ¡èåœï¼ˆ30åˆ†é’Ÿï¼‰
- æ‰‹ä¼šå¾ˆç´¯ï¼Œå¾ˆæ— èŠ
- æ°´æ§½é‡Œçš„ç¢—ä¸€ç›´æ²¡æ´—ï¼Œå †ç§¯å¦‚å±±

**æœ‰æ—¶é—´åˆ‡ç‰‡ï¼š**
- åˆ‡ 10æ ¹èƒ¡èåœï¼ˆ3åˆ†é’Ÿï¼‰
- æ´— 1åˆ†é’Ÿç¢—
- å†åˆ‡ 10æ ¹èƒ¡èåœï¼ˆ3åˆ†é’Ÿï¼‰
- å†æ´— 1åˆ†é’Ÿç¢—
- ...å¾ªç¯å¾€å¤

**å¥½å¤„ï¼š**
- æ‰‹ä¸ä¼šå¤ªç´¯ï¼ˆå®šæœŸä¼‘æ¯ï¼‰
- ç¢—ä¸ä¼šå †ç§¯å¤ªå¤šï¼ˆå®šæœŸå¤„ç†ï¼‰
- å¯ä»¥éšæ—¶å“åº”å®¶äººçš„å‘¼å”¤ï¼ˆå®šæœŸæ£€æŸ¥ï¼‰

åœ¨ React ä¸­ä¹Ÿä¸€æ ·ï¼š

```javascript
// å¤„ç†å¤§åˆ—è¡¨æ¸²æŸ“
function renderLargeList(items) {
  let i = 0;

  function renderChunk() {
    const start = performance.now();

    // æ¸²æŸ“ä¸€å°å—ï¼ˆ5msï¼‰
    while (i < items.length && performance.now() - start < 5) {
      renderItem(items[i]);
      i++;
    }

    if (i < items.length) {
      // è¿˜æœ‰å…ƒç´ ï¼Œè®©å‡ºæ§åˆ¶æƒï¼Œç¨åç»§ç»­
      scheduleCallback(renderChunk);
    }
  }

  renderChunk();
}
```

---

### ç±»æ¯”2ï¼šç•ªèŒ„å·¥ä½œæ³• = æ—¶é—´åˆ‡ç‰‡ ğŸ…

**React æ¦‚å¿µ**ï¼šæ¯æ‰§è¡Œ 5ms æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦åº”è¯¥æš‚åœ

**ç”Ÿæ´»åœºæ™¯**ï¼šç•ªèŒ„å·¥ä½œæ³•ï¼Œæ¯å·¥ä½œ 25åˆ†é’Ÿä¼‘æ¯ 5åˆ†é’Ÿ

**ç›¸ä¼¼æ€§è§£é‡Šï¼š**

```javascript
// ç•ªèŒ„å·¥ä½œæ³•
function pomodoroWorkSession() {
  let workTime = 0;
  const workInterval = 25 * 60 * 1000;  // 25åˆ†é’Ÿ
  const breakInterval = 5 * 60 * 1000;  // 5åˆ†é’Ÿ

  function work() {
    const start = Date.now();

    // å·¥ä½œ 25åˆ†é’Ÿ
    while (Date.now() - start < workInterval) {
      doWork();

      // æ¯å·¥ä½œä¸€ä¼šå„¿æ£€æŸ¥æ˜¯å¦è¯¥ä¼‘æ¯äº†
      if (shouldTakeBreak()) {
        break;
      }
    }

    // ä¼‘æ¯ 5åˆ†é’Ÿ
    takeBreak();

    // ç»§ç»­ä¸‹ä¸€ä¸ªç•ªèŒ„é’Ÿ
    setTimeout(work, breakInterval);
  }

  work();
}

// React æ—¶é—´åˆ‡ç‰‡
function reactWorkLoop() {
  let currentTask = getNextTask();

  function work() {
    const start = performance.now();
    const deadline = start + 5;  // 5ms

    // å·¥ä½œç›´åˆ°æ—¶é—´ç‰‡ç”¨å®Œ
    while (currentTask && performance.now() < deadline) {
      performWork(currentTask);
      currentTask = getNextTask();
    }

    if (currentTask) {
      // è¿˜æœ‰ä»»åŠ¡ï¼Œè®©å‡ºæ§åˆ¶æƒï¼Œç¨åç»§ç»­
      scheduleCallback(work);
    }
  }

  work();
}
```

**ä¸¾ä¾‹ï¼š**

å­¦ä¹  React æºç ï¼š

**æ²¡æœ‰æ—¶é—´åˆ‡ç‰‡ï¼ˆä¸ç”¨ç•ªèŒ„é’Ÿï¼‰ï¼š**
- è¿ç»­å­¦ä¹  3å°æ—¶ï¼Œä¸­é—´ä¸ä¼‘æ¯
- å¤§è„‘ç–²åŠ³ï¼Œæ•ˆç‡ä¸‹é™
- å¯èƒ½é”™è¿‡é‡è¦æ¶ˆæ¯ï¼ˆæ‰‹æœºé™éŸ³äº†ï¼‰

**æœ‰æ—¶é—´åˆ‡ç‰‡ï¼ˆä½¿ç”¨ç•ªèŒ„é’Ÿï¼‰ï¼š**
- å­¦ä¹  25åˆ†é’Ÿ
- ä¼‘æ¯ 5åˆ†é’Ÿï¼ˆçœ‹æ‰‹æœºã€å–æ°´ï¼‰
- å†å­¦ä¹  25åˆ†é’Ÿ
- å†ä¼‘æ¯ 5åˆ†é’Ÿ
- ...

**å¥½å¤„ï¼š**
- å¤§è„‘ä¸ä¼šè¿‡åº¦ç–²åŠ³
- å¯ä»¥åŠæ—¶å¤„ç†æ¶ˆæ¯
- ä¿æŒä¸“æ³¨å’Œæ•ˆç‡

---

### ç±»æ¯”3ï¼šè½®æµä½¿ç”¨æ¸¸æˆæœº = shouldYield() æ£€æŸ¥ ğŸ®

**React æ¦‚å¿µ**ï¼šshouldYield() æ£€æŸ¥æ˜¯å¦åº”è¯¥è®©å‡ºæ§åˆ¶æƒ

**ç”Ÿæ´»åœºæ™¯**ï¼šå…„å¼Ÿå§å¦¹è½®æµç©æ¸¸æˆæœºï¼Œæ¯äººç© 5åˆ†é’Ÿ

**ç›¸ä¼¼æ€§è§£é‡Šï¼š**

```javascript
// æ¸¸æˆæœºè½®æµä½¿ç”¨
function playGame(player) {
  const startTime = Date.now();
  const playDuration = 5 * 60 * 1000;  // 5åˆ†é’Ÿ

  function play() {
    // æ£€æŸ¥æ˜¯å¦è¯¥æ¢äººäº†
    if (Date.now() - startTime >= playDuration) {
      console.log(`${player}ï¼Œæ—¶é—´åˆ°äº†ï¼Œè¯¥æ¢äººäº†ï¼`);
      nextPlayer();
      return;
    }

    // ç»§ç»­ç©
    playOneRound();
    requestAnimationFrame(play);
  }

  play();
}

// React shouldYield
function workLoop() {
  const startTime = performance.now();
  const deadline = startTime + 5;  // 5ms

  while (hasWork()) {
    // æ£€æŸ¥æ˜¯å¦è¯¥è®©å‡ºæ§åˆ¶æƒäº†
    if (performance.now() >= deadline) {
      console.log('æ—¶é—´ç‰‡ç”¨å®Œï¼Œè®©å‡ºæ§åˆ¶æƒ');
      scheduleCallback(workLoop);
      return;
    }

    // ç»§ç»­å·¥ä½œ
    doWork();
  }
}
```

**ä¸¾ä¾‹ï¼š**

3ä¸ªå°å­©è½®æµç©æ¸¸æˆæœºï¼š

**æ²¡æœ‰ shouldYieldï¼ˆæ²¡æœ‰è®¡æ—¶å™¨ï¼‰ï¼š**
- å°æ˜ä¸€ç›´ç©ï¼Œä¸ç»™åˆ«äººç©
- å°çº¢å’Œå°åˆšä¸€ç›´ç­‰ï¼Œå¾ˆä¸å…¬å¹³
- å¯èƒ½å¼•å‘äº‰åµ

**æœ‰ shouldYieldï¼ˆæœ‰è®¡æ—¶å™¨ï¼‰ï¼š**
- å°æ˜ç© 5åˆ†é’Ÿï¼Œè®¡æ—¶å™¨å“äº†
- å°æ˜ä¸»åŠ¨è®©ä½ï¼Œå°çº¢ä¸Šåœº
- å°çº¢ç© 5åˆ†é’Ÿï¼Œè®¡æ—¶å™¨å“äº†
- å°çº¢è®©ä½ï¼Œå°åˆšä¸Šåœº
- ...

**å¥½å¤„ï¼š**
- å…¬å¹³å…¬æ­£ï¼Œæ¯ä¸ªäººéƒ½æœ‰æœºä¼š
- é¿å…äº‰åµ
- åŸ¹å…»åˆ†äº«æ„è¯†

åœ¨ React ä¸­ï¼š

```javascript
// é«˜ä¼˜å…ˆçº§ä»»åŠ¡å’Œä½ä¼˜å…ˆçº§ä»»åŠ¡è½®æµæ‰§è¡Œ
function scheduler() {
  let currentTask = getNextTask();

  function work() {
    const deadline = performance.now() + 5;

    while (currentTask && performance.now() < deadline) {
      // æ‰§è¡Œå½“å‰ä»»åŠ¡
      performWork(currentTask);
      currentTask = getNextTask();
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰æ›´é«˜ä¼˜å…ˆçº§ä»»åŠ¡
    if (hasHigherPriorityWork()) {
      // è®©ä½ç»™é«˜ä¼˜å…ˆçº§ä»»åŠ¡
      scheduleHighPriorityWork();
    } else if (currentTask) {
      // ç»§ç»­æ‰§è¡Œå½“å‰ä»»åŠ¡
      scheduleCallback(work);
    }
  }

  work();
}
```

---

### ç±»æ¯”4ï¼šæ•™å®¤è½®æµå‘è¨€ = ä»»åŠ¡è°ƒåº¦ ğŸ¤

**React æ¦‚å¿µ**ï¼šæ—¶é—´åˆ‡ç‰‡é…åˆä¼˜å…ˆçº§è°ƒåº¦

**ç”Ÿæ´»åœºæ™¯**ï¼šæ•™å®¤é‡Œå¤šä¸ªå­¦ç”Ÿä¸¾æ‰‹å‘è¨€ï¼Œè€å¸ˆæŒ‰ä¼˜å…ˆçº§å’Œæ—¶é—´åˆ†é…

**ç›¸ä¼¼æ€§è§£é‡Šï¼š**

```javascript
// æ•™å®¤å‘è¨€ç³»ç»Ÿ
const students = [
  { name: 'å°æ˜', priority: 'urgent', question: 'æˆ‘è¦ä¸Šå•æ‰€' },
  { name: 'å°çº¢', priority: 'normal', question: 'è¿™é“é¢˜æ€ä¹ˆåšï¼Ÿ' },
  { name: 'å°åˆš', priority: 'low', question: 'è¯¾åèƒ½å€Ÿç¬”è®°å—ï¼Ÿ' }
];

function teacherManagesSpeaking() {
  students.sort((a, b) => {
    // æŒ‰ä¼˜å…ˆçº§æ’åº
    return priorityMap[a.priority] - priorityMap[b.priority];
  });

  students.forEach(student => {
    const startTime = Date.now();
    const maxTime = 3 * 60 * 1000;  // æ¯äººæœ€å¤šè®² 3åˆ†é’Ÿ

    function speak() {
      if (Date.now() - startTime >= maxTime) {
        console.log(`${student.name}ï¼Œæ—¶é—´åˆ°äº†ï¼Œè®©å…¶ä»–åŒå­¦è¯´`);
        return;
      }

      // ç»§ç»­å‘è¨€
      console.log(`${student.name}: ${student.question}`);
    }

    speak();
  });
}
```

**ä¸¾ä¾‹ï¼š**

è¯¾å ‚ä¸Šï¼Œ3ä¸ªå­¦ç”Ÿä¸¾æ‰‹ï¼š

**è€å¸ˆçš„å¤„ç†ï¼ˆç±»ä¼¼ React Schedulerï¼‰ï¼š**

1. **å°æ˜ï¼ˆç´§æ€¥ï¼‰**ï¼šæˆ‘è¦ä¸Šå•æ‰€
   - ä¼˜å…ˆçº§æœ€é«˜ï¼Œç«‹å³å“åº”
   - å…è®¸è®²å®Œï¼ˆä¸é™æ—¶ï¼‰

2. **å°çº¢ï¼ˆæ­£å¸¸ï¼‰**ï¼šè¿™é“é¢˜æ€ä¹ˆåšï¼Ÿ
   - æ­£å¸¸ä¼˜å…ˆçº§ï¼Œå…è®¸è®² 3åˆ†é’Ÿ
   - å¦‚æœè¶…è¿‡ 3åˆ†é’Ÿï¼Œæš‚åœï¼Œè®©å°åˆšä¹Ÿè¯´è¯´

3. **å°åˆšï¼ˆä½ï¼‰**ï¼šè¯¾åèƒ½å€Ÿç¬”è®°å—ï¼Ÿ
   - ä½ä¼˜å…ˆçº§ï¼Œå¯ä»¥è¯¾åå†è¯´
   - ä½†å¦‚æœä¸€ç›´ç­‰ï¼Œä¹Ÿä¼šè¢«æå‡ä¼˜å…ˆçº§

**åœ¨ React ä¸­ï¼š**

```javascript
const tasks = [
  { name: 'ç”¨æˆ·ç‚¹å‡»', priority: UserBlockingPriority },  // ç´§æ€¥
  { name: 'æ•°æ®åŠ è½½', priority: NormalPriority },        // æ­£å¸¸
  { name: 'æ•°æ®ç»Ÿè®¡', priority: LowPriority }            // ä½
];

function scheduler() {
  // æŒ‰ä¼˜å…ˆçº§æ’åº
  tasks.sort((a, b) => a.priority - b.priority);

  function work() {
    const task = tasks[0];
    const deadline = performance.now() + 5;

    while (performance.now() < deadline) {
      performWork(task);

      if (task.completed) {
        tasks.shift();  // ç§»é™¤å·²å®Œæˆä»»åŠ¡
        break;
      }
    }

    if (tasks.length > 0) {
      scheduleCallback(work);  // ç»§ç»­å¤„ç†å‰©ä½™ä»»åŠ¡
    }
  }

  work();
}
```

---

### ç±»æ¯”æ€»ç»“è¡¨

| React æ¦‚å¿µ | ç”Ÿæ´»åœºæ™¯ç±»æ¯” | æ ¸å¿ƒç›¸ä¼¼ç‚¹ |
|-----------|------------|-----------|
| æ—¶é—´åˆ‡ç‰‡ï¼ˆ5msï¼‰ | åšé¥­åˆ‡èœ 5åˆ†é’Ÿï¼Œæ´—ç¢— 1åˆ†é’Ÿ | å®šæœŸæš‚åœï¼Œé¿å…ç–²åŠ³/é˜»å¡ |
| shouldYield() | ç•ªèŒ„é’Ÿæ£€æŸ¥æ˜¯å¦è¯¥ä¼‘æ¯äº† | å®šæœŸæ£€æŸ¥æ˜¯å¦åº”è¯¥è®©å‡ºæ§åˆ¶æƒ |
| MessageChannel è°ƒåº¦ | æ¸¸æˆæœºè®¡æ—¶å™¨å“äº†ï¼Œæ¢ä¸‹ä¸€ä¸ªäºº | å¼‚æ­¥è°ƒåº¦ä¸‹ä¸€ä¸ªä»»åŠ¡ |
| æ—¶é—´ç‰‡ç”¨å®Œæš‚åœ | å‘è¨€æ—¶é—´åˆ°äº†ï¼Œè®©å…¶ä»–äººè¯´ | å…¬å¹³åˆ†é…èµ„æºï¼Œé¿å…å„æ–­ |
| å¯ä¸­æ–­ä»»åŠ¡ | ç´§æ€¥ç”µè¯æ¥äº†ï¼Œæš‚åœå·¥ä½œ | é«˜ä¼˜å…ˆçº§ä»»åŠ¡å¯ä»¥æ’é˜Ÿ |

---

## å…­ã€ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼šæ—¶é—´åˆ‡ç‰‡ä¼šè®©ä»»åŠ¡æ‰§è¡Œå¾—æ›´æ…¢ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

æ—¶é—´åˆ‡ç‰‡ç¡®å®å¢åŠ äº†è°ƒåº¦å¼€é”€ï¼Œä½†å®ƒçš„ä»·å€¼ä¸åœ¨äºè®©å•ä¸ªä»»åŠ¡æ›´å¿«ï¼Œè€Œåœ¨äºï¼š
- ä¿æŒé¡µé¢å“åº”æ€§ï¼ˆç”¨æˆ·ä¸ä¼šæ„Ÿè§‰å¡é¡¿ï¼‰
- é¿å…é•¿ä»»åŠ¡é˜»å¡æ¸²æŸ“ï¼ˆä¿æŒ 60fpsï¼‰
- å…è®¸é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ’é˜Ÿï¼ˆç”¨æˆ·äº¤äº’ä¼˜å…ˆï¼‰

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

ç›´è§‰ä¸Šï¼Œæˆ‘ä»¬è®¤ä¸º"ä¸åœé¡¿åœ°æ‰§è¡Œ"ä¼šæ›´å¿«ã€‚è¿™åœ¨å•ä»»åŠ¡åœºæ™¯ä¸‹ç¡®å®æˆç«‹ï¼Œä½†åœ¨å¤šä»»åŠ¡ã€éœ€è¦å“åº”ç”¨æˆ·äº¤äº’çš„åœºæ™¯ä¸‹ï¼Œç”¨æˆ·ä½“éªŒï¼ˆæ„ŸçŸ¥é€Ÿåº¦ï¼‰æ¯”çº¯ç²¹çš„æ‰§è¡Œé€Ÿåº¦æ›´é‡è¦ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```javascript
// å¯¹æ¯”å®éªŒï¼šå¤„ç† 10000 ä¸ªå…ƒç´ 

// ===== æ²¡æœ‰æ—¶é—´åˆ‡ç‰‡ =====
function processWithoutSlicing(items) {
  const start = performance.now();

  for (let i = 0; i < items.length; i++) {
    processItem(items[i]);
  }

  const end = performance.now();
  console.log(`æ‰§è¡Œæ—¶é—´: ${end - start}ms`);  // å‡è®¾ 100ms
}

// ===== æœ‰æ—¶é—´åˆ‡ç‰‡ =====
function processWithSlicing(items) {
  const start = performance.now();
  let i = 0;

  function work() {
    const chunkStart = performance.now();

    while (i < items.length && performance.now() - chunkStart < 5) {
      processItem(items[i]);
      i++;
    }

    if (i < items.length) {
      scheduleCallback(work);  // ç»§ç»­
    } else {
      const end = performance.now();
      console.log(`æ‰§è¡Œæ—¶é—´: ${end - start}ms`);  // å‡è®¾ 105msï¼ˆå¤šäº†5msè°ƒåº¦å¼€é”€ï¼‰
    }
  }

  work();
}

// å¯¹æ¯”ï¼š
// æ²¡æœ‰æ—¶é—´åˆ‡ç‰‡: 100msï¼ˆæ›´å¿«ï¼‰
// æœ‰æ—¶é—´åˆ‡ç‰‡:   105msï¼ˆç¨æ…¢ï¼Œä½†...ï¼‰
```

**ä½†æ˜¯ï¼ç”¨æˆ·æ„ŸçŸ¥çš„å·®å¼‚ï¼š**

```
æ²¡æœ‰æ—¶é—´åˆ‡ç‰‡ï¼š
0ms -------- 100ms --------->
[    æ‰§è¡Œä»»åŠ¡    ]
            â†“
            ç”¨æˆ·ç‚¹å‡»æŒ‰é’®ï¼Œ100ms åæ‰å“åº”
            ç”¨æˆ·æ„Ÿè§‰ï¼šå¡é¡¿ï¼

æœ‰æ—¶é—´åˆ‡ç‰‡ï¼š
0ms - 5ms - 10ms - 15ms - ... - 105ms
[æ‰§è¡Œ][è®©å‡º][æ‰§è¡Œ][è®©å‡º] ... [å®Œæˆ]
    â†“     â†“     â†“
    å¯ä»¥å“åº”ç”¨æˆ·è¾“å…¥
    ç”¨æˆ·æ„Ÿè§‰ï¼šæµç•…ï¼
```

**å®é™…æµ‹è¯•ï¼š**

```javascript
// åœºæ™¯ï¼šç”¨æˆ·åœ¨è¾“å…¥æ¡†æ‰“å­—ï¼ŒåŒæ—¶åå°å¤„ç†å¤§æ•°æ®

// æ²¡æœ‰æ—¶é—´åˆ‡ç‰‡
function handleInputWithoutSlicing(e) {
  updateInput(e.target.value);  // æ›´æ–°è¾“å…¥æ¡†

  // ç«‹å³å¤„ç†å¤§æ•°æ®ï¼ˆ100msï¼‰
  processLargeData();

  // ç»“æœï¼šç”¨æˆ·æ‰“å­—å 100ms æ‰èƒ½çœ‹åˆ°è¾“å…¥
  // ç”¨æˆ·æ„Ÿè§‰ï¼šå¡é¡¿ã€å»¶è¿Ÿ
}

// æœ‰æ—¶é—´åˆ‡ç‰‡
function handleInputWithSlicing(e) {
  updateInput(e.target.value);  // ç«‹å³æ›´æ–°è¾“å…¥æ¡†

  // ç”¨æ—¶é—´åˆ‡ç‰‡å¤„ç†å¤§æ•°æ®ï¼ˆ105msï¼Œä½†ä¸é˜»å¡è¾“å…¥ï¼‰
  processLargeDataWithSlicing();

  // ç»“æœï¼šç”¨æˆ·æ‰“å­—ç«‹å³çœ‹åˆ°è¾“å…¥ï¼Œå¤§æ•°æ®åœ¨åå°å¤„ç†
  // ç”¨æˆ·æ„Ÿè§‰ï¼šæµç•…ã€å“åº”å¿«
}
```

**ç»“è®ºï¼š**

æ—¶é—´åˆ‡ç‰‡çš„ç›®æ ‡ä¸æ˜¯è®©å•ä¸ªä»»åŠ¡æ›´å¿«ï¼Œè€Œæ˜¯ï¼š
- âœ… è®©ç”¨æˆ·æ„Ÿè§‰æ›´å¿«ï¼ˆå“åº”æ€§ï¼‰
- âœ… è®©é¡µé¢ä¿æŒæµç•…ï¼ˆ60fpsï¼‰
- âœ… è®©é«˜ä¼˜å…ˆçº§ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œï¼ˆç”¨æˆ·ä½“éªŒï¼‰

---

### è¯¯åŒº2ï¼šæ—¶é—´ç‰‡è¶ŠçŸ­è¶Šå¥½ âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

æ—¶é—´ç‰‡å¤ªçŸ­ä¼šå¯¼è‡´è°ƒåº¦å¼€é”€è¿‡å¤§ï¼Œåè€Œé™ä½æ•ˆç‡ã€‚React é€‰æ‹© 5ms æ˜¯ç»è¿‡æƒè¡¡çš„ç»“æœï¼š
- å¤ªçŸ­ï¼ˆ1msï¼‰ï¼šè°ƒåº¦å¼€é”€å¤§ï¼Œæ•ˆç‡ä½
- å¤ªé•¿ï¼ˆ16msï¼‰ï¼šå¯èƒ½é˜»å¡ä¸€å¸§ï¼Œå¯¼è‡´å¡é¡¿
- é€‚ä¸­ï¼ˆ5msï¼‰ï¼šå¹³è¡¡å“åº”æ€§å’Œæ•ˆç‡

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

ç›´è§‰ä¸Šï¼Œæ—¶é—´ç‰‡è¶ŠçŸ­ï¼Œæ£€æŸ¥è¶Šé¢‘ç¹ï¼Œå“åº”æ€§åº”è¯¥è¶Šå¥½ã€‚ä½†è¿™å¿½ç•¥äº†è°ƒåº¦æœ¬èº«ä¹Ÿæœ‰å¼€é”€ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```javascript
// è°ƒåº¦å¼€é”€åˆ†æ

// å‡è®¾æ¯æ¬¡è°ƒåº¦å¼€é”€ 0.5ms
const scheduleOverhead = 0.5;

// æ—¶é—´ç‰‡ 1ms
const yieldInterval1ms = 1;
const scheduleTimes1ms = 100 / 1;  // 100ms ä»»åŠ¡ï¼Œè°ƒåº¦ 100 æ¬¡
const overhead1ms = scheduleTimes1ms * scheduleOverhead;  // 50ms å¼€é”€
// æ€»æ—¶é—´ = 100 + 50 = 150ms

// æ—¶é—´ç‰‡ 5ms
const yieldInterval5ms = 5;
const scheduleTimes5ms = 100 / 5;  // 100ms ä»»åŠ¡ï¼Œè°ƒåº¦ 20 æ¬¡
const overhead5ms = scheduleTimes5ms * scheduleOverhead;  // 10ms å¼€é”€
// æ€»æ—¶é—´ = 100 + 10 = 110ms

// æ—¶é—´ç‰‡ 16ms
const yieldInterval16ms = 16;
const scheduleTimes16ms = 100 / 16;  // 100ms ä»»åŠ¡ï¼Œè°ƒåº¦ 7 æ¬¡
const overhead16ms = scheduleTimes16ms * scheduleOverhead;  // 3.5ms å¼€é”€
// æ€»æ—¶é—´ = 100 + 3.5 = 103.5ms

// å¯¹æ¯”ï¼š
// 1ms:  150msï¼ˆå¼€é”€å¤ªå¤§ï¼‰
// 5ms:  110msï¼ˆå¹³è¡¡ï¼‰
// 16ms: 103.5msï¼ˆæ›´å¿«ï¼Œä½†å¯èƒ½é˜»å¡ä¸€å¸§ï¼‰
```

**å¸§ç‡å½±å“ï¼š**

```javascript
// æµè§ˆå™¨ä¸€å¸§çš„æ—¶é—´åˆ†é…ï¼ˆ60fps = 16.6msï¼‰

// æ—¶é—´ç‰‡ 1ms
// æ¯å¸§å¯ä»¥è°ƒåº¦ 16 æ¬¡ï¼Œè°ƒåº¦å¼€é”€ 8ms
// ç•™ç»™æ¸²æŸ“çš„æ—¶é—´ï¼š16.6 - 8 = 8.6msï¼ˆå¤Ÿç”¨ï¼‰

// æ—¶é—´ç‰‡ 5ms
// æ¯å¸§å¯ä»¥è°ƒåº¦ 3 æ¬¡ï¼Œè°ƒåº¦å¼€é”€ 1.5ms
// ç•™ç»™æ¸²æŸ“çš„æ—¶é—´ï¼š16.6 - 1.5 = 15.1msï¼ˆå……è¶³ï¼‰

// æ—¶é—´ç‰‡ 16ms
// æ¯å¸§åªèƒ½è°ƒåº¦ 1 æ¬¡ï¼Œè°ƒåº¦å¼€é”€ 0.5ms
// ä½† JS æ‰§è¡Œ 16msï¼Œç•™ç»™æ¸²æŸ“çš„æ—¶é—´ï¼š16.6 - 16 = 0.6msï¼ˆä¸å¤Ÿï¼ï¼‰
// å¯èƒ½å¯¼è‡´æ‰å¸§
```

**å®é™…æµ‹è¯•ï¼š**

```javascript
functionæµ‹è¯•ä¸åŒæ—¶é—´ç‰‡é•¿åº¦() {
  const task = () => {
    // æ¨¡æ‹Ÿä»»åŠ¡ï¼š100ms
    for (let i = 0; i < 1000000; i++) {
      Math.random();
    }
  };

  // æ—¶é—´ç‰‡ 1ms
  const result1ms = æµ‹é‡æ‰§è¡Œæ—¶é—´(() => {
    executeWithTimeSlicing(task, 1);
  });
  console.log(`1ms: ${result1ms}ms`);  // çº¦ 150ms

  // æ—¶é—´ç‰‡ 5ms
  const result5ms = æµ‹é‡æ‰§è¡Œæ—¶é—´(() => {
    executeWithTimeSlicing(task, 5);
  });
  console.log(`5ms: ${result5ms}ms`);  // çº¦ 110ms

  // æ—¶é—´ç‰‡ 16ms
  const result16ms = æµ‹é‡æ‰§è¡Œæ—¶é—´(() => {
    executeWithTimeSlicing(task, 16);
  });
  console.log(`16ms: ${result16ms}ms`);  // çº¦ 103msï¼ˆä½†å¯èƒ½æ‰å¸§ï¼‰
}
```

**ç»“è®ºï¼š**

5ms æ˜¯ç»è¿‡æƒè¡¡çš„æœ€ä½³æ—¶é—´ç‰‡é•¿åº¦ï¼š
- âœ… è°ƒåº¦å¼€é”€é€‚ä¸­ï¼ˆçº¦ 10%ï¼‰
- âœ… ä¸ä¼šé˜»å¡ä¸€å¸§ï¼ˆç•™ç»™æ¸²æŸ“ 11.6msï¼‰
- âœ… å“åº”æ€§è¶³å¤Ÿå¥½ï¼ˆæ¯ 5ms å¯ä»¥å“åº”ç”¨æˆ·è¾“å…¥ï¼‰

---

### è¯¯åŒº3ï¼šsetTimeout(0) å’Œ MessageChannel æ²¡æœ‰åŒºåˆ« âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

setTimeout å’Œ MessageChannel éƒ½æ˜¯å®ä»»åŠ¡ï¼Œä½†åœ¨äº‹ä»¶å¾ªç¯ä¸­çš„ä¼˜å…ˆçº§å’Œè¡Œä¸ºä¸åŒï¼š
- MessageChannel ä¼˜å…ˆçº§æ›´é«˜ï¼Œæ›´æ—©æ‰§è¡Œ
- setTimeout æœ‰ 4ms æœ€å°å»¶è¿Ÿï¼ˆæµè§ˆå™¨é™åˆ¶ï¼‰
- setTimeout åµŒå¥— 5 å±‚åå»¶è¿Ÿå¢åŠ åˆ° 4ms

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

æˆ‘ä»¬å¸¸ç”¨ `setTimeout(fn, 0)` æ¥å®ç°å¼‚æ­¥æ‰§è¡Œï¼Œç›´è§‰ä¸Šè®¤ä¸º MessageChannel åªæ˜¯æ¢äº†ä¸ª APIï¼Œæ•ˆæœä¸€æ ·ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```javascript
// å®éªŒï¼šå¯¹æ¯” setTimeout å’Œ MessageChannel çš„æ‰§è¡Œæ—¶æœº

console.log('1. åŒæ­¥ä»£ç å¼€å§‹');

// å¾®ä»»åŠ¡ï¼ˆPromiseï¼‰
Promise.resolve().then(() => {
  console.log('2. å¾®ä»»åŠ¡ï¼ˆPromiseï¼‰');
});

// MessageChannelï¼ˆå®ä»»åŠ¡ï¼‰
const channel = new MessageChannel();
channel.port1.onmessage = () => {
  console.log('3. MessageChannelï¼ˆå®ä»»åŠ¡ï¼‰');
};
channel.port2.postMessage(null);

// setTimeoutï¼ˆå®ä»»åŠ¡ï¼‰
setTimeout(() => {
  console.log('4. setTimeoutï¼ˆå®ä»»åŠ¡ï¼‰');
}, 0);

console.log('5. åŒæ­¥ä»£ç ç»“æŸ');

// è¾“å‡ºé¡ºåºï¼š
// 1. åŒæ­¥ä»£ç å¼€å§‹
// 5. åŒæ­¥ä»£ç ç»“æŸ
// 2. å¾®ä»»åŠ¡ï¼ˆPromiseï¼‰
// 3. MessageChannelï¼ˆå®ä»»åŠ¡ï¼‰
// 4. setTimeoutï¼ˆå®ä»»åŠ¡ï¼‰

// MessageChannel æ¯” setTimeout å…ˆæ‰§è¡Œï¼
```

**setTimeout çš„é™åˆ¶ï¼š**

```javascript
// é™åˆ¶1ï¼šæœ€å°å»¶è¿Ÿ 4ms
const start = performance.now();
setTimeout(() => {
  const delay = performance.now() - start;
  console.log(`setTimeoutå»¶è¿Ÿ: ${delay}ms`);  // çº¦ 4msï¼Œä¸æ˜¯ 0ms
}, 0);

// é™åˆ¶2ï¼šåµŒå¥—è¶…è¿‡ 5 å±‚åï¼Œå»¶è¿Ÿå¢åŠ åˆ° 4ms
function testNestedSetTimeout(level) {
  if (level === 0) {
    console.log(`ç¬¬ ${level} å±‚`);
    return;
  }

  const start = performance.now();
  setTimeout(() => {
    const delay = performance.now() - start;
    console.log(`ç¬¬ ${level} å±‚ï¼Œå»¶è¿Ÿ: ${delay}ms`);
    testNestedSetTimeout(level - 1);
  }, 0);
}

testNestedSetTimeout(10);

// è¾“å‡ºï¼š
// ç¬¬ 10 å±‚ï¼Œå»¶è¿Ÿ: ~1ms
// ç¬¬ 9 å±‚ï¼Œå»¶è¿Ÿ: ~1ms
// ç¬¬ 8 å±‚ï¼Œå»¶è¿Ÿ: ~1ms
// ç¬¬ 7 å±‚ï¼Œå»¶è¿Ÿ: ~1ms
// ç¬¬ 6 å±‚ï¼Œå»¶è¿Ÿ: ~1ms
// ç¬¬ 5 å±‚ï¼Œå»¶è¿Ÿ: ~4msï¼ˆå¼€å§‹å¢åŠ å»¶è¿Ÿï¼‰
// ç¬¬ 4 å±‚ï¼Œå»¶è¿Ÿ: ~4ms
// ç¬¬ 3 å±‚ï¼Œå»¶è¿Ÿ: ~4ms
// ç¬¬ 2 å±‚ï¼Œå»¶è¿Ÿ: ~4ms
// ç¬¬ 1 å±‚ï¼Œå»¶è¿Ÿ: ~4ms
```

**MessageChannel çš„ä¼˜åŠ¿ï¼š**

```javascript
// MessageChannel æ²¡æœ‰ 4ms é™åˆ¶
const channel = new MessageChannel();

const start = performance.now();
channel.port1.onmessage = () => {
  const delay = performance.now() - start;
  console.log(`MessageChannelå»¶è¿Ÿ: ${delay}ms`);  // çº¦ 0-1ms
};
channel.port2.postMessage(null);

// MessageChannel åµŒå¥—æ²¡æœ‰å»¶è¿Ÿå¢åŠ 
function testNestedMessageChannel(level) {
  if (level === 0) return;

  const channel = new MessageChannel();
  const start = performance.now();

  channel.port1.onmessage = () => {
    const delay = performance.now() - start;
    console.log(`ç¬¬ ${level} å±‚ï¼Œå»¶è¿Ÿ: ${delay}ms`);  // å§‹ç»ˆçº¦ 0-1ms
    testNestedMessageChannel(level - 1);
  };

  channel.port2.postMessage(null);
}

testNestedMessageChannel(10);

// è¾“å‡ºï¼šæ¯å±‚å»¶è¿Ÿéƒ½çº¦ 0-1msï¼Œæ²¡æœ‰å¢åŠ 
```

**åœ¨ React Scheduler ä¸­çš„åº”ç”¨ï¼š**

```javascript
// å¦‚æœç”¨ setTimeout å®ç°æ—¶é—´åˆ‡ç‰‡
function workLoopWithSetTimeout() {
  let currentTask = getNextTask();

  function work() {
    const start = performance.now();

    while (currentTask && performance.now() - start < 5) {
      performWork(currentTask);
      currentTask = getNextTask();
    }

    if (currentTask) {
      setTimeout(work, 0);  // è‡³å°‘ 4ms å»¶è¿Ÿ
    }
  }

  work();
}

// å¦‚æœç”¨ MessageChannel å®ç°æ—¶é—´åˆ‡ç‰‡
const channel = new MessageChannel();
channel.port1.onmessage = workLoopWithMessageChannel;

function workLoopWithMessageChannel() {
  let currentTask = getNextTask();
  const start = performance.now();

  while (currentTask && performance.now() - start < 5) {
    performWork(currentTask);
    currentTask = getNextTask();
  }

  if (currentTask) {
    channel.port2.postMessage(null);  // çº¦ 0ms å»¶è¿Ÿ
  }
}

// å¯¹æ¯”ï¼š
// setTimeout:     5ms å·¥ä½œ + 4ms å»¶è¿Ÿ = 9ms/è½®
// MessageChannel: 5ms å·¥ä½œ + 0ms å»¶è¿Ÿ = 5ms/è½®
// MessageChannel æ›´é«˜æ•ˆ
```

**ç»“è®ºï¼š**

MessageChannel æ¯” setTimeout æ›´é€‚åˆæ—¶é—´åˆ‡ç‰‡ï¼š
- âœ… ä¼˜å…ˆçº§æ›´é«˜ï¼Œæ›´æ—©æ‰§è¡Œ
- âœ… æ²¡æœ‰ 4ms æœ€å°å»¶è¿Ÿ
- âœ… åµŒå¥—æ²¡æœ‰å»¶è¿Ÿå¢åŠ 
- âœ… æ—¶é—´åˆ‡ç‰‡æ›´ç²¾ç¡®ã€æ›´é«˜æ•ˆ

---

## ä¸ƒã€ã€å®æˆ˜ä»£ç ã€‘

### åŸºç¡€å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰

ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´å¯è¿è¡Œçš„æ—¶é—´åˆ‡ç‰‡å®ç°ï¼š

```javascript
// ===== 1. åŸºç¡€æ—¶é—´åˆ‡ç‰‡å®ç° =====
console.log("=== 1. åŸºç¡€æ—¶é—´åˆ‡ç‰‡å®ç° ===");

// é…ç½®
const YIELD_INTERVAL = 5;  // æ—¶é—´ç‰‡é•¿åº¦ 5ms
let deadline = 0;  // å½“å‰æ—¶é—´ç‰‡çš„æˆªæ­¢æ—¶é—´

// è·å–å½“å‰æ—¶é—´
function getCurrentTime() {
  return performance.now();
}

// é‡ç½®æˆªæ­¢æ—¶é—´
function resetDeadline() {
  deadline = getCurrentTime() + YIELD_INTERVAL;
  console.log(`é‡ç½®æˆªæ­¢æ—¶é—´: ${deadline.toFixed(2)}ms`);
}

// æ£€æŸ¥æ˜¯å¦åº”è¯¥è®©å‡ºæ§åˆ¶æƒ
function shouldYield() {
  const currentTime = getCurrentTime();
  const should = currentTime >= deadline;

  if (should) {
    console.log(`â° æ—¶é—´ç‰‡ç”¨å®Œ! å½“å‰æ—¶é—´: ${currentTime.toFixed(2)}ms, æˆªæ­¢æ—¶é—´: ${deadline.toFixed(2)}ms`);
  }

  return should;
}

// ===== 2. æ¨¡æ‹Ÿé•¿ä»»åŠ¡ï¼ˆæ²¡æœ‰æ—¶é—´åˆ‡ç‰‡ï¼‰ =====
console.log("\n=== 2. æ‰§è¡Œé•¿ä»»åŠ¡ï¼ˆæ²¡æœ‰æ—¶é—´åˆ‡ç‰‡ï¼‰ ===");

function longTaskWithoutSlicing() {
  const start = getCurrentTime();
  console.log(`å¼€å§‹æ‰§è¡Œé•¿ä»»åŠ¡ï¼Œæ—¶é—´: ${start.toFixed(2)}ms`);

  // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œï¼šå¤„ç† 10000 ä¸ªå…ƒç´ 
  let count = 0;
  for (let i = 0; i < 10000; i++) {
    // æ¨¡æ‹Ÿå¤æ‚è®¡ç®—
    Math.random() * Math.random();
    count++;
  }

  const end = getCurrentTime();
  const duration = end - start;

  console.log(`é•¿ä»»åŠ¡å®Œæˆï¼Œå¤„ç†äº† ${count} ä¸ªå…ƒç´ `);
  console.log(`æ€»è€—æ—¶: ${duration.toFixed(2)}ms`);
  console.log(`âŒ è¿™æ®µæ—¶é—´ä¸»çº¿ç¨‹è¢«å®Œå…¨å ç”¨ï¼Œç”¨æˆ·è¾“å…¥å¾—ä¸åˆ°å“åº”`);

  return duration;
}

longTaskWithoutSlicing();

// ===== 3. ä½¿ç”¨æ—¶é—´åˆ‡ç‰‡ä¼˜åŒ–é•¿ä»»åŠ¡ =====
console.log("\n=== 3. ä½¿ç”¨æ—¶é—´åˆ‡ç‰‡ä¼˜åŒ–é•¿ä»»åŠ¡ ===");

function longTaskWithSlicing(callback) {
  const totalStart = getCurrentTime();
  let count = 0;
  const totalItems = 10000;
  let sliceCount = 0;  // åˆ‡ç‰‡æ¬¡æ•°

  console.log(`å¼€å§‹æ‰§è¡Œé•¿ä»»åŠ¡ï¼ˆæœ‰æ—¶é—´åˆ‡ç‰‡ï¼‰ï¼Œæ€»å…± ${totalItems} ä¸ªå…ƒç´ `);

  function work() {
    resetDeadline();  // é‡ç½®å½“å‰æ—¶é—´ç‰‡çš„æˆªæ­¢æ—¶é—´
    sliceCount++;
    const sliceStart = getCurrentTime();

    console.log(`\n--- ç¬¬ ${sliceCount} ä¸ªæ—¶é—´ç‰‡å¼€å§‹ ---`);

    // æ‰§è¡Œå·¥ä½œï¼Œç›´åˆ°æ—¶é—´ç‰‡ç”¨å®Œæˆ–ä»»åŠ¡å®Œæˆ
    while (count < totalItems) {
      if (shouldYield()) {
        // æ—¶é—´ç‰‡ç”¨å®Œï¼Œæš‚åœå·¥ä½œ
        const sliceDuration = getCurrentTime() - sliceStart;
        console.log(`ç¬¬ ${sliceCount} ä¸ªæ—¶é—´ç‰‡ç»“æŸï¼Œè€—æ—¶: ${sliceDuration.toFixed(2)}ms`);
        console.log(`å·²å¤„ç†: ${count}/${totalItems} ä¸ªå…ƒç´ `);
        console.log(`âœ… è®©å‡ºæ§åˆ¶æƒï¼Œæµè§ˆå™¨å¯ä»¥å¤„ç†å…¶ä»–äº‹æƒ…`);

        // ç»§ç»­ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡
        scheduleContinuation(work);
        return;
      }

      // æ‰§è¡Œä¸€å°å—å·¥ä½œ
      Math.random() * Math.random();
      count++;
    }

    // ä»»åŠ¡å®Œæˆ
    const totalDuration = getCurrentTime() - totalStart;
    console.log(`\n=== æ‰€æœ‰ä»»åŠ¡å®Œæˆ ===`);
    console.log(`å¤„ç†äº† ${count} ä¸ªå…ƒç´ `);
    console.log(`æ€»è€—æ—¶: ${totalDuration.toFixed(2)}ms`);
    console.log(`åˆ‡ç‰‡æ¬¡æ•°: ${sliceCount}`);
    console.log(`å¹³å‡æ¯ä¸ªæ—¶é—´ç‰‡: ${(totalDuration / sliceCount).toFixed(2)}ms`);

    if (callback) callback();
  }

  work();
}

// ä½¿ç”¨ setTimeout æ¨¡æ‹Ÿè°ƒåº¦ï¼ˆç®€åŒ–ç‰ˆï¼‰
function scheduleContinuation(callback) {
  setTimeout(callback, 0);
}

longTaskWithSlicing(() => {
  console.log('\nâœ… ä»»åŠ¡å®Œæˆï¼Œä¸»çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯ä»¥å“åº”ç”¨æˆ·è¾“å…¥');
});

// ===== 4. ä½¿ç”¨ MessageChannel å®ç°è°ƒåº¦ =====
setTimeout(() => {
  console.log("\n=== 4. ä½¿ç”¨ MessageChannel å®ç°è°ƒåº¦ ===");

  const channel = new MessageChannel();
  const port = channel.port2;
  let scheduledCallback = null;

  // ç›‘å¬æ¶ˆæ¯
  channel.port1.onmessage = () => {
    if (scheduledCallback) {
      const callback = scheduledCallback;
      scheduledCallback = null;
      callback();
    }
  };

  // è°ƒåº¦å‡½æ•°
  function scheduleWithMessageChannel(callback) {
    scheduledCallback = callback;
    port.postMessage(null);
  }

  // ä½¿ç”¨ MessageChannel æ‰§è¡Œä»»åŠ¡
  function taskWithMessageChannel(callback) {
    const totalStart = getCurrentTime();
    let count = 0;
    const totalItems = 10000;
    let sliceCount = 0;

    console.log(`å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼ˆMessageChannel è°ƒåº¦ï¼‰`);

    function work() {
      resetDeadline();
      sliceCount++;
      const sliceStart = getCurrentTime();

      while (count < totalItems) {
        if (shouldYield()) {
          const sliceDuration = getCurrentTime() - sliceStart;
          console.log(`æ—¶é—´ç‰‡ ${sliceCount} ç»“æŸï¼Œè€—æ—¶: ${sliceDuration.toFixed(2)}msï¼Œå·²å¤„ç†: ${count}/${totalItems}`);

          // ä½¿ç”¨ MessageChannel ç»§ç»­
          scheduleWithMessageChannel(work);
          return;
        }

        Math.random() * Math.random();
        count++;
      }

      const totalDuration = getCurrentTime() - totalStart;
      console.log(`\nä»»åŠ¡å®Œæˆï¼ˆMessageChannelï¼‰ï¼Œæ€»è€—æ—¶: ${totalDuration.toFixed(2)}msï¼Œåˆ‡ç‰‡æ¬¡æ•°: ${sliceCount}`);

      if (callback) callback();
    }

    work();
  }

  taskWithMessageChannel(() => {
    console.log('âœ… MessageChannel è°ƒåº¦æ›´é«˜æ•ˆ');
  });
}, 1000);

// ===== 5. å¯¹æ¯” setTimeout å’Œ MessageChannel çš„å»¶è¿Ÿ =====
setTimeout(() => {
  console.log("\n=== 5. å¯¹æ¯” setTimeout å’Œ MessageChannel çš„å»¶è¿Ÿ ===");

  // æµ‹è¯• setTimeout å»¶è¿Ÿ
  const setTimeoutStart = getCurrentTime();
  setTimeout(() => {
    const setTimeoutDelay = getCurrentTime() - setTimeoutStart;
    console.log(`setTimeout(0) å»¶è¿Ÿ: ${setTimeoutDelay.toFixed(2)}ms`);
  }, 0);

  // æµ‹è¯• MessageChannel å»¶è¿Ÿ
  const channel = new MessageChannel();
  const messageChannelStart = getCurrentTime();
  channel.port1.onmessage = () => {
    const messageChannelDelay = getCurrentTime() - messageChannelStart;
    console.log(`MessageChannel å»¶è¿Ÿ: ${messageChannelDelay.toFixed(2)}ms`);
    console.log(`âœ… MessageChannel æ¯” setTimeout æ›´å¿«`);
  };
  channel.port2.postMessage(null);
}, 2000);

// ===== 6. æ¨¡æ‹Ÿç”¨æˆ·äº¤äº’æ‰“æ–­ =====
setTimeout(() => {
  console.log("\n=== 6. æ¨¡æ‹Ÿç”¨æˆ·äº¤äº’æ‰“æ–­é•¿ä»»åŠ¡ ===");

  let userInputPending = false;  // æ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥æ ‡å¿—

  function shouldYieldWithInput() {
    const currentTime = getCurrentTime();

    // 1. æ£€æŸ¥æ—¶é—´ç‰‡æ˜¯å¦ç”¨å®Œ
    if (currentTime >= deadline) {
      return true;
    }

    // 2. æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·è¾“å…¥
    if (userInputPending) {
      console.log(`âš¡ æ£€æµ‹åˆ°ç”¨æˆ·è¾“å…¥ï¼Œç«‹å³è®©å‡ºæ§åˆ¶æƒ`);
      return true;
    }

    return false;
  }

  function taskWithInputCheck(callback) {
    const start = getCurrentTime();
    let count = 0;
    const totalItems = 10000;

    function work() {
      resetDeadline();

      while (count < totalItems) {
        if (shouldYieldWithInput()) {
          // å¦‚æœæ˜¯ç”¨æˆ·è¾“å…¥ï¼Œå¤„ç†è¾“å…¥
          if (userInputPending) {
            console.log(`ğŸ–±ï¸ å¤„ç†ç”¨æˆ·è¾“å…¥...`);
            userInputPending = false;  // é‡ç½®æ ‡å¿—
          }

          scheduleContinuation(work);
          return;
        }

        Math.random() * Math.random();
        count++;
      }

      const duration = getCurrentTime() - start;
      console.log(`ä»»åŠ¡å®Œæˆï¼Œæ€»è€—æ—¶: ${duration.toFixed(2)}ms`);
      if (callback) callback();
    }

    work();
  }

  // å¯åŠ¨ä»»åŠ¡
  taskWithInputCheck(() => {
    console.log('âœ… ä»»åŠ¡å®Œæˆï¼Œå³ä½¿æœ‰ç”¨æˆ·è¾“å…¥ä¹Ÿå¾—åˆ°äº†åŠæ—¶å“åº”');
  });

  // æ¨¡æ‹Ÿç”¨æˆ·åœ¨ 10ms åè¾“å…¥
  setTimeout(() => {
    console.log(`\n[10ms] ç”¨æˆ·ç‚¹å‡»äº†æŒ‰é’®ï¼`);
    userInputPending = true;
  }, 10);
}, 3000);
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼š**

```
=== 1. åŸºç¡€æ—¶é—´åˆ‡ç‰‡å®ç° ===

=== 2. æ‰§è¡Œé•¿ä»»åŠ¡ï¼ˆæ²¡æœ‰æ—¶é—´åˆ‡ç‰‡ï¼‰ ===
å¼€å§‹æ‰§è¡Œé•¿ä»»åŠ¡ï¼Œæ—¶é—´: 1000.00ms
é•¿ä»»åŠ¡å®Œæˆï¼Œå¤„ç†äº† 10000 ä¸ªå…ƒç´ 
æ€»è€—æ—¶: 8.50ms
âŒ è¿™æ®µæ—¶é—´ä¸»çº¿ç¨‹è¢«å®Œå…¨å ç”¨ï¼Œç”¨æˆ·è¾“å…¥å¾—ä¸åˆ°å“åº”

=== 3. ä½¿ç”¨æ—¶é—´åˆ‡ç‰‡ä¼˜åŒ–é•¿ä»»åŠ¡ ===
å¼€å§‹æ‰§è¡Œé•¿ä»»åŠ¡ï¼ˆæœ‰æ—¶é—´åˆ‡ç‰‡ï¼‰ï¼Œæ€»å…± 10000 ä¸ªå…ƒç´ 
é‡ç½®æˆªæ­¢æ—¶é—´: 1013.50ms

--- ç¬¬ 1 ä¸ªæ—¶é—´ç‰‡å¼€å§‹ ---
â° æ—¶é—´ç‰‡ç”¨å®Œ! å½“å‰æ—¶é—´: 1013.60ms, æˆªæ­¢æ—¶é—´: 1013.50ms
ç¬¬ 1 ä¸ªæ—¶é—´ç‰‡ç»“æŸï¼Œè€—æ—¶: 5.10ms
å·²å¤„ç†: 5890/10000 ä¸ªå…ƒç´ 
âœ… è®©å‡ºæ§åˆ¶æƒï¼Œæµè§ˆå™¨å¯ä»¥å¤„ç†å…¶ä»–äº‹æƒ…

--- ç¬¬ 2 ä¸ªæ—¶é—´ç‰‡å¼€å§‹ ---
...

=== æ‰€æœ‰ä»»åŠ¡å®Œæˆ ===
å¤„ç†äº† 10000 ä¸ªå…ƒç´ 
æ€»è€—æ—¶: 12.30ms
åˆ‡ç‰‡æ¬¡æ•°: 2
å¹³å‡æ¯ä¸ªæ—¶é—´ç‰‡: 6.15ms

âœ… ä»»åŠ¡å®Œæˆï¼Œä¸»çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯ä»¥å“åº”ç”¨æˆ·è¾“å…¥
```

---

### è¿›é˜¶ï¼šReactæºç å®ç°

```javascript
// React Scheduler æºç ç‰‡æ®µ
// packages/scheduler/src/forks/Scheduler.js

// æ—¶é—´ç‰‡é•¿åº¦ï¼ˆé»˜è®¤ 5msï¼‰
let yieldInterval = 5;

// å½“å‰æ—¶é—´ç‰‡çš„æˆªæ­¢æ—¶é—´
let deadline = 0;

// æ˜¯å¦æ­£åœ¨è°ƒåº¦
let isMessageLoopRunning = false;

// è°ƒåº¦çš„å›è°ƒå‡½æ•°
let scheduledHostCallback = null;

// åˆ›å»º MessageChannel
const channel = new MessageChannel();
const port = channel.port2;

// ç›‘å¬æ¶ˆæ¯ï¼Œæ‰§è¡Œå·¥ä½œç›´åˆ°æ—¶é—´ç‰‡ç”¨å®Œ
channel.port1.onmessage = performWorkUntilDeadline;

// æ‰§è¡Œå·¥ä½œç›´åˆ°æ—¶é—´ç‰‡ç”¨å®Œ
function performWorkUntilDeadline() {
  if (scheduledHostCallback !== null) {
    const currentTime = getCurrentTime();

    // è®¾ç½®å½“å‰æ—¶é—´ç‰‡çš„æˆªæ­¢æ—¶é—´
    deadline = currentTime + yieldInterval;

    const hasTimeRemaining = true;
    let hasMoreWork = true;

    try {
      // æ‰§è¡Œå·¥ä½œå¾ªç¯ï¼Œè¿”å›æ˜¯å¦è¿˜æœ‰æ›´å¤šå·¥ä½œ
      hasMoreWork = scheduledHostCallback(hasTimeRemaining, currentTime);
    } finally {
      if (hasMoreWork) {
        // è¿˜æœ‰å·¥ä½œï¼Œç»§ç»­è°ƒåº¦ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡
        port.postMessage(null);
      } else {
        // å·¥ä½œå®Œæˆ
        isMessageLoopRunning = false;
        scheduledHostCallback = null;
      }
    }
  } else {
    isMessageLoopRunning = false;
  }
}

// è¯·æ±‚è°ƒåº¦
function requestHostCallback(callback) {
  scheduledHostCallback = callback;

  if (!isMessageLoopRunning) {
    isMessageLoopRunning = true;
    port.postMessage(null);  // å‘é€æ¶ˆæ¯ï¼Œè§¦å‘ performWorkUntilDeadline
  }
}

// æ£€æŸ¥æ˜¯å¦åº”è¯¥è®©å‡ºæ§åˆ¶æƒ
function shouldYieldToHost() {
  const currentTime = getCurrentTime();

  // æ—¶é—´ç‰‡ç”¨å®Œ
  if (currentTime >= deadline) {
    return true;
  }

  // å¦‚æœæ”¯æŒ isInputPendingï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·è¾“å…¥
  if (
    enableIsInputPending &&
    navigator !== undefined &&
    navigator.scheduling !== undefined &&
    navigator.scheduling.isInputPending !== undefined
  ) {
    const scheduling = navigator.scheduling;
    return scheduling.isInputPending();
  }

  return false;
}

// å·¥ä½œå¾ªç¯
function workLoop(hasTimeRemaining, initialTime) {
  let currentTime = initialTime;

  // æ£€æŸ¥å»¶è¿Ÿä»»åŠ¡é˜Ÿåˆ—
  advanceTimers(currentTime);

  // è·å–æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡
  currentTask = peek(taskQueue);

  while (
    currentTask !== null &&
    !(enableSchedulerDebugging && isSchedulerPaused)
  ) {
    // å…³é”®åˆ¤æ–­ï¼šä»»åŠ¡æœªè¿‡æœŸ ä¸” åº”è¯¥è®©å‡ºæ§åˆ¶æƒ
    if (
      currentTask.expirationTime > currentTime &&
      (!hasTimeRemaining || shouldYieldToHost())
    ) {
      // æ—¶é—´ç‰‡ç”¨å®Œï¼Œé€€å‡ºå¾ªç¯
      break;
    }

    const callback = currentTask.callback;

    if (typeof callback === 'function') {
      currentTask.callback = null;
      currentPriorityLevel = currentTask.priorityLevel;

      // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦è¿‡æœŸ
      const didUserCallbackTimeout = currentTask.expirationTime <= currentTime;

      // æ‰§è¡Œä»»åŠ¡
      const continuationCallback = callback(didUserCallbackTimeout);

      currentTime = getCurrentTime();

      if (typeof continuationCallback === 'function') {
        // ä»»åŠ¡è¿”å›äº†å»¶ç»­å‡½æ•°ï¼Œæ›´æ–°å›è°ƒ
        currentTask.callback = continuationCallback;
      } else {
        // ä»»åŠ¡å®Œæˆï¼Œç§»é™¤
        if (currentTask === peek(taskQueue)) {
          pop(taskQueue);
        }
      }

      advanceTimers(currentTime);
    } else {
      // å›è°ƒä¸ºç©ºï¼Œç§»é™¤ä»»åŠ¡
      pop(taskQueue);
    }

    // è·å–ä¸‹ä¸€ä¸ªä»»åŠ¡
    currentTask = peek(taskQueue);
  }

  // è¿”å›æ˜¯å¦è¿˜æœ‰æ›´å¤šå·¥ä½œ
  if (currentTask !== null) {
    return true;
  } else {
    // æ£€æŸ¥å»¶è¿Ÿé˜Ÿåˆ—
    const firstTimer = peek(timerQueue);
    if (firstTimer !== null) {
      requestHostTimeout(handleTimeout, firstTimer.startTime - currentTime);
    }
    return false;
  }
}

// è°ƒåº¦å›è°ƒï¼ˆå…¥å£å‡½æ•°ï¼‰
function unstable_scheduleCallback(priorityLevel, callback, options) {
  const currentTime = getCurrentTime();

  // ... åˆ›å»ºä»»åŠ¡ï¼ŒåŠ å…¥é˜Ÿåˆ—

  // è¯·æ±‚è°ƒåº¦
  if (!isHostCallbackScheduled && !isPerformingWork) {
    isHostCallbackScheduled = true;
    requestHostCallback(flushWork);
  }

  return newTask;
}

// åˆ·æ–°å·¥ä½œé˜Ÿåˆ—
function flushWork(hasTimeRemaining, initialTime) {
  isHostCallbackScheduled = false;

  if (isHostTimeoutScheduled) {
    isHostTimeoutScheduled = false;
    cancelHostTimeout();
  }

  isPerformingWork = true;
  const previousPriorityLevel = currentPriorityLevel;

  try {
    // æ‰§è¡Œå·¥ä½œå¾ªç¯
    return workLoop(hasTimeRemaining, initialTime);
  } finally {
    currentTask = null;
    currentPriorityLevel = previousPriorityLevel;
    isPerformingWork = false;
  }
}
```

**å…³é”®ç‚¹è¯´æ˜ï¼š**

1. **yieldInterval = 5ms**ï¼šæ—¶é—´ç‰‡é•¿åº¦
2. **deadline = currentTime + yieldInterval**ï¼šè®¡ç®—æˆªæ­¢æ—¶é—´
3. **shouldYieldToHost()**ï¼šæ£€æŸ¥æ˜¯å¦åº”è¯¥è®©å‡ºæ§åˆ¶æƒ
   - æ—¶é—´æ£€æŸ¥ï¼š`currentTime >= deadline`
   - è¾“å…¥æ£€æŸ¥ï¼š`navigator.scheduling.isInputPending()`
4. **MessageChannel**ï¼šå®ç°å¼‚æ­¥è°ƒåº¦
   - `port.postMessage(null)` è§¦å‘ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡
   - æ¯” setTimeout æ›´é«˜æ•ˆ
5. **workLoop**ï¼šå·¥ä½œå¾ªç¯
   - æ£€æŸ¥ä»»åŠ¡æ˜¯å¦è¿‡æœŸ
   - æ£€æŸ¥æ˜¯å¦åº”è¯¥è®©å‡ºæ§åˆ¶æƒ
   - è¿‡æœŸä»»åŠ¡å¿…é¡»æ‰§è¡Œï¼Œæœªè¿‡æœŸä»»åŠ¡å¯ä¸­æ–­

---

## å…«ã€ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜1ï¼š"ä»€ä¹ˆæ˜¯æ—¶é—´åˆ‡ç‰‡ï¼ŸReact ä¸ºä»€ä¹ˆéœ€è¦æ—¶é—´åˆ‡ç‰‡ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"æ—¶é—´åˆ‡ç‰‡å°±æ˜¯æŠŠä»»åŠ¡åˆ†æˆå°å—æ‰§è¡Œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **æ—¶é—´åˆ‡ç‰‡æ˜¯ React Scheduler å°†é•¿ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªå°ä»»åŠ¡çš„æœºåˆ¶ï¼Œæ¯ä¸ªå°ä»»åŠ¡æ‰§è¡Œçº¦ 5ms åæ£€æŸ¥æ˜¯å¦åº”è¯¥è®©å‡ºæ§åˆ¶æƒï¼ˆshouldYieldï¼‰ï¼Œå¦‚æœåº”è¯¥ï¼Œåˆ™é€šè¿‡ MessageChannel å¼‚æ­¥è°ƒåº¦ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡ç»§ç»­æ‰§è¡Œã€‚**
>
> **ä¸ºä»€ä¹ˆéœ€è¦æ—¶é—´åˆ‡ç‰‡ï¼Ÿè§£å†³ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š**
>
> 1. **ä¸»çº¿ç¨‹é˜»å¡é—®é¢˜**
>    - JavaScript å•çº¿ç¨‹ï¼Œé•¿ä»»åŠ¡ï¼ˆå¦‚æ¸²æŸ“ 10000 ä¸ªåˆ—è¡¨é¡¹ï¼‰ä¼šå ç”¨ä¸»çº¿ç¨‹å‡ åç”šè‡³ä¸Šç™¾æ¯«ç§’
>    - æœŸé—´ç”¨æˆ·ç‚¹å‡»æŒ‰é’®ã€è¾“å…¥æ–‡å­—éƒ½å¾—ä¸åˆ°å“åº”ï¼Œç”¨æˆ·æ„Ÿè§‰å¡é¡¿
>    - æ—¶é—´åˆ‡ç‰‡æ¯ 5ms æš‚åœä¸€æ¬¡ï¼Œè®©æµè§ˆå™¨æœ‰æœºä¼šå¤„ç†ç”¨æˆ·è¾“å…¥
>
> 2. **æ¸²æŸ“æµç•…æ€§é—®é¢˜**
>    - æµè§ˆå™¨ 60fps = 16.6ms/å¸§ï¼Œå¦‚æœ JavaScript æ‰§è¡Œè¶…è¿‡ 16.6msï¼Œä¼šå¯¼è‡´æ‰å¸§
>    - æ—¶é—´åˆ‡ç‰‡æ¯ 5ms æš‚åœï¼Œç•™ç»™æ¸²æŸ“çº¦ 11.6msï¼Œä¿è¯ 60fps æµç•…åº¦
>
> 3. **ä»»åŠ¡ä¼˜å…ˆçº§è°ƒåº¦é—®é¢˜**
>    - é…åˆä¼˜å…ˆçº§ç³»ç»Ÿï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡åœ¨æ—¶é—´ç‰‡ç»“æŸæ—¶å¯ä»¥è¢«é«˜ä¼˜å…ˆçº§ä»»åŠ¡æŠ¢å 
>    - ä¾‹å¦‚ï¼šç”¨æˆ·ç‚¹å‡»ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰å¯ä»¥æ‰“æ–­æ•°æ®åˆ†æï¼ˆä½ä¼˜å…ˆçº§ï¼‰
>
> **å®ç°æœºåˆ¶ï¼š**
> - `yieldInterval = 5ms`ï¼šæ—¶é—´ç‰‡é•¿åº¦
> - `shouldYield()`ï¼šæ£€æŸ¥ `currentTime >= deadline`
> - `MessageChannel`ï¼šå¼‚æ­¥è°ƒåº¦ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡ï¼ˆæ¯” setTimeout æ›´é«˜æ•ˆï¼‰
>
> **å®é™…åº”ç”¨ï¼š**
> - React 18 çš„ Concurrent Mode ä¾èµ–æ—¶é—´åˆ‡ç‰‡å®ç°å¯ä¸­æ–­æ¸²æŸ“
> - `startTransition` API å°†æ›´æ–°æ ‡è®°ä¸ºä½ä¼˜å…ˆçº§ï¼Œå¯è¢«æ—¶é—´åˆ‡ç‰‡æ‰“æ–­
> - ä¿è¯ç”¨æˆ·äº¤äº’ï¼ˆå¦‚è¾“å…¥ã€ç‚¹å‡»ï¼‰å§‹ç»ˆèƒ½å¿«é€Ÿå“åº”

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**

1. âœ… ä¸ä»…è¯´æ˜äº†"æ˜¯ä»€ä¹ˆ"ï¼Œè¿˜è¯´æ˜äº†"ä¸ºä»€ä¹ˆ"ï¼ˆè§£å†³çš„ä¸‰ä¸ªé—®é¢˜ï¼‰
2. âœ… æä¾›äº†å…·ä½“çš„æŠ€æœ¯ç»†èŠ‚ï¼ˆ5msã€shouldYieldã€MessageChannelï¼‰
3. âœ… è”ç³»äº†å®é™…åº”ç”¨åœºæ™¯ï¼ˆConcurrent Modeã€startTransitionï¼‰
4. âœ… å±•ç¤ºäº†ç³»ç»Ÿæ€§ç†è§£ï¼Œè€Œä¸æ˜¯ç®€å•èƒŒè¯µ

---

### é—®é¢˜2ï¼š"ä¸ºä»€ä¹ˆ React Scheduler ç”¨ MessageChannel è€Œä¸æ˜¯ setTimeoutï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"å› ä¸º MessageChannel æ¯” setTimeout æ›´å¿«ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **React Scheduler ä½¿ç”¨ MessageChannel è€Œä¸æ˜¯ setTimeoutï¼Œä¸»è¦æœ‰ä¸‰ä¸ªåŸå› ï¼š**
>
> 1. **ä¼˜å…ˆçº§æ›´é«˜ï¼Œæ‰§è¡Œæ›´æ—©**
>    - åœ¨äº‹ä»¶å¾ªç¯ä¸­ï¼ŒMessageChannel æ˜¯å®ä»»åŠ¡ï¼Œä½†ä¼˜å…ˆçº§é«˜äº setTimeout
>    - å®æµ‹ï¼šMessageChannel å»¶è¿Ÿçº¦ 0-1msï¼ŒsetTimeout(0) å»¶è¿Ÿçº¦ 4ms
>    - æ—¶é—´åˆ‡ç‰‡éœ€è¦å¿«é€Ÿè°ƒåº¦ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡ï¼ŒMessageChannel æ›´åˆé€‚
>
> 2. **æ²¡æœ‰æœ€å°å»¶è¿Ÿé™åˆ¶**
>    - setTimeout æœ‰ 4ms çš„æœ€å°å»¶è¿Ÿï¼ˆæµè§ˆå™¨é™åˆ¶ï¼Œé˜²æ­¢æ»¥ç”¨ï¼‰
>    - åµŒå¥—è¶…è¿‡ 5 å±‚åï¼Œå»¶è¿Ÿä¼šè¢«å¼ºåˆ¶å¢åŠ åˆ° 4ms
>    - MessageChannel æ²¡æœ‰è¿™ä¸ªé™åˆ¶ï¼Œå¯ä»¥ç«‹å³è°ƒåº¦
>
> 3. **é¿å…åµŒå¥—é™åˆ¶**
>    - React Scheduler éœ€è¦é¢‘ç¹è°ƒåº¦ï¼ˆæ¯ 5ms ä¸€æ¬¡ï¼‰
>    - å¦‚æœç”¨ setTimeoutï¼ŒåµŒå¥—å±‚çº§å¾ˆå¿«è¶…è¿‡ 5 å±‚ï¼Œå»¶è¿Ÿå¢åŠ 
>    - MessageChannel æ²¡æœ‰åµŒå¥—é™åˆ¶ï¼Œé€‚åˆé«˜é¢‘è°ƒåº¦åœºæ™¯
>
> **å®é™…å¯¹æ¯”ï¼š**
>
> ```javascript
> // setTimeout å®ç°ï¼ˆæœ‰å»¶è¿Ÿï¼‰
> function scheduleWithSetTimeout(callback) {
>   setTimeout(callback, 0);  // å®é™…å»¶è¿Ÿ ~4ms
> }
>
> // MessageChannel å®ç°ï¼ˆæ›´å¿«ï¼‰
> const channel = new MessageChannel();
> channel.port1.onmessage = callback;
> function scheduleWithMessageChannel() {
>   channel.port2.postMessage(null);  // å®é™…å»¶è¿Ÿ ~0ms
> }
>
> // æ—¶é—´åˆ‡ç‰‡è°ƒåº¦
> // setTimeout:     5ms å·¥ä½œ + 4ms å»¶è¿Ÿ = 9ms/è½®
> // MessageChannel: 5ms å·¥ä½œ + 0ms å»¶è¿Ÿ = 5ms/è½®
> // MessageChannel æ•ˆç‡æå‡çº¦ 45%
> ```
>
> **äº‹ä»¶å¾ªç¯é¡ºåºï¼š**
> - åŒæ­¥ä»£ç  â†’ å¾®ä»»åŠ¡ï¼ˆPromiseï¼‰â†’ MessageChannelï¼ˆå®ä»»åŠ¡ï¼‰â†’ setTimeoutï¼ˆå®ä»»åŠ¡ï¼‰
> - MessageChannel åœ¨ setTimeout ä¹‹å‰æ‰§è¡Œ
>
> **ä¸ºä»€ä¹ˆä¸ç”¨ requestAnimationFrameï¼Ÿ**
> - rAF ä¾èµ–æµè§ˆå™¨å¸§ç‡ï¼Œå¯èƒ½åœ¨ 16.6ms åæ‰æ‰§è¡Œ
> - React éœ€è¦æ›´é¢‘ç¹çš„è°ƒåº¦ï¼ˆ5msï¼‰ï¼ŒrAF ä¸å¤Ÿçµæ´»

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**

1. âœ… æä¾›äº†ä¸‰ä¸ªæ¸…æ™°çš„åŸå› ï¼ˆä¼˜å…ˆçº§ã€å»¶è¿Ÿã€åµŒå¥—ï¼‰
2. âœ… ç”¨ä»£ç å¯¹æ¯”è¯´æ˜äº†æ€§èƒ½å·®å¼‚ï¼ˆ45% æ•ˆç‡æå‡ï¼‰
3. âœ… è¯´æ˜äº†äº‹ä»¶å¾ªç¯é¡ºåºï¼Œå±•ç¤ºå¯¹æµè§ˆå™¨æœºåˆ¶çš„ç†è§£
4. âœ… ä¸»åŠ¨å¯¹æ¯”äº†å…¶ä»–æ–¹æ¡ˆï¼ˆrAFï¼‰ï¼Œå±•ç¤ºå…¨é¢æ€è€ƒ

---

## ä¹ã€ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šæ—¶é—´åˆ‡ç‰‡æ˜¯ä»€ä¹ˆï¼Ÿ ğŸ¯

**ä¸€å¥è¯ï¼š** æ—¶é—´åˆ‡ç‰‡æ˜¯å°†é•¿ä»»åŠ¡æ‹†åˆ†æˆå°ä»»åŠ¡ï¼Œæ¯ä¸ªå°ä»»åŠ¡æ‰§è¡Œ 5ms åæ£€æŸ¥æ˜¯å¦åº”è¯¥è®©å‡ºæ§åˆ¶æƒã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
while (hasWork()) {
  if (shouldYield()) {
    scheduleContinueLater();
    return;
  }
  doWork();
}
```

**åº”ç”¨ï¼š** é¿å…é•¿ä»»åŠ¡é˜»å¡ä¸»çº¿ç¨‹ï¼Œä¿æŒé¡µé¢å“åº”æ€§ã€‚

---

### å¡ç‰‡2ï¼šæ—¶é—´ç‰‡é•¿åº¦ 5ms â±ï¸

**ä¸€å¥è¯ï¼š** React Scheduler é»˜è®¤æ—¶é—´ç‰‡é•¿åº¦ä¸º 5msï¼Œå¹³è¡¡äº†å“åº”æ€§å’Œæ•ˆç‡ã€‚

**ä¸¾ä¾‹ï¼š**
```
ä¸€å¸§ï¼š16.6msï¼ˆ60fpsï¼‰
æ¸²æŸ“ï¼š~10msï¼ˆå¸ƒå±€+ç»˜åˆ¶ï¼‰
JSï¼š  6.6ms
å®‰å…¨å€¼ï¼š5ms
```

**åº”ç”¨ï¼š** æ¯ 5ms æš‚åœä¸€æ¬¡ï¼Œç•™ç»™æ¸²æŸ“ 11.6msï¼Œä¿è¯ 60fpsã€‚

---

### å¡ç‰‡3ï¼šshouldYield() åˆ¤æ–­ ğŸš¦

**ä¸€å¥è¯ï¼š** shouldYield() æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦è¶…è¿‡æˆªæ­¢æ—¶é—´ï¼ˆdeadlineï¼‰ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
deadline = startTime + 5;  // 5ms å
shouldYield = (currentTime >= deadline);
```

**åº”ç”¨ï¼š** æ—¶é—´ç‰‡ç”¨å®Œæ—¶è¿”å› trueï¼Œè®©å‡ºæ§åˆ¶æƒã€‚

---

### å¡ç‰‡4ï¼šMessageChannel è°ƒåº¦ ğŸ“¬

**ä¸€å¥è¯ï¼š** React ç”¨ MessageChannel å®ç°å¼‚æ­¥è°ƒåº¦ï¼Œæ¯” setTimeout æ›´å¿«ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
const channel = new MessageChannel();
channel.port1.onmessage = continueWork;
channel.port2.postMessage(null);  // è§¦å‘è°ƒåº¦
```

**åº”ç”¨ï¼š** å»¶è¿Ÿçº¦ 0msï¼Œæ¯” setTimeout(4ms) å¿« 4 å€ã€‚

---

### å¡ç‰‡5ï¼šä¸ºä»€ä¹ˆä¸ç”¨ setTimeoutï¼Ÿ â°

**ä¸€å¥è¯ï¼š** setTimeout æœ‰ 4ms æœ€å°å»¶è¿Ÿå’ŒåµŒå¥—é™åˆ¶ï¼Œä¸é€‚åˆé«˜é¢‘è°ƒåº¦ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
setTimeout(fn, 0);  // å®é™…å»¶è¿Ÿ ~4ms
// åµŒå¥— 5 å±‚åï¼Œå»¶è¿Ÿå¢åŠ åˆ° 4ms
```

**åº”ç”¨ï¼š** MessageChannel æ²¡æœ‰è¿™äº›é™åˆ¶ï¼Œæ›´é€‚åˆæ—¶é—´åˆ‡ç‰‡ã€‚

---

### å¡ç‰‡6ï¼šæˆªæ­¢æ—¶é—´è®¡ç®— ğŸ§®

**ä¸€å¥è¯ï¼š** æˆªæ­¢æ—¶é—´ = å¼€å§‹æ—¶é—´ + æ—¶é—´ç‰‡é•¿åº¦ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
const start = 1000;  // å¼€å§‹æ—¶é—´ 1000ms
const yieldInterval = 5;  // æ—¶é—´ç‰‡ 5ms
const deadline = start + yieldInterval;  // 1005ms
```

**åº”ç”¨ï¼š** å½“å‰æ—¶é—´è¶…è¿‡ deadlineï¼ŒshouldYield() è¿”å› trueã€‚

---

### å¡ç‰‡7ï¼šç”¨æˆ·è¾“å…¥æ£€æŸ¥ ğŸ–±ï¸

**ä¸€å¥è¯ï¼š** shouldYield() è¿˜å¯ä»¥æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„ç”¨æˆ·è¾“å…¥ï¼ˆisInputPendingï¼‰ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
if (navigator.scheduling?.isInputPending()) {
  return true;  // æœ‰ç”¨æˆ·è¾“å…¥ï¼Œè®©å‡ºæ§åˆ¶æƒ
}
```

**åº”ç”¨ï¼š** å³ä½¿æ—¶é—´ç‰‡è¿˜æ²¡ç”¨å®Œï¼Œæœ‰ç”¨æˆ·è¾“å…¥ä¹Ÿåº”è¯¥è®©å‡ºã€‚

---

### å¡ç‰‡8ï¼šæ—¶é—´åˆ‡ç‰‡çš„å¼€é”€ ğŸ’°

**ä¸€å¥è¯ï¼š** æ—¶é—´åˆ‡ç‰‡å¢åŠ äº†çº¦ 10% çš„è°ƒåº¦å¼€é”€ï¼Œä½†æ¢æ¥äº†é¡µé¢å“åº”æ€§ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
// æ²¡æœ‰æ—¶é—´åˆ‡ç‰‡ï¼š100ms
// æœ‰æ—¶é—´åˆ‡ç‰‡ï¼š  110msï¼ˆå¤šäº† 10ms è°ƒåº¦å¼€é”€ï¼‰
// ä½†ç”¨æˆ·æ„Ÿè§‰æ›´æµç•…
```

**åº”ç”¨ï¼š** ç‰ºç‰²å°‘é‡æ€§èƒ½ï¼Œæ¢å–æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

---

### å¡ç‰‡9ï¼šå¯ä¸­æ–­æ¸²æŸ“ âœ‚ï¸

**ä¸€å¥è¯ï¼š** æ—¶é—´åˆ‡ç‰‡é…åˆä¼˜å…ˆçº§ç³»ç»Ÿï¼Œå®ç°å¯ä¸­æ–­çš„ä»»åŠ¡è°ƒåº¦ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
while (hasWork()) {
  if (shouldYield() && hasHigherPriorityWork()) {
    // ä¸­æ–­å½“å‰ä»»åŠ¡ï¼Œæ‰§è¡Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡
    scheduleHighPriorityWork();
    return;
  }
  doWork();
}
```

**åº”ç”¨ï¼š** ç”¨æˆ·ç‚¹å‡»å¯ä»¥æ‰“æ–­æ•°æ®åˆ†æä»»åŠ¡ã€‚

---

### å¡ç‰‡10ï¼šæ—¶é—´åˆ‡ç‰‡ä¸ Concurrent Mode âš›ï¸

**ä¸€å¥è¯ï¼š** React 18 çš„ Concurrent Mode ä¾èµ–æ—¶é—´åˆ‡ç‰‡å®ç°å¯ä¸­æ–­æ¸²æŸ“ã€‚

**ä¸¾ä¾‹ï¼š**
```javascript
// startTransition æ ‡è®°ä¸ºä½ä¼˜å…ˆçº§æ›´æ–°
startTransition(() => {
  setFilteredList(filter(list));  // å¯è¢«æ—¶é—´åˆ‡ç‰‡æ‰“æ–­
});

// ç”¨æˆ·ç‚¹å‡»æ—¶ï¼Œä½ä¼˜å…ˆçº§æ›´æ–°ä¼šè¢«ä¸­æ–­
onClick={() => setCount(c => c + 1)};
```

**åº”ç”¨ï¼š** æ—¶é—´åˆ‡ç‰‡æ˜¯ React 18 æ–°ç‰¹æ€§çš„åŸºç¡€ã€‚

---

## åã€ã€ä¸€å¥è¯æ€»ç»“ã€‘

**æ—¶é—´åˆ‡ç‰‡æ˜¯å°†é•¿ä»»åŠ¡æ‹†åˆ†æˆæ¯ä¸ªçº¦5msçš„å°ä»»åŠ¡ï¼Œé€šè¿‡shouldYield()æ£€æŸ¥æ˜¯å¦è¶…è¿‡æˆªæ­¢æ—¶é—´æ¥å†³å®šæ˜¯å¦è®©å‡ºæ§åˆ¶æƒï¼Œä½¿ç”¨MessageChannelå¼‚æ­¥è°ƒåº¦ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼Œä¿è¯é¡µé¢å“åº”æ€§å’Œ60fpsæµç•…åº¦ï¼Œæ˜¯React Schedulerå®ç°å¯ä¸­æ–­è°ƒåº¦çš„æ ¸å¿ƒæœºåˆ¶ã€‚**

---

## é™„å½•

### å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] ç†è§£æ—¶é—´åˆ‡ç‰‡çš„æ ¸å¿ƒæ¦‚å¿µï¼šå®šæœŸæ£€æŸ¥ + ä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒ
- [ ] çŸ¥é“æ—¶é—´ç‰‡é•¿åº¦ä¸ºä»€ä¹ˆæ˜¯ 5msï¼ˆ16.6ms - 10ms â‰ˆ 5msï¼‰
- [ ] ç†è§£ shouldYield() çš„åˆ¤æ–­é€»è¾‘ï¼ˆcurrentTime >= deadlineï¼‰
- [ ] çŸ¥é“ MessageChannel æ¯” setTimeout çš„ä¼˜åŠ¿ï¼ˆä¼˜å…ˆçº§é«˜ã€æ— å»¶è¿Ÿã€æ— åµŒå¥—é™åˆ¶ï¼‰
- [ ] ç†è§£æ—¶é—´åˆ‡ç‰‡å¦‚ä½•é¿å…é˜»å¡ä¸»çº¿ç¨‹
- [ ] ç†è§£æ—¶é—´åˆ‡ç‰‡å¦‚ä½•ä¿è¯ 60fps æµç•…åº¦
- [ ] çŸ¥é“æ—¶é—´åˆ‡ç‰‡é…åˆä¼˜å…ˆçº§å®ç°å¯ä¸­æ–­è°ƒåº¦
- [ ] ç†è§£æ—¶é—´åˆ‡ç‰‡çš„å¼€é”€ï¼ˆçº¦ 10%ï¼‰å’Œä»·å€¼ï¼ˆå“åº”æ€§ï¼‰
- [ ] çŸ¥é“æ—¶é—´åˆ‡ç‰‡åœ¨ React Concurrent Mode ä¸­çš„åº”ç”¨
- [ ] èƒ½æ‰‹å†™ä¸€ä¸ªç®€åŒ–çš„æ—¶é—´åˆ‡ç‰‡å®ç°

### ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®

1. **æœ€å°å †ä»»åŠ¡é˜Ÿåˆ—**ï¼šäº†è§£ä»»åŠ¡é˜Ÿåˆ—å¦‚ä½•æŒ‰è¿‡æœŸæ—¶é—´æ’åº
2. **ä¼˜å…ˆçº§ç³»ç»Ÿ**ï¼šå¤ä¹ ä¼˜å…ˆçº§å¦‚ä½•é…åˆæ—¶é—´åˆ‡ç‰‡å®ç°å¯ä¸­æ–­è°ƒåº¦
3. **Concurrent Mode**ï¼šå­¦ä¹  React 18 å¦‚ä½•åˆ©ç”¨æ—¶é—´åˆ‡ç‰‡å®ç°å¹¶å‘æ¸²æŸ“
4. **è°ƒåº¦å¾ªç¯**ï¼šæ·±å…¥ç†è§£ workLoop å¦‚ä½•é…åˆ shouldYield æ‰§è¡Œä»»åŠ¡

### å¿«é€Ÿå‚è€ƒå¡

**æ—¶é—´åˆ‡ç‰‡æ ¸å¿ƒå…¬å¼ï¼š**

```javascript
// æ—¶é—´ç‰‡é•¿åº¦
yieldInterval = 5;  // ms

// æˆªæ­¢æ—¶é—´
deadline = startTime + yieldInterval;

// æ˜¯å¦è®©å‡º
shouldYield = (currentTime >= deadline);
```

**MessageChannel vs setTimeoutï¼š**

| ç‰¹æ€§ | MessageChannel | setTimeout |
|------|---------------|-----------|
| å»¶è¿Ÿ | ~0ms | ~4ms |
| åµŒå¥—é™åˆ¶ | æ—  | 5å±‚åå»¶è¿Ÿå¢åŠ  |
| ä¼˜å…ˆçº§ | é«˜ | ä½ |
| é€‚ç”¨åœºæ™¯ | é«˜é¢‘è°ƒåº¦ | æ™®é€šå»¶è¿Ÿ |

### å‚è€ƒèµ„æº

- [React Scheduler æºç ](https://github.com/facebook/react/blob/main/packages/scheduler/src/forks/Scheduler.js)
- [React å®˜æ–¹æ–‡æ¡£ - Concurrent Features](https://react.dev/blog/2022/03/29/react-v18#what-is-concurrent-react)
- [MessageChannel MDN](https://developer.mozilla.org/en-US/docs/Web/API/MessageChannel)
- [isInputPending API](https://developer.mozilla.org/en-US/docs/Web/API/Scheduling/isInputPending)
