# è‡ªåŠ¨æ‰¹å¤„ç†å¢å¼º

## ä¸€ã€ã€30å­—æ ¸å¿ƒã€‘

**è‡ªåŠ¨æ‰¹å¤„ç†æ˜¯ React 18+ çš„æ€§èƒ½ä¼˜åŒ–ç‰¹æ€§ï¼Œå°†å¤šä¸ªçŠ¶æ€æ›´æ–°åˆå¹¶ä¸ºä¸€æ¬¡é‡æ¸²æŸ“ï¼Œæ‰©å±•åˆ° promisesã€setTimeoutã€äº‹ä»¶å¤„ç†å™¨ç­‰æ‰€æœ‰åœºæ™¯ï¼Œæ˜¾è‘—å‡å°‘ä¸å¿…è¦çš„æ¸²æŸ“ã€‚**

---

## äºŒã€ã€ç¬¬ä¸€æ€§åŸç†ã€‘

### ä»€ä¹ˆæ˜¯ç¬¬ä¸€æ€§åŸç†ï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šå›åˆ°äº‹ç‰©æœ€åŸºæœ¬çš„çœŸç†ï¼Œä»æºå¤´æ€è€ƒé—®é¢˜

### è‡ªåŠ¨æ‰¹å¤„ç†çš„ç¬¬ä¸€æ€§åŸç† ğŸ¯

#### 1. æœ€åŸºç¡€çš„å®šä¹‰

**è‡ªåŠ¨æ‰¹å¤„ç† = å¤šæ¬¡çŠ¶æ€æ›´æ–° â†’ ä¸€æ¬¡é‡æ¸²æŸ“**

ä»…æ­¤è€Œå·²ï¼æ²¡æœ‰æ›´åŸºç¡€çš„äº†ã€‚

å½“ä½ åœ¨ React ç»„ä»¶ä¸­å¤šæ¬¡è°ƒç”¨ `setState` æˆ– `setXxx` æ—¶ï¼ŒReact ä¸ä¼šç«‹å³æ¸²æŸ“ç»„ä»¶å¤šæ¬¡ï¼Œè€Œæ˜¯å°†è¿™äº›æ›´æ–°"æ”’èµ·æ¥"ï¼Œåœ¨åˆé€‚çš„æ—¶æœºä¸€æ¬¡æ€§æ‰¹é‡å¤„ç†ï¼Œåªæ¸²æŸ“ä¸€æ¬¡ã€‚

#### 2. ä¸ºä»€ä¹ˆéœ€è¦è‡ªåŠ¨æ‰¹å¤„ç†ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•å‡å°‘ä¸å¿…è¦çš„æ¸²æŸ“æ¬¡æ•°ï¼Œæå‡æ€§èƒ½ï¼Ÿ**

React çš„æ¸²æŸ“æ˜¯æœ‰æˆæœ¬çš„ï¼š
- DOM æ“ä½œå¾ˆæ˜‚è´µ
- è™šæ‹Ÿ DOM å¯¹æ¯”éœ€è¦è®¡ç®—
- ç»„ä»¶çš„ render å‡½æ•°éœ€è¦æ‰§è¡Œ
- Effect å‰¯ä½œç”¨éœ€è¦è¿è¡Œ

å¦‚æœæ¯æ¬¡ `setState` éƒ½ç«‹å³æ¸²æŸ“ï¼Œåœ¨ä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨ä¸­è°ƒç”¨ 3 æ¬¡ `setState` å°±ä¼šè§¦å‘ 3 æ¬¡æ¸²æŸ“ï¼Œè¿™ä¼šï¼š
- é€ æˆæ€§èƒ½æµªè´¹ï¼ˆä¸­é—´çŠ¶æ€å¯èƒ½æ²¡äººå…³å¿ƒï¼‰
- UI é—ªçƒï¼ˆç”¨æˆ·ä¼šçœ‹åˆ°å¤šæ¬¡ä¸­é—´çŠ¶æ€ï¼‰
- è¿åç›´è§‰ï¼ˆå¼€å‘è€…æœŸæœ›åŒæ­¥ä»£ç æ˜¯"åŸå­æ€§"çš„ï¼‰

#### 3. è‡ªåŠ¨æ‰¹å¤„ç†çš„ä¸‰å±‚ä»·å€¼

##### ä»·å€¼1ï¼šæ€§èƒ½æå‡ âš¡

æ‰¹å¤„ç†å‡å°‘äº†æ¸²æŸ“æ¬¡æ•°ï¼Œç›´æ¥æå‡æ€§èƒ½ã€‚

```javascript
// æ²¡æœ‰æ‰¹å¤„ç†ï¼šæ¸²æŸ“ 3 æ¬¡
function handleClick() {
  setCount(c => c + 1);  // ç¬¬1æ¬¡æ¸²æŸ“
  setFlag(f => !f);      // ç¬¬2æ¬¡æ¸²æŸ“
  setText('updated');    // ç¬¬3æ¬¡æ¸²æŸ“
}

// æœ‰æ‰¹å¤„ç†ï¼šæ¸²æŸ“ 1 æ¬¡
function handleClick() {
  setCount(c => c + 1);  // æš‚å­˜
  setFlag(f => !f);      // æš‚å­˜
  setText('updated');    // æš‚å­˜ â†’ æ‰¹é‡æäº¤ â†’ 1æ¬¡æ¸²æŸ“
}
```

##### ä»·å€¼2ï¼šç”¨æˆ·ä½“éªŒä¼˜åŒ– ğŸ¨

é¿å…äº†ä¸­é—´çŠ¶æ€çš„é—ªçƒï¼Œç”¨æˆ·çœ‹åˆ°çš„æ˜¯æœ€ç»ˆä¸€è‡´çš„ UIã€‚

```javascript
function Form() {
  const [name, setName] = useState('');
  const [email, setEmail] = useState('');
  const [isValid, setIsValid] = useState(false);

  function handleSubmit() {
    setName('Alice');
    setEmail('alice@example.com');
    setIsValid(true);
    // æ‰¹å¤„ç†ï¼šç”¨æˆ·åªçœ‹åˆ°æœ€ç»ˆå®Œæ•´çš„è¡¨å•çŠ¶æ€
    // ä¸ä¼šå…ˆçœ‹åˆ° name æ›´æ–°ï¼Œå†çœ‹åˆ° email æ›´æ–°ï¼Œå†çœ‹åˆ° isValid æ›´æ–°
  }
}
```

##### ä»·å€¼3ï¼šå¼€å‘è€…å¿ƒæ™ºæ¨¡å‹ç®€åŒ– ğŸ§ 

å¼€å‘è€…ä¸éœ€è¦æ‹…å¿ƒ"åœ¨å“ªé‡Œæ›´æ–°çŠ¶æ€ä¼šè§¦å‘å¤šæ¬¡æ¸²æŸ“"ï¼ŒReact è‡ªåŠ¨å¤„ç†ã€‚

```javascript
// React 17: éœ€è¦å°å¿ƒç¿¼ç¿¼
setTimeout(() => {
  setCount(1);
  setFlag(true); // âŒ ä¼šè§¦å‘ç¬¬2æ¬¡æ¸²æŸ“
}, 1000);

// React 18+: éšä¾¿å†™
setTimeout(() => {
  setCount(1);
  setFlag(true); // âœ… è‡ªåŠ¨æ‰¹å¤„ç†ï¼Œåªæ¸²æŸ“1æ¬¡
}, 1000);
```

#### 4. ä»ç¬¬ä¸€æ€§åŸç†æ¨å¯¼ React å®ç°

**æ¨ç†é“¾ï¼š**

```
1. å‰æï¼šReact çš„ setState æ˜¯å¼‚æ­¥çš„ï¼ˆè®¾è®¡é€‰æ‹©ï¼‰
   â†“
2. é—®é¢˜ï¼šå¦‚ä½•åˆ¤æ–­"ä¸€ç»„"æ›´æ–°åº”è¯¥æ‰¹é‡å¤„ç†ï¼Ÿ
   â†“
3. React 17 æ–¹æ¡ˆï¼šåªåœ¨äº‹ä»¶å¤„ç†å™¨ä¸­æ‰¹å¤„ç†ï¼ˆèŒƒå›´å¤ªçª„ï¼‰
   â†“
4. é™åˆ¶ï¼šsetTimeoutã€Promiseã€åŸç”Ÿäº‹ä»¶ç­‰æ— æ³•æ‰¹å¤„ç†
   â†“
5. React 18 æ–¹æ¡ˆï¼šå¼•å…¥è‡ªåŠ¨æ‰¹å¤„ç†æœºåˆ¶
   â†“
6. æ ¸å¿ƒæŠ€æœ¯ï¼šConcurrent æ¨¡å¼ + Lane ä¼˜å…ˆçº§æ¨¡å‹
   â†“
7. å®ç°ï¼šåˆ›å»ºä¸€ä¸ª"æ‰¹å¤„ç†ä¸Šä¸‹æ–‡"ï¼Œæ”¶é›†æ‰€æœ‰æ›´æ–°
   â†“
8. æ—¶æœºï¼šåœ¨å½“å‰æ‰§è¡Œæ ˆæ¸…ç©ºåï¼Œç»Ÿä¸€æäº¤æ›´æ–°
   â†“
9. React 18+ æ‰©å±•åˆ°æ‰€æœ‰åœºæ™¯ï¼ˆäº‹ä»¶ã€setTimeoutã€Promiseç­‰ï¼‰
   â†“
10. React 19.2 è¿›ä¸€æ­¥ä¼˜åŒ– SSR çš„ Suspense æ‰¹å¤„ç†
```

**ä¸ºä»€ä¹ˆ React 18 æ‰èƒ½å®ç°å…¨è‡ªåŠ¨æ‰¹å¤„ç†ï¼Ÿ**

- **Concurrent æ¸²æŸ“æ¶æ„**ï¼šReact 18 å¼•å…¥äº†å¯ä¸­æ–­çš„æ¸²æŸ“æœºåˆ¶
- **Lane ä¼˜å…ˆçº§æ¨¡å‹**ï¼šèƒ½å¤Ÿè·Ÿè¸ªå’Œç®¡ç†ä¸åŒæ¥æºçš„æ›´æ–°
- **createRoot API**ï¼šæ–°çš„æ ¹èŠ‚ç‚¹ API å¯ç”¨äº†å¹¶å‘ç‰¹æ€§
- **è°ƒåº¦å™¨å‡çº§**ï¼šèƒ½å¤Ÿåœ¨åˆé€‚çš„æ—¶æœºæ‰¹é‡æäº¤æ›´æ–°

#### 5. ä¸€å¥è¯æ€»ç»“ç¬¬ä¸€æ€§åŸç†

**è‡ªåŠ¨æ‰¹å¤„ç†æ˜¯é€šè¿‡è°ƒåº¦å™¨å°†å¤šä¸ªçŠ¶æ€æ›´æ–°åˆå¹¶ä¸ºä¸€æ¬¡æäº¤ï¼Œä»è€Œå‡å°‘æ¸²æŸ“æ¬¡æ•°çš„æ€§èƒ½ä¼˜åŒ–æœºåˆ¶ï¼Œæ˜¯ React å¹¶å‘æ¸²æŸ“æ¶æ„çš„é‡è¦æˆæœã€‚**

---

## ä¸‰ã€ã€3ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‘

### æ ¸å¿ƒæ¦‚å¿µ1ï¼šæ‰¹å¤„ç†é˜Ÿåˆ—ï¼ˆBatching Queueï¼‰ ğŸ“¦

**æ‰¹å¤„ç†é˜Ÿåˆ—æ˜¯ React å†…éƒ¨ç”¨äºæ”¶é›†çŠ¶æ€æ›´æ–°çš„æ•°æ®ç»“æ„ï¼Œåœ¨é€‚å½“æ—¶æœºç»Ÿä¸€å¤„ç†ã€‚**

```javascript
// ===== ç®€åŒ–å®ç°ï¼šæ‰¹å¤„ç†é˜Ÿåˆ—åŸç† =====
class SimpleBatchQueue {
  constructor() {
    this.updates = [];      // å¾…å¤„ç†çš„æ›´æ–°é˜Ÿåˆ—
    this.isBatching = false; // æ˜¯å¦æ­£åœ¨æ‰¹å¤„ç†
  }

  // æ·»åŠ æ›´æ–°åˆ°é˜Ÿåˆ—
  scheduleUpdate(update) {
    this.updates.push(update);

    if (!this.isBatching) {
      this.isBatching = true;
      // ç­‰å¾…å½“å‰æ‰§è¡Œæ ˆæ¸…ç©ºåï¼Œç»Ÿä¸€å¤„ç†
      queueMicrotask(() => {
        this.flushUpdates();
      });
    }
  }

  // æ‰¹é‡å¤„ç†æ‰€æœ‰æ›´æ–°
  flushUpdates() {
    console.log(`æ‰¹å¤„ç† ${this.updates.length} ä¸ªæ›´æ–°`);

    // åˆå¹¶æ‰€æœ‰æ›´æ–°
    this.updates.forEach(update => update());

    // æ¸…ç©ºé˜Ÿåˆ—
    this.updates = [];
    this.isBatching = false;

    // åªè§¦å‘1æ¬¡æ¸²æŸ“
    console.log('è§¦å‘1æ¬¡é‡æ¸²æŸ“');
  }
}

// ===== ä½¿ç”¨ç¤ºä¾‹ =====
const queue = new SimpleBatchQueue();

console.log('=== å¼€å§‹æ‰§è¡Œäº‹ä»¶å¤„ç†å™¨ ===');
queue.scheduleUpdate(() => console.log('æ›´æ–° count'));
queue.scheduleUpdate(() => console.log('æ›´æ–° flag'));
queue.scheduleUpdate(() => console.log('æ›´æ–° text'));
console.log('=== äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œå®Œæ¯• ===');

// è¾“å‡ºï¼š
// === å¼€å§‹æ‰§è¡Œäº‹ä»¶å¤„ç†å™¨ ===
// === äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œå®Œæ¯• ===
// æ‰¹å¤„ç† 3 ä¸ªæ›´æ–°
// æ›´æ–° count
// æ›´æ–° flag
// æ›´æ–° text
// è§¦å‘1æ¬¡é‡æ¸²æŸ“
```

**è¯¦ç»†è§£é‡Šï¼š**

1. **æ”¶é›†é˜¶æ®µ**ï¼šå½“ä½ è°ƒç”¨ `setState` æ—¶ï¼Œæ›´æ–°è¢«æ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œä¸ç«‹å³æ‰§è¡Œ
2. **ç­‰å¾…æ‰§è¡Œæ ˆæ¸…ç©º**ï¼šä½¿ç”¨å¾®ä»»åŠ¡ï¼ˆmicrotaskï¼‰æœºåˆ¶ç­‰å¾…å½“å‰åŒæ­¥ä»£ç æ‰§è¡Œå®Œ
3. **æ‰¹é‡æäº¤**ï¼šä¸€æ¬¡æ€§å¤„ç†é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ›´æ–°
4. **è§¦å‘æ¸²æŸ“**ï¼šåˆå¹¶åçš„çŠ¶æ€å˜æ›´åªè§¦å‘ä¸€æ¬¡ç»„ä»¶é‡æ¸²æŸ“

**åœ¨ React æºç ä¸­çš„åº”ç”¨ï¼š**

React ä½¿ç”¨ Lane æ¨¡å‹ç®¡ç†æ‰¹å¤„ç†é˜Ÿåˆ—ï¼š

```javascript
// React æºç ç®€åŒ–ï¼ˆpackages/react-reconciler/src/ReactFiberWorkLoop.jsï¼‰
function ensureRootIsScheduled(root) {
  // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„æ›´æ–°
  const nextLanes = getNextLanes(root);

  if (nextLanes === NoLanes) {
    // æ²¡æœ‰æ›´æ–°ï¼Œä¸è°ƒåº¦
    return;
  }

  // å°†å¤šä¸ªæ›´æ–°åˆå¹¶åˆ°åŒä¸€ä¸ª Lane
  scheduleSyncCallback(performSyncWorkOnRoot.bind(null, root));
}
```

### æ ¸å¿ƒæ¦‚å¿µ2ï¼šè‡ªåŠ¨æ£€æµ‹æœºåˆ¶ï¼ˆAutomatic Detectionï¼‰ ğŸ”

**React 18+ èƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹æ‰€æœ‰æ¥æºçš„çŠ¶æ€æ›´æ–°å¹¶åº”ç”¨æ‰¹å¤„ç†ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„ã€‚**

```javascript
import { useState } from 'react';

// ===== React 17 vs React 18 å¯¹æ¯” =====
function React17Behavior() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);

  // âœ… React 17: äº‹ä»¶å¤„ç†å™¨ä¸­æ‰¹å¤„ç†
  const handleClick = () => {
    setCount(c => c + 1);
    setFlag(f => !f);
    // åªæ¸²æŸ“1æ¬¡
  };

  // âŒ React 17: setTimeout ä¸­ä¸æ‰¹å¤„ç†
  const handleDelayed = () => {
    setTimeout(() => {
      setCount(c => c + 1); // ç¬¬1æ¬¡æ¸²æŸ“
      setFlag(f => !f);     // ç¬¬2æ¬¡æ¸²æŸ“
    }, 1000);
  };

  // âŒ React 17: Promise ä¸­ä¸æ‰¹å¤„ç†
  const handleAsync = async () => {
    await fetch('/api');
    setCount(c => c + 1);   // ç¬¬1æ¬¡æ¸²æŸ“
    setFlag(f => !f);       // ç¬¬2æ¬¡æ¸²æŸ“
  };

  return <div>React 17 è¡Œä¸º</div>;
}

function React18Behavior() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);

  // âœ… React 18: äº‹ä»¶å¤„ç†å™¨ä¸­æ‰¹å¤„ç†
  const handleClick = () => {
    setCount(c => c + 1);
    setFlag(f => !f);
    // åªæ¸²æŸ“1æ¬¡
  };

  // âœ… React 18: setTimeout ä¸­è‡ªåŠ¨æ‰¹å¤„ç†
  const handleDelayed = () => {
    setTimeout(() => {
      setCount(c => c + 1);
      setFlag(f => !f);
      // åªæ¸²æŸ“1æ¬¡ ğŸ‰
    }, 1000);
  };

  // âœ… React 18: Promise ä¸­è‡ªåŠ¨æ‰¹å¤„ç†
  const handleAsync = async () => {
    await fetch('/api');
    setCount(c => c + 1);
    setFlag(f => !f);
    // åªæ¸²æŸ“1æ¬¡ ğŸ‰
  };

  // âœ… React 18: åŸç”Ÿäº‹ä»¶ä¸­è‡ªåŠ¨æ‰¹å¤„ç†
  const handleNative = () => {
    document.addEventListener('custom', () => {
      setCount(c => c + 1);
      setFlag(f => !f);
      // åªæ¸²æŸ“1æ¬¡ ğŸ‰
    });
  };

  return <div>React 18 è¡Œä¸º</div>;
}
```

**è‡ªåŠ¨æ£€æµ‹çš„è¦†ç›–èŒƒå›´ï¼š**

| åœºæ™¯ | React 17 | React 18+ |
|------|---------|-----------|
| React äº‹ä»¶å¤„ç†å™¨ (`onClick`) | âœ… æ‰¹å¤„ç† | âœ… æ‰¹å¤„ç† |
| `setTimeout` / `setInterval` | âŒ ä¸æ‰¹å¤„ç† | âœ… æ‰¹å¤„ç† |
| Promise / async-await | âŒ ä¸æ‰¹å¤„ç† | âœ… æ‰¹å¤„ç† |
| åŸç”Ÿäº‹ä»¶ (`addEventListener`) | âŒ ä¸æ‰¹å¤„ç† | âœ… æ‰¹å¤„ç† |
| `fetch` å›è°ƒ | âŒ ä¸æ‰¹å¤„ç† | âœ… æ‰¹å¤„ç† |

**åœ¨ React æºç ä¸­çš„åº”ç”¨ï¼š**

React 18 é€šè¿‡ `createRoot` å¯ç”¨è‡ªåŠ¨æ‰¹å¤„ç†ï¼š

```javascript
// React 17 (æ—§ API)
import ReactDOM from 'react-dom';
ReactDOM.render(<App />, document.getElementById('root'));
// åªåœ¨äº‹ä»¶å¤„ç†å™¨ä¸­æ‰¹å¤„ç†

// React 18+ (æ–° API)
import { createRoot } from 'react-dom/client';
const root = createRoot(document.getElementById('root'));
root.render(<App />);
// æ‰€æœ‰åœºæ™¯éƒ½è‡ªåŠ¨æ‰¹å¤„ç†
```

### æ ¸å¿ƒæ¦‚å¿µ3ï¼šæ‰¹å¤„ç†è¾¹ç•Œï¼ˆBatching Boundaryï¼‰ ğŸš§

**æ‰¹å¤„ç†åªåœ¨åŒä¸€ä¸ªæ‰§è¡Œæ ˆä¸­æœ‰æ•ˆï¼Œä¸åŒæ‰§è¡Œæ ˆçš„æ›´æ–°ä¼šåˆ†åˆ«æ‰¹å¤„ç†ã€‚**

```javascript
import { useState } from 'react';

function BatchingBoundary() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);

  console.log('=== ç»„ä»¶æ¸²æŸ“ ===');

  // ===== åœºæ™¯1ï¼šåŒä¸€æ‰§è¡Œæ ˆ â†’ æ‰¹å¤„ç† =====
  const handleSameStack = () => {
    console.log('å¼€å§‹æ›´æ–°');
    setCount(c => c + 1);   // åœ¨åŒä¸€æ‰§è¡Œæ ˆ
    setFlag(f => !f);       // åœ¨åŒä¸€æ‰§è¡Œæ ˆ
    console.log('æ›´æ–°ç»“æŸ');
    // åªæ¸²æŸ“1æ¬¡
  };

  // ===== åœºæ™¯2ï¼šä¸åŒæ‰§è¡Œæ ˆ â†’ åˆ†åˆ«æ‰¹å¤„ç† =====
  const handleDifferentStacks = () => {
    console.log('ç¬¬1ä¸ªæ‰§è¡Œæ ˆ');
    setCount(c => c + 1);
    setFlag(f => !f);
    // æ¸²æŸ“1æ¬¡

    setTimeout(() => {
      console.log('ç¬¬2ä¸ªæ‰§è¡Œæ ˆ');
      setCount(c => c + 1);
      setFlag(f => !f);
      // å†æ¸²æŸ“1æ¬¡
    }, 0);
  };

  // ===== åœºæ™¯3ï¼šå¤šä¸ª setTimeout â†’ å„è‡ªæ‰¹å¤„ç† =====
  const handleMultipleTimeouts = () => {
    // æ‰§è¡Œæ ˆ1
    setTimeout(() => {
      setCount(1);
      setFlag(true);
      // æ¸²æŸ“1æ¬¡
    }, 100);

    // æ‰§è¡Œæ ˆ2
    setTimeout(() => {
      setCount(2);
      setFlag(false);
      // å†æ¸²æŸ“1æ¬¡
    }, 200);
  };

  return (
    <div>
      <p>Count: {count}, Flag: {flag ? 'true' : 'false'}</p>
      <button onClick={handleSameStack}>åŒä¸€æ‰§è¡Œæ ˆ</button>
      <button onClick={handleDifferentStacks}>ä¸åŒæ‰§è¡Œæ ˆ</button>
      <button onClick={handleMultipleTimeouts}>å¤šä¸ª setTimeout</button>
    </div>
  );
}
```

**æ‰¹å¤„ç†è¾¹ç•Œçš„åˆ¤æ–­è§„åˆ™ï¼š**

```
åŒä¸€æ‰§è¡Œæ ˆï¼š
  âœ… setCount(1)
  âœ… setFlag(true)
  âœ… setText('updated')
  â†’ æ‰¹å¤„ç† â†’ 1æ¬¡æ¸²æŸ“

ä¸åŒæ‰§è¡Œæ ˆï¼š
  æ‰§è¡Œæ ˆ1: setCount(1) + setFlag(true) â†’ 1æ¬¡æ¸²æŸ“
  æ‰§è¡Œæ ˆ2: setCount(2) + setFlag(false) â†’ 1æ¬¡æ¸²æŸ“
```

**åœ¨ React æºç /å¼€å‘ä¸­çš„åº”ç”¨ï¼š**

ç†è§£æ‰¹å¤„ç†è¾¹ç•Œå¯ä»¥å¸®åŠ©ä½ é¢„æµ‹æ¸²æŸ“æ¬¡æ•°ï¼š

```javascript
function DataFetcher() {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  async function fetchData() {
    // æ‰§è¡Œæ ˆ1ï¼šå¼€å§‹åŠ è½½
    setLoading(true);
    setError(null);
    // æ¸²æŸ“1æ¬¡

    try {
      const response = await fetch('/api'); // â¬…ï¸ await åˆ‡æ¢æ‰§è¡Œæ ˆ
      const json = await response.json();

      // æ‰§è¡Œæ ˆ2ï¼šåŠ è½½æˆåŠŸ
      setData(json);
      setLoading(false);
      // æ¸²æŸ“1æ¬¡
    } catch (err) {
      // æ‰§è¡Œæ ˆ3ï¼šåŠ è½½å¤±è´¥
      setError(err.message);
      setLoading(false);
      // æ¸²æŸ“1æ¬¡
    }
  }

  // æ€»å…±æœ€å¤šæ¸²æŸ“3æ¬¡ï¼ˆæ¯ä¸ª await åˆ‡æ¢äº†æ‰§è¡Œæ ˆï¼‰
}
```

---

## å››ã€ã€æœ€å°å¯ç”¨ã€‘

æŒæ¡ä»¥ä¸‹å†…å®¹ï¼Œå°±èƒ½ç†è§£ React è‡ªåŠ¨æ‰¹å¤„ç†çš„æ ¸å¿ƒï¼š

### 4.1 æ ¸å¿ƒå˜åŒ–ï¼šReact 17 â†’ React 18+

**React 17 åŠä¹‹å‰ï¼š** åªåœ¨ React äº‹ä»¶å¤„ç†å™¨ä¸­æ‰¹å¤„ç†

```javascript
// React 17
function App() {
  const [count, setCount] = useState(0);

  // âœ… æ‰¹å¤„ç†
  const handleClick = () => {
    setCount(1);
    setCount(2);
    // åªæ¸²æŸ“1æ¬¡
  };

  // âŒ ä¸æ‰¹å¤„ç†
  const handleAsync = () => {
    setTimeout(() => {
      setCount(1); // æ¸²æŸ“1æ¬¡
      setCount(2); // æ¸²æŸ“2æ¬¡
    }, 0);
  };
}
```

**React 18+ (ä½¿ç”¨ createRoot)ï¼š** æ‰€æœ‰åœºæ™¯éƒ½è‡ªåŠ¨æ‰¹å¤„ç†

```javascript
// React 18+
import { createRoot } from 'react-dom/client';

function App() {
  const [count, setCount] = useState(0);

  // âœ… æ‰¹å¤„ç†
  const handleClick = () => {
    setCount(1);
    setCount(2);
    // åªæ¸²æŸ“1æ¬¡
  };

  // âœ… ä¹Ÿæ‰¹å¤„ç†äº†
  const handleAsync = () => {
    setTimeout(() => {
      setCount(1);
      setCount(2);
      // åªæ¸²æŸ“1æ¬¡ ğŸ‰
    }, 0);
  };
}

// å¿…é¡»ä½¿ç”¨ createRoot å¯ç”¨è‡ªåŠ¨æ‰¹å¤„ç†
const root = createRoot(document.getElementById('root'));
root.render(<App />);
```

### 4.2 ä½¿ç”¨ flushSync é€€å‡ºæ‰¹å¤„ç†

åœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼Œå¦‚æœä½ éœ€è¦**å¼ºåˆ¶åŒæ­¥æ¸²æŸ“**ï¼Œå¯ä»¥ä½¿ç”¨ `flushSync`ï¼š

```javascript
import { flushSync } from 'react-dom';

function handleClick() {
  flushSync(() => {
    setCount(c => c + 1);
    // ç«‹å³æ¸²æŸ“ï¼ˆä¸ç­‰å¾…æ‰¹å¤„ç†ï¼‰
  });

  // DOM å·²ç»æ›´æ–°ï¼Œå¯ä»¥è¯»å–æœ€æ–°å€¼
  console.log(divRef.current.textContent); // æ–°çš„ count å€¼

  setFlag(f => !f); // è¿™ä¸ªä¼šæ­£å¸¸æ‰¹å¤„ç†
}
```

**ä½•æ—¶ä½¿ç”¨ `flushSync`ï¼š**
- éœ€è¦ç«‹å³è¯»å– DOM çš„æœ€æ–°çŠ¶æ€
- ç¬¬ä¸‰æ–¹åº“éœ€è¦åŒæ­¥çš„ DOM æ›´æ–°
- æµ‹é‡ DOM å°ºå¯¸ï¼ˆscrollHeightã€offsetWidth ç­‰ï¼‰

âš ï¸ **æ³¨æ„**ï¼š`flushSync` ä¼šæŸå®³æ€§èƒ½ï¼Œå°½é‡é¿å…ä½¿ç”¨ã€‚

### 4.3 React 19.2 çš„ SSR Suspense æ‰¹å¤„ç†

React 19.2 è¿›ä¸€æ­¥ä¼˜åŒ–äº†æœåŠ¡ç«¯æ¸²æŸ“çš„ Suspense æ‰¹å¤„ç†ï¼š

```javascript
// React 19.2 ä¹‹å‰ï¼šSuspense è¾¹ç•Œé€ä¸ªæ˜¾ç¤º
<Suspense fallback={<Loading />}>
  <Component1 /> {/* æ•°æ®åˆ°è¾¾ â†’ æ˜¾ç¤º1 */}
</Suspense>
<Suspense fallback={<Loading />}>
  <Component2 /> {/* æ•°æ®åˆ°è¾¾ â†’ æ˜¾ç¤º2 */}
</Suspense>

// React 19.2ï¼šSuspense è¾¹ç•Œæ‰¹é‡æ˜¾ç¤º
// å¦‚æœ Component1 å’Œ Component2 çš„æ•°æ®å‡ ä¹åŒæ—¶åˆ°è¾¾
// React ä¼šç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œå°†å®ƒä»¬ä¸€èµ·æ˜¾ç¤º
// å‡å°‘é¡µé¢é—ªçƒï¼ŒåŠ¨ç”»æ›´æµç•…
```

**è¿™äº›çŸ¥è¯†è¶³ä»¥ï¼š**
- ç†è§£ React 17 vs 18+ çš„æ‰¹å¤„ç†å·®å¼‚
- çŸ¥é“ä½•æ—¶ä½¿ç”¨ `createRoot` å¯ç”¨è‡ªåŠ¨æ‰¹å¤„ç†
- äº†è§£ `flushSync` çš„ä½¿ç”¨åœºæ™¯
- ä¸ºå­¦ä¹  React å¹¶å‘æ¸²æŸ“æ‰“ä¸‹åŸºç¡€

---

## äº”ã€ã€1ä¸ªç±»æ¯”ã€‘

### ç±»æ¯”1ï¼šæ‰“åŒ…å¿«é€’ ğŸ“¦

**React æ‰¹å¤„ç† = å¿«é€’å…¬å¸æ‰“åŒ…å‘è´§**

æƒ³è±¡ä½ åœ¨ç½‘ä¸Šä¹°äº†å¾ˆå¤šä¸œè¥¿ï¼Œåˆ†åˆ«ä¸‹äº† 5 ä¸ªè®¢å•ï¼š

**æ²¡æœ‰æ‰¹å¤„ç†ï¼ˆReact 17 çš„ setTimeoutï¼‰ï¼š**
- ç¬¬1ä¸ªè®¢å•åˆ°ä»“åº“ â†’ ç«‹å³å‘è´§ï¼ˆç¬¬1æ¬¡ç‰©æµï¼‰
- ç¬¬2ä¸ªè®¢å•åˆ°ä»“åº“ â†’ ç«‹å³å‘è´§ï¼ˆç¬¬2æ¬¡ç‰©æµï¼‰
- ç¬¬3ä¸ªè®¢å•åˆ°ä»“åº“ â†’ ç«‹å³å‘è´§ï¼ˆç¬¬3æ¬¡ç‰©æµï¼‰
- ...
- å¿«é€’å‘˜è¦è·‘ 5 æ¬¡ï¼Œæˆæœ¬é«˜ï¼Œæ•ˆç‡ä½

**æœ‰æ‰¹å¤„ç†ï¼ˆReact 18+ï¼‰ï¼š**
- ç¬¬1ä¸ªè®¢å•åˆ°ä»“åº“ â†’ æš‚å­˜
- ç¬¬2ä¸ªè®¢å•åˆ°ä»“åº“ â†’ æš‚å­˜
- ç¬¬3ä¸ªè®¢å•åˆ°ä»“åº“ â†’ æš‚å­˜
- ç­‰æ‰€æœ‰è®¢å•éƒ½åˆ°é½ï¼ˆåŒä¸€æ‰§è¡Œæ ˆï¼‰
- æ‰“åŒ…åœ¨ä¸€èµ·å‘è´§ï¼ˆåªè·‘1æ¬¡ï¼‰
- æˆæœ¬ä½ï¼Œæ•ˆç‡é«˜ï¼Œç”¨æˆ·ä½“éªŒå¥½

```javascript
// æ²¡æœ‰æ‰¹å¤„ç† = æ¯ä¸ªè®¢å•å•ç‹¬å‘è´§
function handleClick() {
  setOrder1('å·²å‘è´§'); // å¿«é€’1
  setOrder2('å·²å‘è´§'); // å¿«é€’2
  setOrder3('å·²å‘è´§'); // å¿«é€’3
  // å¿«é€’å‘˜è·‘äº† 3 æ¬¡
}

// æœ‰æ‰¹å¤„ç† = è®¢å•æ‰“åŒ…ä¸€èµ·å‘è´§
function handleClick() {
  setOrder1('å·²å‘è´§'); // æš‚å­˜
  setOrder2('å·²å‘è´§'); // æš‚å­˜
  setOrder3('å·²å‘è´§'); // æš‚å­˜
  // æ‰“åŒ… â†’ å¿«é€’å‘˜åªè·‘ 1 æ¬¡
}
```

---

### ç±»æ¯”2ï¼šå…¬äº¤è½¦å‘è½¦ ğŸšŒ

**React æ‰¹å¤„ç† = å…¬äº¤è½¦ç­‰ä¹˜å®¢ä¸Šé½å†å‘è½¦**

**æ²¡æœ‰æ‰¹å¤„ç†ï¼š**
- æ¥1ä¸ªä¹˜å®¢ â†’ ç«‹å³å‘è½¦
- æ¥1ä¸ªä¹˜å®¢ â†’ ç«‹å³å‘è½¦
- ç»“æœï¼šè½¦è¾†åˆ©ç”¨ç‡ä½ï¼Œæ²¹è´¹æµªè´¹

**æœ‰æ‰¹å¤„ç†ï¼š**
- æ¥1ä¸ªä¹˜å®¢ â†’ ç­‰å¾…
- æ¥1ä¸ªä¹˜å®¢ â†’ ç­‰å¾…
- æ¥1ä¸ªä¹˜å®¢ â†’ ç­‰å¾…
- ç­‰ä¸€æ®µæ—¶é—´ï¼ˆåŒä¸€æ‰§è¡Œæ ˆï¼‰
- ä¸€èµ·å‘è½¦
- ç»“æœï¼šè½¦è¾†åˆ©ç”¨ç‡é«˜ï¼ŒèŠ‚çœèµ„æº

```javascript
// æ²¡æœ‰æ‰¹å¤„ç† = æ¥ä¸€ä¸ªèµ°ä¸€ä¸ª
setPassenger1('ä¸Šè½¦'); // å‘è½¦1æ¬¡
setPassenger2('ä¸Šè½¦'); // å‘è½¦1æ¬¡
setPassenger3('ä¸Šè½¦'); // å‘è½¦1æ¬¡

// æœ‰æ‰¹å¤„ç† = ç­‰ä¹˜å®¢ä¸Šé½ä¸€èµ·èµ°
setPassenger1('ä¸Šè½¦'); // ç­‰å¾…
setPassenger2('ä¸Šè½¦'); // ç­‰å¾…
setPassenger3('ä¸Šè½¦'); // ç­‰å¾…
// â†’ å‘è½¦1æ¬¡ï¼Œè½½ç€3ä¸ªä¹˜å®¢
```

---

### ç±»æ¯”3ï¼šé¤å…ä¸Šèœ ğŸ½ï¸

**React æ‰¹å¤„ç† = é¤å…èœé½äº†ä¸€èµ·ä¸Šæ¡Œ**

**æ²¡æœ‰æ‰¹å¤„ç†ï¼š**
- ç‚’å¥½1ä¸ªèœ â†’ ç«‹å³ä¸Šæ¡Œï¼ˆæœåŠ¡å‘˜è·‘1æ¬¡ï¼‰
- ç‚’å¥½1ä¸ªèœ â†’ ç«‹å³ä¸Šæ¡Œï¼ˆæœåŠ¡å‘˜è·‘1æ¬¡ï¼‰
- ç‚’å¥½1ä¸ªèœ â†’ ç«‹å³ä¸Šæ¡Œï¼ˆæœåŠ¡å‘˜è·‘1æ¬¡ï¼‰
- ç»“æœï¼šæœåŠ¡å‘˜ç´¯æ­»ï¼Œå®¢äººç­‰å¾…æ—¶é—´åˆ†æ•£

**æœ‰æ‰¹å¤„ç†ï¼š**
- ç‚’å¥½1ä¸ªèœ â†’ æš‚æ—¶æ”¾åœ¨å‡ºèœå£
- ç‚’å¥½1ä¸ªèœ â†’ æš‚æ—¶æ”¾åœ¨å‡ºèœå£
- ç‚’å¥½1ä¸ªèœ â†’ æš‚æ—¶æ”¾åœ¨å‡ºèœå£
- èœé½äº† â†’ æœåŠ¡å‘˜ç«¯ç€æ‰˜ç›˜ä¸€èµ·ä¸Šæ¡Œ
- ç»“æœï¼šæœåŠ¡å‘˜æ•ˆç‡é«˜ï¼Œå®¢äººä½“éªŒå¥½

```javascript
// æ²¡æœ‰æ‰¹å¤„ç† = åšä¸€ä¸ªä¸Šä¸€ä¸ª
setCourse1('å®Œæˆ'); // æœåŠ¡å‘˜è·‘1æ¬¡
setCourse2('å®Œæˆ'); // æœåŠ¡å‘˜è·‘1æ¬¡
setCourse3('å®Œæˆ'); // æœåŠ¡å‘˜è·‘1æ¬¡

// æœ‰æ‰¹å¤„ç† = èœé½äº†ä¸€èµ·ä¸Š
setCourse1('å®Œæˆ'); // æš‚æ—¶æ”¾å‡ºèœå£
setCourse2('å®Œæˆ'); // æš‚æ—¶æ”¾å‡ºèœå£
setCourse3('å®Œæˆ'); // æš‚æ—¶æ”¾å‡ºèœå£
// â†’ æ‰˜ç›˜ç«¯ä¸Šæ¡Œï¼ŒæœåŠ¡å‘˜åªè·‘1æ¬¡
```

---

### ç±»æ¯”4ï¼šé“¶è¡Œæ±‡æ€»äº¤æ˜“ ğŸ’°

**React æ‰¹å¤„ç† = é“¶è¡Œæ‰¹é‡å¤„ç†äº¤æ˜“**

**æ²¡æœ‰æ‰¹å¤„ç†ï¼š**
- æ”¶åˆ°1ç¬”è½¬è´¦ â†’ ç«‹å³æ›´æ–°è´¦æˆ·ä½™é¢ â†’ ç«‹å³å‘çŸ­ä¿¡
- æ”¶åˆ°1ç¬”è½¬è´¦ â†’ ç«‹å³æ›´æ–°è´¦æˆ·ä½™é¢ â†’ ç«‹å³å‘çŸ­ä¿¡
- ç»“æœï¼šç³»ç»Ÿå‹åŠ›å¤§ï¼ŒçŸ­ä¿¡è½°ç‚¸ç”¨æˆ·

**æœ‰æ‰¹å¤„ç†ï¼š**
- æ”¶åˆ°1ç¬”è½¬è´¦ â†’ è®°å½•
- æ”¶åˆ°1ç¬”è½¬è´¦ â†’ è®°å½•
- æ”¶åˆ°1ç¬”è½¬è´¦ â†’ è®°å½•
- æ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆå¦‚æ¯åˆ†é’Ÿï¼‰
- æ‰¹é‡æ›´æ–°è´¦æˆ·ä½™é¢
- å‘é€1æ¡æ±‡æ€»çŸ­ä¿¡ï¼š"æ‚¨æœ‰3ç¬”äº¤æ˜“ï¼Œä½™é¢1000å…ƒ"
- ç»“æœï¼šç³»ç»Ÿé«˜æ•ˆï¼Œç”¨æˆ·ä½“éªŒå¥½

```javascript
// æ²¡æœ‰æ‰¹å¤„ç† = æ¯ç¬”äº¤æ˜“ç«‹å³å¤„ç†
setBalance(balance + 100); // æ›´æ–° + å‘çŸ­ä¿¡
setBalance(balance + 200); // æ›´æ–° + å‘çŸ­ä¿¡
setBalance(balance + 50);  // æ›´æ–° + å‘çŸ­ä¿¡

// æœ‰æ‰¹å¤„ç† = äº¤æ˜“æ±‡æ€»åå¤„ç†
setBalance(balance + 100); // è®°å½•
setBalance(balance + 200); // è®°å½•
setBalance(balance + 50);  // è®°å½•
// â†’ æ‰¹é‡æ›´æ–° â†’ å‘é€1æ¡çŸ­ä¿¡
```

---

### ç±»æ¯”æ€»ç»“è¡¨

| React æ¦‚å¿µ | ç”Ÿæ´»åœºæ™¯ç±»æ¯” | ç›¸ä¼¼ç‚¹ |
|-----------|-------------|--------|
| çŠ¶æ€æ›´æ–° | å¿«é€’è®¢å• / ä¹˜å®¢ä¸Šè½¦ / èœå“å®Œæˆ | è§¦å‘ä¸€ä¸ªæ“ä½œ |
| æ‰¹å¤„ç†é˜Ÿåˆ— | ä»“åº“æš‚å­˜åŒº / å…¬äº¤ç«™å° / å‡ºèœå£ | ä¸´æ—¶æ”¶é›† |
| æ‰¹é‡æäº¤ | æ‰“åŒ…å‘è´§ / å‘è½¦ / ä¸Šèœ | ä¸€æ¬¡æ€§å¤„ç† |
| æ¸²æŸ“ | ç‰©æµé…é€ / è¡Œé©¶ / ç«¯èœ | æœ€ç»ˆå‘ˆç° |
| React 17 é™åˆ¶ | åªåœ¨ä»“åº“æ‰“åŒ…ï¼Œå…¶ä»–åœ°æ–¹å•ç‹¬å‘ | éƒ¨åˆ†æ‰¹å¤„ç† |
| React 18+ å¢å¼º | æ‰€æœ‰åœ°ç‚¹éƒ½æ‰“åŒ…å‘è´§ | å…¨è‡ªåŠ¨æ‰¹å¤„ç† |
| flushSync | åŠ æ€¥è®¢å•ç«‹å³å‘è´§ | å¼ºåˆ¶åŒæ­¥å¤„ç† |

---

## å…­ã€ã€åç›´è§‰ç‚¹ã€‘

### è¯¯åŒº1ï¼šæ‰¹å¤„ç†ä¼š"å»¶è¿Ÿ"çŠ¶æ€æ›´æ–° âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

æ‰¹å¤„ç†åªæ˜¯**å»¶è¿Ÿæ¸²æŸ“**ï¼Œè€Œä¸æ˜¯å»¶è¿ŸçŠ¶æ€æ›´æ–°ã€‚çŠ¶æ€ç«‹å³æ›´æ–°ï¼Œåªæ˜¯ UI å»¶è¿Ÿåæ˜ ã€‚

```javascript
function Counter() {
  const [count, setCount] = useState(0);

  const handleClick = () => {
    console.log('ç‚¹å‡»å‰:', count); // 0

    setCount(c => c + 1);
    console.log('è°ƒç”¨ setState å:', count); // è¿˜æ˜¯ 0ï¼ˆé—­åŒ…æ•è·çš„æ—§å€¼ï¼‰

    setCount(c => c + 1);
    console.log('å†æ¬¡è°ƒç”¨å:', count); // è¿˜æ˜¯ 0

    // ä½†æ˜¯ React å†…éƒ¨å·²ç»æ”¶é›†äº†2æ¬¡æ›´æ–°
    // ä¼šåœ¨æ‰¹å¤„ç†æ—¶åˆå¹¶ä¸º count = 2
  };

  console.log('æ¸²æŸ“æ—¶çš„ count:', count); // 2ï¼ˆä¸‹æ¬¡æ¸²æŸ“ï¼‰

  return <button onClick={handleClick}>{count}</button>;
}
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

å› ä¸º `setState` æ˜¯å¼‚æ­¥çš„ï¼Œå¾ˆå¤šäººä»¥ä¸º"æ‰¹å¤„ç†å¯¼è‡´å¼‚æ­¥"ï¼Œä½†å®é™…ä¸Šï¼š
- `setState` æœ¬èº«å°±æ˜¯å¼‚æ­¥çš„ï¼ˆReact çš„è®¾è®¡é€‰æ‹©ï¼‰
- æ‰¹å¤„ç†åªæ˜¯å†³å®š"ä½•æ—¶è§¦å‘æ¸²æŸ“"
- çŠ¶æ€æ—©å°±æ›´æ–°äº†ï¼Œåªæ˜¯ UI è¿˜æ²¡åˆ·æ–°

**æ­£ç¡®ç†è§£ï¼š**

```javascript
// âŒ é”™è¯¯ç†è§£ï¼šæ‰¹å¤„ç†è®©çŠ¶æ€æ›´æ–°å˜æ…¢äº†
setCount(1);    // çŠ¶æ€æ›´æ–°è¢«"å»¶è¿Ÿ"
setCount(2);    // çŠ¶æ€æ›´æ–°è¢«"å»¶è¿Ÿ"
// â†’ æ¸²æŸ“ï¼ˆå»¶è¿Ÿå¾ˆä¹…ï¼‰

// âœ… æ­£ç¡®ç†è§£ï¼šçŠ¶æ€ç«‹å³æ›´æ–°ï¼Œåªæ˜¯æ¸²æŸ“åˆå¹¶äº†
setCount(1);    // React å†…éƒ¨ç«‹å³è®°å½•ï¼šcount = 1
setCount(2);    // React å†…éƒ¨ç«‹å³è®°å½•ï¼šcount = 2
// â†’ æ‰¹é‡å¤„ç† â†’ åªæ¸²æŸ“1æ¬¡ï¼Œæ˜¾ç¤º count = 2
```

---

### è¯¯åŒº2ï¼šæ‰€æœ‰åœºæ™¯éƒ½ä¼šè‡ªåŠ¨æ‰¹å¤„ç† âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

è™½ç„¶ React 18+ æ‰©å±•äº†æ‰¹å¤„ç†èŒƒå›´ï¼Œä½†**ä¸æ˜¯æ‰€æœ‰åœºæ™¯éƒ½æ‰¹å¤„ç†**ã€‚å…³é”®åœ¨äºæ˜¯å¦åœ¨**åŒä¸€ä¸ªæ‰§è¡Œæ ˆ**ã€‚

```javascript
function App() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);

  // âœ… æ‰¹å¤„ç†ï¼ˆåŒä¸€æ‰§è¡Œæ ˆï¼‰
  const case1 = () => {
    setCount(1);
    setFlag(true);
    // åªæ¸²æŸ“1æ¬¡
  };

  // âŒ ä¸æ‰¹å¤„ç†ï¼ˆä¸åŒæ‰§è¡Œæ ˆï¼‰
  const case2 = () => {
    setCount(1);
    setFlag(true);
    // æ¸²æŸ“1æ¬¡

    setTimeout(() => {
      setCount(2);
      setFlag(false);
      // å†æ¸²æŸ“1æ¬¡ï¼ˆä¸åŒæ‰§è¡Œæ ˆï¼‰
    }, 0);
  };

  // âŒ ä¸æ‰¹å¤„ç†ï¼ˆå¤šä¸ªå¼‚æ­¥å›è°ƒï¼‰
  const case3 = async () => {
    setCount(1);
    setFlag(true);
    // æ¸²æŸ“1æ¬¡

    await fetch('/api1'); // await åˆ‡æ¢æ‰§è¡Œæ ˆ
    setCount(2);
    // æ¸²æŸ“1æ¬¡

    await fetch('/api2'); // å†æ¬¡åˆ‡æ¢æ‰§è¡Œæ ˆ
    setFlag(false);
    // å†æ¸²æŸ“1æ¬¡
  };
}
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

"è‡ªåŠ¨æ‰¹å¤„ç†"å¬èµ·æ¥åƒæ˜¯"å…¨è‡ªåŠ¨ã€æ— æ¡ä»¶"ï¼Œè®©äººè¯¯ä»¥ä¸ºï¼š
- ä»»ä½•æ—¶å€™è°ƒç”¨ `setState` éƒ½ä¼šæ‰¹å¤„ç†
- ä¸åŒçš„ `setTimeout` ä¹‹é—´ä¹Ÿä¼šæ‰¹å¤„ç†
- `async/await` çš„æ¯ä¸ªé˜¶æ®µéƒ½ä¼šåˆå¹¶

ä½†å®é™…ä¸Šï¼Œæ‰¹å¤„ç†çš„è¾¹ç•Œæ˜¯**æ‰§è¡Œæ ˆ**ï¼Œä¸åŒæ‰§è¡Œæ ˆæ— æ³•åˆå¹¶ã€‚

**æ­£ç¡®ç†è§£ï¼š**

```javascript
// âœ… åŒä¸€æ‰§è¡Œæ ˆ â†’ æ‰¹å¤„ç†
function sameStack() {
  setA(1);  // æ‰§è¡Œæ ˆ1
  setB(2);  // æ‰§è¡Œæ ˆ1
  setC(3);  // æ‰§è¡Œæ ˆ1
  // â†’ 1æ¬¡æ¸²æŸ“
}

// âŒ ä¸åŒæ‰§è¡Œæ ˆ â†’ åˆ†åˆ«æ‰¹å¤„ç†
function differentStacks() {
  // æ‰§è¡Œæ ˆ1
  setA(1);
  setB(2);
  // â†’ æ¸²æŸ“1æ¬¡

  setTimeout(() => {
    // æ‰§è¡Œæ ˆ2
    setC(3);
    setD(4);
    // â†’ å†æ¸²æŸ“1æ¬¡
  }, 0);
}
```

---

### è¯¯åŒº3ï¼šReact 17 ä¸æ”¯æŒæ‰¹å¤„ç† âŒ

**ä¸ºä»€ä¹ˆé”™ï¼Ÿ**

React 17 **æ”¯æŒæ‰¹å¤„ç†**ï¼Œåªæ˜¯**èŒƒå›´æœ‰é™**ï¼Œä»…åœ¨ React äº‹ä»¶å¤„ç†å™¨ä¸­æ‰¹å¤„ç†ã€‚

```javascript
// React 17

// âœ… æ”¯æŒæ‰¹å¤„ç†ï¼ˆReact äº‹ä»¶ï¼‰
function handleClick() {
  setCount(1);
  setFlag(true);
  // åªæ¸²æŸ“1æ¬¡
}

// âŒ ä¸æ”¯æŒæ‰¹å¤„ç†ï¼ˆsetTimeoutï¼‰
function handleAsync() {
  setTimeout(() => {
    setCount(1);  // æ¸²æŸ“1æ¬¡
    setFlag(true); // æ¸²æŸ“2æ¬¡
  }, 0);
}
```

**ä¸ºä»€ä¹ˆäººä»¬å®¹æ˜“è¿™æ ·é”™ï¼Ÿ**

å› ä¸º React 18 çš„å®£ä¼ é‡ç‚¹æ˜¯"è‡ªåŠ¨æ‰¹å¤„ç†"ï¼Œè®©äººè¯¯ä»¥ä¸ºï¼š
- React 17 å®Œå…¨æ²¡æœ‰æ‰¹å¤„ç†
- React 18 æ‰å‘æ˜äº†æ‰¹å¤„ç†æœºåˆ¶

ä½†å®é™…ä¸Šï¼š
- React 17 åœ¨äº‹ä»¶å¤„ç†å™¨ä¸­ä¸€ç›´æœ‰æ‰¹å¤„ç†
- React 18 åªæ˜¯**æ‰©å±•äº†é€‚ç”¨èŒƒå›´**ï¼ˆä»"éƒ¨åˆ†"åˆ°"å…¨éƒ¨"ï¼‰

**æ­£ç¡®ç†è§£ï¼š**

| åœºæ™¯ | React 17 | React 18+ |
|------|---------|-----------|
| React äº‹ä»¶å¤„ç†å™¨ | âœ… æ‰¹å¤„ç† | âœ… æ‰¹å¤„ç† |
| setTimeout | âŒ ä¸æ‰¹å¤„ç† | âœ… æ‰¹å¤„ç† |
| Promise | âŒ ä¸æ‰¹å¤„ç† | âœ… æ‰¹å¤„ç† |
| åŸç”Ÿäº‹ä»¶ | âŒ ä¸æ‰¹å¤„ç† | âœ… æ‰¹å¤„ç† |

**React 17 å¯ä»¥æ‰‹åŠ¨æ‰¹å¤„ç†ï¼š**

```javascript
import { unstable_batchedUpdates } from 'react-dom';

// React 17: æ‰‹åŠ¨æ‰¹å¤„ç†
setTimeout(() => {
  unstable_batchedUpdates(() => {
    setCount(1);
    setFlag(true);
    // åªæ¸²æŸ“1æ¬¡
  });
}, 0);
```

ä½†è¿™å¾ˆéº»çƒ¦ï¼ŒReact 18 è®©å®ƒå˜æˆäº†"è‡ªåŠ¨"ã€‚

---

## ä¸ƒã€ã€å®æˆ˜ä»£ç ã€‘

### å®æˆ˜åœºæ™¯1ï¼šReact 17 vs React 18 æ‰¹å¤„ç†å¯¹æ¯”

```javascript
import { useState } from 'react';

// ===== 1. React 17 çš„æ‰¹å¤„ç†é™åˆ¶ =====
function React17Demo() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);
  const [text, setText] = useState('initial');

  let renderCount = 0;
  console.log(`=== React 17 æ¸²æŸ“æ¬¡æ•°: ${++renderCount} ===`);

  // âœ… åœºæ™¯1ï¼šReact äº‹ä»¶å¤„ç†å™¨ï¼ˆæ‰¹å¤„ç†ï¼‰
  const handleReactEvent = () => {
    console.log('--- React äº‹ä»¶å¼€å§‹ ---');
    setCount(c => c + 1);
    setFlag(f => !f);
    setText('updated');
    console.log('--- React äº‹ä»¶ç»“æŸ ---');
    // åªæ¸²æŸ“1æ¬¡ âœ…
  };

  // âŒ åœºæ™¯2ï¼šsetTimeoutï¼ˆä¸æ‰¹å¤„ç†ï¼‰
  const handleTimeout = () => {
    setTimeout(() => {
      console.log('--- setTimeout å¼€å§‹ ---');
      setCount(c => c + 1);   // æ¸²æŸ“ç¬¬1æ¬¡
      setFlag(f => !f);       // æ¸²æŸ“ç¬¬2æ¬¡
      setText('timeout');     // æ¸²æŸ“ç¬¬3æ¬¡
      console.log('--- setTimeout ç»“æŸ ---');
      // æ¸²æŸ“3æ¬¡ âŒ
    }, 0);
  };

  // âŒ åœºæ™¯3ï¼šPromiseï¼ˆä¸æ‰¹å¤„ç†ï¼‰
  const handlePromise = () => {
    Promise.resolve().then(() => {
      console.log('--- Promise å¼€å§‹ ---');
      setCount(c => c + 1);   // æ¸²æŸ“ç¬¬1æ¬¡
      setFlag(f => !f);       // æ¸²æŸ“ç¬¬2æ¬¡
      setText('promise');     // æ¸²æŸ“ç¬¬3æ¬¡
      console.log('--- Promise ç»“æŸ ---');
      // æ¸²æŸ“3æ¬¡ âŒ
    });
  };

  return (
    <div>
      <h3>React 17 è¡Œä¸º</h3>
      <p>Count: {count}, Flag: {String(flag)}, Text: {text}</p>
      <button onClick={handleReactEvent}>React äº‹ä»¶ï¼ˆæ‰¹å¤„ç†ï¼‰</button>
      <button onClick={handleTimeout}>setTimeoutï¼ˆä¸æ‰¹å¤„ç†ï¼‰</button>
      <button onClick={handlePromise}>Promiseï¼ˆä¸æ‰¹å¤„ç†ï¼‰</button>
    </div>
  );
}

// ===== 2. React 18 çš„è‡ªåŠ¨æ‰¹å¤„ç† =====
function React18Demo() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);
  const [text, setText] = useState('initial');

  let renderCount = 0;
  console.log(`=== React 18 æ¸²æŸ“æ¬¡æ•°: ${++renderCount} ===`);

  // âœ… åœºæ™¯1ï¼šReact äº‹ä»¶å¤„ç†å™¨ï¼ˆæ‰¹å¤„ç†ï¼‰
  const handleReactEvent = () => {
    console.log('--- React äº‹ä»¶å¼€å§‹ ---');
    setCount(c => c + 1);
    setFlag(f => !f);
    setText('updated');
    console.log('--- React äº‹ä»¶ç»“æŸ ---');
    // åªæ¸²æŸ“1æ¬¡ âœ…
  };

  // âœ… åœºæ™¯2ï¼šsetTimeoutï¼ˆè‡ªåŠ¨æ‰¹å¤„ç†ï¼‰
  const handleTimeout = () => {
    setTimeout(() => {
      console.log('--- setTimeout å¼€å§‹ ---');
      setCount(c => c + 1);
      setFlag(f => !f);
      setText('timeout');
      console.log('--- setTimeout ç»“æŸ ---');
      // åªæ¸²æŸ“1æ¬¡ âœ… (React 18 æ”¹è¿›)
    }, 0);
  };

  // âœ… åœºæ™¯3ï¼šPromiseï¼ˆè‡ªåŠ¨æ‰¹å¤„ç†ï¼‰
  const handlePromise = () => {
    Promise.resolve().then(() => {
      console.log('--- Promise å¼€å§‹ ---');
      setCount(c => c + 1);
      setFlag(f => !f);
      setText('promise');
      console.log('--- Promise ç»“æŸ ---');
      // åªæ¸²æŸ“1æ¬¡ âœ… (React 18 æ”¹è¿›)
    });
  };

  // âœ… åœºæ™¯4ï¼šasync/awaitï¼ˆè‡ªåŠ¨æ‰¹å¤„ç†ï¼‰
  const handleAsync = async () => {
    // æ‰§è¡Œæ ˆ1
    console.log('--- async ç¬¬1é˜¶æ®µ ---');
    setCount(c => c + 1);
    setFlag(f => !f);
    // æ¸²æŸ“1æ¬¡

    await new Promise(resolve => setTimeout(resolve, 100));

    // æ‰§è¡Œæ ˆ2
    console.log('--- async ç¬¬2é˜¶æ®µ ---');
    setText('async');
    setCount(c => c + 1);
    // å†æ¸²æŸ“1æ¬¡
  };

  // âœ… åœºæ™¯5ï¼šåŸç”Ÿäº‹ä»¶ï¼ˆè‡ªåŠ¨æ‰¹å¤„ç†ï¼‰
  const handleNativeEvent = () => {
    document.getElementById('custom-btn')?.addEventListener('click', () => {
      console.log('--- åŸç”Ÿäº‹ä»¶å¼€å§‹ ---');
      setCount(c => c + 1);
      setFlag(f => !f);
      setText('native');
      console.log('--- åŸç”Ÿäº‹ä»¶ç»“æŸ ---');
      // åªæ¸²æŸ“1æ¬¡ âœ… (React 18 æ”¹è¿›)
    });
  };

  return (
    <div>
      <h3>React 18 è¡Œä¸º</h3>
      <p>Count: {count}, Flag: {String(flag)}, Text: {text}</p>
      <button onClick={handleReactEvent}>React äº‹ä»¶ï¼ˆæ‰¹å¤„ç†ï¼‰</button>
      <button onClick={handleTimeout}>setTimeoutï¼ˆæ‰¹å¤„ç†ï¼‰</button>
      <button onClick={handlePromise}>Promiseï¼ˆæ‰¹å¤„ç†ï¼‰</button>
      <button onClick={handleAsync}>async/awaitï¼ˆæ‰¹å¤„ç†ï¼‰</button>
      <button id="custom-btn" onClick={handleNativeEvent}>
        åŸç”Ÿäº‹ä»¶ï¼ˆæ‰¹å¤„ç†ï¼‰
      </button>
    </div>
  );
}
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼ˆReact 17ï¼‰ï¼š**

```
ç‚¹å‡» "setTimeout" æŒ‰é’®ï¼š
=== React 17 æ¸²æŸ“æ¬¡æ•°: 1 ===
--- setTimeout å¼€å§‹ ---
--- setTimeout ç»“æŸ ---
=== React 17 æ¸²æŸ“æ¬¡æ•°: 2 ===
=== React 17 æ¸²æŸ“æ¬¡æ•°: 3 ===
=== React 17 æ¸²æŸ“æ¬¡æ•°: 4 ===
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼ˆReact 18ï¼‰ï¼š**

```
ç‚¹å‡» "setTimeout" æŒ‰é’®ï¼š
=== React 18 æ¸²æŸ“æ¬¡æ•°: 1 ===
--- setTimeout å¼€å§‹ ---
--- setTimeout ç»“æŸ ---
=== React 18 æ¸²æŸ“æ¬¡æ•°: 2 ===  // åªæ¸²æŸ“1æ¬¡
```

---

### å®æˆ˜åœºæ™¯2ï¼šä½¿ç”¨ flushSync é€€å‡ºæ‰¹å¤„ç†

```javascript
import { useState, useRef } from 'react';
import { flushSync } from 'react-dom';

function FlushSyncDemo() {
  const [count, setCount] = useState(0);
  const [text, setText] = useState('initial');
  const divRef = useRef(null);

  let renderCount = 0;
  console.log(`=== æ¸²æŸ“æ¬¡æ•°: ${++renderCount} ===`);

  // ===== åœºæ™¯1ï¼šæ­£å¸¸æ‰¹å¤„ç† =====
  const handleNormal = () => {
    console.log('--- å¼€å§‹æ›´æ–° ---');

    setCount(c => c + 1);
    setText('updated');

    // âŒ æ­¤æ—¶ DOM è¿˜æ²¡æ›´æ–°ï¼Œè¯»å–çš„æ˜¯æ—§å€¼
    console.log('DOM å†…å®¹:', divRef.current?.textContent);
    console.log('--- æ›´æ–°ç»“æŸ ---');
    // åªæ¸²æŸ“1æ¬¡
  };

  // ===== åœºæ™¯2ï¼šä½¿ç”¨ flushSync å¼ºåˆ¶åŒæ­¥ =====
  const handleFlushSync = () => {
    console.log('--- å¼€å§‹æ›´æ–° ---');

    flushSync(() => {
      setCount(c => c + 1);
      // ç«‹å³æ¸²æŸ“ï¼ˆä¸ç­‰å¾…æ‰¹å¤„ç†ï¼‰
    });

    // âœ… æ­¤æ—¶ DOM å·²æ›´æ–°ï¼Œå¯ä»¥è¯»å–æœ€æ–°å€¼
    console.log('DOM å†…å®¹:', divRef.current?.textContent);

    setText('flushed');
    // è¿™ä¸ªä¼šæ­£å¸¸æ‰¹å¤„ç†

    console.log('--- æ›´æ–°ç»“æŸ ---');
    // æ€»å…±æ¸²æŸ“2æ¬¡ï¼šflushSync è§¦å‘1æ¬¡ + åç»­æ‰¹å¤„ç†1æ¬¡
  };

  // ===== åœºæ™¯3ï¼šæµ‹é‡ DOM å°ºå¯¸ =====
  const handleMeasure = () => {
    flushSync(() => {
      setText('å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿å¾ˆé•¿çš„æ–‡æœ¬');
    });

    // âœ… ç«‹å³è¯»å–æœ€æ–°çš„ DOM å°ºå¯¸
    const height = divRef.current?.offsetHeight;
    console.log('å…ƒç´ é«˜åº¦:', height);

    setCount(c => c + 1);
  };

  return (
    <div>
      <h3>flushSync ç¤ºä¾‹</h3>
      <div ref={divRef}>
        Count: {count}, Text: {text}
      </div>
      <button onClick={handleNormal}>æ­£å¸¸æ‰¹å¤„ç†</button>
      <button onClick={handleFlushSync}>ä½¿ç”¨ flushSync</button>
      <button onClick={handleMeasure}>æµ‹é‡ DOM</button>
    </div>
  );
}
```

**è¿è¡Œè¾“å‡ºç¤ºä¾‹ï¼š**

```
ç‚¹å‡» "æ­£å¸¸æ‰¹å¤„ç†" æŒ‰é’®ï¼š
--- å¼€å§‹æ›´æ–° ---
DOM å†…å®¹: Count: 0, Text: initial  // è¯»å–çš„æ˜¯æ—§å€¼
--- æ›´æ–°ç»“æŸ ---
=== æ¸²æŸ“æ¬¡æ•°: 2 ===  // åªæ¸²æŸ“1æ¬¡

ç‚¹å‡» "ä½¿ç”¨ flushSync" æŒ‰é’®ï¼š
--- å¼€å§‹æ›´æ–° ---
=== æ¸²æŸ“æ¬¡æ•°: 3 ===  // flushSync ç«‹å³è§¦å‘æ¸²æŸ“
DOM å†…å®¹: Count: 1, Text: initial  // è¯»å–çš„æ˜¯æ–°å€¼
--- æ›´æ–°ç»“æŸ ---
=== æ¸²æŸ“æ¬¡æ•°: 4 ===  // åç»­æ‰¹å¤„ç†å†æ¸²æŸ“1æ¬¡
```

---

### å®æˆ˜åœºæ™¯3ï¼šReact 19.2 çš„ SSR Suspense æ‰¹å¤„ç†ï¼ˆæ¦‚å¿µæ¼”ç¤ºï¼‰

```javascript
// ===== React 19.2 ä¹‹å‰çš„è¡Œä¸º =====
function OldSSRBehavior() {
  return (
    <div>
      {/* Suspense è¾¹ç•Œ1ï¼šæ•°æ®åˆ°è¾¾ â†’ ç«‹å³æ˜¾ç¤º */}
      <Suspense fallback={<Loading />}>
        <UserProfile userId={1} />
      </Suspense>

      {/* Suspense è¾¹ç•Œ2ï¼šæ•°æ®åˆ°è¾¾ â†’ ç«‹å³æ˜¾ç¤ºï¼ˆé—ªçƒï¼‰*/}
      <Suspense fallback={<Loading />}>
        <UserPosts userId={1} />
      </Suspense>

      {/* Suspense è¾¹ç•Œ3ï¼šæ•°æ®åˆ°è¾¾ â†’ ç«‹å³æ˜¾ç¤ºï¼ˆé—ªçƒï¼‰*/}
      <Suspense fallback={<Loading />}>
        <UserComments userId={1} />
      </Suspense>
    </div>
  );
}

// ===== React 19.2 çš„ä¼˜åŒ–è¡Œä¸º =====
function NewSSRBehavior() {
  return (
    <div>
      {/*
        å¦‚æœ UserProfileã€UserPostsã€UserComments çš„æ•°æ®
        åœ¨çŸ­æ—¶é—´å†…ï¼ˆå¦‚ 50msï¼‰ç›¸ç»§åˆ°è¾¾ï¼Œ
        React 19.2 ä¼šæ‰¹é‡æ˜¾ç¤ºå®ƒä»¬ï¼Œ
        è€Œä¸æ˜¯é€ä¸ªæ˜¾ç¤ºé€ æˆé—ªçƒ
      */}
      <Suspense fallback={<Loading />}>
        <UserProfile userId={1} />
      </Suspense>

      <Suspense fallback={<Loading />}>
        <UserPosts userId={1} />
      </Suspense>

      <Suspense fallback={<Loading />}>
        <UserComments userId={1} />
      </Suspense>
    </div>
  );
}

// ===== æ•°æ®è·å–ç¤ºä¾‹ =====
async function fetchUserProfile(userId) {
  // æ¨¡æ‹Ÿï¼š100ms åè¿”å›æ•°æ®
  await new Promise(resolve => setTimeout(resolve, 100));
  return { name: 'Alice', email: 'alice@example.com' };
}

async function fetchUserPosts(userId) {
  // æ¨¡æ‹Ÿï¼š120ms åè¿”å›æ•°æ®
  await new Promise(resolve => setTimeout(resolve, 120));
  return [{ id: 1, title: 'Post 1' }];
}

async function fetchUserComments(userId) {
  // æ¨¡æ‹Ÿï¼š110ms åè¿”å›æ•°æ®
  await new Promise(resolve => setTimeout(resolve, 110));
  return [{ id: 1, text: 'Comment 1' }];
}

// React 19.2 æ‰¹å¤„ç†é€»è¾‘ï¼ˆç®€åŒ–ï¼‰ï¼š
// 1. UserProfile æ•°æ®åˆ°è¾¾ï¼ˆ100msï¼‰
// 2. UserComments æ•°æ®åˆ°è¾¾ï¼ˆ110msï¼‰â†’ ç­‰å¾…æ‰¹å¤„ç†
// 3. UserPosts æ•°æ®åˆ°è¾¾ï¼ˆ120msï¼‰â†’ ç­‰å¾…æ‰¹å¤„ç†
// 4. ä¸€èµ·æ˜¾ç¤º3ä¸ªç»„ä»¶ï¼ˆå‡å°‘é—ªçƒï¼‰
```

---

### å®Œæ•´å¯è¿è¡Œç¤ºä¾‹ï¼ˆåœ¨ React 18+ ç¯å¢ƒï¼‰

```javascript
import React, { useState } from 'react';
import { createRoot } from 'react-dom/client';

function AutoBatchingDemo() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);
  const [text, setText] = useState('initial');

  console.log('=== ç»„ä»¶æ¸²æŸ“ ===');

  const handleBatching = () => {
    console.log('å¼€å§‹æ›´æ–°');
    setCount(c => c + 1);
    setFlag(f => !f);
    setText('batched');
    console.log('æ›´æ–°ç»“æŸ');
    // åªä¼šçœ‹åˆ°1æ¬¡"ç»„ä»¶æ¸²æŸ“"
  };

  const handleTimeout = () => {
    setTimeout(() => {
      console.log('setTimeout å¼€å§‹');
      setCount(c => c + 1);
      setFlag(f => !f);
      setText('timeout');
      console.log('setTimeout ç»“æŸ');
      // React 18: åªä¼šçœ‹åˆ°1æ¬¡"ç»„ä»¶æ¸²æŸ“"
      // React 17: ä¼šçœ‹åˆ°3æ¬¡"ç»„ä»¶æ¸²æŸ“"
    }, 1000);
  };

  return (
    <div style={{ padding: '20px' }}>
      <h1>React è‡ªåŠ¨æ‰¹å¤„ç†æ¼”ç¤º</h1>
      <div style={{ margin: '20px 0', padding: '10px', background: '#f0f0f0' }}>
        <p><strong>Count:</strong> {count}</p>
        <p><strong>Flag:</strong> {String(flag)}</p>
        <p><strong>Text:</strong> {text}</p>
      </div>
      <button onClick={handleBatching} style={{ marginRight: '10px' }}>
        åŒæ­¥æ‰¹å¤„ç†
      </button>
      <button onClick={handleTimeout}>
        å¼‚æ­¥æ‰¹å¤„ç†ï¼ˆ1ç§’åï¼‰
      </button>
      <p style={{ marginTop: '20px', color: '#666' }}>
        æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹æ¸²æŸ“æ¬¡æ•°
      </p>
    </div>
  );
}

// React 18+ ä½¿ç”¨ createRoot å¯ç”¨è‡ªåŠ¨æ‰¹å¤„ç†
const root = createRoot(document.getElementById('root'));
root.render(<AutoBatchingDemo />);
```

---

## å…«ã€ã€é¢è¯•å¿…é—®ã€‘

### é—®é¢˜1ï¼š"React 18 çš„è‡ªåŠ¨æ‰¹å¤„ç†å’Œ React 17 æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"React 18 çš„è‡ªåŠ¨æ‰¹å¤„ç†å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹æ‰¹å¤„ç†çŠ¶æ€æ›´æ–°ï¼ŒReact 17 åªèƒ½åœ¨äº‹ä»¶å¤„ç†å™¨ä¸­æ‰¹å¤„ç†ã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **React 18 çš„è‡ªåŠ¨æ‰¹å¤„ç†æœ‰ä¸‰ä¸ªå…³é”®æ”¹è¿›ï¼š**
>
> 1. **è¦†ç›–èŒƒå›´æ‰©å±•**ï¼š
>    - React 17ï¼šåªåœ¨ React åˆæˆäº‹ä»¶å¤„ç†å™¨ä¸­æ‰¹å¤„ç†
>    - React 18ï¼šæ‰©å±•åˆ°æ‰€æœ‰åœºæ™¯ï¼ˆsetTimeoutã€Promiseã€async/awaitã€åŸç”Ÿäº‹ä»¶ç­‰ï¼‰
>    - åŸå› ï¼šReact 18 å¼•å…¥äº†æ–°çš„å¹¶å‘æ¸²æŸ“æ¶æ„å’Œ Lane ä¼˜å…ˆçº§æ¨¡å‹ï¼Œèƒ½å¤Ÿè·Ÿè¸ªæ‰€æœ‰æ¥æºçš„æ›´æ–°
>
> 2. **å¯ç”¨æ–¹å¼æ”¹å˜**ï¼š
>    - React 17ï¼šåœ¨éäº‹ä»¶å¤„ç†å™¨åœºæ™¯éœ€è¦æ‰‹åŠ¨ä½¿ç”¨ `unstable_batchedUpdates`
>    - React 18ï¼šå®Œå…¨è‡ªåŠ¨ï¼Œåªéœ€ä½¿ç”¨ `createRoot` æ›¿ä»£ `ReactDOM.render`
>    - ç¤ºä¾‹ï¼š
>    ```javascript
>    // React 17 æ‰‹åŠ¨æ‰¹å¤„ç†
>    import { unstable_batchedUpdates } from 'react-dom';
>    setTimeout(() => {
>      unstable_batchedUpdates(() => {
>        setCount(1);
>        setFlag(true);
>      });
>    }, 0);
>
>    // React 18 è‡ªåŠ¨æ‰¹å¤„ç†
>    setTimeout(() => {
>      setCount(1);
>      setFlag(true);
>      // è‡ªåŠ¨æ‰¹å¤„ç†ï¼Œæ— éœ€æ‰‹åŠ¨åŒ…è£¹
>    }, 0);
>    ```
>
> 3. **æ€§èƒ½æ”¶ç›Š**ï¼š
>    - React 17ï¼šå¼‚æ­¥æ“ä½œä¸­çš„å¤šæ¬¡ setState ä¼šè§¦å‘å¤šæ¬¡æ¸²æŸ“ï¼Œæµªè´¹æ€§èƒ½
>    - React 18ï¼šå‡å°‘äº†æ¸²æŸ“æ¬¡æ•°ï¼Œå…¸å‹åœºæ™¯ä¸‹å¯å‡å°‘ 50% ä»¥ä¸Šçš„æ— æ•ˆæ¸²æŸ“
>    - å®é™…æ¡ˆä¾‹ï¼šåœ¨æ•°æ®è·å–åœºæ™¯ä¸­ï¼Œ`setLoading(true)` + `setError(null)` + `setData(result)` ä»3æ¬¡æ¸²æŸ“ä¼˜åŒ–åˆ°1æ¬¡
>
> **åº•å±‚åŸç†ï¼š**
>
> React 18 çš„å¹¶å‘æ¸²æŸ“æ¶æ„ä½¿ç”¨äº†**Lane ä¼˜å…ˆçº§æ¨¡å‹**å’Œ**è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰**ï¼š
> - Lane æ¨¡å‹ï¼šç”¨äºŒè¿›åˆ¶ä½æ ‡è®°æ›´æ–°ä¼˜å…ˆçº§ï¼Œèƒ½å¤Ÿæ‰¹é‡å¤„ç†ç›¸åŒä¼˜å…ˆçº§çš„æ›´æ–°
> - è°ƒåº¦å™¨ï¼šåœ¨å¾®ä»»åŠ¡ï¼ˆmicrotaskï¼‰é˜Ÿåˆ—ä¸­ç»Ÿä¸€æäº¤æ›´æ–°ï¼Œè€Œä¸æ˜¯ç«‹å³æ‰§è¡Œ
> - æ‰¹å¤„ç†è¾¹ç•Œï¼šä»¥æ‰§è¡Œæ ˆä¸ºè¾¹ç•Œï¼ŒåŒä¸€æ‰§è¡Œæ ˆä¸­çš„æ›´æ–°ä¼šè¢«æ”¶é›†å¹¶æ‰¹é‡å¤„ç†
>
> **å®é™…å·¥ä½œä¸­çš„åº”ç”¨ï¼š**
>
> åœ¨å¤„ç†å¤æ‚è¡¨å•ã€æ•°æ®è·å–ã€å®æ—¶æ›´æ–°ç­‰åœºæ™¯æ—¶ï¼ŒReact 18 çš„è‡ªåŠ¨æ‰¹å¤„ç†æ˜¾è‘—æ”¹å–„äº†æ€§èƒ½ï¼š
> - è¡¨å•æäº¤ï¼šå¤šä¸ªå­—æ®µçš„æ ¡éªŒçŠ¶æ€æ›´æ–°ä¸€æ¬¡æ€§åæ˜ 
> - WebSocket å®æ—¶æ•°æ®ï¼šæ‰¹é‡æ›´æ–°å¤šä¸ªçŠ¶æ€è€Œä¸é—ªçƒ
> - æœç´¢è¿‡æ»¤ï¼šè¾“å…¥+è¿‡æ»¤+æ’åºä¸€æ¬¡æ€§å®Œæˆ

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**

1. âœ… **å¤šå±‚æ¬¡è§£é‡Š**ï¼šä»èŒƒå›´ã€å¯ç”¨æ–¹å¼ã€æ€§èƒ½æ”¶ç›Šä¸‰ä¸ªç»´åº¦å¯¹æ¯”
2. âœ… **åŸç†æ·±å…¥**ï¼šæåˆ°äº† Lane æ¨¡å‹ã€è°ƒåº¦å™¨ã€å¹¶å‘æ¸²æŸ“ç­‰åº•å±‚æœºåˆ¶
3. âœ… **ä»£ç ç¤ºä¾‹**ï¼šå±•ç¤ºäº†å®é™…çš„ä»£ç å·®å¼‚
4. âœ… **å®é™…åº”ç”¨**ï¼šè”ç³»åˆ°è¡¨å•ã€WebSocketã€æœç´¢ç­‰çœŸå®åœºæ™¯

---

### é—®é¢˜2ï¼š"ä»€ä¹ˆæ—¶å€™éœ€è¦ä½¿ç”¨ flushSync é€€å‡ºæ‰¹å¤„ç†ï¼Ÿ"

**æ™®é€šå›ç­”ï¼ˆâŒ ä¸å‡ºå½©ï¼‰ï¼š**

"å½“ä½ éœ€è¦ç«‹å³è¯»å– DOM çš„æœ€æ–°å€¼æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ flushSyncã€‚"

**å‡ºå½©å›ç­”ï¼ˆâœ… æ¨èï¼‰ï¼š**

> **flushSync çš„ä½¿ç”¨åœºæ™¯æœ‰ä¸‰ç±»ï¼š**
>
> 1. **éœ€è¦ç«‹å³è¯»å– DOM çŠ¶æ€**ï¼š
>    ```javascript
>    import { flushSync } from 'react-dom';
>
>    function ScrollToBottom() {
>      const listRef = useRef(null);
>      const [messages, setMessages] = useState([]);
>
>      const addMessage = (msg) => {
>        flushSync(() => {
>          setMessages(prev => [...prev, msg]);
>          // ç«‹å³æ¸²æŸ“ï¼Œç¡®ä¿ DOM æ›´æ–°
>        });
>
>        // âœ… æ­¤æ—¶å¯ä»¥è¯»å–æœ€æ–°çš„ scrollHeight
>        listRef.current.scrollTop = listRef.current.scrollHeight;
>      };
>    }
>    ```
>
> 2. **ç¬¬ä¸‰æ–¹åº“éœ€è¦åŒæ­¥ DOM æ›´æ–°**ï¼š
>    - å›¾è¡¨åº“ï¼ˆChart.jsã€D3.jsï¼‰éœ€è¦åœ¨ DOM æ›´æ–°åç«‹å³æµ‹é‡å°ºå¯¸
>    - æ‹–æ‹½åº“ï¼ˆreact-dndï¼‰éœ€è¦åŒæ­¥ DOM ä½ç½®è®¡ç®—
>    - åŠ¨ç”»åº“éœ€è¦ç«‹å³è¯»å–å…ƒç´ ä½ç½®è§¦å‘åŠ¨ç”»
>
> 3. **æµè§ˆå™¨ API éœ€è¦æœ€æ–° DOM**ï¼š
>    ```javascript
>    const measureElement = () => {
>      flushSync(() => {
>        setText('æ–°çš„å¾ˆé•¿çš„æ–‡æœ¬...');
>      });
>
>      // âœ… ç«‹å³è¯»å–æœ€æ–°çš„å°ºå¯¸
>      const { offsetWidth, offsetHeight } = divRef.current;
>      console.log('å…ƒç´ å°ºå¯¸:', offsetWidth, offsetHeight);
>    };
>    ```
>
> **é‡è¦æ³¨æ„äº‹é¡¹ï¼š**
>
> - **æ€§èƒ½æŸå¤±**ï¼šflushSync ä¼šé˜»æ­¢æ‰¹å¤„ç†ï¼Œå¼ºåˆ¶åŒæ­¥æ¸²æŸ“ï¼ŒæŸå®³æ€§èƒ½
> - **è°¨æ…ä½¿ç”¨**ï¼š99% çš„æƒ…å†µä¸éœ€è¦ flushSyncï¼Œåªåœ¨ä¸Šè¿°åœºæ™¯ä½¿ç”¨
> - **æ›¿ä»£æ–¹æ¡ˆ**ï¼š
>   - ä¼˜å…ˆè€ƒè™‘ `useLayoutEffect`ï¼ˆåœ¨ DOM æ›´æ–°åã€æµè§ˆå™¨ç»˜åˆ¶å‰æ‰§è¡Œï¼‰
>   - ä½¿ç”¨ `useEffect` + ä¾èµ–é¡¹ï¼ˆåœ¨æ¸²æŸ“åå¼‚æ­¥æ‰§è¡Œï¼‰
>   - ä½¿ç”¨ ref å›è°ƒï¼ˆ`<div ref={node => measureNode(node)} />`ï¼‰
>
> **ä¸æ‰¹å¤„ç†çš„å…³ç³»ï¼š**
>
> ```javascript
> function handleClick() {
>   // æ‰¹å¤„ç†ï¼šæ”¶é›†æ›´æ–°
>   setCount(1);
>   setFlag(true);
>
>   flushSync(() => {
>     setText('sync');
>     // ç«‹å³æ¸²æŸ“ï¼ˆç»•è¿‡æ‰¹å¤„ç†ï¼‰
>   });
>
>   // DOM å·²æ›´æ–°ï¼Œå¯ä»¥è¯»å–
>   console.log(divRef.current.textContent);
>
>   setName('Alice');
>   // è¿™ä¸ªä¼šç»§ç»­æ‰¹å¤„ç†
> }
> ```
>
> **åœ¨ React æºç ä¸­çš„å®ç°ï¼š**
>
> `flushSync` é€šè¿‡è®¾ç½® `DiscreteEventPriority`ï¼ˆç¦»æ•£äº‹ä»¶ä¼˜å…ˆçº§ï¼‰å¼ºåˆ¶åŒæ­¥æäº¤æ›´æ–°ï¼š
> ```javascript
> // React æºç ç®€åŒ–
> function flushSync(callback) {
>   const previousPriority = getCurrentUpdatePriority();
>   try {
>     setCurrentUpdatePriority(DiscreteEventPriority);
>     callback();
>     flushSyncWork(); // ç«‹å³åˆ·æ–°å·¥ä½œ
>   } finally {
>     setCurrentUpdatePriority(previousPriority);
>   }
> }
> ```

**ä¸ºä»€ä¹ˆè¿™ä¸ªå›ç­”å‡ºå½©ï¼Ÿ**

1. âœ… **å…·ä½“åœºæ™¯**ï¼šåˆ—ä¸¾äº† DOM è¯»å–ã€ç¬¬ä¸‰æ–¹åº“ã€æµè§ˆå™¨ API ä¸‰ç±»å…¸å‹åœºæ™¯
2. âœ… **ä»£ç ç¤ºä¾‹**ï¼šæä¾›äº†å®é™…å¯ç”¨çš„ä»£ç ç‰‡æ®µ
3. âœ… **æ³¨æ„äº‹é¡¹**ï¼šå¼ºè°ƒäº†æ€§èƒ½æŸå¤±å’Œæ›¿ä»£æ–¹æ¡ˆ
4. âœ… **æºç è”ç³»**ï¼šç®€è¦è¯´æ˜äº†åº•å±‚å®ç°æœºåˆ¶

---

## ä¹ã€ã€åŒ–éª¨ç»µæŒã€‘

### å¡ç‰‡1ï¼šç›´è§‰ç†è§£ - æ‰¹å¤„ç†æ˜¯ä»€ä¹ˆï¼Ÿ ğŸ¯

**ä¸€å¥è¯ï¼š** æ‰¹å¤„ç†å°±æ˜¯"æ”’ç€ä¸€èµ·åš"ï¼Œè€Œä¸æ˜¯"æ¥ä¸€ä¸ªåšä¸€ä¸ª"ã€‚

**ä¸¾ä¾‹ï¼š**

æƒ³è±¡ä½ åœ¨æ•´ç†ä¹¦æ¶ï¼Œè¦æŠŠ 10 æœ¬ä¹¦æ”¾å›å»ï¼š
- âŒ æ²¡æœ‰æ‰¹å¤„ç†ï¼šæ‹¿1æœ¬ â†’ èµ°åˆ°ä¹¦æ¶ â†’ æ”¾å›å» â†’ å›æ¥æ‹¿ç¬¬2æœ¬ â†’ èµ°åˆ°ä¹¦æ¶...ï¼ˆèµ°10æ¬¡ï¼‰
- âœ… æœ‰æ‰¹å¤„ç†ï¼šæ‹¿10æœ¬ä¹¦ â†’ èµ°åˆ°ä¹¦æ¶ä¸€æ¬¡ â†’ å…¨éƒ¨æ”¾å›å»ï¼ˆèµ°1æ¬¡ï¼‰

React æ‰¹å¤„ç†åŒç†ï¼š
```javascript
// æ²¡æœ‰æ‰¹å¤„ç†ï¼šæ¸²æŸ“3æ¬¡
setCount(1);    // æ¸²æŸ“
setFlag(true);  // æ¸²æŸ“
setText('hi');  // æ¸²æŸ“

// æœ‰æ‰¹å¤„ç†ï¼šæ¸²æŸ“1æ¬¡
setCount(1);    // æš‚å­˜
setFlag(true);  // æš‚å­˜
setText('hi');  // æš‚å­˜ â†’ æ‰¹é‡æäº¤ â†’ æ¸²æŸ“1æ¬¡
```

**åº”ç”¨ï¼š** å‡å°‘æ¸²æŸ“æ¬¡æ•° = æå‡æ€§èƒ½ + ç”¨æˆ·ä½“éªŒæ›´æµç•…

---

### å¡ç‰‡2ï¼šReact 17 vs 18 çš„æ‰¹å¤„ç†èŒƒå›´ ğŸ“Š

**ä¸€å¥è¯ï¼š** React 17 åªåœ¨äº‹ä»¶å¤„ç†å™¨ä¸­æ‰¹å¤„ç†ï¼ŒReact 18 æ‰©å±•åˆ°æ‰€æœ‰åœºæ™¯ã€‚

**å¯¹æ¯”è¡¨ï¼š**

| åœºæ™¯ | React 17 | React 18+ |
|------|---------|-----------|
| onClick ç­‰äº‹ä»¶ | âœ… | âœ… |
| setTimeout | âŒ | âœ… |
| Promise | âŒ | âœ… |
| async/await | âŒ | âœ… |
| åŸç”Ÿäº‹ä»¶ | âŒ | âœ… |

**å…³é”®ä»£ç ï¼š**

```javascript
// React 18 å¿…é¡»ä½¿ç”¨ createRoot å¯ç”¨
import { createRoot } from 'react-dom/client';
const root = createRoot(document.getElementById('root'));
root.render(<App />);
```

**åº”ç”¨ï¼š** React 18 é¡¹ç›®ä¸­ï¼Œæ‰€æœ‰ setState éƒ½ä¼šè‡ªåŠ¨æ‰¹å¤„ç†ï¼Œæ— éœ€æ‰‹åŠ¨ä¼˜åŒ–

---

### å¡ç‰‡3ï¼šæ‰¹å¤„ç†é˜Ÿåˆ—åŸç† ğŸ“¦

**ä¸€å¥è¯ï¼š** React å°†å¤šä¸ªçŠ¶æ€æ›´æ–°æ”¶é›†åˆ°é˜Ÿåˆ—ï¼Œç­‰æ‰§è¡Œæ ˆæ¸…ç©ºåä¸€æ¬¡æ€§å¤„ç†ã€‚

**ç®€åŒ–å®ç°ï¼š**

```javascript
const updateQueue = [];
let isBatching = false;

function scheduleUpdate(update) {
  updateQueue.push(update); // æ”¶é›†æ›´æ–°

  if (!isBatching) {
    isBatching = true;
    queueMicrotask(() => {
      // ç­‰æ‰§è¡Œæ ˆæ¸…ç©ºåå¤„ç†
      updateQueue.forEach(u => u());
      updateQueue.length = 0;
      isBatching = false;
      render(); // åªæ¸²æŸ“1æ¬¡
    });
  }
}
```

**åº”ç”¨ï¼š** ç†è§£é˜Ÿåˆ—æœºåˆ¶å¯ä»¥é¢„æµ‹æ¸²æŸ“æ—¶æœº

---

### å¡ç‰‡4ï¼šæ‰¹å¤„ç†è¾¹ç•Œ - æ‰§è¡Œæ ˆ ğŸš§

**ä¸€å¥è¯ï¼š** æ‰¹å¤„ç†çš„è¾¹ç•Œæ˜¯æ‰§è¡Œæ ˆï¼Œä¸åŒæ‰§è¡Œæ ˆæ— æ³•åˆå¹¶ã€‚

**ä¸¾ä¾‹ï¼š**

```javascript
// åŒä¸€æ‰§è¡Œæ ˆ â†’ æ‰¹å¤„ç†
function sameStack() {
  setA(1);  // æ‰§è¡Œæ ˆ1
  setB(2);  // æ‰§è¡Œæ ˆ1
  // æ¸²æŸ“1æ¬¡
}

// ä¸åŒæ‰§è¡Œæ ˆ â†’ åˆ†åˆ«æ‰¹å¤„ç†
function differentStacks() {
  setA(1);  // æ‰§è¡Œæ ˆ1 â†’ æ¸²æŸ“1æ¬¡

  setTimeout(() => {
    setB(2);  // æ‰§è¡Œæ ˆ2 â†’ å†æ¸²æŸ“1æ¬¡
  }, 0);
}
```

**åº”ç”¨ï¼š** awaitã€setTimeout ä¼šåˆ‡æ¢æ‰§è¡Œæ ˆï¼Œå¯¼è‡´å¤šæ¬¡æ¸²æŸ“

---

### å¡ç‰‡5ï¼šflushSync - å¼ºåˆ¶åŒæ­¥æ¸²æŸ“ âš¡

**ä¸€å¥è¯ï¼š** flushSync è®©æ›´æ–°ç«‹å³æ¸²æŸ“ï¼Œç»•è¿‡æ‰¹å¤„ç†ã€‚

**ä½¿ç”¨åœºæ™¯ï¼š**

```javascript
import { flushSync } from 'react-dom';

function ScrollList() {
  const listRef = useRef(null);

  const addItem = (item) => {
    flushSync(() => {
      setItems(prev => [...prev, item]);
      // ç«‹å³æ¸²æŸ“
    });

    // âœ… DOM å·²æ›´æ–°ï¼Œå¯ä»¥è¯»å–æœ€æ–° scrollHeight
    listRef.current.scrollTop = listRef.current.scrollHeight;
  };
}
```

**åº”ç”¨ï¼š** åªåœ¨éœ€è¦ç«‹å³è¯»å– DOM æ—¶ä½¿ç”¨ï¼Œå¦åˆ™æŸå®³æ€§èƒ½

---

### å¡ç‰‡6ï¼šReact 19.2 çš„ SSR Suspense æ‰¹å¤„ç† ğŸŒ

**ä¸€å¥è¯ï¼š** React 19.2 ä¼˜åŒ–äº†æœåŠ¡ç«¯æ¸²æŸ“çš„ Suspense è¾¹ç•Œæ‰¹é‡æ˜¾ç¤ºã€‚

**æ”¹è¿›ç‚¹ï¼š**

```javascript
// ä¹‹å‰ï¼šSuspense è¾¹ç•Œé€ä¸ªæ˜¾ç¤ºï¼ˆé—ªçƒï¼‰
<Suspense><Component1 /></Suspense> // æ•°æ®åˆ°è¾¾ â†’ æ˜¾ç¤º
<Suspense><Component2 /></Suspense> // æ•°æ®åˆ°è¾¾ â†’ æ˜¾ç¤º

// React 19.2ï¼šSuspense è¾¹ç•Œæ‰¹é‡æ˜¾ç¤º
// å¦‚æœæ•°æ®åœ¨çŸ­æ—¶é—´å†…åˆ°è¾¾ï¼Œä¸€èµ·æ˜¾ç¤º
// å‡å°‘é—ªçƒï¼ŒåŠ¨ç”»æ›´æµç•…
```

**åº”ç”¨ï¼š** SSR åº”ç”¨ä¸­ï¼Œå¤šä¸ª Suspense è¾¹ç•Œçš„å†…å®¹ä¼šæ›´å¹³æ»‘åœ°å‘ˆç°

---

### å¡ç‰‡7ï¼šæ‰¹å¤„ç† vs é˜²æŠ–èŠ‚æµ ğŸ”„

**ä¸€å¥è¯ï¼š** æ‰¹å¤„ç†æ˜¯"åˆå¹¶æ¸²æŸ“"ï¼Œé˜²æŠ–èŠ‚æµæ˜¯"å»¶è¿Ÿæ‰§è¡Œ"ï¼Œç›®çš„ä¸åŒã€‚

**å¯¹æ¯”ï¼š**

| ç‰¹æ€§ | æ‰¹å¤„ç† | é˜²æŠ–/èŠ‚æµ |
|------|--------|----------|
| ç›®çš„ | å‡å°‘æ¸²æŸ“æ¬¡æ•° | å‡å°‘å‡½æ•°è°ƒç”¨æ¬¡æ•° |
| æ—¶æœº | è‡ªåŠ¨ï¼ˆReact ç®¡ç†ï¼‰ | æ‰‹åŠ¨ï¼ˆå¼€å‘è€…æ§åˆ¶ï¼‰ |
| å»¶è¿Ÿ | å¾®ä»»åŠ¡ï¼ˆæçŸ­ï¼‰ | å¯é…ç½®ï¼ˆå¦‚300msï¼‰ |
| é€‚ç”¨åœºæ™¯ | setState | æœç´¢ã€æ»šåŠ¨ã€resize |

**ä¸¾ä¾‹ï¼š**

```javascript
// æ‰¹å¤„ç†ï¼šåˆå¹¶çŠ¶æ€æ›´æ–°
setCount(1);
setCount(2);
setCount(3);
// â†’ åªæ¸²æŸ“1æ¬¡ï¼Œæ˜¾ç¤º count = 3

// é˜²æŠ–ï¼šå»¶è¿Ÿæ‰§è¡Œå‡½æ•°
const debouncedSearch = debounce(search, 300);
input.addEventListener('input', debouncedSearch);
// â†’ åœæ­¢è¾“å…¥300msåæ‰æ‰§è¡Œæœç´¢
```

**åº”ç”¨ï¼š** æ‰¹å¤„ç†å’Œé˜²æŠ–å¯ä»¥åŒæ—¶ä½¿ç”¨ï¼Œç›¸äº’è¡¥å……

---

### å¡ç‰‡8ï¼šæ€§èƒ½æ”¶ç›Šåˆ†æ âš¡

**ä¸€å¥è¯ï¼š** æ‰¹å¤„ç†å¯å‡å°‘ 50%+ çš„æ— æ•ˆæ¸²æŸ“ï¼Œæ˜¾è‘—æå‡æ€§èƒ½ã€‚

**å®æµ‹æ•°æ®ï¼ˆå‡è®¾åœºæ™¯ï¼‰ï¼š**

```javascript
// æ•°æ®è·å–åœºæ™¯
async function fetchData() {
  setLoading(true);
  setError(null);
  setData(null);
  // React 17: 3æ¬¡æ¸²æŸ“
  // React 18: 1æ¬¡æ¸²æŸ“

  const result = await fetch('/api');

  setLoading(false);
  setData(result);
  // React 17: 2æ¬¡æ¸²æŸ“
  // React 18: 1æ¬¡æ¸²æŸ“
}

// æ€»æ¸²æŸ“æ¬¡æ•°ï¼š
// React 17: 5æ¬¡
// React 18: 2æ¬¡
// æ€§èƒ½æå‡: 60%
```

**åº”ç”¨ï¼š** åœ¨é¢‘ç¹æ›´æ–°çŠ¶æ€çš„åœºæ™¯ï¼ˆå¦‚å®æ—¶æ•°æ®ã€è¡¨å•ï¼‰æ”¶ç›Šæœ€å¤§

---

### å¡ç‰‡9ï¼šReact æºç ä¸­çš„æ‰¹å¤„ç† ğŸ”§

**ä¸€å¥è¯ï¼š** React ä½¿ç”¨ Lane æ¨¡å‹å’Œè°ƒåº¦å™¨å®ç°è‡ªåŠ¨æ‰¹å¤„ç†ã€‚

**æ ¸å¿ƒæ¦‚å¿µï¼š**

1. **Lane ä¼˜å…ˆçº§æ¨¡å‹**ï¼šç”¨äºŒè¿›åˆ¶ä½æ ‡è®°æ›´æ–°ä¼˜å…ˆçº§
2. **è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰**ï¼šåœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰¹é‡æäº¤æ›´æ–°
3. **batchedUpdates ä¸Šä¸‹æ–‡**ï¼šæ ‡è®°å½“å‰æ˜¯å¦åœ¨æ‰¹å¤„ç†ä¸­

**ç®€åŒ–æºç ï¼š**

```javascript
// packages/react-reconciler/src/ReactFiberWorkLoop.js
function ensureRootIsScheduled(root) {
  const nextLanes = getNextLanes(root);

  if (nextLanes === NoLanes) return;

  // å°†å¤šä¸ªæ›´æ–°åˆå¹¶åˆ°åŒä¸€ä¸ª Lane
  scheduleSyncCallback(performSyncWorkOnRoot.bind(null, root));
}
```

**åº”ç”¨ï¼š** ç†è§£æºç æœ‰åŠ©äºæ·±å…¥æŒæ¡ React å¹¶å‘æœºåˆ¶

---

### å¡ç‰‡10ï¼šæœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹ âœ…

**ä¸€å¥è¯ï¼š** ä¿¡ä»»è‡ªåŠ¨æ‰¹å¤„ç†ï¼Œé¿å…è¿‡åº¦ä¼˜åŒ–å’Œè¯¯ç”¨ flushSyncã€‚

**æœ€ä½³å®è·µï¼š**

1. âœ… **ä½¿ç”¨ createRoot**ï¼šå¯ç”¨ React 18 çš„è‡ªåŠ¨æ‰¹å¤„ç†
   ```javascript
   import { createRoot } from 'react-dom/client';
   const root = createRoot(document.getElementById('root'));
   root.render(<App />);
   ```

2. âœ… **ä¿¡ä»»æ‰¹å¤„ç†**ï¼šä¸éœ€è¦æ‰‹åŠ¨åˆå¹¶ setState
   ```javascript
   // âœ… æ¨èï¼šç›´æ¥å†™
   setCount(1);
   setFlag(true);
   setText('hi');

   // âŒ ä¸æ¨èï¼šæ‰‹åŠ¨åˆå¹¶
   setState({ count: 1, flag: true, text: 'hi' });
   ```

3. âš ï¸ **è°¨æ…ä½¿ç”¨ flushSync**ï¼šåªåœ¨å¿…é¡»ç«‹å³è¯»å– DOM æ—¶ä½¿ç”¨
   ```javascript
   // âŒ ä¸éœ€è¦ flushSync
   flushSync(() => setCount(1));

   // âœ… åªåœ¨éœ€è¦è¯» DOM æ—¶ç”¨
   flushSync(() => setCount(1));
   const height = divRef.current.offsetHeight;
   ```

4. âœ… **ç†è§£æ‰§è¡Œæ ˆè¾¹ç•Œ**ï¼šé¢„æµ‹æ¸²æŸ“æ¬¡æ•°
   ```javascript
   // æ¸²æŸ“1æ¬¡
   setA(1); setB(2);

   // æ¸²æŸ“2æ¬¡ï¼ˆawait åˆ‡æ¢æ‰§è¡Œæ ˆï¼‰
   setA(1);
   await fetch('/api');
   setB(2);
   ```

**åº”ç”¨ï¼š** éµå¾ªæœ€ä½³å®è·µå¯ä»¥å……åˆ†å‘æŒ¥æ‰¹å¤„ç†çš„æ€§èƒ½ä¼˜åŠ¿

---

## åã€ã€ä¸€å¥è¯æ€»ç»“ã€‘

**è‡ªåŠ¨æ‰¹å¤„ç†æ˜¯ React 18+ å¼•å…¥çš„æ€§èƒ½ä¼˜åŒ–æœºåˆ¶ï¼Œé€šè¿‡å°†å¤šä¸ªçŠ¶æ€æ›´æ–°åˆå¹¶ä¸ºä¸€æ¬¡é‡æ¸²æŸ“ï¼Œæ‰©å±•åˆ° setTimeoutã€Promiseã€async/await ç­‰æ‰€æœ‰åœºæ™¯ï¼Œåˆ©ç”¨ Lane ä¼˜å…ˆçº§æ¨¡å‹å’Œè°ƒåº¦å™¨åœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰¹é‡æäº¤æ›´æ–°ï¼Œç›¸æ¯” React 17 çš„éƒ¨åˆ†æ‰¹å¤„ç†ï¼Œæ˜¾è‘—å‡å°‘äº†æ— æ•ˆæ¸²æŸ“ï¼Œæå‡äº†åº”ç”¨æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚**

---

## é™„å½•

### å­¦ä¹ æ£€æŸ¥æ¸…å•

#### åŸºç¡€ç†è§£
- [ ] ç†è§£æ‰¹å¤„ç†çš„å®šä¹‰ï¼šå¤šæ¬¡æ›´æ–° â†’ ä¸€æ¬¡æ¸²æŸ“
- [ ] çŸ¥é“ React 17 vs 18 çš„æ‰¹å¤„ç†èŒƒå›´å·®å¼‚
- [ ] äº†è§£æ‰¹å¤„ç†çš„ä¸‰å±‚ä»·å€¼ï¼šæ€§èƒ½ã€ä½“éªŒã€å¿ƒæ™ºæ¨¡å‹
- [ ] æŒæ¡æ‰¹å¤„ç†è¾¹ç•Œçš„æ¦‚å¿µï¼šæ‰§è¡Œæ ˆ

#### å®æˆ˜åº”ç”¨
- [ ] ä¼šä½¿ç”¨ `createRoot` å¯ç”¨è‡ªåŠ¨æ‰¹å¤„ç†
- [ ] èƒ½é¢„æµ‹ä»£ç çš„æ¸²æŸ“æ¬¡æ•°
- [ ] çŸ¥é“ä½•æ—¶ä½¿ç”¨ `flushSync`
- [ ] ç†è§£ async/await å¯¹æ‰¹å¤„ç†çš„å½±å“

#### è¿›é˜¶ç†è§£
- [ ] äº†è§£æ‰¹å¤„ç†é˜Ÿåˆ—çš„å·¥ä½œåŸç†
- [ ] çŸ¥é“ Lane ä¼˜å…ˆçº§æ¨¡å‹çš„ä½œç”¨
- [ ] ç†è§£ React 19.2 çš„ SSR Suspense æ‰¹å¤„ç†
- [ ] èƒ½å¤Ÿè§£é‡Šæ‰¹å¤„ç†çš„æºç å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰

#### é¢è¯•å‡†å¤‡
- [ ] èƒ½å¤Ÿå¯¹æ¯” React 17 vs 18 çš„æ‰¹å¤„ç†å·®å¼‚
- [ ] èƒ½å¤Ÿè¯´æ˜ flushSync çš„ä½¿ç”¨åœºæ™¯å’Œæ³¨æ„äº‹é¡¹
- [ ] èƒ½å¤Ÿä¸¾ä¾‹è¯´æ˜æ‰¹å¤„ç†çš„æ€§èƒ½æ”¶ç›Š
- [ ] èƒ½å¤Ÿè”ç³» Fiber æ¶æ„è§£é‡Šæ‰¹å¤„ç†æœºåˆ¶

---

### ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®

**åŸºç¡€è·¯å¾„ï¼ˆé€‚åˆåˆå­¦è€…ï¼‰ï¼š**
1. å¤ä¹  React çš„ setState å¼‚æ­¥æ›´æ–°æœºåˆ¶
2. å­¦ä¹  React 18 çš„å¹¶å‘ç‰¹æ€§ï¼ˆConcurrent Modeï¼‰
3. äº†è§£ useTransition å’Œ useDeferredValueï¼ˆä¼˜å…ˆçº§æ›´æ–°ï¼‰
4. å­¦ä¹  Suspense å’Œ use() Hook

**è¿›é˜¶è·¯å¾„ï¼ˆé€‚åˆæ·±å…¥å­¦ä¹ ï¼‰ï¼š**
1. ç ”ç©¶ React Fiber æ¶æ„å’ŒåŒç¼“å†²æœºåˆ¶
2. å­¦ä¹  Lane ä¼˜å…ˆçº§æ¨¡å‹å’Œè°ƒåº¦å™¨ï¼ˆSchedulerï¼‰
3. é˜…è¯» React æºç ï¼š`ReactFiberWorkLoop.js` å’Œ `ReactFiberLane.js`
4. ç†è§£ React 19 çš„ Actions å’Œ form action ç‰¹æ€§

**å®æˆ˜å»ºè®®ï¼š**
1. åœ¨é¡¹ç›®ä¸­å‡çº§åˆ° React 18+ï¼Œä½¿ç”¨ `createRoot`
2. ä½¿ç”¨ React DevTools Profiler è§‚å¯Ÿæ‰¹å¤„ç†çš„æ•ˆæœ
3. å¯¹æ¯” React 17 å’Œ 18 é¡¹ç›®çš„æ¸²æŸ“æ€§èƒ½
4. å°è¯•ä¼˜åŒ–é«˜é¢‘æ›´æ–°åœºæ™¯ï¼ˆå¦‚å®æ—¶æ•°æ®ã€å¤æ‚è¡¨å•ï¼‰

---

### å‚è€ƒèµ„æº

#### å®˜æ–¹æ–‡æ¡£
- [React v18.0 Release Notes](https://react.dev/blog/2022/03/29/react-v18)
- [Automatic Batching - React Working Group](https://github.com/reactwg/react-18/discussions/21)
- [React 19.2 Release Notes](https://react.dev/blog/2025/10/01/react-19-2)
- [flushSync API Reference](https://react.dev/reference/react-dom/flushSync)

#### ç¤¾åŒºæ–‡ç« 
- [Automatic Batching in React 18 - DEV Community](https://dev.to/this-is-learning/automatic-batching-in-react-18-273h)
- [React 18 Automatic Batching - Tasos Kakouris](https://tasoskakour.com/blog/react-18-automatic-batching/)
- [Understanding Automatic Batching in React 18 - Medium](https://medium.com/@Brahmbhatnilay/understanding-automatic-batching-in-react-18-enhancing-performance-with-optimized-state-updates-9658d04e5785)
- [React 19.2 Suspense Batching - Medium](https://medium.com/@roman_fedyskyi/react-19-2-brings-suspense-batching-to-server-rendering-68cf3340bc5b)

#### ç›¸å…³çŸ¥è¯†ç‚¹ï¼ˆæœ¬é¡¹ç›®å…¶ä»–æ–‡æ¡£ï¼‰
- `atom/03_Fiberæ¶æ„/03_å·¥ä½œå¾ªç¯.md` - ç†è§£ Fiber çš„å·¥ä½œæœºåˆ¶
- `atom/04_Schedulerè°ƒåº¦å™¨/01_ä¼˜å…ˆçº§å®šä¹‰.md` - ç†è§£ Lane ä¼˜å…ˆçº§æ¨¡å‹
- `atom/07_Hookså®ç°/01_Hooksé“¾è¡¨.md` - ç†è§£ Hook çš„çŠ¶æ€ç®¡ç†

---

**ç‰ˆæœ¬ï¼š** v1.0
**åˆ›å»ºæ—¥æœŸï¼š** 2025-12-07
**é€‚ç”¨ React ç‰ˆæœ¬ï¼š** React 18.0+, React 19.0+
**ä½œè€…ï¼š** Claude Code
**é¡¹ç›®ï¼š** React19 æºç å­¦ä¹ 
